name: Security Tests

permissions:
  contents: read
  pull-requests: read

on:
  pull_request:
  push:
    branches: [main]

jobs:
  security-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Run security regression tests
        run: make test-security

      - name: Check for security test coverage
        run: |
          # Count security tests by scanning for TestSecurityRegression pattern
          SECURITY_TESTS=$(grep -r "TestSecurityRegression" --include="*_test.go" . | grep -c "func Test" || echo "0")
          echo "Total security regression tests: $SECURITY_TESTS"

          # Minimum threshold (current baseline ~297, set threshold at 250 for safety margin)
          THRESHOLD=250

          if [ "$SECURITY_TESTS" -lt "$THRESHOLD" ]; then
            echo ""
            echo "ERROR: Security test count dropped below threshold"
            echo "Expected: >= $THRESHOLD"
            echo "Actual:   $SECURITY_TESTS"
            echo ""
            echo "This may indicate security tests were accidentally removed."
            echo "If tests were intentionally removed, update the threshold."
            exit 1
          fi

          echo ""
          echo "Security test count is healthy: $SECURITY_TESTS >= $THRESHOLD"

      - name: Scan for SECURITY VIOLATION markers
        if: failure()
        run: |
          echo "Checking for SECURITY VIOLATION markers in test output..."
          # This step runs on failure to help identify which security properties were violated
          grep -r "SECURITY VIOLATION" --include="*_test.go" . || echo "No SECURITY VIOLATION markers found in test files"
