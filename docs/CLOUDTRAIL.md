# CloudTrail Correlation Guide

Sentinel logs capture **who requested credentials and why** (allow/deny decisions). AWS CloudTrail logs capture **what actions were taken** with those credentials inside AWS. This guide explains how to correlate the two using the `request_id` and `source_identity` fields that Sentinel stamps on every session.

## Overview

When Sentinel issues credentials, it follows a two-step process:

1. **Policy evaluation** - Sentinel checks if the user is allowed to assume the requested profile
2. **Credential issuance** - If allowed, Sentinel assumes the target role with a unique `SourceIdentity`

The `SourceIdentity` value is immutable for the lifetime of the AWS session and appears in every CloudTrail event generated by that session. This creates a direct link between Sentinel's access decision and all subsequent AWS API calls.

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  Sentinel Log   │────>│  AWS Session     │────>│  CloudTrail     │
│                 │     │                  │     │                 │
│ request_id:     │     │ SourceIdentity:  │     │ sourceIdentity: │
│ a1b2c3d4        │     │ sentinel:alice:  │     │ sentinel:alice: │
│                 │     │ direct:a1b2c3d4  │     │ direct:a1b2c3d4 │
│ effect: allow   │     │                  │     │ eventName: ...  │
└─────────────────┘     └──────────────────┘     └─────────────────┘
```

## Sentinel Log Format

Sentinel writes decision logs in JSON Lines format. Each log entry contains fields for policy evaluation context and, for allow decisions, CloudTrail correlation fields.

### DecisionLogEntry Fields

| Field | Type | Description | Present |
|-------|------|-------------|---------|
| `timestamp` | string | ISO8601 timestamp of the decision | Always |
| `user` | string | Username making the request | Always |
| `profile` | string | AWS profile requested | Always |
| `effect` | string | `"allow"` or `"deny"` | Always |
| `rule` | string | Name of matched rule (empty if default deny) | Always |
| `rule_index` | int | Position of matched rule (-1 if no match) | Always |
| `reason` | string | Rule's reason field or "no matching rule" | Always |
| `policy_path` | string | SSM Parameter Store path for policy | Always |
| `request_id` | string | 8-char hex request identifier | Allow only |
| `source_identity` | string | Full `sentinel:user:approval-marker:request-id` string | Allow only |
| `role_arn` | string | Target role ARN | Allow only |
| `session_duration_seconds` | int | Session duration in seconds | Allow only |

### Example: Allow Decision (with correlation fields)

```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "user": "alice",
  "profile": "production-admin",
  "effect": "allow",
  "rule": "prod-access-weekdays",
  "rule_index": 2,
  "reason": "Production access during business hours",
  "policy_path": "/sentinel/policy",
  "request_id": "a1b2c3d4",
  "source_identity": "sentinel:alice:direct:a1b2c3d4",
  "role_arn": "arn:aws:iam::123456789012:role/ProductionAdmin",
  "session_duration_seconds": 3600
}
```

### Example: Deny Decision (no correlation fields)

```json
{
  "timestamp": "2024-01-15T22:30:00Z",
  "user": "bob",
  "profile": "production-admin",
  "effect": "deny",
  "rule": "",
  "rule_index": -1,
  "reason": "no matching rule",
  "policy_path": "/sentinel/policy"
}
```

Note: Deny decisions do not include `request_id`, `source_identity`, `role_arn`, or `session_duration_seconds` because no credentials are issued.

## SourceIdentity Format

Sentinel stamps every AWS session with a `SourceIdentity` value that uniquely identifies the access request and its approval status.

### Format

```
sentinel:<user>:<approval-marker>:<request-id>
```

| Component | Description | Example |
|-----------|-------------|---------|
| `sentinel` | Fixed prefix identifying Sentinel-issued credentials | `sentinel` |
| `user` | Sanitized username (alphanumeric only, max 20 chars) | `alice` |
| `approval-marker` | Either `direct` or an 8-char hex approval ID | `direct` or `abcd1234` |
| `request-id` | 8-character lowercase hex string (32 bits of entropy) | `a1b2c3d4` |

### Approval Marker Values

- **`direct`** - Access was granted directly by policy (no approval required)
- **8-char hex** - Access was granted via an approved request; the value is the approval request ID

### Examples

| Scenario | SourceIdentity |
|----------|----------------|
| Direct access (policy allows) | `sentinel:alice:direct:a1b2c3d4` |
| Approved access (via request) | `sentinel:alice:abcd1234:a1b2c3d4` |

### Legacy Format

For backward compatibility, Sentinel recognizes the legacy 3-part format when parsing:

```
sentinel:<user>:<request-id>
```

This format is treated as direct access. New credentials always use the 4-part format.

### How SourceIdentity Appears in CloudTrail

In CloudTrail events, the `SourceIdentity` appears in the `userIdentity` object:

```json
{
  "eventVersion": "1.08",
  "userIdentity": {
    "type": "AssumedRole",
    "principalId": "AROA3XFRBF535EXAMPLE:session-name",
    "arn": "arn:aws:sts::123456789012:assumed-role/ProductionAdmin/session-name",
    "accountId": "123456789012",
    "sessionContext": {
      "sessionIssuer": {
        "type": "Role",
        "principalId": "AROA3XFRBF535EXAMPLE",
        "arn": "arn:aws:iam::123456789012:role/ProductionAdmin",
        "accountId": "123456789012",
        "userName": "ProductionAdmin"
      }
    },
    "sourceIdentity": "sentinel:alice:direct:a1b2c3d4"
  },
  "eventTime": "2024-01-15T10:35:00Z",
  "eventSource": "ec2.amazonaws.com",
  "eventName": "DescribeInstances",
  ...
}
```

### AWS Constraints

- **Maximum length**: 64 characters (Sentinel format uses max 38 chars)
- **Allowed characters**: Alphanumeric and `=,.@-`
- **Immutability**: Set once on `AssumeRole`, cannot be changed for session lifetime
- **Propagation**: Automatically propagates through role chaining via session tags

## Correlation Workflow

To trace what a user did with Sentinel-issued credentials:

### Step 1: Find the Sentinel Log Entry

Search Sentinel logs for the access request by user, timestamp, or request_id:

```bash
# Search by user
grep '"user":"alice"' /var/log/sentinel/decisions.log

# Search by request_id
grep '"request_id":"a1b2c3d4"' /var/log/sentinel/decisions.log

# Search by time window (using jq)
cat /var/log/sentinel/decisions.log | jq -c 'select(.timestamp >= "2024-01-15T10:00:00Z" and .timestamp <= "2024-01-15T11:00:00Z")'
```

### Step 2: Extract the SourceIdentity Value

From the Sentinel log entry, copy the `source_identity` field value:

```bash
# Extract source_identity from matching entry
grep '"request_id":"a1b2c3d4"' /var/log/sentinel/decisions.log | jq -r '.source_identity'
# Output: sentinel:alice:direct:a1b2c3d4
```

### Step 3: Search CloudTrail for Matching SourceIdentity

Use the AWS CLI or Athena to find all CloudTrail events with that `sourceIdentity`:

```bash
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=Username,AttributeValue="sentinel:alice:direct:a1b2c3d4" \
  --start-time "2024-01-15T10:00:00Z" \
  --end-time "2024-01-15T12:00:00Z"
```

### Step 4: View All API Calls from That Session

The CloudTrail results show every AWS API call made during that session:

```bash
# Pretty-print the events
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=Username,AttributeValue="sentinel:alice:direct:a1b2c3d4" \
  --start-time "2024-01-15T10:00:00Z" \
  --end-time "2024-01-15T12:00:00Z" \
  --output json | jq '.Events[].CloudTrailEvent | fromjson | {time: .eventTime, service: .eventSource, action: .eventName}'
```

This produces a timeline of actions:

```json
{"time": "2024-01-15T10:35:00Z", "service": "ec2.amazonaws.com", "action": "DescribeInstances"}
{"time": "2024-01-15T10:36:15Z", "service": "s3.amazonaws.com", "action": "ListBuckets"}
{"time": "2024-01-15T10:38:42Z", "service": "iam.amazonaws.com", "action": "GetUser"}
```

## AWS CLI Examples

The AWS CLI provides `lookup-events` for searching CloudTrail's recent history. These examples demonstrate common patterns for correlating Sentinel sessions with AWS activity.

> **Note:** `aws cloudtrail lookup-events` searches the last 90 days of management events. For older events or data events (S3 object-level, Lambda invocations), use Athena queries against CloudTrail logs in S3.

### Lookup by SourceIdentity

Find all CloudTrail events for a specific Sentinel session:

```bash
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=Username,AttributeValue="sentinel:alice:direct:a1b2c3d4" \
  --start-time "2024-01-15T00:00:00Z" \
  --end-time "2024-01-15T23:59:59Z"
```

### Extract Key Fields with jq

Parse the nested CloudTrail response to extract actionable information:

```bash
# Get event time, service, action, and source IP
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=Username,AttributeValue="sentinel:alice:direct:a1b2c3d4" \
  --start-time "2024-01-15T10:00:00Z" \
  --end-time "2024-01-15T12:00:00Z" \
  --output json | jq -r '
    .Events[].CloudTrailEvent | fromjson |
    [.eventTime, .eventSource, .eventName, .sourceIPAddress] | @tsv
  '
```

Example output:

```
2024-01-15T10:35:00Z    ec2.amazonaws.com       DescribeInstances       198.51.100.42
2024-01-15T10:36:15Z    s3.amazonaws.com        ListBuckets             198.51.100.42
2024-01-15T10:38:42Z    iam.amazonaws.com       GetUser                 198.51.100.42
```

### Find All Sentinel Sessions in Time Window

List all Sentinel-issued sessions in the last hour:

```bash
aws cloudtrail lookup-events \
  --start-time "$(date -u -v-1H +%Y-%m-%dT%H:%M:%SZ)" \
  --end-time "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
  --output json | jq -r '
    .Events[].CloudTrailEvent | fromjson |
    select(.userIdentity.sourceIdentity != null) |
    select(.userIdentity.sourceIdentity | startswith("sentinel:")) |
    .userIdentity.sourceIdentity
  ' | sort -u
```

### Filter by AWS Service

Find all EC2 actions from a Sentinel session:

```bash
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=Username,AttributeValue="sentinel:alice:direct:a1b2c3d4" \
  --start-time "2024-01-15T10:00:00Z" \
  --end-time "2024-01-15T12:00:00Z" \
  --output json | jq '
    .Events[].CloudTrailEvent | fromjson |
    select(.eventSource == "ec2.amazonaws.com") |
    {time: .eventTime, action: .eventName, resources: .resources}
  '
```

### Cross-Reference Workflow

Complete example starting from Sentinel log and ending with CloudTrail activity:

```bash
# Step 1: Find the Sentinel decision for a user and extract source identity
SOURCE_IDENTITY=$(grep '"user":"alice"' /var/log/sentinel/decisions.log | tail -1 | jq -r '.source_identity')
echo "Source Identity: $SOURCE_IDENTITY"
# Example output: sentinel:alice:direct:a1b2c3d4

# Step 2: (Optional) Extract just the request ID from the source identity
REQUEST_ID=$(echo "$SOURCE_IDENTITY" | rev | cut -d: -f1 | rev)
echo "Request ID: $REQUEST_ID"

# Step 3: Lookup CloudTrail events
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=Username,AttributeValue="$SOURCE_IDENTITY" \
  --start-time "2024-01-15T00:00:00Z" \
  --end-time "2024-01-16T00:00:00Z" \
  --output json | jq -r '
    .Events[].CloudTrailEvent | fromjson |
    "[\(.eventTime)] \(.eventSource): \(.eventName)"
  '
```

Example output:

```
[2024-01-15T10:35:00Z] ec2.amazonaws.com: DescribeInstances
[2024-01-15T10:36:15Z] s3.amazonaws.com: ListBuckets
[2024-01-15T10:38:42Z] iam.amazonaws.com: GetUser
```

## Athena Queries

For advanced analysis, historical queries beyond 90 days, or data events (S3 object-level operations, Lambda invocations), use Amazon Athena to query CloudTrail logs stored in S3.

### Prerequisites

1. **CloudTrail logs exported to S3** - Configure a trail to deliver logs to an S3 bucket
2. **Athena table for CloudTrail logs** - Create a table using the CloudTrail schema

For setup instructions, see [Querying CloudTrail Logs with Athena](https://docs.aws.amazon.com/athena/latest/ug/cloudtrail-logs.html) in the AWS documentation.

### Find All Actions by Sentinel Session

Query all API calls made with a specific Sentinel-issued session:

```sql
SELECT
    eventtime,
    eventsource,
    eventname,
    sourceipaddress,
    useridentity.sourceidentity
FROM cloudtrail_logs
WHERE useridentity.sourceidentity = 'sentinel:alice:direct:a1b2c3d4'
ORDER BY eventtime;
```

### Aggregate Sentinel Usage by User

Summarize API call volume and action diversity per Sentinel user:

```sql
SELECT
    REGEXP_EXTRACT(useridentity.sourceidentity, 'sentinel:([^:]+):', 1) AS sentinel_user,
    COUNT(*) AS api_calls,
    COUNT(DISTINCT eventname) AS unique_actions,
    COUNT(DISTINCT eventsource) AS services_used
FROM cloudtrail_logs
WHERE useridentity.sourceidentity LIKE 'sentinel:%'
    AND eventtime >= '2024-01-01T00:00:00Z'
GROUP BY 1
ORDER BY api_calls DESC;
```

### Find High-Risk Actions by Sentinel Users

Identify potentially sensitive operations:

```sql
SELECT
    eventtime,
    useridentity.sourceidentity,
    eventsource,
    eventname,
    errorcode,
    errormessage
FROM cloudtrail_logs
WHERE useridentity.sourceidentity LIKE 'sentinel:%'
    AND (
        eventname LIKE 'Delete%'
        OR eventname LIKE 'Put%Policy'
        OR eventname LIKE 'Create%'
        OR eventname LIKE 'Attach%'
        OR eventname LIKE 'Detach%'
    )
ORDER BY eventtime DESC
LIMIT 100;
```

### Daily Session Count by User

Track Sentinel usage patterns over time:

```sql
SELECT
    DATE(eventtime) AS day,
    REGEXP_EXTRACT(useridentity.sourceidentity, 'sentinel:([^:]+):', 1) AS sentinel_user,
    COUNT(DISTINCT useridentity.sourceidentity) AS unique_sessions,
    COUNT(*) AS total_api_calls
FROM cloudtrail_logs
WHERE useridentity.sourceidentity LIKE 'sentinel:%'
    AND eventtime >= DATE_ADD('day', -30, CURRENT_DATE)
GROUP BY 1, 2
ORDER BY 1 DESC, 4 DESC;
```

### Find Sessions That Required Approval

Query sessions where access was granted via an approved request (not direct access):

```sql
SELECT
    eventtime,
    useridentity.sourceidentity,
    REGEXP_EXTRACT(useridentity.sourceidentity, 'sentinel:[^:]+:([^:]+):', 1) AS approval_marker,
    eventsource,
    eventname
FROM cloudtrail_logs
WHERE useridentity.sourceidentity LIKE 'sentinel:%'
    AND REGEXP_EXTRACT(useridentity.sourceidentity, 'sentinel:[^:]+:([^:]+):', 1) != 'direct'
ORDER BY eventtime DESC
LIMIT 100;
```

### Breakdown of Direct vs Approved Access

Summarize access patterns by approval status:

```sql
SELECT
    CASE
        WHEN REGEXP_EXTRACT(useridentity.sourceidentity, 'sentinel:[^:]+:([^:]+):', 1) = 'direct'
        THEN 'direct'
        ELSE 'approved'
    END AS access_type,
    COUNT(*) AS session_count
FROM cloudtrail_logs
WHERE useridentity.sourceidentity LIKE 'sentinel:%'
    AND eventtime >= DATE_ADD('day', -30, CURRENT_DATE)
GROUP BY 1;
```

### Find Sessions by Approval ID

Locate all activity associated with a specific approval request:

```sql
SELECT
    eventtime,
    useridentity.sourceidentity,
    eventsource,
    eventname,
    sourceipaddress
FROM cloudtrail_logs
WHERE useridentity.sourceidentity LIKE 'sentinel:%:abcd1234:%'
ORDER BY eventtime;
```

### Cross-Reference with Sentinel Logs

For complete correlation, export Sentinel decision logs to S3 in JSON Lines format (Athena-compatible). Then join the two sources:

```sql
-- Assuming sentinel_logs table exists with Sentinel decision log data
SELECT
    s.timestamp AS sentinel_decision_time,
    s.user,
    s.profile,
    s.effect,
    s.rule,
    c.eventtime AS aws_action_time,
    c.eventsource,
    c.eventname
FROM sentinel_logs s
LEFT JOIN cloudtrail_logs c
    ON c.useridentity.sourceidentity = s.source_identity
    AND c.eventtime >= s.timestamp
    AND c.eventtime <= DATE_ADD('hour', 1, CAST(s.timestamp AS timestamp))
WHERE s.effect = 'allow'
    AND s.timestamp >= '2024-01-15T00:00:00Z'
ORDER BY s.timestamp, c.eventtime;
```

This query shows each Sentinel allow decision alongside the AWS actions taken within the session duration.

### Creating the Sentinel Logs Table

If you export Sentinel decision logs to S3, create an Athena table:

```sql
CREATE EXTERNAL TABLE sentinel_logs (
    timestamp STRING,
    user STRING,
    profile STRING,
    effect STRING,
    rule STRING,
    rule_index INT,
    reason STRING,
    policy_path STRING,
    request_id STRING,
    source_identity STRING,
    role_arn STRING,
    session_duration_seconds INT
)
ROW FORMAT SERDE 'org.openx.data.jsonserde.JsonSerDe'
LOCATION 's3://your-bucket/sentinel-logs/';
```
