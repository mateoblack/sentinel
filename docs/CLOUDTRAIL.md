# CloudTrail Correlation Guide

Sentinel logs capture **who requested credentials and why** (allow/deny decisions). AWS CloudTrail logs capture **what actions were taken** with those credentials inside AWS. This guide explains how to correlate the two using the `request_id` and `source_identity` fields that Sentinel stamps on every session.

## Overview

When Sentinel issues credentials, it follows a two-step process:

1. **Policy evaluation** - Sentinel checks if the user is allowed to assume the requested profile
2. **Credential issuance** - If allowed, Sentinel assumes the target role with a unique `SourceIdentity`

The `SourceIdentity` value is immutable for the lifetime of the AWS session and appears in every CloudTrail event generated by that session. This creates a direct link between Sentinel's access decision and all subsequent AWS API calls.

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  Sentinel Log   │────>│  AWS Session     │────>│  CloudTrail     │
│                 │     │                  │     │                 │
│ request_id:     │     │ SourceIdentity:  │     │ sourceIdentity: │
│ a1b2c3d4        │     │ sentinel:alice:  │     │ sentinel:alice: │
│                 │     │ a1b2c3d4         │     │ a1b2c3d4        │
│ effect: allow   │     │                  │     │ eventName: ...  │
└─────────────────┘     └──────────────────┘     └─────────────────┘
```

## Sentinel Log Format

Sentinel writes decision logs in JSON Lines format. Each log entry contains fields for policy evaluation context and, for allow decisions, CloudTrail correlation fields.

### DecisionLogEntry Fields

| Field | Type | Description | Present |
|-------|------|-------------|---------|
| `timestamp` | string | ISO8601 timestamp of the decision | Always |
| `user` | string | Username making the request | Always |
| `profile` | string | AWS profile requested | Always |
| `effect` | string | `"allow"` or `"deny"` | Always |
| `rule` | string | Name of matched rule (empty if default deny) | Always |
| `rule_index` | int | Position of matched rule (-1 if no match) | Always |
| `reason` | string | Rule's reason field or "no matching rule" | Always |
| `policy_path` | string | SSM Parameter Store path for policy | Always |
| `request_id` | string | 8-char hex request identifier | Allow only |
| `source_identity` | string | Full `sentinel:user:request-id` string | Allow only |
| `role_arn` | string | Target role ARN | Allow only |
| `session_duration_seconds` | int | Session duration in seconds | Allow only |

### Example: Allow Decision (with correlation fields)

```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "user": "alice",
  "profile": "production-admin",
  "effect": "allow",
  "rule": "prod-access-weekdays",
  "rule_index": 2,
  "reason": "Production access during business hours",
  "policy_path": "/sentinel/policy",
  "request_id": "a1b2c3d4",
  "source_identity": "sentinel:alice:a1b2c3d4",
  "role_arn": "arn:aws:iam::123456789012:role/ProductionAdmin",
  "session_duration_seconds": 3600
}
```

### Example: Deny Decision (no correlation fields)

```json
{
  "timestamp": "2024-01-15T22:30:00Z",
  "user": "bob",
  "profile": "production-admin",
  "effect": "deny",
  "rule": "",
  "rule_index": -1,
  "reason": "no matching rule",
  "policy_path": "/sentinel/policy"
}
```

Note: Deny decisions do not include `request_id`, `source_identity`, `role_arn`, or `session_duration_seconds` because no credentials are issued.

## SourceIdentity Format

Sentinel stamps every AWS session with a `SourceIdentity` value that uniquely identifies the access request.

### Format

```
sentinel:<user>:<request-id>
```

| Component | Description | Example |
|-----------|-------------|---------|
| `sentinel` | Fixed prefix identifying Sentinel-issued credentials | `sentinel` |
| `user` | Sanitized username (alphanumeric only, max 20 chars) | `alice` |
| `request-id` | 8-character lowercase hex string (32 bits of entropy) | `a1b2c3d4` |

### Example

```
sentinel:alice:a1b2c3d4
```

### How SourceIdentity Appears in CloudTrail

In CloudTrail events, the `SourceIdentity` appears in the `userIdentity` object:

```json
{
  "eventVersion": "1.08",
  "userIdentity": {
    "type": "AssumedRole",
    "principalId": "AROA3XFRBF535EXAMPLE:session-name",
    "arn": "arn:aws:sts::123456789012:assumed-role/ProductionAdmin/session-name",
    "accountId": "123456789012",
    "sessionContext": {
      "sessionIssuer": {
        "type": "Role",
        "principalId": "AROA3XFRBF535EXAMPLE",
        "arn": "arn:aws:iam::123456789012:role/ProductionAdmin",
        "accountId": "123456789012",
        "userName": "ProductionAdmin"
      }
    },
    "sourceIdentity": "sentinel:alice:a1b2c3d4"
  },
  "eventTime": "2024-01-15T10:35:00Z",
  "eventSource": "ec2.amazonaws.com",
  "eventName": "DescribeInstances",
  ...
}
```

### AWS Constraints

- **Maximum length**: 64 characters (Sentinel format uses max 38 chars)
- **Allowed characters**: Alphanumeric and `=,.@-`
- **Immutability**: Set once on `AssumeRole`, cannot be changed for session lifetime
- **Propagation**: Automatically propagates through role chaining via session tags

## Correlation Workflow

To trace what a user did with Sentinel-issued credentials:

### Step 1: Find the Sentinel Log Entry

Search Sentinel logs for the access request by user, timestamp, or request_id:

```bash
# Search by user
grep '"user":"alice"' /var/log/sentinel/decisions.log

# Search by request_id
grep '"request_id":"a1b2c3d4"' /var/log/sentinel/decisions.log

# Search by time window (using jq)
cat /var/log/sentinel/decisions.log | jq -c 'select(.timestamp >= "2024-01-15T10:00:00Z" and .timestamp <= "2024-01-15T11:00:00Z")'
```

### Step 2: Extract the SourceIdentity Value

From the Sentinel log entry, copy the `source_identity` field value:

```bash
# Extract source_identity from matching entry
grep '"request_id":"a1b2c3d4"' /var/log/sentinel/decisions.log | jq -r '.source_identity'
# Output: sentinel:alice:a1b2c3d4
```

### Step 3: Search CloudTrail for Matching SourceIdentity

Use the AWS CLI or Athena to find all CloudTrail events with that `sourceIdentity`:

```bash
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=Username,AttributeValue="sentinel:alice:a1b2c3d4" \
  --start-time "2024-01-15T10:00:00Z" \
  --end-time "2024-01-15T12:00:00Z"
```

### Step 4: View All API Calls from That Session

The CloudTrail results show every AWS API call made during that session:

```bash
# Pretty-print the events
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=Username,AttributeValue="sentinel:alice:a1b2c3d4" \
  --start-time "2024-01-15T10:00:00Z" \
  --end-time "2024-01-15T12:00:00Z" \
  --output json | jq '.Events[].CloudTrailEvent | fromjson | {time: .eventTime, service: .eventSource, action: .eventName}'
```

This produces a timeline of actions:

```json
{"time": "2024-01-15T10:35:00Z", "service": "ec2.amazonaws.com", "action": "DescribeInstances"}
{"time": "2024-01-15T10:36:15Z", "service": "s3.amazonaws.com", "action": "ListBuckets"}
{"time": "2024-01-15T10:38:42Z", "service": "iam.amazonaws.com", "action": "GetUser"}
```

