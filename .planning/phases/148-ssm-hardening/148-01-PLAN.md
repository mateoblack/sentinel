---
phase: 148-ssm-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - deploy/ssm.go
  - deploy/ssm_test.go
  - cli/ssm.go
  - cli/ssm_test.go
autonomous: true
---

<objective>
Implement SSM parameter hardening commands for backup, restore, and status reporting.

Purpose: Enable users to protect Sentinel policy parameters with versioning visibility, local backups for disaster recovery, and restore capability.

Output: New `sentinel ssm backup` and `sentinel ssm restore` commands with auto-discovery and status reporting.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summary (DynamoDB hardening patterns, confirmation prompts)
@.planning/phases/147-dynamodb-hardening/147-01-SUMMARY.md

# Existing SSM auditing code (patterns, interfaces)
@deploy/audit.go

# Existing SSM operations for policy loading
@policy/loader.go

# CLI patterns for infrastructure commands
@cli/dynamodb.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deploy/ssm.go with SSMHardener</name>
  <files>deploy/ssm.go, deploy/ssm_test.go</files>
  <action>
Create deploy/ssm.go with SSM parameter backup and restore capabilities:

1. Define ssmHardenAPI interface extending ssmAuditAPI:
   ```go
   // ssmHardenAPI extends audit operations with hardening capabilities.
   type ssmHardenAPI interface {
       // Audit operations (from ssmAuditAPI)
       GetParameter(ctx context.Context, params *ssm.GetParameterInput, optFns ...func(*ssm.Options)) (*ssm.GetParameterOutput, error)
       GetParametersByPath(ctx context.Context, params *ssm.GetParametersByPathInput, optFns ...func(*ssm.Options)) (*ssm.GetParametersByPathOutput, error)

       // Hardening operations
       GetParameterHistory(ctx context.Context, params *ssm.GetParameterHistoryInput, optFns ...func(*ssm.Options)) (*ssm.GetParameterHistoryOutput, error)
       PutParameter(ctx context.Context, params *ssm.PutParameterInput, optFns ...func(*ssm.Options)) (*ssm.PutParameterOutput, error)
   }
   ```

2. Create SSMHardener struct:
   ```go
   type SSMHardener struct {
       client ssmHardenAPI
   }
   ```

3. Define status and backup types:
   ```go
   // ParameterStatus represents the current state of an SSM parameter.
   type ParameterStatus struct {
       Name           string    `json:"name"`
       Type           string    `json:"type"`
       Version        int64     `json:"version"`
       LastModified   time.Time `json:"last_modified"`
       DataType       string    `json:"data_type,omitempty"`
   }

   // ParameterBackup represents a backed up parameter.
   type ParameterBackup struct {
       Name      string    `json:"name"`
       Type      string    `json:"type"`
       Value     string    `json:"value"`
       Version   int64     `json:"version"`
       BackupAt  time.Time `json:"backup_at"`
   }

   // BackupResult contains the result of a backup operation.
   type BackupResult struct {
       Parameters []ParameterBackup `json:"parameters"`
       BackupDir  string            `json:"backup_dir"`
       Count      int               `json:"count"`
   }

   // RestoreResult contains the result of a restore operation.
   type RestoreResult struct {
       Restored []string `json:"restored"`
       Skipped  []string `json:"skipped"`
       Failed   []string `json:"failed"`
       Errors   []string `json:"errors,omitempty"`
   }
   ```

4. Implement DiscoverSentinelParameters:
   ```go
   // DiscoverSentinelParameters finds all SSM parameters matching the Sentinel prefix pattern.
   // Default prefix is "/sentinel/" but can be customized.
   func (h *SSMHardener) DiscoverSentinelParameters(ctx context.Context, prefix string) ([]string, error)
   ```

5. Implement GetParameterStatus:
   ```go
   // GetParameterStatus returns the current status for a parameter including version info.
   func (h *SSMHardener) GetParameterStatus(ctx context.Context, paramName string) (*ParameterStatus, error)
   ```

6. Implement GetParametersStatus for batch status:
   ```go
   // GetParametersStatus returns status for multiple parameters.
   func (h *SSMHardener) GetParametersStatus(ctx context.Context, paramNames []string) ([]*ParameterStatus, error)
   ```

7. Implement BackupParameters:
   ```go
   // BackupParameters creates local backups of parameter values.
   // Writes each parameter to a JSON file in the backup directory.
   // If backupDir is empty, uses current directory.
   func (h *SSMHardener) BackupParameters(ctx context.Context, paramNames []string, backupDir string) (*BackupResult, error)
   ```

8. Implement RestoreParameters:
   ```go
   // RestoreParameters restores parameters from backup files.
   // Only restores parameters that exist in both backup and paramNames list.
   // Uses Overwrite mode to update existing parameters.
   func (h *SSMHardener) RestoreParameters(ctx context.Context, backupDir string, paramNames []string) (*RestoreResult, error)
   ```

9. Implement LoadBackup helper:
   ```go
   // LoadBackup reads backup files from a directory.
   func LoadBackup(backupDir string) ([]ParameterBackup, error)
   ```

10. Add NewSSMHardener and NewSSMHardenerWithClient constructors.

11. Create tests in deploy/ssm_test.go covering:
    - DiscoverSentinelParameters with prefix matching
    - DiscoverSentinelParameters with pagination (multiple pages)
    - GetParameterStatus for various parameter types (String, SecureString)
    - GetParametersStatus batch operation
    - BackupParameters creating files with correct format
    - RestoreParameters updating existing parameters
    - RestoreParameters skipping non-matching parameters
    - AccessDenied error handling
  </action>
  <verify>go test ./deploy/... -run TestSSM -v passes</verify>
  <done>SSMHardener discovers parameters, creates backups, and restores from backup files</done>
</task>

<task type="auto">
  <name>Task 2: Add sentinel ssm backup and restore CLI commands</name>
  <files>cli/ssm.go, cli/ssm_test.go</files>
  <action>
Create cli/ssm.go with SSM hardening commands:

1. SSMBackupCommandInput struct:
   ```go
   type SSMBackupCommandInput struct {
       Parameters  []string // Specific parameters to backup (empty = auto-discover)
       Prefix      string   // Prefix for auto-discovery (default: "/sentinel/")
       OutputDir   string   // Directory for backup files (default: "./sentinel-backup-{timestamp}")
       JSONOutput  bool     // Output in JSON format
       AWSProfile  string   // AWS profile for credentials
       Region      string   // AWS region

       // For testing
       Hardener *deploy.SSMHardener
       Stdout   *os.File
       Stderr   *os.File
   }
   ```

2. SSMRestoreCommandInput struct:
   ```go
   type SSMRestoreCommandInput struct {
       BackupDir   string   // Directory containing backup files (required)
       Parameters  []string // Specific parameters to restore (empty = all in backup)
       Force       bool     // Skip confirmation prompt
       JSONOutput  bool     // Output in JSON format
       AWSProfile  string   // AWS profile for credentials
       Region      string   // AWS region

       // For testing
       Hardener *deploy.SSMHardener
       Stdout   *os.File
       Stderr   *os.File
       Stdin    *os.File  // For confirmation prompt
   }
   ```

3. ConfigureSSMCommands:
   - Create "ssm" command group under app
   - Add "backup" subcommand: `sentinel ssm backup`
   - Add "restore" subcommand: `sentinel ssm restore`
   - Flags for backup:
     - `--parameter` - Specific parameter name (repeatable, default: auto-discover)
     - `--prefix` - Parameter prefix for discovery (default: "/sentinel/")
     - `--output-dir, -o` - Output directory for backup files
     - `--json` - Output in JSON format
     - `--aws-profile` - AWS profile
     - `--region` - AWS region
   - Flags for restore:
     - `--backup-dir, -d` - Directory containing backup files (required)
     - `--parameter` - Specific parameter to restore (repeatable, default: all)
     - `--force, -f` - Skip confirmation prompt
     - `--json` - Output in JSON format
     - `--aws-profile` - AWS profile
     - `--region` - AWS region

4. SSMBackupCommand logic:
   - If no --parameter specified: Use DiscoverSentinelParameters with prefix
   - Get current status for all parameters via GetParametersStatus
   - Show current parameter status (table format):
     ```
     Sentinel SSM Backup
     ===================

     Parameters to backup (5 found):

       Parameter                        Type          Version    Last Modified
       ---------                        ----          -------    -------------
       /sentinel/policies/production    String        3          2026-01-25 14:30:00
       /sentinel/policies/staging       String        2          2026-01-24 10:15:00
       /sentinel/config/signing-key     SecureString  1          2026-01-20 09:00:00

     Backup directory: ./sentinel-backup-20260127-143000/

     Proceed with backup? [Y/n]
     ```
   - Call BackupParameters and report results
   - Output success message with backup location

5. SSMRestoreCommand logic:
   - Load backup files from --backup-dir
   - If --parameter specified, filter to those parameters
   - Show what will be restored:
     ```
     Sentinel SSM Restore
     ====================

     Backup from: ./sentinel-backup-20260127-143000/
     Backup date: 2026-01-27 14:30:00

     Parameters to restore (3 found):

       Parameter                        Backup Version    Current Version
       ---------                        --------------    ---------------
       /sentinel/policies/production    3                 5
       /sentinel/policies/staging       2                 2 (no change)
       /sentinel/config/signing-key     1                 2

     Warning: This will overwrite current parameter values.
     Restore 2 parameters? [y/N]
     ```
   - If not --force, prompt for confirmation (default N for restore since destructive)
   - Call RestoreParameters and report results

6. Human-readable output format for backup:
   ```
   ✓ Backed up 5 parameters to ./sentinel-backup-20260127-143000/

   Files created:
     sentinel-policies-production.json (v3)
     sentinel-policies-staging.json (v2)
     sentinel-config-signing-key.json (v1)
   ```

7. Human-readable output format for restore:
   ```
   ✓ /sentinel/policies/production: Restored (v3 → v6)
   - /sentinel/policies/staging: Skipped (already at v2)
   ✓ /sentinel/config/signing-key: Restored (v1 → v3)

   Summary: 2 restored, 1 skipped
   ```

8. JSON output format for backup:
   ```json
   {
     "parameters": [
       {
         "name": "/sentinel/policies/production",
         "version": 3,
         "file": "sentinel-policies-production.json"
       }
     ],
     "backup_dir": "./sentinel-backup-20260127-143000/",
     "count": 5
   }
   ```

9. JSON output format for restore:
   ```json
   {
     "restored": ["/sentinel/policies/production"],
     "skipped": ["/sentinel/policies/staging"],
     "failed": [],
     "count": 2
   }
   ```

10. Exit codes:
    - 0: Success (backup created or restore completed)
    - 1: Failure (no parameters found, backup failed, restore failed)
    - 2: User cancelled at confirmation prompt

11. Create tests covering:
    - Backup with auto-discovery
    - Backup with explicit --parameter
    - Backup with custom --output-dir
    - Restore from backup directory
    - Restore with --parameter filter
    - Confirmation prompt works correctly
    - --force bypasses confirmation
    - JSON output format for both commands
    - No parameters found error
    - Backup directory not found error
  </action>
  <verify>go test ./cli/... -run TestSSM -v passes</verify>
  <done>sentinel ssm backup and sentinel ssm restore commands with auto-discovery, status preview, and confirmation prompts</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test ./deploy/... -v passes
- [ ] go test ./cli/... -run SSM -v passes
- [ ] gofmt -l . shows no formatting issues
- [ ] No new lint warnings introduced
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- SSMHardener discovers Sentinel parameters by prefix
- SSMHardener creates backups with version information
- SSMHardener restores parameters from backup files
- CLI shows current parameter status before operations
- Backup creates timestamped directory with JSON files
- Restore requires confirmation unless --force
- Exit codes reflect operation status
</success_criteria>

<output>
After completion, create `.planning/phases/148-ssm-hardening/148-01-SUMMARY.md`
</output>
