---
phase: 34-break-glass-policies
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - cli/breakglass.go
  - cli/breakglass_test.go
autonomous: true
---

<objective>
Integrate break-glass policy into CLI breakglass command.

Purpose: Enforce policy-based authorization before allowing break-glass invocation.
Output: breakglass command checks policy authorization with clear error messages.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan output
@.planning/phases/34-break-glass-policies/34-01-SUMMARY.md

# CLI integration patterns
@cli/breakglass.go
@cli/approve.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add BreakGlassPolicy field to breakglass command input</name>
  <files>cli/breakglass.go</files>
  <action>
Add optional BreakGlassPolicy field to BreakGlassCommandInput:

1. **Add field to BreakGlassCommandInput struct**:
   ```go
   // BreakGlassPolicy is an optional policy for authorization control.
   // If nil, any user can invoke break-glass (no policy enforcement).
   BreakGlassPolicy *breakglass.BreakGlassPolicy
   ```

2. **Add policy check in BreakGlassCommand** (after profile validation, before rate limit check):
   - Find matching rule: `rule := breakglass.FindBreakGlassPolicyRule(input.BreakGlassPolicy, input.ProfileName)`
   - Check authorization: If rule exists, call `breakglass.IsBreakGlassAllowed(rule, username, reasonCode, time.Now(), duration)`
   - If not allowed, output clear error to stderr:
     - "Not authorized to invoke break-glass for profile %q" (user not in list)
     - "Reason code %q not allowed for this profile" (reason code restricted)
     - "Break-glass not allowed at this time" (time window restriction)
     - "Duration %v exceeds maximum allowed %v for this profile" (duration cap)
   - If rule is nil (no matching rule), check if policy exists:
     - If policy exists but no rule matches: deny with "No break-glass policy rule matches profile %q"
     - If policy is nil: allow (backward compatible, no policy = no enforcement)

Pattern: Follow approve.go authorization check patterns exactly.
  </action>
  <verify>go build ./cli/... compiles without errors</verify>
  <done>BreakGlassPolicy field added with authorization enforcement</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for policy enforcement in breakglass command</name>
  <files>cli/breakglass_test.go</files>
  <action>
Add test cases for policy enforcement following existing test patterns:

1. **TestBreakGlassCommand_PolicyAuthorization**:
   - User authorized by policy (success)
   - User not authorized (error: not authorized)
   - Reason code not allowed (error: reason code not allowed)
   - Time window blocked (error: not allowed at this time)
   - Duration exceeds cap (error: duration exceeds maximum)
   - No matching rule (error: no policy rule matches)
   - Nil policy (success: backward compatible)

2. **Mock setup**:
   - Create mock Store (use existing mockBreakGlassStore pattern)
   - Create test policies with various rules

3. **Test naming**: `TestBreakGlassCommand_Policy*` to group policy-related tests

Target: 7+ test cases covering all authorization scenarios
  </action>
  <verify>go test ./cli/... -v -run TestBreakGlassCommand_Policy passes</verify>
  <done>All policy enforcement tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go build ./cli/... succeeds
- [ ] go test ./cli/... -v -run TestBreakGlassCommand passes
- [ ] No new linter warnings: golangci-lint run ./cli/...
</verification>

<success_criteria>

- BreakGlassPolicy field added to BreakGlassCommandInput
- Policy authorization enforced in BreakGlassCommand
- Clear error messages for authorization failures
- 7+ tests covering all authorization scenarios
- Backward compatible: nil policy = no enforcement
</success_criteria>

<output>
After completion, create `.planning/phases/34-break-glass-policies/34-02-SUMMARY.md`
</output>
