---
phase: 125-policy-validate-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [cli/policy.go, cli/policy_test.go]
autonomous: true
---

<objective>
Implement `sentinel policy validate` command for local YAML syntax and schema validation without SSM access.

Purpose: Enable policy developers to validate policy files locally before pushing to SSM, completing the pull → edit → diff → validate → push workflow.
Output: CLI command that validates policy YAML and outputs success/error with helpful messages.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/121-policy-schema-enhancements/121-01-SUMMARY.md

# Relevant source files:
@cli/policy.go
@policy/validate.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement PolicyValidateCommand</name>
  <files>cli/policy.go</files>
  <action>
Add PolicyValidateCommand to cli/policy.go with the following behavior:

1. **Input struct** (PolicyValidateCommandInput):
   - InputFile string (positional arg - path to policy YAML file)
   - Quiet bool (--quiet / -q flag - only show errors, no success message)
   - Stdout/Stderr *os.File (for testing)

2. **Command flow**:
   a. Read policy file from disk
   b. Validate using policy.ValidatePolicy(data)
   c. On success: print "Policy is valid" to stderr (unless --quiet), exit 0
   d. On error: print error message to stderr, exit 1

3. **Error handling**:
   - File not found: exit 1 with "Error: file not found: {path}"
   - Parse error: exit 1 with "Error: parse error: {details}"
   - Validation error: exit 1 with "Error: validation error: {details}"
   - Include "Suggestion:" hint to fix the issue

4. **Registration**: Add validate subcommand under policyCmd in ConfigurePolicyCommand.

5. **Design notes**:
   - No AWS credentials needed (pure local validation)
   - Uses existing policy.ValidatePolicy() which handles both parse and validation
   - Exit code 0 = valid, exit code 1 = invalid (scripting friendly)
  </action>
  <verify>go build ./cli/... succeeds with no errors</verify>
  <done>PolicyValidateCommand registered and compiles, validates local files without AWS access</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for PolicyValidateCommand</name>
  <files>cli/policy_test.go</files>
  <action>
Extend cli/policy_test.go with tests for PolicyValidateCommand:

1. **Test cases**:
   - TestPolicyValidateCommand_ValidPolicy: valid policy YAML, exit 0, success message
   - TestPolicyValidateCommand_InvalidYAML: malformed YAML syntax, exit 1, parse error
   - TestPolicyValidateCommand_ValidationError: valid YAML but invalid policy (e.g., no rules), exit 1
   - TestPolicyValidateCommand_FileNotFound: missing input file, exit 1
   - TestPolicyValidateCommand_QuietMode: --quiet flag suppresses success message
   - TestPolicyValidateCommand_InvalidVersion: unsupported version field, exit 1
   - TestPolicyValidateCommand_InvalidEffect: invalid effect value, exit 1

2. **Test helpers**:
   - Create temp file with valid/invalid policy content
   - Capture stderr to verify output messages
   - Verify exit codes match expected behavior

3. **Verification**:
   - Verify exit codes (0 = valid, 1 = invalid)
   - Verify error messages contain appropriate context
   - Verify --quiet mode has no output on success
  </action>
  <verify>go test -v ./cli/... -run PolicyValidate passes all tests</verify>
  <done>All policy validate tests pass with coverage for valid, invalid, and error cases</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds with no errors
- [ ] `go test ./cli/... -run PolicyValidate` passes all tests
- [ ] `go vet ./...` passes
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- PolicyValidateCommand validates local policy files without AWS access
- Exit code 0 for valid policy, 1 for invalid
- Error messages distinguish parse errors from validation errors
- --quiet flag suppresses success output
- Tests cover valid, invalid, file not found, and error cases
</success_criteria>

<output>
After completion, create `.planning/phases/125-policy-validate-command/125-01-SUMMARY.md`
</output>
