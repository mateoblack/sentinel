---
phase: 111-decision-logging-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [cli/credentials.go, cli/sentinel_exec.go, sentinel/server.go, cli/credentials_test.go, cli/sentinel_exec_test.go, sentinel/server_test.go]
autonomous: true
---

<objective>
Add device ID to CLI-side and server-side decision logs for forensic correlation.

Purpose: Enable forensic correlation between CLI decision logs and Lambda TVM logs by including the same device ID. Even without MDM posture data locally, the device ID allows security teams to track credential issuance patterns per device and correlate with server-verified posture data.

Output: Device ID appears in CLI and local server mode decision logs when available, with graceful degradation when unavailable.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/110-session-device-binding/110-01-SUMMARY.md

Relevant source files:
@cli/credentials.go
@cli/sentinel_exec.go
@sentinel/server.go
@logging/decision.go
@device/identity.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DeviceID to CLI credentials command decision logs</name>
  <files>cli/credentials.go</files>
  <action>
Add device ID collection and logging to the credentials command flow:

1. At the top of runCredentialProcess(), collect device ID:
   ```go
   // Collect device ID for forensic logging (fail-open: continue without on error)
   deviceID, deviceErr := device.GetDeviceID()
   if deviceErr != nil {
       log.Printf("Warning: failed to collect device ID for logging: %v", deviceErr)
   }
   ```

2. Add import for device package if not present:
   ```go
   "github.com/byteness/aws-vault/v7/device"
   ```

3. In the allow decision logging block (around line 411), before calling NewEnhancedDecisionLogEntry:
   - Create a minimal DevicePosture with just the DeviceID if available:
   ```go
   // Include device ID in logs for forensic correlation
   if deviceID != "" {
       credFields.DevicePosture = &device.DevicePosture{
           DeviceID: deviceID,
       }
   }
   ```

This enables correlation between CLI logs and Lambda TVM logs using the same device identifier. The full MDM posture (enrolled, compliant, etc.) is only available in Lambda logs since MDM is queried server-side.
  </action>
  <verify>go build ./cli/... succeeds; go vet ./cli/... reports no issues</verify>
  <done>CLI credentials command includes device_id in decision logs when available</done>
</task>

<task type="auto">
  <name>Task 2: Add DeviceID to CLI exec command decision logs</name>
  <files>cli/sentinel_exec.go</files>
  <action>
Add device ID collection and logging to the exec command flow:

1. Near the top of runSentinelExec() (after the input parsing), collect device ID:
   ```go
   // Collect device ID for forensic logging (fail-open: continue without on error)
   deviceID, deviceErr := device.GetDeviceID()
   if deviceErr != nil {
       log.Printf("Warning: failed to collect device ID for logging: %v", deviceErr)
   }
   ```

2. Add import for device package if not present:
   ```go
   "github.com/byteness/aws-vault/v7/device"
   ```

3. In the allow decision logging block (around line 562), before calling NewEnhancedDecisionLogEntry:
   ```go
   // Include device ID in logs for forensic correlation
   if deviceID != "" {
       credFields.DevicePosture = &device.DevicePosture{
           DeviceID: deviceID,
       }
   }
   ```

Note: The exec --remote-server mode already passes device ID to the Lambda TVM (Phase 109), but we also want it in local CLI logs for correlation. The Lambda will have full MDM posture, CLI logs will have device ID only.
  </action>
  <verify>go build ./cli/... succeeds; go vet ./cli/... reports no issues</verify>
  <done>CLI exec command includes device_id in decision logs when available</done>
</task>

<task type="auto">
  <name>Task 3: Add DeviceID to local server mode decision logs</name>
  <files>sentinel/server.go</files>
  <action>
Add device ID to the local server mode (sentinel exec --server) decision logs:

1. In the SentinelServer struct or as a package-level variable cached at server startup, collect the device ID once:
   - In NewSentinelServer() or at the start of Start(), collect device ID:
   ```go
   // Collect device ID once at server startup for decision logging
   deviceID, deviceErr := device.GetDeviceID()
   if deviceErr != nil {
       log.Printf("Warning: failed to collect device ID for logging: %v", deviceErr)
       deviceID = "" // Continue without device ID
   }
   ```
   - Store in SentinelServer struct as `deviceID string`

2. Add import for device package:
   ```go
   "github.com/byteness/aws-vault/v7/device"
   ```

3. In serveCredentials() where credFields is populated (around line 339-354), add:
   ```go
   // Include device ID in logs for forensic correlation
   if s.deviceID != "" {
       credFields.DevicePosture = &device.DevicePosture{
           DeviceID: s.deviceID,
       }
   }
   ```

The local server doesn't have MDM access (that's Lambda TVM's job), but including the device ID enables correlation with Lambda logs when the same device uses both modes.
  </action>
  <verify>go build ./sentinel/... succeeds; go vet ./sentinel/... reports no issues</verify>
  <done>Local server mode includes device_id in decision logs when available</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./cli/... ./sentinel/...` succeeds without errors
- [ ] `go vet ./cli/... ./sentinel/...` reports no issues
- [ ] Decision logs from CLI credentials, exec, and server mode include device_id when available
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Device ID appears in decision logs from all credential issuance paths
- Graceful degradation: missing device ID doesn't break credential flow
</success_criteria>

<output>
After completion, create `.planning/phases/111-decision-logging-enhancement/111-01-SUMMARY.md`
</output>
