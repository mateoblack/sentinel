---
phase: 134-input-sanitization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - shell/security_test.go
autonomous: true
---

<objective>
Add security regression tests for shell function generation to prevent command injection.

Purpose: Document and verify that shell escaping prevents injection attacks in generated shell functions.
Output: Security regression tests covering shell escaping and function name sanitization attack vectors.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Shell generation with escaping:
@shell/shell.go
@shell/shell_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shell escaping security regression tests</name>
  <files>shell/security_test.go</files>
  <action>
Create shell/security_test.go with security regression tests:

1. TestSecurityRegression_ShellEscape - tests shellEscape() against injection vectors:
   - Command substitution: `$(whoami)`, `` `whoami` ``
   - Variable expansion: `$HOME`, `${PATH}`
   - Command chaining: `; rm -rf /`, `| cat /etc/passwd`
   - Newline injection: `\nmalicious`
   - Quote escaping: `'`, `"`, `\'`
   - Backslash sequences: `\`
   - Special shell chars: `!`, `*`, `?`, `[`, `]`

   Verify: escaped output when eval'd doesn't execute commands

2. TestSecurityRegression_FunctionNameSanitization - tests sanitizeFunctionName():
   - Shell metacharacters: `;`, `|`, `&`, `$`, `(`, `)`, `{`, `}`
   - Path separators: `/`, `..`
   - Spaces and tabs
   - Null bytes
   - Unicode characters

   Verify: function names are alphanumeric + hyphen only, prefixed with "sentinel-"

3. TestSecurityRegression_GeneratedScriptSafety - integration test:
   - Create profiles with malicious names
   - Generate script
   - Parse and verify no injection vectors survive
   - Check for: unescaped variables, command substitution, shell metacharacters

4. Document threat model:
   - Profile names come from SSM (admin-controlled)
   - BUT we still sanitize for defense-in-depth
   - Attack scenario: compromised SSM parameter name

Use SECURITY VIOLATION markers for test failures as in identity/security_test.go
  </action>
  <verify>`go test ./shell/... -v -run SecurityRegression` passes</verify>
  <done>Security regression tests exist for shell escaping, all injection vectors tested and documented</done>
</task>

<task type="auto">
  <name>Task 2: Add edge case tests for shell escaping</name>
  <files>shell/shell_test.go</files>
  <action>
Add additional edge case tests to shell/shell_test.go:

1. TestShellEscape_AllSpecialChars - comprehensive test of all POSIX special chars:
   - Space, tab, newline
   - Single and double quotes
   - Backslash, dollar sign, backtick
   - Ampersand, pipe, semicolon
   - Less than, greater than, question mark, asterisk
   - Square and curly brackets, parentheses
   - Hash (comment), tilde, exclamation

2. TestShellEscape_Unicode - verify Unicode handling:
   - Non-ASCII characters
   - Multi-byte UTF-8 sequences
   - Unicode control characters

3. TestSanitizeFunctionName_EdgeCases:
   - Empty string handling
   - String of only special chars
   - Very long names
   - Names starting with numbers
   - Names with consecutive special chars

4. Verify escaping produces shell-safe output that can be parsed by bash
  </action>
  <verify>`go test ./shell/... -v -run Shell` passes</verify>
  <done>Comprehensive edge case tests for shell escaping functions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test ./shell/... -v` passes
- [ ] `go build ./...` succeeds
- [ ] Security regression tests cover all shell injection vectors
- [ ] Edge cases for Unicode and special characters tested
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Shell escaping security is documented via tests
- Defense-in-depth for admin-controlled inputs verified
</success_criteria>

<output>
After completion, create `.planning/phases/134-input-sanitization/134-02-SUMMARY.md`
</output>
