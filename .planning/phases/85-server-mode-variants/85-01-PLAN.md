---
phase: 85-server-mode-variants
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [shell/shell.go, shell/shell_test.go, cli/shell_init.go, cli/shell_init_test.go]
autonomous: true
---

<objective>
Extend shell init to generate server-mode variants of shell wrapper functions.

Purpose: Enable users to get both standard functions (`sentinel-{profile}`) and server-mode functions (`sentinel-{profile}-server`) from a single `sentinel shell init` command.
Output: Updated shell package and CLI with `--include-server` flag support.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/84-shell-init-command/84-01-SUMMARY.md

@shell/shell.go
@cli/shell_init.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend GenerateScript for server mode variants</name>
  <files>shell/shell.go, shell/shell_test.go</files>
  <action>
1. Add `IncludeServer bool` field to a new `GenerateOptions` struct in shell/shell.go
2. Create `GenerateScriptWithOptions(profiles []ProfileInfo, policyRoot string, format ShellFormat, opts GenerateOptions) string` function
3. Keep existing `GenerateScript` as wrapper calling `GenerateScriptWithOptions` with default options (backward compatible)
4. When `IncludeServer` is true, generate additional functions with `-server` suffix that include `--server` flag:
   - Standard: `sentinel-production() { sentinel exec --profile production --policy-parameter /sentinel/policies/production -- "$@" }`
   - Server: `sentinel-production-server() { sentinel exec --server --profile production --policy-parameter /sentinel/policies/production -- "$@" }`
5. Add comment in generated script explaining server mode: `# -server variants use real-time revocation mode`
6. Add tests for new GenerateScriptWithOptions function:
   - Test IncludeServer=false generates only standard functions
   - Test IncludeServer=true generates both standard and -server functions
   - Test empty profiles with IncludeServer=true shows appropriate comment
  </action>
  <verify>go test -v ./shell/... passes with new tests; go build ./... succeeds</verify>
  <done>GenerateScriptWithOptions generates server-mode variants when IncludeServer=true; existing GenerateScript behavior unchanged</done>
</task>

<task type="auto">
  <name>Task 2: Add --include-server flag to shell init command</name>
  <files>cli/shell_init.go, cli/shell_init_test.go</files>
  <action>
1. Add `IncludeServer bool` field to `ShellInitCommandInput` struct
2. Add `--include-server` flag to `ConfigureShellInitCommand`:
   - Description: "Also generate -server variants for real-time revocation mode"
   - Default: false (backward compatible)
3. Update `ShellInitCommand` to pass `shell.GenerateOptions{IncludeServer: input.IncludeServer}` to `GenerateScriptWithOptions`
4. Update stderr summary when server variants included:
   - "Generated X shell function(s) for format: bash" becomes
   - "Generated X shell function(s) (Y with server mode) for format: bash"
5. Add tests for new flag:
   - Test --include-server=false generates only standard functions
   - Test --include-server=true generates both variants
  </action>
  <verify>go test -v ./cli/... -run ShellInit passes; gofmt -e cli/shell_init.go shows no errors</verify>
  <done>sentinel shell init --include-server generates both standard and server-mode shell functions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go build ./... succeeds
- [ ] go test -v ./shell/... passes (including new IncludeServer tests)
- [ ] gofmt -e cli/shell_init.go cli/shell_init_test.go shows no errors (CLI tests validated syntactically)
- [ ] Generated script includes -server variants when --include-server flag used
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Backward compatibility maintained (--include-server defaults to false)
- Server-mode variants correctly add --server flag to sentinel exec
</success_criteria>

<output>
After completion, create `.planning/phases/85-server-mode-variants/85-01-SUMMARY.md`
</output>
