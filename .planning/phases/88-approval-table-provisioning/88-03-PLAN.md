---
phase: 88-approval-table-provisioning
plan: 03
type: execute
wave: 3
depends_on: ["88-02"]
files_modified: [cli/init_approvals.go, cli/init_approvals_test.go, cli/sentinel.go]
autonomous: true
---

<objective>
Create CLI `sentinel init approvals` command for DynamoDB approval table provisioning.

Purpose: Provide user-facing command to create the sentinel-requests DynamoDB table with correct schema, GSIs, and TTL configuration. Supports --plan mode for preview and --generate-iam for IAM policy output.
Output: Working `sentinel init approvals` command integrated into CLI.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/88-approval-table-provisioning/88-02-SUMMARY.md

Existing CLI patterns:
@cli/bootstrap.go (init bootstrap command pattern with --plan, --yes flags)
@cli/sentinel.go (command registration with kingpin)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create init approvals CLI command</name>
  <files>cli/init_approvals.go</files>
  <action>
Create sentinel init approvals command following bootstrap.go patterns:

1. Command registration in configureInitApprovalsCommand():
   - Subcommand of "init": sentinel init approvals
   - Flags:
     --table string (default: "sentinel-requests") - table name
     --region string (required) - AWS region
     --aws-profile string - AWS profile for credentials
     --plan bool - show what would be created without creating
     --yes bool - skip confirmation prompt
     --generate-iam bool - output IAM policy for table access

2. initApprovalsCommand struct:
   - Table string
   - Region string
   - AWSProfile string
   - Plan bool
   - Yes bool
   - GenerateIAM bool

3. Run() method:
   a) Load AWS config using loadAWSConfig() helper (from bootstrap.go pattern)
   b) If --generate-iam:
      - Output IAM policy document for DynamoDB table access
      - Include: CreateTable, DescribeTable, UpdateTimeToLive
      - Include: Query, GetItem, PutItem, DeleteItem, UpdateItem for table and GSIs
      - Output as JSON to stdout
      - Return (don't create table)

   c) Create TableProvisioner with config
   d) Get ApprovalTableSchema with table name

   e) If --plan:
      - Call provisioner.Plan()
      - Print plan output showing table name, GSIs, TTL config
      - Print "No changes made (--plan mode)"
      - Return

   f) If not --yes:
      - Print what will be created
      - Prompt for confirmation (y/N)
      - If not confirmed, exit

   g) Call provisioner.Create()
   h) Print result (CREATED, EXISTS, or error)
   i) If successful, print suggestion to update ~/.aws/config or use --request-table flag

4. Helper: generateTableIAMPolicy(tableName, region, accountID string) string
   - Generate IAM policy JSON for DynamoDB operations
   - Use arn:aws:dynamodb:{region}:{account}:table/{tableName}
   - Include index ARNs: arn:aws:dynamodb:{region}:{account}:table/{tableName}/index/*

5. Output formatting:
   - Use consistent "Sentinel Init Approvals" header
   - Green checkmark for success, red X for failure (if terminal supports color)
   - Clear next-step suggestions

Follow existing CLI patterns: use GlobalFlags for common options, handle errors with actionable messages.
  </action>
  <verify>go build ./cli/... compiles without errors</verify>
  <done>sentinel init approvals command with --plan, --region, --aws-profile, --table, --yes, --generate-iam flags.</done>
</task>

<task type="auto">
  <name>Task 2: Register command and add tests</name>
  <files>cli/init_approvals_test.go, cli/sentinel.go</files>
  <action>
1. In cli/sentinel.go:
   - Add call to configureInitApprovalsCommand(initCmd) after configureBootstrapCommand
   - Follow existing command registration pattern

2. In cli/init_approvals_test.go:
   Create tests for command behavior (note: full integration tests may not run in CI due to CGO dependency, use gofmt validation):

   a) Test generateTableIAMPolicy():
      - Returns valid JSON
      - Contains correct table ARN
      - Contains correct index ARN pattern
      - Includes all required actions

   b) Test command flag parsing (if possible without CGO):
      - Default table name is "sentinel-requests"
      - Region is required
      - Flags parse correctly

   c) Test plan output formatting:
      - Mock provisioner
      - Verify plan mode doesn't call Create()
      - Verify output includes table name, GSIs

3. Document in test file:
   // Note: Full CLI integration tests require CGO (1password-sdk-go dependency).
   // These tests validate logic and formatting without full CLI execution.

Target >80% coverage on testable code paths.
  </action>
  <verify>go build ./cli/... succeeds; gofmt -l cli/init_approvals*.go shows no issues</verify>
  <done>Command registered in sentinel.go. Tests for IAM policy generation and formatting.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./cli/...` succeeds
- [ ] `go build ./...` succeeds (full build)
- [ ] `go test -v ./infrastructure/...` passes all tests
- [ ] No gofmt issues: `gofmt -l cli/init_approvals*.go infrastructure/`
- [ ] `./sentinel init approvals --help` shows all flags (if binary can be built)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- `sentinel init approvals --plan` shows preview
- `sentinel init approvals --generate-iam` outputs valid IAM policy
- Command follows existing CLI patterns (flags, output, error handling)
</success_criteria>

<output>
After completion, create `.planning/phases/88-approval-table-provisioning/88-03-SUMMARY.md`
</output>
