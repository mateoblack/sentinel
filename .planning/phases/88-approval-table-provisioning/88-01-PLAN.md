---
phase: 88-approval-table-provisioning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [infrastructure/schema.go, infrastructure/schema_test.go]
autonomous: true
---

<objective>
Create DynamoDB table schema types and validation for infrastructure provisioning.

Purpose: Define reusable schema types that represent DynamoDB table definitions (partition keys, sort keys, GSIs, TTL) for use by table creation and CLI commands. These types will be shared across all three init subcommands (approvals, breakglass, sessions).
Output: infrastructure/ package with TableSchema type, GSI definitions, validation, and predefined schemas for sentinel-requests table.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Existing patterns to follow:
@request/dynamodb.go (GSI naming: gsi-requester, gsi-status, gsi-profile)
@bootstrap/planner.go (existing bootstrap pattern for SSM)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create infrastructure package with schema types</name>
  <files>infrastructure/schema.go</files>
  <action>
Create new infrastructure/ package with DynamoDB schema types:

1. TableSchema struct:
   - TableName string
   - PartitionKey KeyAttribute (Name, Type)
   - SortKey *KeyAttribute (optional)
   - GlobalSecondaryIndexes []GSISchema
   - TTLAttribute string (attribute name for TTL)
   - BillingMode string (PAY_PER_REQUEST)

2. KeyAttribute struct:
   - Name string
   - Type string (S, N, B for String, Number, Binary)

3. GSISchema struct:
   - IndexName string
   - PartitionKey KeyAttribute
   - SortKey *KeyAttribute (optional)
   - Projection string (ALL, KEYS_ONLY, INCLUDE)

4. Validation methods:
   - TableSchema.Validate() error - validates all fields are set correctly
   - KeyAttribute.Validate() error - validates type is S, N, or B
   - GSISchema.Validate() error - validates index has valid keys

5. Predefined schema function:
   - ApprovalTableSchema(tableName string) TableSchema
   Returns schema matching request/dynamodb.go expectations:
   - Partition key: id (S)
   - GSIs: gsi-requester (requester/created_at), gsi-status (status/created_at), gsi-profile (profile/created_at)
   - TTL attribute: ttl
   - Billing: PAY_PER_REQUEST

Follow existing patterns: use string type aliases with IsValid() methods like policy/effect.go pattern.
  </action>
  <verify>go build ./infrastructure/... compiles without errors</verify>
  <done>TableSchema, KeyAttribute, GSISchema types defined with Validate() methods. ApprovalTableSchema() returns correct schema.</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive unit tests for schema types</name>
  <files>infrastructure/schema_test.go</files>
  <action>
Create comprehensive tests for schema validation:

1. Test KeyAttribute validation:
   - Valid types (S, N, B) pass
   - Invalid type fails with descriptive error
   - Empty name fails

2. Test GSISchema validation:
   - Valid GSI with partition key only passes
   - Valid GSI with partition + sort key passes
   - Invalid partition key type fails
   - Empty index name fails

3. Test TableSchema validation:
   - Complete schema passes
   - Missing table name fails
   - Missing partition key fails
   - Invalid partition key type fails
   - Invalid GSI fails (propagates GSI validation)
   - Empty TTL attribute allowed (optional)

4. Test ApprovalTableSchema():
   - Returns schema with correct table name
   - Has 3 GSIs with correct names (gsi-requester, gsi-status, gsi-profile)
   - Each GSI has correct partition/sort keys
   - TTL attribute is "ttl"
   - Billing mode is PAY_PER_REQUEST

Use table-driven tests for validation cases. Target >90% coverage on schema.go.
  </action>
  <verify>go test -v -cover ./infrastructure/... shows >90% coverage</verify>
  <done>All validation paths tested. ApprovalTableSchema returns expected schema.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./infrastructure/...` succeeds
- [ ] `go test -v ./infrastructure/...` passes all tests
- [ ] `go test -cover ./infrastructure/...` shows >90% coverage
- [ ] No gofmt issues: `gofmt -l infrastructure/`
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- TableSchema correctly models DynamoDB table structure
- ApprovalTableSchema matches request/dynamodb.go expectations
</success_criteria>

<output>
After completion, create `.planning/phases/88-approval-table-provisioning/88-01-SUMMARY.md`
</output>
