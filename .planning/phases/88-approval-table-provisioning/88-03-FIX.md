---
phase: 88-approval-table-provisioning
plan: 88-03-FIX
type: fix
wave: 1
depends_on: []
files_modified:
  - infrastructure/provisioner.go
  - infrastructure/provisioner_test.go
  - bootstrap/infrastructure.go
  - bootstrap/infrastructure_test.go
  - cli/bootstrap.go
  - cli/bootstrap_test.go
autonomous: true
---

<objective>
Fix 3 major UAT issues from v1.12 Infrastructure Provisioning.

Source: 88-03-ISSUES.md
Priority: 0 critical, 3 major, 0 minor

**Core problem:** The v1.12 commands assume users already have DynamoDB permissions, but the whole point of these commands is to help users SET UP that infrastructure. Users need to see plans and IAM policies BEFORE they have permissions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/88-approval-table-provisioning/88-03-ISSUES.md

**Key source files:**
@infrastructure/provisioner.go
@cli/bootstrap.go
@bootstrap/infrastructure.go
</context>

<tasks>
<task type="auto">
  <name>Task 1: Fix --plan flag to work without DynamoDB permissions (UAT-001)</name>
  <files>infrastructure/provisioner.go, infrastructure/provisioner_test.go</files>
  <action>
Modify the `Plan()` method in `infrastructure/provisioner.go` to NOT call `getTableStatus()`.

The --plan flag should show what WOULD be created without checking if the table exists. This is a true dry-run - it describes the schema, not the delta.

Changes to `Plan()` method (around line 210):
1. Remove the call to `getTableStatus()` at line 215
2. Always set `WouldCreate: true` (since we can't check)
3. Always populate GSIs, TTLAttribute, and BillingMode from the schema
4. Add a comment explaining this is intentional for permission-less dry-run

The method becomes:
```go
func (p *TableProvisioner) Plan(ctx context.Context, schema TableSchema) (*ProvisionPlan, error) {
    if err := schema.Validate(); err != nil {
        return nil, fmt.Errorf("invalid schema: %w", err)
    }

    // Plan shows what WOULD be created without checking table status.
    // This allows users to see the schema before they have DynamoDB permissions.
    plan := &ProvisionPlan{
        TableName:    schema.TableName,
        WouldCreate:  true, // Cannot check without permissions
        GSIs:         schema.GSINames(),
        TTLAttribute: schema.TTLAttribute,
    }

    if schema.BillingMode != "" {
        plan.BillingMode = string(schema.BillingMode)
    } else {
        plan.BillingMode = string(BillingModePayPerRequest)
    }

    return plan, nil
}
```

Update tests:
- Remove `TestTableProvisioner_Plan_DescribeTableError` (no longer relevant)
- Update existing Plan tests to not expect DescribeTable calls
- Add test: `TestTableProvisioner_Plan_NoAWSCalls` - verify Plan doesn't call any AWS APIs
  </action>
  <verify>Run `go fmt ./infrastructure/...` to verify syntax. Existing tests that don't rely on Plan calling DescribeTable should still pass conceptually.</verify>
  <done>Plan() method returns schema information without making any AWS API calls. Users can run `sentinel init approvals --plan` without DynamoDB permissions.</done>
</task>

<task type="auto">
  <name>Task 2: Fix init status --check-tables to handle access denied gracefully (UAT-002)</name>
  <files>bootstrap/infrastructure.go, bootstrap/infrastructure_test.go</files>
  <action>
Modify the `InfrastructureChecker.CheckTable()` method (or equivalent) to catch AccessDeniedException and return a special status instead of failing.

In `bootstrap/infrastructure.go`:
1. Find the method that calls DynamoDB DescribeTable for status checking
2. Add error handling for access denied errors:
   - Check if error contains "AccessDeniedException" or use errors.As for AWS error types
   - Return status "ACCESS_DENIED" instead of propagating error
3. Update `CheckAllTables()` or similar to continue checking other tables even if one fails

Error detection pattern (add to errors package if needed, or inline):
```go
func isAccessDenied(err error) bool {
    if err == nil {
        return false
    }
    // Check for common AWS access denied patterns
    errStr := err.Error()
    return strings.Contains(errStr, "AccessDeniedException") ||
           strings.Contains(errStr, "AccessDenied") ||
           strings.Contains(errStr, "not authorized to perform")
}
```

Update the table status check:
```go
func (c *InfrastructureChecker) CheckTable(ctx context.Context, tableName string) (string, error) {
    output, err := c.client.DescribeTable(ctx, &dynamodb.DescribeTableInput{
        TableName: aws.String(tableName),
    })
    if err != nil {
        var rnf *types.ResourceNotFoundException
        if errors.As(err, &rnf) {
            return "NOT_FOUND", nil
        }
        // Handle access denied gracefully
        if isAccessDenied(err) {
            return "ACCESS_DENIED", nil
        }
        return "", err
    }
    // ... rest of function
}
```

Add tests:
- `TestInfrastructureChecker_CheckTable_AccessDenied` - returns "ACCESS_DENIED" status
- `TestInfrastructureChecker_CheckAllTables_PartialAccessDenied` - continues checking other tables
  </action>
  <verify>Run `go fmt ./bootstrap/...` to verify syntax.</verify>
  <done>Status command with --check-tables shows "ACCESS_DENIED" for tables without permissions instead of crashing. Other information (SSM policies, suggestions) still displayed.</done>
</task>

<task type="auto">
  <name>Task 3: Fix --generate-iam-policies to include DynamoDB policies (UAT-003)</name>
  <files>cli/bootstrap.go, cli/bootstrap_test.go</files>
  <action>
The issue is that `--generate-iam-policies` only outputs policies in two scenarios:
1. When `--plan` flag is also set (lines 224-226)
2. After successful execution (line 315-317)

If user runs without `--plan` and then cancels at confirmation, policies are never shown.

Fix: Make `--generate-iam-policies` an info-only operation that outputs policies and exits early, similar to how `--generate-iam` works on individual init commands.

In `cli/bootstrap.go`, add early exit for `--generate-iam-policies` after loading config but BEFORE the plan/execute logic:

```go
// After loading config (around line 175), add:

// If only generating IAM policies, output and exit early
if input.GenerateIAMPolicies && !input.PlanOnly {
    if !input.JSONOutput {
        outputCombinedIAMPolicies(stdout, input)
    } else {
        // JSON output for IAM policies
        policies := generateCombinedIAMPolicies(input)
        // Marshal and output as JSON
    }
    return nil
}
```

This means:
- `--generate-iam-policies` alone: outputs policies and exits
- `--generate-iam-policies --plan`: outputs plan AND policies (existing behavior)
- `--generate-iam-policies` during execution: still outputs after execution (existing behavior)

Alternative simpler fix: Output IAM policies after cancellation too. At line 255 (after "Cancelled."), add:
```go
if input.GenerateIAMPolicies && !input.JSONOutput {
    outputCombinedIAMPolicies(stdout, input)
}
```

Choose the simpler fix (output after cancellation) as it's less disruptive and still solves the user's problem.

Add test:
- `TestBootstrapCommand_GenerateIAMPolicies_ShowsAfterCancel` - verifies DynamoDB policies appear in output even when user cancels
  </action>
  <verify>Run `go fmt ./cli/...` to verify syntax.</verify>
  <done>Running `sentinel init bootstrap --profile dev --with-approvals --generate-iam-policies --region us-east-1` and cancelling at confirmation still shows the DynamoDB IAM policies.</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] All three tasks completed
- [ ] `go fmt` passes on all modified packages
- [ ] No syntax errors introduced
- [ ] Tests added for each fix
</verification>

<success_criteria>
- UAT-001: `sentinel init approvals --plan` works without DynamoDB permissions
- UAT-002: `sentinel init status --check-tables` shows "ACCESS_DENIED" instead of crashing
- UAT-003: `--generate-iam-policies` with `--with-*` flags outputs DynamoDB policies
- All fixes include test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/88-approval-table-provisioning/88-03-FIX-SUMMARY.md`
</output>
