---
phase: 57-performance-load-testing
plan: 03
type: execute
wave: 2
depends_on: ["57-01", "57-02"]
files_modified: [testutil/load_test.go, sentinel/load_test.go]
autonomous: true
---

<objective>
Create load simulation tests that exercise the full credential issuance path under sustained load.

Purpose: Verify system behavior under realistic production-like load patterns and identify bottlenecks.
Output: Load tests with configurable request rates, duration, and success rate metrics.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/57-performance-load-testing/57-01-SUMMARY.md
@.planning/phases/57-performance-load-testing/57-02-SUMMARY.md

@sentinel/provider.go
@policy/evaluate.go
@policy/cache.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create load test infrastructure</name>
  <files>testutil/load_test.go</files>
  <action>
Create reusable load testing infrastructure:

1. LoadTestConfig struct:
   - RequestsPerSecond int
   - Duration time.Duration
   - Workers int
   - Timeout time.Duration

2. LoadTestResult struct:
   - TotalRequests int
   - SuccessCount int
   - ErrorCount int
   - LatencyP50, P95, P99 time.Duration
   - Throughput float64 (requests/sec)

3. RunLoadTest function:
   - Takes config and request function
   - Uses rate limiter (golang.org/x/time/rate already in go.mod)
   - Spawns worker goroutines
   - Collects latency samples
   - Returns LoadTestResult

4. Helper functions:
   - calculatePercentile(samples []time.Duration, p float64) time.Duration
   - formatLoadTestResult(result LoadTestResult) string

Use channels for work distribution and result collection.
Ensure graceful shutdown on context cancellation.

Note: This is test infrastructure, not production code. Put in testutil package.
  </action>
  <verify>go build ./testutil/... compiles without errors</verify>
  <done>Load test infrastructure compiles and is ready for use</done>
</task>

<task type="auto">
  <name>Task 2: Create credential flow load tests</name>
  <files>sentinel/load_test.go</files>
  <action>
Create load tests for the credential issuance path:

1. TestLoad_PolicyEvaluation - sustained policy evaluation at 1000 req/sec
   - Uses mock policy loader (no SSM calls)
   - Runs for 10 seconds
   - Verifies >99% success rate
   - Logs P50, P95, P99 latencies

2. TestLoad_CachedPolicyEvaluation - cache hit path under load
   - Pre-warm cache with policy
   - 1000 req/sec for 10 seconds
   - Verify cache hit ratio near 100%

3. TestLoad_IdentityGeneration - request ID generation under load
   - Tests crypto/rand throughput
   - 5000 req/sec for 5 seconds
   - Verify no ID collisions

4. TestLoad_MixedWorkload - realistic mixed operations
   - 80% policy evaluation (allow)
   - 15% policy evaluation (deny)
   - 5% cache miss (new profile)
   - 500 req/sec for 30 seconds

Use t.Skip() to skip load tests by default (they take time).
Enable with build tag: //go:build loadtest
Run with: go test -tags=loadtest -v ./sentinel/...

Log results with t.Logf() for review.
Assert minimum thresholds:
- P99 latency < 10ms for policy evaluation
- Throughput > 800 req/sec achieved
  </action>
  <verify>go test -tags=loadtest -v -run=TestLoad ./sentinel/... runs load tests and reports metrics</verify>
  <done>Load tests run, report latency percentiles, and verify throughput thresholds</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go build ./testutil/... succeeds
- [ ] go test -tags=loadtest -v -run=TestLoad ./sentinel/... runs and passes
- [ ] Load test results show P50, P95, P99 latencies
- [ ] Throughput metrics reported
- [ ] No test failures introduced
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Load test infrastructure is reusable
- Credential flow handles 1000 req/sec without degradation
- Latency metrics within acceptable bounds
  </success_criteria>

<output>
After completion, create `.planning/phases/57-performance-load-testing/57-03-SUMMARY.md`
</output>
