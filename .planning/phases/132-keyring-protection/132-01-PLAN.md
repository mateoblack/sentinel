---
phase: 132-keyring-protection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vault/credentialkeyring.go
  - vault/sessionkeyring.go
  - vault/oidctokenkeyring.go
  - cli/global.go
  - cli/sentinel.go
autonomous: true
---

<objective>
Harden keyring storage security with platform-specific access controls to prevent credential theft by other local processes.

Purpose: Credentials stored in system keyring should only be accessible by the application that created them, not by other applications or when the device is locked.
Output: Hardened keyring configuration with access controls for macOS Keychain, Linux keyctl, and Windows Credential Manager.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior security work
@.planning/phases/129-local-server-security/129-01-SUMMARY.md

# Existing keyring code
@vault/credentialkeyring.go
@vault/sessionkeyring.go
@vault/oidctokenkeyring.go
@cli/global.go
@cli/sentinel.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden macOS Keychain settings in keyring config</name>
  <files>cli/global.go, cli/sentinel.go</files>
  <action>
Update keyringConfigDefaults and sentinelKeyringConfigDefaults in both files:

1. Set KeychainAccessibleWhenUnlocked: false (credentials inaccessible when device locked)
2. Set KeychainSynchronizable: false (prevent iCloud sync of credentials)
3. Keep KeychainTrustApplication: true (allows app to access its own items)

Add comment explaining each security setting:
```go
var keyringConfigDefaults = keyring.Config{
    ServiceName:              "aws-vault",
    // ... existing fields ...

    // macOS Keychain security hardening:
    // - TrustApplication: allows this app to access items it created
    // - AccessibleWhenUnlocked: false = credentials unavailable when device locked
    // - Synchronizable: false = prevent credential sync to iCloud
    KeychainTrustApplication:       true,
    KeychainAccessibleWhenUnlocked: false,
    KeychainSynchronizable:         false,
    // ... rest of config ...
}
```

The KeychainAccessibleWhenUnlocked: false setting ensures credentials are only accessible when the user has unlocked their Mac, preventing access during sleep/screensaver.

Note: The keyring library defaults KeychainAccessibleWhenUnlocked to false already, so this makes it explicit. KeychainSynchronizable defaults vary, so we explicitly disable it.
  </action>
  <verify>go build ./... passes with no errors</verify>
  <done>macOS Keychain security settings explicitly configured with comments explaining each setting</done>
</task>

<task type="auto">
  <name>Task 2: Add KeychainNotTrustApplication to all keyring items</name>
  <files>vault/credentialkeyring.go, vault/sessionkeyring.go, vault/oidctokenkeyring.go</files>
  <action>
Ensure ALL keyring items are stored with KeychainNotTrustApplication: true to prevent other applications from being added to the ACL.

1. CredentialKeyring.Set already has this - verify and add comment
2. SessionKeyring.Set - add KeychainNotTrustApplication: true
3. OIDCTokenKeyring.Set - add KeychainNotTrustApplication: true

For each Set method, update the keyring.Item to include:
```go
return sk.Keyring.Set(keyring.Item{
    Key:         key.String(),
    Data:        valJSON,
    Label:       fmt.Sprintf("..."),
    Description: "...",

    // macOS Keychain: prevent other applications from accessing this item
    // without explicit user approval
    KeychainNotTrustApplication: true,
})
```

Also add KeychainNotSynchronizable: true to explicitly prevent iCloud sync at the item level (defense in depth with config-level setting).

IMPORTANT: The Item-level settings override config defaults, providing defense in depth.
  </action>
  <verify>go build ./... passes; grep -r "KeychainNotTrustApplication" vault/ shows all three keyring files have this setting</verify>
  <done>All keyring item storage operations include KeychainNotTrustApplication: true and KeychainNotSynchronizable: true</done>
</task>

<task type="auto">
  <name>Task 3: Add Linux keyctl permission restrictions</name>
  <files>cli/global.go, cli/sentinel.go</files>
  <action>
Add Linux kernel keyring permissions to restrict access to the current user only.

Update keyringConfigDefaults:
```go
var keyringConfigDefaults = keyring.Config{
    // ... existing fields ...

    // Linux kernel keyring security:
    // - KeyCtlScope: "user" = keys visible only to current user's keyring
    // - KeyCtlPerm: restrict to possessor permissions only (view, read, write, search, link)
    //   Formula: (possessor << 24) with all permissions (0x3f)
    //   This prevents other users and group members from accessing keys
    KeyCtlScope: "user",
    KeyCtlPerm:  keyring.KEYCTL_PERM_ALL << 24, // 0x3f000000 = possessor-only permissions
}
```

The permission mask 0x3f000000 sets:
- Possessor: all permissions (bits 24-29)
- User: no permissions (bits 16-21)
- Group: no permissions (bits 8-13)
- Other: no permissions (bits 0-5)

This ensures only the process that created the key (and child processes) can access it, not other processes running as the same user.

Note: This only affects the "keyctl" backend. Other Linux backends (secret-service, pass) have their own access controls.
  </action>
  <verify>go build ./... passes with no errors</verify>
  <done>Linux keyctl backend configured with possessor-only permissions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds without errors
- [ ] `go test ./vault/...` passes all tests
- [ ] grep confirms KeychainNotTrustApplication in all three vault/*keyring.go files
- [ ] grep confirms KeyCtlPerm in cli/global.go and cli/sentinel.go
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- macOS Keychain items protected with:
  - KeychainNotTrustApplication: true (per-item)
  - KeychainNotSynchronizable: true (per-item)
  - KeychainAccessibleWhenUnlocked: false (config)
  - KeychainSynchronizable: false (config)
- Linux keyctl items protected with possessor-only permissions
- No regressions in existing keyring functionality
</success_criteria>

<output>
After completion, create `.planning/phases/132-keyring-protection/132-01-SUMMARY.md`
</output>
