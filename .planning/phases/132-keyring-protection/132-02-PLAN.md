---
phase: 132-keyring-protection
plan: 02
type: execute
wave: 2
depends_on: ["132-01"]
files_modified:
  - vault/keyring_security_test.go
autonomous: true
---

<objective>
Add security regression tests validating keyring storage protection properties.

Purpose: Ensure keyring security settings are correctly applied and cannot be accidentally removed in future changes.
Output: Security regression tests verifying keyring item protection properties.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior security test patterns
@.planning/phases/131-dynamodb-security/131-02-SUMMARY.md

# Source files being tested
@vault/credentialkeyring.go
@vault/sessionkeyring.go
@vault/oidctokenkeyring.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create keyring security regression tests</name>
  <files>vault/keyring_security_test.go</files>
  <action>
Create a new test file vault/keyring_security_test.go with security regression tests following the TestSecurityRegression_* naming convention established in Phase 131.

```go
package vault

import (
    "testing"

    "github.com/byteness/keyring"
)

// TestSecurityRegression_CredentialKeyring_NotTrustApplication verifies that
// credential storage prevents other applications from being trusted.
// THREAT: Malicious applications could be added to keychain ACL to steal credentials
func TestSecurityRegression_CredentialKeyring_NotTrustApplication(t *testing.T) {
    // Create a mock keyring that captures the Item passed to Set
    var capturedItem keyring.Item
    mockKeyring := &mockKeyringCapture{
        captureSet: func(item keyring.Item) error {
            capturedItem = item
            return nil
        },
    }

    ck := &CredentialKeyring{Keyring: mockKeyring}

    // Store a credential
    err := ck.Set("test-profile", aws.Credentials{
        AccessKeyID:     "AKIAIOSFODNN7EXAMPLE",
        SecretAccessKey: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
    })
    if err != nil {
        t.Fatalf("Set failed: %v", err)
    }

    // SECURITY CHECK: KeychainNotTrustApplication must be true
    if !capturedItem.KeychainNotTrustApplication {
        t.Error("SECURITY VIOLATION: CredentialKeyring.Set must set KeychainNotTrustApplication: true")
    }
}

// TestSecurityRegression_SessionKeyring_NotTrustApplication verifies that
// session storage prevents other applications from being trusted.
func TestSecurityRegression_SessionKeyring_NotTrustApplication(t *testing.T) {
    // Similar test for SessionKeyring
}

// TestSecurityRegression_OIDCTokenKeyring_NotTrustApplication verifies that
// OIDC token storage prevents other applications from being trusted.
func TestSecurityRegression_OIDCTokenKeyring_NotTrustApplication(t *testing.T) {
    // Similar test for OIDCTokenKeyring
}

// TestSecurityRegression_Keyring_NoiCloudSync verifies that
// all keyring items prevent iCloud synchronization.
// THREAT: Credentials synced to iCloud could be compromised via Apple account breach
func TestSecurityRegression_Keyring_NoiCloudSync(t *testing.T) {
    // Test all three keyrings for KeychainNotSynchronizable: true
}
```

Implementation notes:
1. Create a mockKeyringCapture type that implements keyring.Keyring interface
2. Capture the Item passed to Set() and verify security properties
3. Each test should have a clear THREAT comment explaining what attack it prevents
4. Follow the pattern from session/dynamodb_security_test.go for consistency
  </action>
  <verify>go test -v ./vault/... -run TestSecurityRegression_ passes all tests</verify>
  <done>Security regression tests verify KeychainNotTrustApplication and KeychainNotSynchronizable are set</done>
</task>

<task type="auto">
  <name>Task 2: Add config-level security tests</name>
  <files>vault/keyring_security_test.go</files>
  <action>
Add tests verifying the global keyring config defaults include security settings.

Add to vault/keyring_security_test.go:

```go
// TestSecurityRegression_KeyringConfig_MacOSHardening verifies that
// keyring config includes macOS Keychain security hardening.
// THREAT: Credentials accessible when device locked or synced to iCloud
func TestSecurityRegression_KeyringConfig_MacOSHardening(t *testing.T) {
    // Import the config from cli package is not ideal for unit tests
    // Instead, document the expected values and test via integration

    // This test verifies our understanding of secure defaults
    t.Run("KeychainAccessibleWhenUnlocked_should_be_false", func(t *testing.T) {
        // When false, credentials require device to be unlocked
        // This prevents access during sleep/screensaver/locked states
        // Verify this is documented in keyring config comments
    })

    t.Run("KeychainSynchronizable_should_be_false", func(t *testing.T) {
        // When false, credentials are not synced to iCloud
        // This prevents credential exposure via Apple account compromise
        // Verify this is documented in keyring config comments
    })
}

// TestSecurityRegression_KeyringConfig_LinuxHardening verifies that
// keyring config includes Linux keyctl security hardening.
// THREAT: Other processes running as same user could access keys
func TestSecurityRegression_KeyringConfig_LinuxHardening(t *testing.T) {
    // Document expected KeyCtlPerm value: 0x3f000000 (possessor-only)
    expectedPerm := uint32(keyring.KEYCTL_PERM_ALL << 24)
    if expectedPerm != 0x3f000000 {
        t.Errorf("Expected KeyCtlPerm 0x3f000000, formula gives %#x", expectedPerm)
    }
}
```

These tests serve as documentation of security requirements and will catch if the keyring library changes permission constants.
  </action>
  <verify>go test -v ./vault/... -run TestSecurityRegression_ passes all tests</verify>
  <done>Config-level security tests verify expected hardening values</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test -v ./vault/... -run TestSecurityRegression_` passes all tests
- [ ] `go test ./vault/...` passes all existing tests (no regressions)
- [ ] Test file follows TestSecurityRegression_* naming convention
- [ ] Each test has THREAT comment explaining attack vector
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Security regression tests cover:
  - CredentialKeyring: KeychainNotTrustApplication
  - SessionKeyring: KeychainNotTrustApplication
  - OIDCTokenKeyring: KeychainNotTrustApplication
  - All keyrings: KeychainNotSynchronizable
  - Config: KeychainAccessibleWhenUnlocked, KeychainSynchronizable, KeyCtlPerm
- Tests follow established security test patterns
</success_criteria>

<output>
After completion, create `.planning/phases/132-keyring-protection/132-02-SUMMARY.md`
</output>
