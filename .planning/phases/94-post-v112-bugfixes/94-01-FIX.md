---
phase: 94-post-v112-bugfixes
plan: 94-01-FIX
type: fix
wave: 1
depends_on: []
files_modified:
  - request/dynamodb.go
  - request/dynamodb_test.go
  - cli/request.go
  - cli/request_test.go
autonomous: true
---

<objective>
Fix 2 UAT issues discovered during post-v1.12 testing.

Source: 94-01-ISSUES.md
Priority: 0 critical, 1 major, 1 minor

**Issues:**
1. DynamoDB reserved keyword bug blocks `sentinel list --status pending`
2. Missing `--aws-profile` on request command breaks SSO users
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/94-post-v112-bugfixes/94-01-ISSUES.md

**Key source files:**
@request/dynamodb.go
@breakglass/dynamodb.go (reference for fix pattern)
@cli/request.go
@cli/approve.go (reference for --aws-profile pattern)
</context>

<tasks>
<task type="auto">
  <name>Task 1: Fix DynamoDB reserved keyword in queryByIndex (UAT-001)</name>
  <files>request/dynamodb.go, request/dynamodb_test.go</files>
  <action>
Modify `queryByIndex` in `request/dynamodb.go` to use expression attribute names for the partition key, matching the pattern in `breakglass/dynamodb.go` lines 334-338.

**Current code (line 310):**
```go
KeyConditionExpression: aws.String(fmt.Sprintf("%s = :v", keyAttr)),
```

**Fixed code:**
```go
// Use expression attribute names for reserved words (e.g., "status")
keyCondition := "#pk = :v"
exprAttrNames := map[string]string{
    "#pk": keyAttr,
}

output, err := s.client.Query(ctx, &dynamodb.QueryInput{
    TableName:                 aws.String(s.tableName),
    IndexName:                 aws.String(indexName),
    KeyConditionExpression:    aws.String(keyCondition),
    ExpressionAttributeNames:  exprAttrNames,
    ExpressionAttributeValues: map[string]types.AttributeValue{
        ":v": &types.AttributeValueMemberS{Value: keyValue},
    },
    ScanIndexForward: aws.Bool(false),
    Limit:            aws.Int32(int32(effectiveLimit)),
})
```

**Why this works:** `#pk` is a placeholder that DynamoDB substitutes with the actual attribute name from `ExpressionAttributeNames`. This avoids the reserved keyword conflict.

**Tests:** Update existing tests to verify:
- `ListByStatus("pending", 10)` succeeds with mock that previously failed on raw "status"
- `ListByRequester` and `ListByProfile` still work (they didn't have the issue but verify no regression)
  </action>
  <verify>Run `gofmt -e request/dynamodb.go` to verify syntax. The fix pattern matches breakglass/dynamodb.go.</verify>
  <done>queryByIndex uses expression attribute names. `sentinel list --status pending` would work (reserved keyword no longer causes error).</done>
</task>

<task type="auto">
  <name>Task 2: Add --aws-profile flag to request command (UAT-002)</name>
  <files>cli/request.go, cli/request_test.go</files>
  <action>
Add `--aws-profile` flag to the request command following the pattern from approve.go.

**1. Add field to RequestCommandInput struct:**
```go
type RequestCommandInput struct {
    ProfileName   string
    Duration      time.Duration
    Justification string
    RequestTable  string
    Region        string
    AWSProfile    string // Optional AWS profile for credentials (SSO users)

    // ... existing optional fields
}
```

**2. Add flag in ConfigureRequestCommand (after --region flag):**
```go
cmd.Flag("aws-profile", "AWS profile for credentials (optional, uses --profile if not specified)").
    StringVar(&input.AWSProfile)
```

**3. Update RequestCommand to use AWSProfile for credentials:**

Change the AWS config loading section (around lines 107-114):
```go
// 3. Load AWS config (needed for STS and DynamoDB)
awsCfgOpts := []func(*config.LoadOptions) error{}

// Use --aws-profile for credentials if specified, otherwise use --profile
credentialProfile := input.AWSProfile
if credentialProfile == "" {
    credentialProfile = input.ProfileName
}
awsCfgOpts = append(awsCfgOpts, config.WithSharedConfigProfile(credentialProfile))

if input.Region != "" {
    awsCfgOpts = append(awsCfgOpts, config.WithRegion(input.Region))
}
awsCfg, err := config.LoadDefaultConfig(ctx, awsCfgOpts...)
```

**4. Add test:**
- `TestRequestCommand_WithAWSProfile` - verifies separate --aws-profile works for credential loading
  </action>
  <verify>Run `gofmt -e cli/request.go` to verify syntax.</verify>
  <done>request command has --aws-profile flag. SSO users can use `sentinel request --profile prod --aws-profile sso-profile ...` to specify separate credentials.</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `gofmt -e` passes on all modified files
- [ ] No syntax errors introduced
- [ ] queryByIndex uses ExpressionAttributeNames pattern
- [ ] request command has --aws-profile flag
</verification>

<success_criteria>
- UAT-001: queryByIndex uses expression attribute names to avoid reserved keyword conflicts
- UAT-002: request command has --aws-profile flag matching other approval commands
- Both fixes maintain backward compatibility
</success_criteria>

<output>
After completion, create `.planning/phases/94-post-v112-bugfixes/94-01-FIX-SUMMARY.md`
</output>
