---
phase: 94-require-server-session
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [policy/types.go, policy/evaluate.go, policy/evaluate_test.go]
autonomous: true
---

<objective>
Add `require_server_session` policy effect to enforce server mode with session tracking.

Purpose: Enable organizations to mandate session tracking via policy, ensuring all credentials are trackable and revocable.
Output: New policy effect type with evaluation logic.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/milestones/v1.13-ROADMAP.md

@policy/types.go
@policy/evaluate.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add EffectRequireServerSession to policy schema</name>
  <files>policy/types.go</files>
  <action>
Add new effect constant after EffectRequireServer:

```go
// EffectRequireServerSession allows access only when credentials are requested via server mode
// WITH session tracking enabled. If either condition is not met, access is denied with a clear
// error indicating server mode with session tracking is required.
EffectRequireServerSession Effect = "require_server_session"
```

Add `SessionTable` field to `Rule` struct to allow policy to specify session table:

```go
// SessionTable specifies the DynamoDB table name for session tracking when
// using require_server_session effect. If empty, uses the --session-table CLI flag.
SessionTable string `yaml:"session_table,omitempty"`
```

Update `Effect.IsValid()` to include the new effect.
  </action>
  <verify>gofmt -e policy/types.go shows no errors</verify>
  <done>New effect constant and SessionTable field added to schema</done>
</task>

<task type="auto">
  <name>Task 2: Update policy evaluation for require_server_session</name>
  <files>policy/evaluate.go</files>
  <action>
Add `RequiresSessionTracking` boolean field to `Decision` struct (similar to RequiresServerMode).

Update the Evaluate function to handle EffectRequireServerSession:
- If effect is require_server_session:
  - Check if mode is ModeServer AND session table name is provided (via new Request field)
  - If both true: convert to EffectAllow
  - If mode is not server: set RequiresServerMode=true, RequiresSessionTracking=true, effect=EffectDeny
  - If mode is server but no session table: set RequiresSessionTracking=true (but not RequiresServerMode), effect=EffectDeny

Add `SessionTableName` field to `Request` struct to track whether session tracking is enabled.

Pattern follows existing EffectRequireServer handling at lines 64-74.
  </action>
  <verify>gofmt -e policy/evaluate.go shows no errors</verify>
  <done>Policy evaluation handles require_server_session effect correctly</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for require_server_session evaluation</name>
  <files>policy/evaluate_test.go</files>
  <action>
Add test function `TestEvaluate_RequireServerSession` with cases:

1. require_server_session + server mode + session table = ALLOW
2. require_server_session + server mode + NO session table = DENY (RequiresSessionTracking=true)
3. require_server_session + cli mode + session table = DENY (RequiresServerMode=true, RequiresSessionTracking=true)
4. require_server_session + cli mode + NO session table = DENY (both flags true)
5. require_server_session + credential_process mode = DENY

Follow existing TestEvaluate_RequireServer pattern for structure.
  </action>
  <verify>gofmt -e policy/evaluate_test.go shows no errors</verify>
  <done>Comprehensive tests for require_server_session evaluation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] gofmt -e passes on all modified files
- [ ] New effect constant EffectRequireServerSession exists
- [ ] SessionTable field added to Rule struct
- [ ] Decision has RequiresSessionTracking field
- [ ] Request has SessionTableName field
- [ ] Evaluation logic handles all mode/session combinations
</verification>

<success_criteria>
- All tasks completed
- Policy schema supports require_server_session effect
- Evaluation produces correct decisions for all mode/session combinations
- Tests cover all evaluation paths
</success_criteria>

<output>
After completion, create `.planning/phases/94-require-server-session/94-01-SUMMARY.md`
</output>
