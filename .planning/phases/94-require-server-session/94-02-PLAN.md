---
phase: 94-require-server-session
plan: 02
type: execute
wave: 2
depends_on: ["94-01"]
files_modified: [cli/sentinel_exec.go, cli/credentials.go, cli/sentinel_exec_test.go, cli/credentials_test.go]
autonomous: true
---

<objective>
Wire require_server_session enforcement into CLI commands with actionable error messages.

Purpose: Users get clear guidance when policy requires server mode with session tracking.
Output: CLI commands enforce require_server_session and provide helpful error messages.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/94-require-server-session/94-01-SUMMARY.md

@cli/sentinel_exec.go
@cli/credentials.go
@policy/evaluate.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pass session table name to policy Request in exec command</name>
  <files>cli/sentinel_exec.go</files>
  <action>
When creating the policy.Request for evaluation, populate SessionTableName from input.SessionTableName:

```go
policyReq := &policy.Request{
    User:             username,
    Profile:          input.ProfileName,
    Time:             time.Now(),
    Mode:             credMode,
    SessionTableName: input.SessionTableName, // Add this line
}
```

After policy evaluation, check for RequiresSessionTracking in the decision:
- If decision.RequiresSessionTracking && decision.RequiresServerMode:
  - Error: "Policy requires server mode with session tracking. Use: sentinel exec --server --session-table <table> --profile X -- <cmd>"
- If decision.RequiresSessionTracking && !decision.RequiresServerMode:
  - Error: "Policy requires session tracking. Add --session-table <table> flag."
- If decision.RequiresServerMode && !decision.RequiresSessionTracking:
  - Keep existing error: "Policy requires server mode. Add --server flag."

Pattern follows existing RequiresServerMode handling.
  </action>
  <verify>gofmt -e cli/sentinel_exec.go shows no errors</verify>
  <done>Exec command passes session table name and produces actionable errors</done>
</task>

<task type="auto">
  <name>Task 2: Pass session table name to policy Request in credentials command</name>
  <files>cli/credentials.go</files>
  <action>
The credentials command doesn't support server mode, so require_server_session will always deny.

When creating the policy.Request, populate SessionTableName as empty string (credentials command doesn't support session tracking):

```go
policyReq := &policy.Request{
    User:             username,
    Profile:          input.ProfileName,
    Time:             time.Now(),
    Mode:             policy.ModeCredentialProcess,
    SessionTableName: "", // credentials command doesn't support session tracking
}
```

After policy evaluation, check for RequiresSessionTracking in the decision:
- If decision.RequiresSessionTracking:
  - Error: "Policy requires server mode with session tracking. credential_process doesn't support session tracking. Use: sentinel exec --server --session-table <table> --profile X -- <cmd>"

This guides users from credential_process to exec --server.
  </action>
  <verify>gofmt -e cli/credentials.go shows no errors</verify>
  <done>Credentials command produces actionable error for require_server_session</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for require_server_session CLI enforcement</name>
  <files>cli/sentinel_exec_test.go, cli/credentials_test.go</files>
  <action>
Add test cases for exec command:

1. TestSentinelExec_RequireServerSession_ServerWithTable - should succeed
2. TestSentinelExec_RequireServerSession_ServerWithoutTable - should fail with session tracking error
3. TestSentinelExec_RequireServerSession_CLIModeWithTable - should fail with server mode + session tracking error
4. TestSentinelExec_RequireServerSession_CLIModeWithoutTable - should fail with combined error

Add test cases for credentials command:

1. TestCredentials_RequireServerSession - should fail with guidance to use exec --server

Use existing mock patterns from credentials_test.go and sentinel_exec_test.go.
Create test policies with effect: require_server_session.
  </action>
  <verify>gofmt -e cli/sentinel_exec_test.go cli/credentials_test.go shows no errors</verify>
  <done>CLI enforcement tests cover all require_server_session scenarios</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] gofmt -e passes on all modified files
- [ ] Exec command passes SessionTableName to policy evaluation
- [ ] Exec command produces distinct errors for missing server vs missing session table
- [ ] Credentials command guides users to exec --server
- [ ] Tests verify all error scenarios
</verification>

<success_criteria>
- All tasks completed
- CLI commands enforce require_server_session effect
- Error messages guide users to correct flags
- Tests cover all enforcement paths
</success_criteria>

<output>
After completion, create `.planning/phases/94-require-server-session/94-02-SUMMARY.md`
</output>
