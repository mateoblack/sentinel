---
phase: 114-secrets-manager-migration
plan: 02
type: execute
wave: 2
depends_on: ["114-01"]
files_modified: [terraform/sentinel-tvm/variables.tf, terraform/sentinel-tvm/main.tf, terraform/sentinel-tvm/iam.tf, docs/LAMBDA_TVM_DEPLOYMENT.md]
autonomous: true
---

<objective>
Update Terraform module and documentation for Secrets Manager integration.

Purpose: Infrastructure needs to support the new Secrets Manager pattern with proper IAM permissions and the new environment variable.

Output: Terraform module supports SENTINEL_MDM_API_SECRET_ID variable and grants Lambda read access to the secret.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/114-secrets-manager-migration/114-01-PLAN.md

@terraform/sentinel-tvm/variables.tf
@terraform/sentinel-tvm/main.tf
@terraform/sentinel-tvm/iam.tf
@docs/LAMBDA_TVM_DEPLOYMENT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MDM variables to Terraform</name>
  <files>terraform/sentinel-tvm/variables.tf</files>
  <action>
Add new variables for MDM configuration including Secrets Manager secret ARN:

```hcl
# MDM Configuration
variable "mdm_provider" {
  description = "MDM provider type: 'jamf', 'intune', 'kandji', or '' (disabled)"
  type        = string
  default     = ""
}

variable "mdm_base_url" {
  description = "Base URL for the MDM API (e.g., https://company.jamfcloud.com)"
  type        = string
  default     = ""
}

variable "mdm_api_secret_arn" {
  description = "ARN of the Secrets Manager secret containing the MDM API token. Recommended over mdm_api_token."
  type        = string
  default     = ""
}

variable "mdm_api_token" {
  description = "DEPRECATED: Use mdm_api_secret_arn instead. MDM API bearer token passed via environment variable."
  type        = string
  default     = ""
  sensitive   = true
}

variable "require_device_posture" {
  description = "When true, reject credentials if device posture verification fails"
  type        = bool
  default     = false
}
```
  </action>
  <verify>terraform fmt -check terraform/sentinel-tvm/variables.tf exits 0 OR terraform fmt terraform/sentinel-tvm/variables.tf formats successfully</verify>
  <done>variables.tf has mdm_provider, mdm_base_url, mdm_api_secret_arn, mdm_api_token (deprecated), and require_device_posture variables</done>
</task>

<task type="auto">
  <name>Task 2: Update Lambda environment variables in Terraform</name>
  <files>terraform/sentinel-tvm/main.tf</files>
  <action>
Update the locals block environment_variables to include MDM configuration:

Add these conditional merges to the existing environment_variables local:

```hcl
# MDM Provider Configuration
var.mdm_provider != "" ? {
  SENTINEL_MDM_PROVIDER = var.mdm_provider
} : {},
var.mdm_base_url != "" ? {
  SENTINEL_MDM_BASE_URL = var.mdm_base_url
} : {},
# Use Secrets Manager (preferred) or env var (deprecated) for MDM API token
var.mdm_api_secret_arn != "" ? {
  SENTINEL_MDM_API_SECRET_ID = var.mdm_api_secret_arn
} : var.mdm_api_token != "" ? {
  SENTINEL_MDM_API_TOKEN = var.mdm_api_token
} : {},
var.require_device_posture ? {
  SENTINEL_REQUIRE_DEVICE = "true"
} : {},
```

This ensures:
- If mdm_api_secret_arn is set, use SENTINEL_MDM_API_SECRET_ID (recommended)
- If only mdm_api_token is set, use SENTINEL_MDM_API_TOKEN (deprecated but supported)
- If neither set, no MDM token env var
  </action>
  <verify>terraform fmt -check terraform/sentinel-tvm/main.tf exits 0 OR terraform fmt terraform/sentinel-tvm/main.tf formats successfully</verify>
  <done>Lambda environment variables include MDM configuration with Secrets Manager support</done>
</task>

<task type="auto">
  <name>Task 3: Add Secrets Manager IAM permissions</name>
  <files>terraform/sentinel-tvm/iam.tf</files>
  <action>
Add IAM policy for Secrets Manager access when mdm_api_secret_arn is provided.

Add this resource after the existing IAM policies:

```hcl
# Policy: Secrets Manager Access (conditional - only if mdm_api_secret_arn is specified)
# Required for loading MDM API token from Secrets Manager with caching
resource "aws_iam_role_policy" "secrets_manager" {
  count = var.mdm_api_secret_arn != "" ? 1 : 0

  name = "${var.function_name}-secrets-manager"
  role = aws_iam_role.tvm_execution.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Sid    = "SecretsManagerAccess"
        Effect = "Allow"
        Action = [
          "secretsmanager:GetSecretValue",
          "secretsmanager:DescribeSecret"
        ]
        Resource = var.mdm_api_secret_arn
      }
    ]
  })
}
```

Note: DescribeSecret is required by the aws-secretsmanager-caching-go library for version tracking.

The count conditional ensures the policy is only created when Secrets Manager is configured.
  </action>
  <verify>terraform fmt -check terraform/sentinel-tvm/iam.tf exits 0 OR terraform fmt terraform/sentinel-tvm/iam.tf formats successfully</verify>
  <done>IAM policy grants Lambda secretsmanager:GetSecretValue and secretsmanager:DescribeSecret on the specified secret ARN</done>
</task>

<task type="auto">
  <name>Task 4: Update TVM documentation for MDM and Secrets Manager</name>
  <files>docs/LAMBDA_TVM_DEPLOYMENT.md</files>
  <action>
Update docs/LAMBDA_TVM_DEPLOYMENT.md to add MDM configuration section.

1. Update the Environment Variables table in "Step 1: Create Lambda Function" section to add:

| Variable | Required | Description |
|----------|----------|-------------|
| `SENTINEL_MDM_PROVIDER` | No | MDM provider: 'jamf', 'intune', 'kandji' |
| `SENTINEL_MDM_BASE_URL` | No | MDM API base URL |
| `SENTINEL_MDM_API_SECRET_ID` | No | **Recommended:** Secrets Manager secret ARN for MDM API token |
| `SENTINEL_MDM_API_TOKEN` | No | **Deprecated:** MDM API token via env var |
| `SENTINEL_REQUIRE_DEVICE` | No | Set to "true" to require device verification |

2. Add new section "## Device Posture (MDM Integration)" after Step 5 with:

### Secrets Manager Setup (Recommended)

Store MDM API token in Secrets Manager for automatic rotation, encryption, and audit logging:

```bash
# Create secret
aws secretsmanager create-secret \
  --name "sentinel/mdm-api-token" \
  --description "Jamf Pro API token for Sentinel TVM" \
  --secret-string "your-bearer-token"

# Note the ARN for Terraform
# arn:aws:secretsmanager:us-east-1:123456789012:secret:sentinel/mdm-api-token-AbCdEf
```

### Terraform Configuration

```hcl
module "sentinel_tvm" {
  source = "./terraform/sentinel-tvm"

  # ... other configuration ...

  # MDM Configuration
  mdm_provider       = "jamf"
  mdm_base_url       = "https://company.jamfcloud.com"
  mdm_api_secret_arn = "arn:aws:secretsmanager:us-east-1:123456789012:secret:sentinel/mdm-api-token-AbCdEf"

  # Optional: require device verification (fail-closed mode)
  # require_device_posture = true
}
```

### Migration from Environment Variable

If currently using `SENTINEL_MDM_API_TOKEN` environment variable:

1. Create Secrets Manager secret with token value
2. Update Terraform to use `mdm_api_secret_arn` instead of `mdm_api_token`
3. Deploy - Lambda will load token from Secrets Manager
4. The env var pattern is deprecated and will log a warning

**Why Secrets Manager?**
- Automatic rotation support
- Encryption at rest with KMS
- Fine-grained IAM access control
- CloudTrail audit logging of secret access

3. Update Security Best Practices section to include:
   - **7. Secrets in Secrets Manager**: Store MDM API tokens in Secrets Manager, not environment variables
  </action>
  <verify>grep -q "MDM_API_SECRET_ID" docs/LAMBDA_TVM_DEPLOYMENT.md returns 0</verify>
  <done>docs/LAMBDA_TVM_DEPLOYMENT.md documents MDM configuration with Secrets Manager as recommended approach</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] terraform fmt terraform/sentinel-tvm/ reports no formatting issues
- [ ] variables.tf has mdm_api_secret_arn and mdm_api_token (deprecated) variables
- [ ] main.tf Lambda environment uses SENTINEL_MDM_API_SECRET_ID when secret ARN provided
- [ ] iam.tf has conditional Secrets Manager policy
- [ ] docs/LAMBDA_TVM_DEPLOYMENT.md documents MDM and Secrets Manager configuration
- [ ] Backward compatibility preserved (env var still works)
</verification>

<success_criteria>
- All tasks completed
- Terraform supports both new (Secrets Manager) and old (env var) patterns
- IAM permissions correctly scoped to specific secret ARN
- Documentation provides clear migration path
- No breaking changes to existing deployments
</success_criteria>

<output>
After completion, create `.planning/phases/114-secrets-manager-migration/114-02-SUMMARY.md`
</output>
