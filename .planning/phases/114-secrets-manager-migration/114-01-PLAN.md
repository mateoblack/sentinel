---
phase: 114-secrets-manager-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [lambda/config.go, lambda/config_test.go, lambda/secrets.go, lambda/secrets_test.go]
autonomous: true
---

<objective>
Migrate MDM API token from environment variable to AWS Secrets Manager with caching.

Purpose: Environment variables for sensitive tokens are a security anti-pattern in Lambda. Secrets Manager provides automatic rotation, encryption at rest, fine-grained IAM access control, and audit logging.

Output: Lambda TVM loads MDM API token from Secrets Manager with in-process caching.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/113-timing-attack-remediation/113-01-SUMMARY.md

@lambda/config.go
@mdm/jamf.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Secrets Manager caching client and loader</name>
  <files>lambda/secrets.go, lambda/secrets_test.go</files>
  <action>
Create a new secrets package within lambda/ that wraps the AWS Secrets Manager caching client:

1. Add dependency: github.com/aws/aws-secretsmanager-caching-go/v2/secretcache

2. Create lambda/secrets.go with:
   - SecretsLoader interface with GetSecret(ctx context.Context, secretID string) (string, error)
   - CachedSecretsLoader struct implementing the interface using secretcache
   - NewCachedSecretsLoader(awsCfg aws.Config, options ...func(*CacheConfig)) (*CachedSecretsLoader, error)
   - CacheConfig struct with optional TTL override (default: 1 hour for Lambda cold starts)
   - Error handling: wrap secretcache errors with descriptive context

3. Create lambda/secrets_test.go with:
   - Mock for testing (MockSecretsLoader)
   - Unit tests for cache initialization
   - Test for GetSecret success/failure paths

The interface allows mocking in tests and future extension (e.g., fallback to env var in dev).

Import pattern:
```go
import (
    "github.com/aws/aws-sdk-go-v2/aws"
    "github.com/aws/aws-secretsmanager-caching-go/v2/secretcache"
)
```

Cache initialization:
```go
cache, err := secretcache.New(
    func(c *secretcache.Cache) {
        c.Client = secretsmanager.NewFromConfig(awsCfg)
    },
)
```
  </action>
  <verify>gofmt -l lambda/secrets.go returns empty (valid syntax)</verify>
  <done>SecretsLoader interface and CachedSecretsLoader implementation exist with tests</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Secrets Manager into TVMConfig loading</name>
  <files>lambda/config.go, lambda/config_test.go</files>
  <action>
Update LoadConfigFromEnv to load MDM API token from Secrets Manager:

1. Add new environment variable constant:
   ```go
   EnvMDMAPISecretID = "SENTINEL_MDM_API_SECRET_ID"  // Secrets Manager secret ID/ARN
   ```

2. Modify LoadConfigFromEnv to:
   - Check if EnvMDMAPISecretID is set (new pattern)
   - If set, create SecretsLoader and fetch secret value
   - If EnvMDMAPIToken is also set, log warning that env var is deprecated
   - Fall back to EnvMDMAPIToken for backward compatibility (with deprecation log)

3. Update TVMConfig struct to include SecretsLoader field (optional, for testing):
   ```go
   // SecretsLoader loads secrets from Secrets Manager. If nil, created automatically.
   SecretsLoader SecretsLoader
   ```

4. Flow:
   ```
   IF SENTINEL_MDM_API_SECRET_ID is set:
       Load token from Secrets Manager (cached)
   ELSE IF SENTINEL_MDM_API_TOKEN is set:
       Use env var (log deprecation warning)
   ELSE:
       No MDM token (MDM provider creation will fail if provider specified)
   ```

5. Update lambda/config_test.go:
   - Add test for loading from Secrets Manager secret ID
   - Add test for env var deprecation warning
   - Add test for backward compatibility (env var still works)
   - Use MockSecretsLoader from secrets_test.go

IMPORTANT: Do NOT remove EnvMDMAPIToken support - maintain backward compatibility. Just add deprecation log message.
  </action>
  <verify>gofmt -l lambda/config.go returns empty (valid syntax)</verify>
  <done>LoadConfigFromEnv supports SENTINEL_MDM_API_SECRET_ID with fallback to env var</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] gofmt -l lambda/secrets.go returns empty
- [ ] gofmt -l lambda/config.go returns empty
- [ ] New SecretsLoader interface exists with caching implementation
- [ ] TVMConfig loading prefers Secrets Manager over env var
- [ ] Backward compatibility maintained (env var still works)
- [ ] Deprecation warning logged when env var used
</verification>

<success_criteria>
- All tasks completed
- SecretsLoader interface enables mocking and future extension
- LoadConfigFromEnv prefers SENTINEL_MDM_API_SECRET_ID over SENTINEL_MDM_API_TOKEN
- Backward compatibility: existing env var config continues to work
- Deprecation warning logged for env var usage
- Tests cover all paths
</success_criteria>

<output>
After completion, create `.planning/phases/114-secrets-manager-migration/114-01-SUMMARY.md`
</output>
