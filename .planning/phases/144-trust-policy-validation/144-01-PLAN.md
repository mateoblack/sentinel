---
phase: 144-trust-policy-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - enforce/validate.go
  - enforce/validate_test.go
  - enforce/advisor.go
  - cli/trust.go
  - cli/trust_test.go
autonomous: true
---

<objective>
Implement trust policy validation command for auditing IAM role trust policies against Sentinel security requirements.

Purpose: Enable users to audit IAM role trust policies for security violations including overly broad principals, missing SourceIdentity conditions, and incorrect Sentinel patterns. Outputs risk-classified findings for security review.

Output: New `sentinel trust validate` command with validation rules, risk classification, and batch role support via prefix matching.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summary (linting patterns)
@.planning/phases/143-policy-linting/143-01-SUMMARY.md

# Existing enforcement analysis infrastructure
@enforce/types.go
@enforce/analyze.go
@enforce/evaluate.go
@enforce/advisor.go
@cli/enforce.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TrustPolicyValidation with risk classification</name>
  <files>enforce/validate.go, enforce/validate_test.go</files>
  <action>
Create new enforce/validate.go with trust policy validation rules:

1. Define RiskLevel type (HIGH, MEDIUM, LOW) and ValidationFinding struct:
   - RiskLevel string (high/medium/low)
   - ValidationFinding: RuleID, RiskLevel, Message, Recommendation, AffectedStatement (Sid or index)

2. ValidateTrustPolicy function that checks:
   - TRUST-01: Wildcard principal (Principal: "*") without conditions → HIGH risk
   - TRUST-02: Allow statements missing sts:SourceIdentity condition → HIGH risk
   - TRUST-03: SourceIdentity pattern doesn't match "sentinel:*" or "sentinel:{user}:*" → MEDIUM risk
   - TRUST-04: Principal includes :root without ExternalId or SourceIdentity → MEDIUM risk
   - TRUST-05: Using StringEquals instead of StringLike for wildcard patterns → LOW risk

3. ValidationResult struct aggregating:
   - Findings []ValidationFinding
   - RiskSummary map[RiskLevel]int (count per level)
   - IsCompliant bool (true if no HIGH/MEDIUM findings)

Create comprehensive tests in enforce/validate_test.go covering:
- Wildcard principal detection
- Missing SourceIdentity detection
- Invalid Sentinel pattern detection
- Root principal without protection
- StringEquals misuse detection
- Compliant policies pass validation
  </action>
  <verify>go test ./enforce/... -run TestValidate -v passes</verify>
  <done>ValidateTrustPolicy returns findings with risk levels for all 5 validation rules</done>
</task>

<task type="auto">
  <name>Task 2: Extend Advisor with ListRoles and batch validation</name>
  <files>enforce/advisor.go, testutil/mock_aws.go</files>
  <action>
Extend enforce/advisor.go:

1. Add ListRoles to iamAPI interface:
   ```go
   ListRoles(ctx context.Context, params *iam.ListRolesInput, optFns ...func(*iam.Options)) (*iam.ListRolesOutput, error)
   ```

2. Add ValidateRole method that calls ValidateTrustPolicy after AnalyzeRole:
   ```go
   func (a *Advisor) ValidateRole(ctx context.Context, roleARN string) (*RoleValidation, error)
   ```
   Returns RoleValidation with: RoleARN, RoleName, Validation *ValidationResult, Error string

3. Add ListRolesByPrefix method for batch discovery:
   ```go
   func (a *Advisor) ListRolesByPrefix(ctx context.Context, prefix string) ([]string, error)
   ```
   Uses IAM ListRoles with PathPrefix or filters by role name prefix

4. Add ValidateRoles batch method that combines ListRolesByPrefix + ValidateRole:
   ```go
   func (a *Advisor) ValidateRoles(ctx context.Context, roleARNs []string) ([]*RoleValidation, error)
   ```

Update testutil/mock_aws.go:
- Add ListRolesFunc and ListRolesCalls to MockIAMClient
- Add ListRoles method implementation
  </action>
  <verify>go test ./enforce/... -run TestAdvisor -v passes</verify>
  <done>Advisor supports ValidateRole, ListRolesByPrefix, and ValidateRoles for batch operations</done>
</task>

<task type="auto">
  <name>Task 3: Add trust validate CLI command</name>
  <files>cli/trust.go, cli/trust_test.go</files>
  <action>
Create cli/trust.go with TrustValidateCommand:

1. TrustValidateCommandInput struct:
   - RoleARNs []string - explicit role ARNs to validate
   - Prefix string - role name prefix for discovery (e.g., "sentinel-")
   - Region string
   - JSONOutput bool
   - AWSProfile string
   - MinRisk string - filter to show only findings >= this level (default: "low")
   - Advisor *enforce.Advisor (for testing)
   - Stdout, Stderr *os.File

2. ConfigureTrustValidateCommand:
   - Create "trust" command group under app
   - Add "validate" subcommand: `sentinel trust validate`
   - Flags: --role (repeatable), --prefix, --region, --json, --aws-profile, --min-risk

3. TrustValidateCommand logic:
   - If --prefix provided: call ListRolesByPrefix to discover roles
   - Combine discovered roles with explicit --role ARNs
   - Call ValidateRoles to get validation results
   - Output in human-readable or JSON format
   - Human format shows: role name, risk level per finding, message, recommendation
   - Exit code: 0 if all compliant, 1 if any HIGH findings, 2 if MEDIUM but no HIGH

4. Human-readable output format (similar to enforce plan but validation-focused):
   ```
   Trust Policy Validation
   =======================

   Role: arn:aws:iam::123456789012:role/MyRole
   Findings: 2 (1 HIGH, 1 MEDIUM)

     [HIGH] TRUST-02: Missing SourceIdentity condition
       Statement: AllowAssumeRole
       Recommendation: Add StringLike condition for sts:SourceIdentity with pattern sentinel:*

     [MEDIUM] TRUST-04: Root principal without ExternalId
       Statement: AllowCrossAccount
       Recommendation: Add sts:ExternalId condition or require SourceIdentity

   Summary
   -------
   Roles validated: 3
   Compliant:       1 role(s)
   Non-compliant:   2 role(s)
   HIGH findings:   2
   MEDIUM findings: 1
   LOW findings:    0
   ```

Create cli/trust_test.go with tests:
- Single role validation
- Batch validation with prefix
- JSON output format
- Exit codes based on findings
- MinRisk filtering
  </action>
  <verify>go test ./cli/... -run TestTrustValidate -v passes</verify>
  <done>sentinel trust validate command works with --role, --prefix, --min-risk, and outputs findings with risk levels</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test ./enforce/... -v passes
- [ ] go test ./cli/... -run Trust -v passes
- [ ] gofmt -l . shows no formatting issues
- [ ] No new lint warnings introduced
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- ValidateTrustPolicy implements all 5 validation rules with risk classification
- Advisor supports batch role validation with prefix discovery
- CLI command outputs findings with risk levels in human-readable and JSON formats
- Exit codes reflect finding severity (0=compliant, 1=HIGH, 2=MEDIUM only)
</success_criteria>

<output>
After completion, create `.planning/phases/144-trust-policy-validation/144-01-SUMMARY.md`
</output>
