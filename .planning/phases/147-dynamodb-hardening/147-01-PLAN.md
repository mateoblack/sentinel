---
phase: 147-dynamodb-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - deploy/dynamodb.go
  - deploy/dynamodb_test.go
  - cli/dynamodb.go
  - cli/dynamodb_test.go
autonomous: true
---

<objective>
Implement DynamoDB hardening command to enable deletion protection and PITR on Sentinel tables.

Purpose: Enable users to harden DynamoDB tables with a single command, protecting against accidental deletion and enabling point-in-time recovery for data corruption recovery.

Output: New `sentinel dynamodb harden` command with table discovery, status reporting, and confirmation prompt.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summary (SCP deployment patterns, confirmation prompts)
@.planning/phases/146-scp-deployment/146-01-SUMMARY.md

# Existing DynamoDB auditing code (patterns, interfaces)
@deploy/audit.go

# CLI patterns for deployment commands
@cli/deploy.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deploy/dynamodb.go with DynamoDBHardener</name>
  <files>deploy/dynamodb.go, deploy/dynamodb_test.go</files>
  <action>
Create deploy/dynamodb.go with DynamoDB hardening capabilities:

1. Define dynamodbHardenAPI interface extending dynamodbAuditAPI:
   ```go
   // dynamodbHardenAPI extends audit operations with hardening capabilities.
   type dynamodbHardenAPI interface {
       // Audit operations (existing from dynamodbAuditAPI)
       DescribeTable(ctx context.Context, params *dynamodb.DescribeTableInput, optFns ...func(*dynamodb.Options)) (*dynamodb.DescribeTableOutput, error)
       DescribeContinuousBackups(ctx context.Context, params *dynamodb.DescribeContinuousBackupsInput, optFns ...func(*dynamodb.Options)) (*dynamodb.DescribeContinuousBackupsOutput, error)

       // Discovery operations
       ListTables(ctx context.Context, params *dynamodb.ListTablesInput, optFns ...func(*dynamodb.Options)) (*dynamodb.ListTablesOutput, error)

       // Hardening operations
       UpdateTable(ctx context.Context, params *dynamodb.UpdateTableInput, optFns ...func(*dynamodb.Options)) (*dynamodb.UpdateTableOutput, error)
       UpdateContinuousBackups(ctx context.Context, params *dynamodb.UpdateContinuousBackupsInput, optFns ...func(*dynamodb.Options)) (*dynamodb.UpdateContinuousBackupsOutput, error)
   }
   ```

2. Create DynamoDBHardener struct:
   ```go
   type DynamoDBHardener struct {
       client dynamodbHardenAPI
   }
   ```

3. Define table status and result types:
   ```go
   // TableProtectionStatus represents the current protection state of a table.
   type TableProtectionStatus struct {
       TableName           string `json:"table_name"`
       DeletionProtection  bool   `json:"deletion_protection"`
       PITREnabled         bool   `json:"pitr_enabled"`
       TableARN            string `json:"table_arn"`
   }

   // HardenResult contains the result of a hardening operation.
   type HardenResult struct {
       TableName                 string `json:"table_name"`
       DeletionProtectionChanged bool   `json:"deletion_protection_changed"`
       PITRChanged               bool   `json:"pitr_changed"`
       Error                     error  `json:"error,omitempty"`
   }
   ```

4. Implement DiscoverSentinelTables:
   ```go
   // DiscoverSentinelTables finds all DynamoDB tables matching the Sentinel prefix pattern.
   // Default prefix is "sentinel-" but can be customized.
   func (h *DynamoDBHardener) DiscoverSentinelTables(ctx context.Context, prefix string) ([]string, error)
   ```

5. Implement GetTableStatus:
   ```go
   // GetTableStatus returns the current protection status for a table.
   func (h *DynamoDBHardener) GetTableStatus(ctx context.Context, tableName string) (*TableProtectionStatus, error)
   ```

6. Implement HardenTable:
   ```go
   // HardenTable enables deletion protection and PITR on a table.
   // It is idempotent: if protections are already enabled, it reports no changes.
   func (h *DynamoDBHardener) HardenTable(ctx context.Context, tableName string, enableDeletionProtection, enablePITR bool) (*HardenResult, error)
   ```

7. Implement HardenTables for batch operations:
   ```go
   // HardenTables applies hardening to multiple tables.
   // Returns results for each table including any errors.
   func (h *DynamoDBHardener) HardenTables(ctx context.Context, tableNames []string, enableDeletionProtection, enablePITR bool) ([]*HardenResult, error)
   ```

8. Add NewDynamoDBHardener and NewDynamoDBHardenerWithClient constructors.

9. Create tests in deploy/dynamodb_test.go covering:
   - DiscoverSentinelTables with prefix matching
   - GetTableStatus for various protection states
   - HardenTable enabling both protections
   - HardenTable idempotent (already enabled)
   - HardenTable partial enable (one protection already on)
   - HardenTables batch operation
   - AccessDenied error handling
  </action>
  <verify>go test ./deploy/... -run TestDynamoDB -v passes</verify>
  <done>DynamoDBHardener discovers tables and enables deletion protection + PITR with idempotent behavior</done>
</task>

<task type="auto">
  <name>Task 2: Add sentinel dynamodb harden CLI command</name>
  <files>cli/dynamodb.go, cli/dynamodb_test.go</files>
  <action>
Create cli/dynamodb.go with DynamoDBHardenCommand:

1. DynamoDBHardenCommandInput struct:
   ```go
   type DynamoDBHardenCommandInput struct {
       Tables      []string // Specific tables to harden (empty = auto-discover)
       Prefix      string   // Prefix for auto-discovery (default: "sentinel-")
       NoPITR      bool     // Skip enabling PITR (default: enable both)
       Force       bool     // Skip confirmation prompt
       JSONOutput  bool     // Output in JSON format
       AWSProfile  string   // AWS profile for credentials
       Region      string   // AWS region

       // For testing
       Hardener *deploy.DynamoDBHardener
       Stdout   *os.File
       Stderr   *os.File
       Stdin    *os.File  // For confirmation prompt
   }
   ```

2. ConfigureDynamoDBHardenCommand:
   - Create "dynamodb" command group under app
   - Add "harden" subcommand: `sentinel dynamodb harden`
   - Flags:
     - `--table` - Specific table name (repeatable, default: auto-discover)
     - `--prefix` - Table prefix for discovery (default: "sentinel-")
     - `--no-pitr` - Skip enabling PITR (only enable deletion protection)
     - `--force, -f` - Skip confirmation prompt
     - `--json` - Output in JSON format
     - `--aws-profile` - AWS profile
     - `--region` - AWS region

3. DynamoDBHardenCommand logic:
   - If no --table specified: Use DiscoverSentinelTables with prefix
   - Get current status for all tables via GetTableStatus
   - Show current protection status (table format):
     ```
     Sentinel DynamoDB Hardening
     ===========================

     Tables to harden (3 found):

       Table                    Deletion Protection    PITR
       -----                    -------------------    ----
       sentinel-requests        Disabled               Disabled
       sentinel-breakglass      Enabled                Disabled
       sentinel-sessions        Disabled               Enabled

     Changes to apply:
     - sentinel-requests: Enable deletion protection, Enable PITR
     - sentinel-breakglass: Enable PITR
     - sentinel-sessions: Enable deletion protection

     Harden 3 tables? [y/N]
     ```
   - If not --force, prompt for confirmation
   - Call HardenTables and report results
   - Output success/failure for each table

4. Human-readable output format:
   ```
   ✓ sentinel-requests: Deletion protection enabled, PITR enabled
   ✓ sentinel-breakglass: PITR enabled (deletion protection already enabled)
   ✓ sentinel-sessions: Deletion protection enabled (PITR already enabled)

   Summary: 3/3 tables hardened successfully
   ```

5. JSON output format:
   ```json
   {
     "tables": [
       {
         "table_name": "sentinel-requests",
         "deletion_protection_changed": true,
         "pitr_changed": true
       }
     ],
     "total": 3,
     "succeeded": 3,
     "failed": 0
   }
   ```

6. Exit codes:
   - 0: Success (all tables hardened or already protected)
   - 1: Failure (one or more tables failed to harden)
   - 2: User cancelled at confirmation prompt

7. Create tests covering:
   - Auto-discovery with default prefix
   - Explicit --table specification
   - Confirmation prompt works correctly
   - --force bypasses confirmation
   - --no-pitr skips PITR enablement
   - JSON output format
   - All tables already protected (nothing to do)
   - Partial failure handling
  </action>
  <verify>go test ./cli/... -run TestDynamoDBHarden -v passes</verify>
  <done>sentinel dynamodb harden command with auto-discovery, status preview, confirmation prompt, and batch hardening</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test ./deploy/... -v passes
- [ ] go test ./cli/... -run DynamoDB -v passes
- [ ] gofmt -l . shows no formatting issues
- [ ] No new lint warnings introduced
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- DynamoDBHardener discovers Sentinel tables by prefix
- DynamoDBHardener enables deletion protection and PITR idempotently
- CLI shows current protection status before making changes
- Confirmation prompt unless --force
- Exit codes reflect hardening status
</success_criteria>

<output>
After completion, create `.planning/phases/147-dynamodb-hardening/147-01-SUMMARY.md`
</output>
