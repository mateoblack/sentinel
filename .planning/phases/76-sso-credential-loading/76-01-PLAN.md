---
phase: 76-sso-credential-loading
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [cli/credentials.go, cli/sentinel_exec.go, cli/credentials_test.go, cli/sentinel_exec_test.go]
autonomous: true
---

<objective>
Add SSO profile credential loading to the core credential commands (credentials, sentinel exec).

Purpose: When users specify --profile with an SSO profile, the commands should load credentials from that profile via the AWS SDK's SSO credential provider chain, just like AWS CLI does.

Output: credentials and sentinel_exec commands that work seamlessly with SSO profiles.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Problem:** Sentinel commands use `config.LoadDefaultConfig(ctx)` which loads credentials from the default credential chain (env vars, IAM role, etc.) but ignores the `--profile` flag for credential resolution. This means SSO profiles don't work.

**Solution:** Add `config.WithSharedConfigProfile(profileName)` when loading AWS config. This tells the AWS SDK to load credentials from the specified profile, which enables SSO credential resolution.

**AWS SDK Behavior:** When a profile has sso_start_url, sso_region, sso_account_id, sso_role_name, the AWS SDK automatically creates an SSO credential provider that reads cached OIDC tokens from ~/.aws/sso/cache/.

@cli/credentials.go
@cli/sentinel_exec.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add profile credential loading to credentials command</name>
  <files>cli/credentials.go</files>
  <action>
Modify CredentialsCommand to add `config.WithSharedConfigProfile(input.ProfileName)` to the awsCfgOpts slice when loading AWS config.

Find the config loading section (around line 151-155):
```go
awsCfgOpts := []func(*config.LoadOptions) error{}
if input.Region != "" {
    awsCfgOpts = append(awsCfgOpts, config.WithRegion(input.Region))
}
awsCfg, err := config.LoadDefaultConfig(ctx, awsCfgOpts...)
```

Change to:
```go
awsCfgOpts := []func(*config.LoadOptions) error{
    config.WithSharedConfigProfile(input.ProfileName),
}
if input.Region != "" {
    awsCfgOpts = append(awsCfgOpts, config.WithRegion(input.Region))
}
awsCfg, err := config.LoadDefaultConfig(ctx, awsCfgOpts...)
```

This ensures credentials are loaded from the specified profile, enabling SSO profiles to work.
  </action>
  <verify>go build ./... succeeds</verify>
  <done>credentials command includes profile in AWS config loading</done>
</task>

<task type="auto">
  <name>Task 2: Add profile credential loading to sentinel exec command</name>
  <files>cli/sentinel_exec.go</files>
  <action>
Modify SentinelExecCommand to add `config.WithSharedConfigProfile(input.ProfileName)` to the awsCfgOpts slice when loading AWS config.

Find the config loading section (around line 143-147):
```go
awsCfgOpts := []func(*config.LoadOptions) error{}
if input.Region != "" {
    awsCfgOpts = append(awsCfgOpts, config.WithRegion(input.Region))
}
awsCfg, err := config.LoadDefaultConfig(ctx, awsCfgOpts...)
```

Change to:
```go
awsCfgOpts := []func(*config.LoadOptions) error{
    config.WithSharedConfigProfile(input.ProfileName),
}
if input.Region != "" {
    awsCfgOpts = append(awsCfgOpts, config.WithRegion(input.Region))
}
awsCfg, err := config.LoadDefaultConfig(ctx, awsCfgOpts...)
```
  </action>
  <verify>go build ./... succeeds</verify>
  <done>sentinel exec command includes profile in AWS config loading</done>
</task>

<task type="auto">
  <name>Task 3: Add test coverage for SSO profile credential loading</name>
  <files>cli/credentials_test.go, cli/sentinel_exec_test.go</files>
  <action>
Add test cases to verify that the profile name is correctly passed to the AWS config loader. Since we can't easily mock the AWS SDK's config loading, verify by checking that the command input correctly flows to the STS client creation.

In cli/credentials_test.go, add a test function:

```go
func TestCredentialsCommand_UsesProfileForAWSConfig(t *testing.T) {
    // This test verifies the command uses the profile for AWS config loading.
    // The actual SSO flow requires real AWS credentials, so we verify
    // the pattern is correct by checking that:
    // 1. ProfileName is required
    // 2. The command doesn't fail immediately on profile validation

    t.Run("profile name is used in config", func(t *testing.T) {
        // Create a temporary config file with an SSO profile
        configContent := `[profile test-sso]
sso_start_url = https://example.awsapps.com/start
sso_region = us-east-1
sso_account_id = 123456789012
sso_role_name = TestRole
region = us-west-2
`
        configFile := createTempConfigFile(t, configContent)
        defer os.Remove(configFile)

        // Set AWS_CONFIG_FILE to use our test config
        oldConfig := os.Getenv("AWS_CONFIG_FILE")
        os.Setenv("AWS_CONFIG_FILE", configFile)
        defer os.Setenv("AWS_CONFIG_FILE", oldConfig)

        // The command should recognize the SSO profile
        // (actual credential loading would require real SSO session)
        s := &Sentinel{}
        err := s.ValidateProfile("test-sso")
        if err != nil {
            t.Fatalf("ValidateProfile failed: %v", err)
        }
    })
}
```

Similar pattern in cli/sentinel_exec_test.go.
  </action>
  <verify>go test ./cli/... -run TestCredentialsCommand_UsesProfileForAWSConfig -v passes</verify>
  <done>Test coverage added for SSO profile credential loading pattern</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `go test ./cli/... -v` passes
- [ ] credentials command has config.WithSharedConfigProfile in AWS config loading
- [ ] sentinel_exec command has config.WithSharedConfigProfile in AWS config loading
</verification>

<success_criteria>

- All tasks completed
- Both credentials and sentinel_exec commands use profile for AWS config loading
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/76-sso-credential-loading/76-01-SUMMARY.md`
</output>
