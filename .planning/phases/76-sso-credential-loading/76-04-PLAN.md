---
phase: 76-sso-credential-loading
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [cli/bootstrap.go, cli/status.go, cli/config.go]
autonomous: true
---

<objective>
Add SSO profile credential loading to infrastructure management commands (bootstrap, status, config validate).

Purpose: Enable bootstrap and configuration commands to work with SSO profiles.

Output: Infrastructure management commands that support SSO credential loading.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Commands:**
- `bootstrap plan/apply` - has --profile (multiple profiles for bootstrapping)
- `status` - has --path flag, no profile flag
- `config validate` - has --ssm flag for SSM parameter path

For bootstrap, the --profile flags specify which profiles to bootstrap. Add --aws-profile for credentials.
For status and config validate with --ssm, add --aws-profile for credentials.

@cli/bootstrap.go
@cli/status.go
@cli/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --aws-profile flag to bootstrap command</name>
  <files>cli/bootstrap.go</files>
  <action>
The bootstrap command uses --profile to specify which profiles to bootstrap (can be multiple). Add --aws-profile to specify which profile to use for AWS credentials.

1. Add AWSProfile field to BootstrapCommandInput struct:
```go
AWSProfile string // AWS profile for credentials (optional)
```

2. Add the flag in ConfigureBootstrapCommand (both plan and apply subcommands):
```go
cmd.Flag("aws-profile", "AWS profile for credentials (optional, uses default chain if not specified)").
    StringVar(&input.AWSProfile)
```

3. Update config loading in both BootstrapPlanCommand and BootstrapApplyCommand:
```go
awsCfgOpts := []func(*config.LoadOptions) error{}
if input.AWSProfile != "" {
    awsCfgOpts = append(awsCfgOpts, config.WithSharedConfigProfile(input.AWSProfile))
}
if input.Region != "" {
    awsCfgOpts = append(awsCfgOpts, config.WithRegion(input.Region))
}
awsCfg, err := config.LoadDefaultConfig(ctx, awsCfgOpts...)
```

Note: bootstrap.go has two config loading sites (plan and apply subcommands), update both.
  </action>
  <verify>go build ./cli/... succeeds</verify>
  <done>bootstrap command has optional --aws-profile flag for SSO support</done>
</task>

<task type="auto">
  <name>Task 2: Add --aws-profile flag to status command</name>
  <files>cli/status.go</files>
  <action>
Add optional --aws-profile flag to status command.

1. Add AWSProfile field to StatusCommandInput struct:
```go
AWSProfile string // Optional AWS profile for credentials
```

2. Add the flag in ConfigureStatusCommand:
```go
cmd.Flag("aws-profile", "AWS profile for credentials (optional, uses default chain if not specified)").
    StringVar(&input.AWSProfile)
```

3. Modify the config loading:
```go
awsCfgOpts := []func(*config.LoadOptions) error{}
if input.AWSProfile != "" {
    awsCfgOpts = append(awsCfgOpts, config.WithSharedConfigProfile(input.AWSProfile))
}
if input.Region != "" {
    awsCfgOpts = append(awsCfgOpts, config.WithRegion(input.Region))
}
awsCfg, err := config.LoadDefaultConfig(ctx, awsCfgOpts...)
```
  </action>
  <verify>go build ./cli/... succeeds</verify>
  <done>status command has optional --aws-profile flag</done>
</task>

<task type="auto">
  <name>Task 3: Add --aws-profile flag to config validate command (SSM mode)</name>
  <files>cli/config.go</files>
  <action>
The config validate command can validate policies from SSM (--ssm flag). Add --aws-profile for SSM access credentials.

1. Add AWSProfile field to ConfigValidateInput struct:
```go
AWSProfile string // Optional AWS profile for SSM credentials
```

2. Add the flag in ConfigureConfigCommand (for the validate subcommand):
```go
validateCmd.Flag("aws-profile", "AWS profile for SSM credentials (optional, uses default chain if not specified)").
    StringVar(&validateInput.AWSProfile)
```

3. Update config loading in validateConfigSSM function or where SSM config is loaded:
```go
opts := []func(*awsconfig.LoadOptions) error{}
if input.AWSProfile != "" {
    opts = append(opts, awsconfig.WithSharedConfigProfile(input.AWSProfile))
}
if input.Region != "" {
    opts = append(opts, awsconfig.WithRegion(input.Region))
}
awsCfg, err := awsconfig.LoadDefaultConfig(ctx, opts...)
```
  </action>
  <verify>go build ./cli/... succeeds</verify>
  <done>config validate command has optional --aws-profile flag for SSM access</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `go test ./cli/... -v` passes
- [ ] bootstrap command has --aws-profile flag
- [ ] status command has --aws-profile flag
- [ ] config validate command has --aws-profile flag for SSM mode
</verification>

<success_criteria>

- All tasks completed
- Infrastructure management commands support SSO credentials via --aws-profile
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/76-sso-credential-loading/76-04-SUMMARY.md`
</output>
