---
phase: 76-sso-credential-loading
plan: 05
type: execute
wave: 1
depends_on: []
files_modified: [cli/permissions.go, cli/check.go, cli/enforce.go, cli/audit.go]
autonomous: true
---

<objective>
Add SSO profile credential loading to permissions and audit commands (permissions, check, enforce, audit).

Purpose: Enable permissions discovery and audit commands to work with SSO profiles.

Output: Permissions and audit commands that support SSO credential loading.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Commands:**
- `permissions` (list, check subcommands) - no profile flag
- `check` (request status) - has --request-id, no profile flag
- `enforce analyze` - has --role flag for target role, no profile for credentials
- `audit verify` - no profile flag

All need optional --aws-profile flag for credentials.

@cli/permissions.go
@cli/check.go
@cli/enforce.go
@cli/audit.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --aws-profile flag to permissions command</name>
  <files>cli/permissions.go</files>
  <action>
The permissions command has multiple subcommands (list, check, detect) that all load AWS config. Add --aws-profile to the parent command so it applies to all.

1. Add AWSProfile field to the relevant input structs (PermissionsCommandInput or similar):
```go
AWSProfile string // Optional AWS profile for credentials
```

2. Add the flag to the permissions parent command or each subcommand:
```go
cmd.Flag("aws-profile", "AWS profile for credentials (optional, uses default chain if not specified)").
    StringVar(&input.AWSProfile)
```

3. Update all config loading sites in permissions.go (there are 3 - around lines 181, 405, 447):
```go
opts := []func(*config.LoadOptions) error{}
if input.AWSProfile != "" {
    opts = append(opts, config.WithSharedConfigProfile(input.AWSProfile))
}
if input.Region != "" {
    opts = append(opts, config.WithRegion(input.Region))
}
awsCfg, err := config.LoadDefaultConfig(ctx, opts...)
```

Note: permissions.go has three config loading sites for different subcommands, update all three.
  </action>
  <verify>go build ./cli/... succeeds</verify>
  <done>permissions command has optional --aws-profile flag</done>
</task>

<task type="auto">
  <name>Task 2: Add --aws-profile flag to check command</name>
  <files>cli/check.go</files>
  <action>
Add optional --aws-profile flag to check command.

1. Add AWSProfile field to CheckCommandInput struct:
```go
AWSProfile string // Optional AWS profile for credentials
```

2. Add the flag in ConfigureCheckCommand:
```go
cmd.Flag("aws-profile", "AWS profile for credentials (optional, uses default chain if not specified)").
    StringVar(&input.AWSProfile)
```

3. Modify the config loading:
```go
awsCfgOpts := []func(*config.LoadOptions) error{}
if input.AWSProfile != "" {
    awsCfgOpts = append(awsCfgOpts, config.WithSharedConfigProfile(input.AWSProfile))
}
if input.Region != "" {
    awsCfgOpts = append(awsCfgOpts, config.WithRegion(input.Region))
}
awsCfg, err := config.LoadDefaultConfig(ctx, awsCfgOpts...)
```
  </action>
  <verify>go build ./cli/... succeeds</verify>
  <done>check command has optional --aws-profile flag</done>
</task>

<task type="auto">
  <name>Task 3: Add --aws-profile flag to enforce and audit commands</name>
  <files>cli/enforce.go, cli/audit.go</files>
  <action>
Add optional --aws-profile flag to enforce and audit commands.

For cli/enforce.go:
1. Add AWSProfile field to EnforceCommandInput struct
2. Add --aws-profile flag in ConfigureEnforceCommand
3. Update config loading to use profile if specified

For cli/audit.go:
1. Add AWSProfile field to AuditCommandInput struct
2. Add --aws-profile flag in ConfigureAuditCommand
3. Update config loading to use profile if specified

Use the same pattern as other commands:
```go
awsCfgOpts := []func(*config.LoadOptions) error{}
if input.AWSProfile != "" {
    awsCfgOpts = append(awsCfgOpts, config.WithSharedConfigProfile(input.AWSProfile))
}
if input.Region != "" {
    awsCfgOpts = append(awsCfgOpts, config.WithRegion(input.Region))
}
```
  </action>
  <verify>go build ./cli/... succeeds</verify>
  <done>enforce and audit commands have optional --aws-profile flag</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `go test ./cli/... -v` passes
- [ ] permissions command has --aws-profile flag
- [ ] check command has --aws-profile flag
- [ ] enforce command has --aws-profile flag
- [ ] audit command has --aws-profile flag
</verification>

<success_criteria>

- All tasks completed
- All permissions and audit commands support SSO credentials via --aws-profile
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/76-sso-credential-loading/76-05-SUMMARY.md`
</output>
