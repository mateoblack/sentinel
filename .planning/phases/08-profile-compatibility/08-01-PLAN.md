---
phase: 08-profile-compatibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [cli/sentinel.go, cli/credentials.go, cli/credentials_test.go]
autonomous: true
---

<objective>
Add profile validation to Sentinel and integrate into credentials command.

Purpose: Fail fast when user specifies a non-existent profile, providing helpful error messages with available profiles.
Output: ValidateProfile method on Sentinel struct, credentials command validates profile before proceeding.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@cli/sentinel.go
@cli/credentials.go
@vault/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ValidateProfile method to Sentinel struct</name>
  <files>cli/sentinel.go</files>
  <action>
Add ValidateProfile method to Sentinel struct that:
1. Loads AWS config file via AwsConfigFile()
2. Calls ProfileSection(profileName) to check if profile exists
3. If profile doesn't exist, return error with available profile names

Method signature:
```go
// ValidateProfile checks if profile exists in AWS config file.
// Returns nil if valid, error with available profiles if not found.
func (s *Sentinel) ValidateProfile(profileName string) error
```

Implementation:
- Use configFile.ProfileSection(name) which returns (ProfileSection, bool)
- If !ok, build error message listing available profiles from configFile.ProfileNames()
- Format: "profile %q not found in AWS config; available profiles: %v"
- Return nil if profile exists
  </action>
  <verify>go build ./... succeeds</verify>
  <done>ValidateProfile method exists and compiles</done>
</task>

<task type="auto">
  <name>Task 2: Integrate profile validation into credentials command</name>
  <files>cli/credentials.go, cli/credentials_test.go</files>
  <action>
1. In CredentialsCommand, after getting current user (step 1), add profile validation:
   - Call s.ValidateProfile(input.ProfileName)
   - If error, write to stderr and return error (before policy loading)

2. Add test in credentials_test.go:
   - Test that missing profile returns appropriate error message
   - Mock or use test config file with known profiles

Insert validation between step 1 (get current user) and step 2 (create AWS config for SSM):
```go
// 1.5. Validate profile exists in AWS config
if err := s.ValidateProfile(input.ProfileName); err != nil {
    fmt.Fprintf(os.Stderr, "%v\n", err)
    return err
}
```
  </action>
  <verify>go test ./cli/... -run TestCredentials passes</verify>
  <done>Credentials command fails fast with helpful error when profile doesn't exist</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go build ./... succeeds
- [ ] go test ./cli/... passes
- [ ] Manual test: `go run ./cmd/sentinel credentials --profile nonexistent --policy-parameter /test` shows error with available profiles
</verification>

<success_criteria>

- ValidateProfile method added to Sentinel struct
- Credentials command validates profile before policy evaluation
- Error message includes available profile names
- Tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-profile-compatibility/08-01-SUMMARY.md`
</output>
