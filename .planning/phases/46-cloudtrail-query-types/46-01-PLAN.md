---
phase: 46-cloudtrail-query-types
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [audit/types.go, audit/types_test.go, audit/verifier.go, audit/verifier_test.go]
autonomous: true
---

<objective>
Define CloudTrail query types and session verifier for Sentinel enforcement assurance.

Purpose: Enable the `sentinel audit verify` command (Phase 47) to query CloudTrail and verify that sessions have proper Sentinel SourceIdentity, detect missing enforcement, and identify potential bypasses.
Output: New `audit` package with types for CloudTrail events, verification results, and a verifier that queries CloudTrail via LookupEvents API.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context - enforcement types we'll reference
@enforce/types.go

# Existing logging types for reference
@logging/decision.go

# CloudTrail correlation documentation - defines SourceIdentity format
@docs/CLOUDTRAIL.md

# Codebase patterns
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CloudTrail query types and session verification types</name>
  <files>audit/types.go, audit/types_test.go</files>
  <action>
Create new `audit` package with types for CloudTrail session verification.

**Types to create:**

1. **SessionInfo** - Parsed information from a CloudTrail event:
   ```go
   type SessionInfo struct {
       SourceIdentity string    // e.g., "sentinel:alice:a1b2c3d4"
       EventTime      time.Time // When the event occurred
       EventID        string    // CloudTrail event ID
       EventName      string    // e.g., "AssumeRole"
       EventSource    string    // e.g., "sts.amazonaws.com"
       RoleARN        string    // Target role ARN
       Username       string    // IAM username or principal
       IsSentinel     bool      // True if SourceIdentity starts with "sentinel:"
       User           string    // Parsed user from SourceIdentity (if Sentinel)
       RequestID      string    // Parsed request-id from SourceIdentity (if Sentinel)
   }
   ```

2. **VerificationResult** - Result of verifying sessions in a time window:
   ```go
   type VerificationResult struct {
       StartTime          time.Time      // Query start time
       EndTime            time.Time      // Query end time
       TotalSessions      int            // Total sessions examined
       SentinelSessions   int            // Sessions with valid Sentinel SourceIdentity
       NonSentinelSessions int           // Sessions without Sentinel SourceIdentity
       BreakGlassSessions int            // Sessions with break-glass markers (future use)
       UnknownSessions    int            // Sessions that couldn't be classified
       Issues             []SessionIssue // Problems found during verification
   }
   ```

3. **SessionIssue** - A problem detected during verification:
   ```go
   type SessionIssue struct {
       Severity    IssueSeverity // "warning", "error"
       Type        IssueType     // "missing_source_identity", "bypass_detected", etc.
       SessionInfo *SessionInfo  // The problematic session
       Message     string        // Human-readable description
   }
   ```

4. **IssueSeverity** and **IssueType** - String type aliases with constants:
   - IssueSeverity: SeverityWarning, SeverityError
   - IssueType: IssueTypeMissingSourceIdentity, IssueTypeBypassDetected, IssueTypeUnexpectedSourceIdentity

5. **VerifyInput** - Parameters for verification:
   ```go
   type VerifyInput struct {
       StartTime time.Time
       EndTime   time.Time
       RoleARN   string // Optional: filter by specific role
       Username  string // Optional: filter by specific user
   }
   ```

**Helper functions:**

1. `ParseSourceIdentity(sourceIdentity string) (user string, requestID string, isSentinel bool)` - Parse a SourceIdentity string into components.

2. `(r *VerificationResult) HasIssues() bool` - Returns true if any issues were found.

3. `(r *VerificationResult) PassRate() float64` - Returns percentage of sessions with valid Sentinel SourceIdentity.

**Tests:** Test ParseSourceIdentity with valid Sentinel format, non-Sentinel format, empty, and malformed inputs. Test VerificationResult helper methods.
  </action>
  <verify>go build ./audit && go test ./audit -v -run TestParse</verify>
  <done>Types compile and ParseSourceIdentity correctly parses "sentinel:user:requestid" format</done>
</task>

<task type="auto">
  <name>Task 2: Create CloudTrail verifier with LookupEvents integration</name>
  <files>audit/verifier.go, audit/verifier_test.go, go.mod</files>
  <action>
Create the verifier that queries CloudTrail and analyzes sessions.

**Add CloudTrail SDK dependency:**
```bash
go get github.com/aws/aws-sdk-go-v2/service/cloudtrail
```

**Interface and implementation:**

1. **cloudtrailAPI** interface (for testability, following notification/sns.go pattern):
   ```go
   type cloudtrailAPI interface {
       LookupEvents(ctx context.Context, params *cloudtrail.LookupEventsInput, optFns ...func(*cloudtrail.Options)) (*cloudtrail.LookupEventsOutput, error)
   }
   ```

2. **Verifier** struct:
   ```go
   type Verifier struct {
       client cloudtrailAPI
   }

   func NewVerifier(client cloudtrailAPI) *Verifier
   ```

3. **Verify** method:
   ```go
   func (v *Verifier) Verify(ctx context.Context, input *VerifyInput) (*VerificationResult, error)
   ```

   Implementation:
   - Call LookupEvents with StartTime, EndTime (required)
   - Filter by Username if provided (using LookupAttribute with AttributeKey=Username)
   - Paginate through results using NextToken (max 50 events per call)
   - For each event:
     - Parse the CloudTrailEvent JSON string to extract userIdentity.sourceIdentity
     - Call ParseSourceIdentity to determine if it's a Sentinel session
     - Build SessionInfo
     - If not a Sentinel session, create a SessionIssue with IssueTypeMissingSourceIdentity
   - Return aggregated VerificationResult

4. **parseCloudTrailEvent** helper:
   ```go
   func parseCloudTrailEvent(eventJSON string) (*SessionInfo, error)
   ```
   Parse the CloudTrailEvent JSON to extract:
   - `userIdentity.sourceIdentity`
   - `userIdentity.arn` (for role ARN extraction)
   - `eventTime`, `eventName`, `eventSource`

**Important:** The CloudTrailEvent field in the Event struct is a JSON string that needs to be unmarshaled separately. Define internal structs for parsing:

```go
type cloudTrailEventPayload struct {
    UserIdentity struct {
        SourceIdentity string `json:"sourceIdentity"`
        ARN            string `json:"arn"`
        Type           string `json:"type"`
        SessionContext struct {
            SessionIssuer struct {
                ARN string `json:"arn"`
            } `json:"sessionIssuer"`
        } `json:"sessionContext"`
    } `json:"userIdentity"`
    EventTime   string `json:"eventTime"`
    EventName   string `json:"eventName"`
    EventSource string `json:"eventSource"`
}
```

**Tests:**
1. Mock cloudtrailAPI for unit tests
2. Test Verify with mock returning events with/without SourceIdentity
3. Test pagination handling (multiple pages of results)
4. Test parseCloudTrailEvent with sample CloudTrail JSON
5. Test filtering by Username
  </action>
  <verify>go build ./audit && go test ./audit -v</verify>
  <done>Verifier queries CloudTrail, parses events, and correctly identifies Sentinel vs non-Sentinel sessions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds without errors
- [ ] `go test ./audit -v` passes all tests
- [ ] `go vet ./audit` reports no issues
- [ ] ParseSourceIdentity correctly handles "sentinel:user:id", "other:format", and empty strings
- [ ] Verifier correctly identifies sessions missing SourceIdentity
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- New audit package with CloudTrail query types
- Verifier can query CloudTrail and classify sessions as Sentinel/non-Sentinel
- Ready for Phase 47 to build CLI command on top
</success_criteria>

<output>
After completion, create `.planning/phases/46-cloudtrail-query-types/46-01-SUMMARY.md`
</output>
