---
phase: 43-enforcement-types
plan: 02
type: execute
wave: 2
depends_on: ["43-01"]
files_modified: [enforce/evaluate.go, enforce/evaluate_test.go, enforce/analyze.go, enforce/analyze_test.go]
autonomous: true
---

<objective>
Implement condition operator evaluation and enforcement analysis logic.

Purpose: Provide the logic to determine whether a trust policy enforces Sentinel SourceIdentity conditions, enabling teams to audit their IAM configuration.
Output: Evaluation and analysis functions that can determine enforcement status for any trust policy.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@docs/ENFORCEMENT.md
@enforce/types.go
@enforce/parse.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement condition operator evaluation</name>
  <files>enforce/evaluate.go, enforce/evaluate_test.go</files>
  <action>
Implement condition operator matching logic for IAM policy conditions.

In enforce/evaluate.go:
1. `MatchPattern(pattern, value string) bool` - implement AWS StringLike wildcard matching:
   - `*` matches any sequence of characters
   - `?` matches any single character
   - Literal matching otherwise
   - Case-sensitive (AWS default)

2. `HasSourceIdentityCondition(stmt *Statement) bool` - check if statement has sts:SourceIdentity condition with sentinel:* pattern

3. `GetSourceIdentityPatterns(stmt *Statement) []string` - extract SourceIdentity patterns from condition block

Condition operators to support:
- StringLike: pattern must match value
- StringNotLike: pattern must NOT match value
- StringEquals: exact match
- StringNotEquals: must not equal

Focus on sts:SourceIdentity key detection. The condition block structure is:
```json
{
  "StringLike": {
    "sts:SourceIdentity": "sentinel:*"
  }
}
```

In enforce/evaluate_test.go:
1. Test MatchPattern with wildcards (*, ?)
2. Test sentinel:* pattern matching
3. Test HasSourceIdentityCondition with various policy structures
4. Test extraction of patterns from nested conditions
  </action>
  <verify>go test ./enforce/... -run TestMatch -v passes</verify>
  <done>Condition operators correctly identify Sentinel SourceIdentity requirements</done>
</task>

<task type="auto">
  <name>Task 2: Implement enforcement analysis</name>
  <files>enforce/analyze.go, enforce/analyze_test.go</files>
  <action>
Implement the main analysis function that determines enforcement status.

In enforce/analyze.go:
1. `AnalyzeTrustPolicy(policy *TrustPolicyDocument) *AnalysisResult` - main analysis function

Analysis logic:
- If ANY statement has sts:SourceIdentity condition with sentinel:* pattern → EnforcementStatus = Full
- If statements have SourceIdentity but not sentinel:* → EnforcementStatus = Partial
- If no SourceIdentity conditions → EnforcementStatus = None

Generate Issues for:
- Missing SourceIdentity condition
- SourceIdentity pattern not matching sentinel:*
- Using StringEquals instead of StringLike (won't work with dynamic request-id)
- Multiple statements with conflicting enforcement

Generate Recommendations based on status:
- None: "Add StringLike condition for sts:SourceIdentity with pattern sentinel:*"
- Partial: "Update SourceIdentity pattern to sentinel:* for full Sentinel enforcement"
- Full: No recommendations (compliant)

2. `IsEnforced(policy *TrustPolicyDocument) bool` - simple check for Full enforcement

In enforce/analyze_test.go:
1. Test against Pattern A from ENFORCEMENT.md (require any Sentinel)
2. Test against Pattern B (require Sentinel + specific users)
3. Test against Pattern C (migration mode - OR condition)
4. Test non-enforced policy returns None status
5. Test partial enforcement detection
  </action>
  <verify>go test ./enforce/... -run TestAnalyze -v passes</verify>
  <done>AnalyzeTrustPolicy returns correct status and actionable recommendations</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./enforce/...` succeeds
- [ ] `go test ./enforce/...` passes all tests
- [ ] `go vet ./enforce/...` reports no issues
- [ ] Analysis correctly identifies Pattern A/B/C from ENFORCEMENT.md
</verification>

<success_criteria>

- MatchPattern implements AWS StringLike wildcards correctly
- HasSourceIdentityCondition detects sentinel:* requirements
- AnalyzeTrustPolicy returns accurate enforcement status
- Recommendations are actionable and match ENFORCEMENT.md guidance
- Tests cover all documented trust policy patterns
</success_criteria>

<output>
After completion, create `.planning/phases/43-enforcement-types/43-02-SUMMARY.md`
</output>
