---
phase: 43-enforcement-types
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [enforce/types.go, enforce/parse.go, enforce/parse_test.go]
autonomous: true
---

<objective>
Define trust policy document types and JSON parsing for IAM trust policy analysis.

Purpose: Establish the data model for parsing AWS IAM trust policies so Sentinel can analyze whether roles enforce SourceIdentity conditions.
Output: New `enforce` package with types for trust policy documents and JSON parsing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@docs/ENFORCEMENT.md
@policy/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define trust policy document types</name>
  <files>enforce/types.go</files>
  <action>
Create new `enforce` package with types for IAM trust policy documents.

Types to define:
1. `TrustPolicyDocument` - top-level structure with Version and Statement
2. `Statement` - Effect, Principal, Action, Condition, Sid fields
3. `Principal` - flexible type handling AWS string or []string or map
4. `ConditionBlock` - map of operator -> key -> values
5. `EnforcementLevel` - string type alias with constants: Advisory, TrustPolicy, SCP
6. `EnforcementStatus` - string type alias with constants: None, Partial, Full
7. `AnalysisResult` - Level, Status, Issues []string, Recommendations []string, HasSourceIdentityCondition bool

Follow existing conventions from policy/types.go:
- Use string type aliases for enums with IsValid() and String() methods
- Use json struct tags (not yaml - these are AWS JSON documents)
- Add godoc comments for all exported types and constants

Reference docs/ENFORCEMENT.md for exact trust policy JSON structure.
  </action>
  <verify>go build ./enforce/... compiles without errors</verify>
  <done>Types defined with proper json tags and validation methods</done>
</task>

<task type="auto">
  <name>Task 2: Implement trust policy JSON parsing</name>
  <files>enforce/parse.go, enforce/parse_test.go</files>
  <action>
Implement JSON parsing for trust policy documents.

In enforce/parse.go:
1. `ParseTrustPolicy(data []byte) (*TrustPolicyDocument, error)` - parse JSON bytes
2. Handle Principal flexibility (can be string, []string, or map with AWS key)
3. `(d *TrustPolicyDocument) Validate() error` - validate required fields

Principal handling is tricky because AWS allows:
- `"Principal": {"AWS": "arn:aws:iam::123456789012:root"}`
- `"Principal": {"AWS": ["arn1", "arn2"]}`
- `"Principal": "*"`

Use custom UnmarshalJSON on Principal type to handle variants, storing normalized form.

In enforce/parse_test.go:
1. Test parsing valid trust policy from docs/ENFORCEMENT.md patterns
2. Test Principal variants (string, array, star)
3. Test Condition block parsing with StringLike, StringNotLike operators
4. Test error cases: empty input, invalid JSON, missing required fields

Follow existing test patterns from policy/parse_test.go.
  </action>
  <verify>go test ./enforce/... -v passes all tests</verify>
  <done>ParseTrustPolicy handles all AWS trust policy variants correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./enforce/...` succeeds
- [ ] `go test ./enforce/...` passes all tests
- [ ] `go vet ./enforce/...` reports no issues
</verification>

<success_criteria>

- New enforce package created
- Trust policy types match AWS JSON structure
- Principal variants handled correctly
- Condition block parsing works for StringLike/StringNotLike operators
- Tests cover documented patterns from ENFORCEMENT.md
</success_criteria>

<output>
After completion, create `.planning/phases/43-enforcement-types/43-01-SUMMARY.md`
</output>
