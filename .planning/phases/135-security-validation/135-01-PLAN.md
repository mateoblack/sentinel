---
phase: 135-security-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [Makefile, scripts/security-test.sh, security/v118_integration_test.go]
autonomous: true
---

<objective>
Create unified security test infrastructure for v1.18 security hardening validation.

Purpose: Enable CI/CD to run all security regression tests in a single command and validate v1.18 features work together.
Output: `make test-security` target, security test script, and v1.18 integration tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phases with security tests (v1.18)
@.planning/phases/126-policy-integrity/126-03-SUMMARY.md
@.planning/phases/127-breakglass-mfa/127-03-SUMMARY.md
@.planning/phases/128-audit-log-integrity/128-03-SUMMARY.md
@.planning/phases/129-local-server-security/129-04-SUMMARY.md
@.planning/phases/130-identity-hardening/130-01-SUMMARY.md
@.planning/phases/131-dynamodb-security/131-02-SUMMARY.md
@.planning/phases/132-keyring-protection/132-02-SUMMARY.md
@.planning/phases/133-rate-limit-hardening/133-02-SUMMARY.md
@.planning/phases/134-input-sanitization/134-02-SUMMARY.md

# Existing infrastructure
@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create security test runner script</name>
  <files>scripts/security-test.sh</files>
  <action>
Create a bash script that:
1. Discovers all `*_security_test.go` and `*security*test*.go` files
2. Runs `go test` with `-run TestSecurityRegression` pattern to execute only security tests
3. Generates a summary report showing:
   - Total security tests run
   - Tests by package
   - Pass/fail counts
   - Any SECURITY VIOLATION markers in output
4. Exits with non-zero status if any test fails
5. Use `-race` flag to detect race conditions in security code
6. Use `-count=1` to disable test caching (security tests must always run)

Make script executable with proper shebang.
  </action>
  <verify>chmod +x scripts/security-test.sh && ./scripts/security-test.sh --help shows usage</verify>
  <done>Script runs all security regression tests and produces report</done>
</task>

<task type="auto">
  <name>Task 2: Add Makefile target for security tests</name>
  <files>Makefile</files>
  <action>
Add the following targets to Makefile:

1. `test-security` - Runs all security regression tests via scripts/security-test.sh
2. `test-security-verbose` - Same but with verbose output (-v flag)
3. `test-all` - Runs both regular tests and security tests

Place these after the existing `test` target. Include .PHONY declarations.

Example targets:
```makefile
test-security: ## Run security regression tests
	@./scripts/security-test.sh

test-security-verbose: ## Run security tests with verbose output
	@./scripts/security-test.sh -v

test-all: test test-security ## Run all tests including security regression
```
  </action>
  <verify>make test-security runs without error and shows test results</verify>
  <done>Makefile has test-security target that runs all security tests</done>
</task>

<task type="auto">
  <name>Task 3: Create v1.18 security integration tests</name>
  <files>security/v118_integration_test.go</files>
  <action>
Create new `security` package with integration tests that validate v1.18 security features work together. Create the security/ directory if it doesn't exist.

Tests should cover cross-phase security scenarios:

1. **TestSecurityRegression_PolicySigningWithRateLimiting**: Verify policy verification (126) works with rate limiting (133)
   - Mock: Policy loader returns signed policy, rate limiter allows request
   - Verify: Both checks pass, credentials vended

2. **TestSecurityRegression_InputValidationInIdentityExtraction**: Verify input sanitization (134) is applied to identity extraction (130)
   - Mock: IAM ARN with special characters
   - Verify: Sanitization applied, no injection possible

3. **TestSecurityRegression_AuditLogIntegrityWithBreakGlass**: Verify audit logs (128) capture MFA details (127)
   - Mock: Break-glass with MFA verification
   - Verify: Log entry contains MFA fields, signature valid

4. **TestSecurityRegression_DynamoDBSecurityAcrossStores**: Verify state validation (131) works for all stores
   - Mock: Attempt invalid state transitions across session, request, breakglass stores
   - Verify: All reject invalid transitions with ErrInvalidStateTransition

5. **TestSecurityRegression_AllInputVectorsValidated**: Verify all user input entry points use validation (134)
   - List all input entry points: profile names, ARNs, function names, log messages
   - Verify: Each has corresponding validation test

Follow existing test patterns:
- Use `TestSecurityRegression_` prefix
- Include THREAT comments explaining attack scenario
- Include SECURITY VIOLATION markers for failures
- Use table-driven tests where appropriate
  </action>
  <verify>go test -v ./security/... -run TestSecurityRegression runs all integration tests</verify>
  <done>Integration tests validate v1.18 security features work together</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `./scripts/security-test.sh` exists and is executable
- [ ] `make test-security` runs all security tests
- [ ] `go test ./security/...` passes all v1.18 integration tests
- [ ] No build errors (`go build ./...`)
- [ ] All security tests use `TestSecurityRegression_` prefix
</verification>

<success_criteria>

- Security test script discovers and runs all security tests
- Makefile provides test-security target for CI integration
- v1.18 integration tests validate cross-phase security features
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/135-security-validation/135-01-SUMMARY.md`
</output>
