---
phase: 135-security-validation
plan: 02
type: execute
wave: 2
depends_on: ["135-01"]
files_modified: [docs/SECURITY_TESTING.md, .github/workflows.disabled/test-security.yml]
autonomous: true
---

<objective>
Document security testing patterns and create CI workflow for security gate.

Purpose: Ensure security testing practices are documented and integrated into CI/CD for regression prevention.
Output: SECURITY_TESTING.md documentation and CI workflow for security tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan output
@.planning/phases/135-security-validation/135-01-SUMMARY.md

# Existing CI workflows
@.github/workflows.disabled/security.yml
@.github/workflows.disabled/govulncheck.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create security testing documentation</name>
  <files>docs/SECURITY_TESTING.md</files>
  <action>
Create comprehensive documentation for Sentinel security testing practices:

## Structure:
1. **Overview** - Purpose of security regression tests, when to add them
2. **Test Naming Convention** - TestSecurityRegression_ prefix, CI filtering
3. **Test Organization** - Per-package *_security_test.go files
4. **Test Patterns**:
   - THREAT comments documenting attack scenario
   - SECURITY VIOLATION markers for failures
   - Table-driven tests for attack vectors
   - AST verification for code patterns (e.g., constant-time comparison)
5. **v1.18 Security Coverage** - List all phases (126-134) and what they test:
   - Phase 126: Policy signing and verification
   - Phase 127: MFA timing attacks, bypass prevention
   - Phase 128: Audit log integrity, HMAC signatures
   - Phase 129: Unix socket process authentication
   - Phase 130: Identity hardening, ARN validation
   - Phase 131: DynamoDB optimistic locking, state transitions
   - Phase 132: Keyring protection (macOS/Linux)
   - Phase 133: Distributed rate limiting
   - Phase 134: Input sanitization, shell escaping
6. **Running Security Tests**:
   - `make test-security` - Run all security tests
   - `go test -run TestSecurityRegression ./...` - Direct go test
   - `./scripts/security-test.sh -v` - Verbose with report
7. **Adding New Security Tests**:
   - When to add (new security feature, vulnerability fix)
   - Template for new test file
   - Registration in integration tests
8. **CI Integration** - How security tests run in CI, blocking vs advisory

Include examples from actual codebase tests.
  </action>
  <verify>cat docs/SECURITY_TESTING.md | head -50 shows documentation structure</verify>
  <done>SECURITY_TESTING.md documents all security testing patterns and v1.18 coverage</done>
</task>

<task type="auto">
  <name>Task 2: Create CI workflow for security tests</name>
  <files>.github/workflows.disabled/test-security.yml</files>
  <action>
Create GitHub Actions workflow that runs security tests on every PR:

```yaml
name: Security Tests

permissions:
  contents: read
  pull-requests: read

on:
  pull_request:
  push:
    branches: [main]

jobs:
  security-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run security regression tests
        run: make test-security

      - name: Check for security test coverage
        run: |
          # Count security tests
          SECURITY_TESTS=$(grep -r "TestSecurityRegression" --include="*_test.go" -c | awk -F: '{sum+=$2} END {print sum}')
          echo "Total security regression tests: $SECURITY_TESTS"

          # Fail if below threshold (current: ~297)
          if [ "$SECURITY_TESTS" -lt 250 ]; then
            echo "ERROR: Security test count dropped below threshold"
            exit 1
          fi
```

Key features:
- Runs on every PR and main branch push
- Uses `make test-security` target from Plan 01
- Counts security tests and fails if count drops (regression prevention)
- Placed in workflows.disabled/ to match existing pattern (can be enabled when ready)
  </action>
  <verify>cat .github/workflows.disabled/test-security.yml shows valid YAML workflow</verify>
  <done>CI workflow runs security tests on PRs and prevents regression</done>
</task>

<task type="auto">
  <name>Task 3: Final security test validation and summary</name>
  <files>none (verification only)</files>
  <action>
Run comprehensive validation of all v1.18 security features:

1. Run full security test suite:
   ```bash
   make test-security
   ```

2. Generate security test inventory:
   ```bash
   grep -r "TestSecurityRegression" --include="*_test.go" -l | wc -l
   ```

3. Verify each v1.18 phase has security tests:
   - Phase 126: policy/security_test.go
   - Phase 127: mfa/security_test.go
   - Phase 128: logging/security_test.go
   - Phase 129: server/security_test.go
   - Phase 130: identity/security_test.go
   - Phase 131: session/dynamodb_security_test.go, request/dynamodb_security_test.go, breakglass/dynamodb_security_test.go
   - Phase 132: vault/keyring_security_test.go
   - Phase 133: ratelimit/security_test.go
   - Phase 134: validate/security_test.go, shell/security_test.go

4. Verify integration tests from Plan 01 pass

5. Document final counts in summary:
   - Total TestSecurityRegression_ tests
   - Tests per package
   - v1.18 coverage completeness
  </action>
  <verify>make test-security passes with full v1.18 coverage</verify>
  <done>All v1.18 security features validated with comprehensive test coverage</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] docs/SECURITY_TESTING.md exists with complete documentation
- [ ] .github/workflows.disabled/test-security.yml is valid YAML
- [ ] `make test-security` passes all tests
- [ ] Security test count is >= 250 (current ~297)
- [ ] All v1.18 phases have corresponding security tests
</verification>

<success_criteria>

- Security testing patterns documented in SECURITY_TESTING.md
- CI workflow ready for activation
- All v1.18 security features have regression tests
- v1.18 milestone security validation complete
</success_criteria>

<output>
After completion, create `.planning/phases/135-security-validation/135-02-SUMMARY.md`
</output>
