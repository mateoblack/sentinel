---
phase: 81-session-management
plan: 02
type: execute
wave: 2
depends_on: ["81-01"]
files_modified: [sentinel/server.go, sentinel/server_test.go, cli/sentinel_exec.go]
autonomous: true
---

<objective>
Integrate session tracking into SentinelServer to record active sessions on credential requests.

Purpose: Connect session storage to the server credential flow for real-time visibility into active sessions.
Output: SentinelServer creates and updates session records on each credential request.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/81-session-management/81-01-SUMMARY.md

# Server implementation to modify:
@sentinel/server.go
@cli/sentinel_exec.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session tracking to SentinelServerConfig</name>
  <files>sentinel/server.go</files>
  <action>
Extend SentinelServerConfig and SentinelServer to support session tracking:

1. Add to SentinelServerConfig:
   - SessionStore session.Store (optional, nil disables session tracking)
   - ServerInstanceID string (unique ID for this server instance, generated if empty)

2. Add to SentinelServer struct:
   - sessionID string (current session ID, created on startup)

3. In NewSentinelServer:
   - Generate ServerInstanceID if empty (use identity.NewRequestID() pattern)
   - If SessionStore is not nil:
     - Create new session with NewSessionID()
     - Set initial fields: User, Profile, ServerInstanceID, Status=Active, StartedAt=now, ExpiresAt=now+config.SessionDuration (or DefaultServerSessionDuration if 0)
     - Call SessionStore.Create()
     - Store sessionID in server struct
   - Session creation failures should be logged but not fail server startup (best-effort tracking)

4. In Shutdown:
   - If sessionID is set and SessionStore is not nil:
     - Get session, set Status=Expired, call Update
     - Log any errors but don't fail shutdown
  </action>
  <verify>go build ./sentinel/... compiles without errors</verify>
  <done>SentinelServer creates session on startup and marks expired on shutdown</done>
</task>

<task type="auto">
  <name>Task 2: Add session touch on credential issuance</name>
  <files>sentinel/server.go</files>
  <action>
Update DefaultRoute to touch session on successful credential issuance:

1. After successful credential retrieval (after writeCredsToResponse call):
   - If s.sessionID != "" && s.config.SessionStore != nil:
     - Call s.config.SessionStore.Touch(ctx, s.sessionID)
     - Log any errors but don't fail the request (best-effort tracking)

2. This updates LastAccessAt and increments RequestCount for the session.

3. Do NOT touch session on:
   - Policy denied (no credentials issued)
   - Credential retrieval failure
   - Auth token mismatch

Session touch is fire-and-forget - it should not impact credential serving latency or reliability.
  </action>
  <verify>go build ./sentinel/... compiles without errors</verify>
  <done>Session is touched on each successful credential issuance</done>
</task>

<task type="auto">
  <name>Task 3: Add session store to CLI exec command</name>
  <files>cli/sentinel_exec.go</files>
  <action>
Wire session store into the exec command for --server mode:

1. Add to SentinelExecCommandInput:
   - SessionTableName string (optional DynamoDB table for sessions)

2. Add CLI flag:
   - --session-table (string, optional) - DynamoDB table for session tracking

3. In configureSentinelServer (or wherever SentinelServerConfig is built):
   - If SessionTableName is set:
     - Create DynamoDB config (reuse existing pattern from break-glass/request stores)
     - Create session.NewDynamoDBStore(cfg, tableName)
     - Set SessionStore in SentinelServerConfig

4. Do NOT add --session-table to credential_process (not applicable - no server).

Session tracking is opt-in via the flag. Without the flag, no session table is created/used.
  </action>
  <verify>go build ./... compiles without errors</verify>
  <done>CLI --server mode can optionally track sessions in DynamoDB</done>
</task>

<task type="auto">
  <name>Task 4: Add tests for session integration</name>
  <files>sentinel/server_test.go</files>
  <action>
Add tests for session tracking in server mode:

1. TestSentinelServer_SessionCreation:
   - Create server with mock SessionStore
   - Verify Create called with correct fields (User, Profile, Status=Active)
   - Verify sessionID is set

2. TestSentinelServer_SessionTouch:
   - Create server with mock SessionStore
   - Issue credential request
   - Verify Touch called with session ID

3. TestSentinelServer_SessionShutdown:
   - Create server with mock SessionStore
   - Shutdown server
   - Verify Update called to set Status=Expired

4. TestSentinelServer_SessionTrackingOptional:
   - Create server without SessionStore
   - Verify no panic, server works normally

Use mock session store that tracks calls for verification. Follow existing server_test.go patterns.
  </action>
  <verify>go test ./sentinel/... -v passes all tests</verify>
  <done>Session tracking integration tested with mock store</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go build ./... succeeds
- [ ] go test ./sentinel/... passes
- [ ] Session created on server start
- [ ] Session touched on credential issuance
- [ ] Session marked expired on shutdown
- [ ] Session tracking is optional (nil store works)
</verification>

<success_criteria>
- All tasks completed
- SentinelServer integrates with session tracking
- Session lifecycle (create, touch, expire) works
- No impact on credential serving when session tracking disabled
</success_criteria>

<output>
After completion, create `.planning/phases/81-session-management/81-02-SUMMARY.md`
</output>
