---
phase: 81-session-management
plan: 03
type: execute
wave: 2
depends_on: ["81-01"]
files_modified: [cli/sentinel_server.go, cli/sentinel_server_test.go]
autonomous: true
---

<objective>
Add CLI commands for viewing and listing server sessions.

Purpose: Enable operators to inspect active server sessions for security monitoring.
Output: New `sentinel server sessions` and `sentinel server session <id>` commands.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/81-session-management/81-01-SUMMARY.md

# Existing CLI patterns to follow:
@cli/breakglass_list.go
@cli/sentinel_list.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sentinel server sessions list command</name>
  <files>cli/sentinel_server.go</files>
  <action>
Create new CLI command file for server session management, following breakglass_list.go patterns:

1. Define ServerSessionsCommandInput struct:
   - Region string
   - TableName string (required)
   - Status string (optional filter: active, revoked, expired)
   - User string (optional filter)
   - Profile string (optional filter)
   - Limit int
   - OutputFormat string (human, json)
   - AWSProfile string (for SSO credential loading)

2. Create ConfigureServerSessionsCommand function:
   - Register "server sessions" subcommand under "server" parent command
   - Flags:
     - --region (required)
     - --table (required, DynamoDB table name)
     - --status (optional, filter by status)
     - --user (optional, filter by user)
     - --profile (optional, filter by AWS profile served)
     - --limit (default 100)
     - --output (human, json)
     - --aws-profile (for SSO credential loading)

3. Create ServerSessionsCommand function:
   - Load AWS config with WithSharedConfigProfile pattern (SSO support)
   - Create session.NewDynamoDBStore
   - Call appropriate List method based on filters:
     - --status: ListByStatus
     - --user: ListByUser
     - --profile: ListByProfile
     - No filter: ListByStatus(active) (default to active sessions)
   - Format output:
     - Human: Table with ID, User, Profile, Status, StartedAt, LastAccessAt, RequestCount
     - JSON: Marshal sessions array

4. Register in main.go with existing command patterns.
  </action>
  <verify>go build ./... compiles without errors</verify>
  <done>sentinel server sessions command lists active sessions</done>
</task>

<task type="auto">
  <name>Task 2: Add sentinel server session detail command</name>
  <files>cli/sentinel_server.go</files>
  <action>
Add command to view single session details:

1. Define ServerSessionCommandInput struct:
   - Region string
   - TableName string
   - SessionID string (required, positional arg)
   - OutputFormat string
   - AWSProfile string

2. Create ConfigureServerSessionCommand function:
   - Register "server session" subcommand
   - Positional arg: session ID
   - Flags: --region, --table, --output, --aws-profile

3. Create ServerSessionCommand function:
   - Validate session ID format using session.ValidateSessionID
   - Load AWS config with SSO support
   - Create store, call Get(id)
   - Handle ErrSessionNotFound with clear error message
   - Format output:
     - Human: Detailed view with all fields including RevokedBy/Reason if applicable
     - JSON: Marshal session

Human format example:
```
Session: abc123def4567890
User: alice
Profile: production-admin
Status: active
Server Instance: xyz789...
Started: 2026-01-20T10:00:00Z
Last Access: 2026-01-20T10:15:00Z
Expires: 2026-01-20T10:30:00Z
Request Count: 42
Source Identity: sentinel:alice:req123
```
  </action>
  <verify>go build ./... compiles without errors</verify>
  <done>sentinel server session command shows session details</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for session CLI commands</name>
  <files>cli/sentinel_server_test.go</files>
  <action>
Create tests following cli/breakglass_list_test.go patterns:

1. Create mock session store for testing (or use testutil pattern if exists)

2. TestServerSessionsCommand_ListActive:
   - Mock store returns active sessions
   - Verify human output format
   - Verify JSON output format

3. TestServerSessionsCommand_FilterByStatus:
   - Test --status=revoked filter
   - Verify correct store method called

4. TestServerSessionsCommand_FilterByUser:
   - Test --user filter
   - Verify ListByUser called

5. TestServerSessionCommand_GetByID:
   - Mock store returns session
   - Verify all fields displayed

6. TestServerSessionCommand_NotFound:
   - Mock store returns ErrSessionNotFound
   - Verify error message

7. TestServerSessionCommand_InvalidID:
   - Pass invalid session ID format
   - Verify validation error before store call

Use testable command pattern (testableServerSessionsCommand) if CLI requires it for mock injection.
  </action>
  <verify>go test ./cli/... -v passes session tests</verify>
  <done>CLI commands tested with mock store</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go build ./... succeeds
- [ ] go test ./cli/... passes
- [ ] sentinel server sessions lists sessions
- [ ] sentinel server session <id> shows details
- [ ] Human and JSON output formats work
- [ ] Filter flags work correctly
</verification>

<success_criteria>
- All tasks completed
- Session listing and detail commands functional
- Output formats match existing CLI patterns
- SSO profile loading works via --aws-profile
</success_criteria>

<output>
After completion, create `.planning/phases/81-session-management/81-03-SUMMARY.md`
</output>
