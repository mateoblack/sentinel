---
phase: 149-cloudtrail-monitoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - deploy/monitoring.go
  - deploy/monitoring_test.go
  - cli/monitoring.go
  - cli/monitoring_test.go
autonomous: true
---

<objective>
Implement CloudTrail monitoring with CloudWatch alarms for Sentinel security events.

Purpose: Enable users to detect and alert on security-critical events affecting Sentinel infrastructure (KMS key changes, DynamoDB deletions, SSM parameter deletions, unmanaged AssumeRole calls).

Output: New `sentinel monitoring setup` command that creates CloudWatch alarms with SNS notification topic for security event alerting.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summary (SSM hardening patterns, confirmation prompts)
@.planning/phases/148-ssm-hardening/148-01-SUMMARY.md

# Existing audit code (patterns for CloudWatch, deployment findings)
@deploy/audit.go

# CLI patterns for infrastructure commands
@cli/dynamodb.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deploy/monitoring.go with MonitoringSetup</name>
  <files>deploy/monitoring.go, deploy/monitoring_test.go</files>
  <action>
Create deploy/monitoring.go with CloudWatch alarm creation capabilities:

1. Define CloudWatch and SNS API interfaces:
   ```go
   // cloudwatchAlarmsAPI defines CloudWatch operations for alarm management.
   type cloudwatchAlarmsAPI interface {
       PutMetricAlarm(ctx context.Context, params *cloudwatch.PutMetricAlarmInput, optFns ...func(*cloudwatch.Options)) (*cloudwatch.PutMetricAlarmOutput, error)
       DescribeAlarms(ctx context.Context, params *cloudwatch.DescribeAlarmsInput, optFns ...func(*cloudwatch.Options)) (*cloudwatch.DescribeAlarmsOutput, error)
   }

   // snsAPI defines SNS operations for topic management.
   type snsAPI interface {
       CreateTopic(ctx context.Context, params *sns.CreateTopicInput, optFns ...func(*sns.Options)) (*sns.CreateTopicOutput, error)
       Subscribe(ctx context.Context, params *sns.SubscribeInput, optFns ...func(*sns.Options)) (*sns.SubscribeOutput, error)
   }

   // cloudwatchLogsMonitorAPI defines CloudWatch Logs operations for metric filters.
   type cloudwatchLogsMonitorAPI interface {
       PutMetricFilter(ctx context.Context, params *cloudwatchlogs.PutMetricFilterInput, optFns ...func(*cloudwatchlogs.Options)) (*cloudwatchlogs.PutMetricFilterOutput, error)
       DescribeMetricFilters(ctx context.Context, params *cloudwatchlogs.DescribeMetricFiltersInput, optFns ...func(*cloudwatchlogs.Options)) (*cloudwatchlogs.DescribeMetricFiltersOutput, error)
   }
   ```

2. Create MonitoringSetup struct:
   ```go
   type MonitoringSetup struct {
       cloudwatch     cloudwatchAlarmsAPI
       sns            snsAPI
       cloudwatchLogs cloudwatchLogsMonitorAPI
   }
   ```

3. Define alarm configuration types:
   ```go
   // AlarmConfig describes a CloudWatch alarm to create.
   type AlarmConfig struct {
       Name              string   `json:"name"`
       Description       string   `json:"description"`
       MetricName        string   `json:"metric_name"`
       Namespace         string   `json:"namespace"`
       Statistic         string   `json:"statistic"`
       Period            int32    `json:"period"`
       EvaluationPeriods int32    `json:"evaluation_periods"`
       Threshold         float64  `json:"threshold"`
       ComparisonOp      string   `json:"comparison_operator"`
   }

   // MetricFilterConfig describes a CloudWatch Logs metric filter.
   type MetricFilterConfig struct {
       Name          string `json:"name"`
       LogGroupName  string `json:"log_group_name"`
       FilterPattern string `json:"filter_pattern"`
       MetricName    string `json:"metric_name"`
       Namespace     string `json:"namespace"`
   }

   // MonitoringResult contains the result of setting up monitoring.
   type MonitoringResult struct {
       SNSTopicARN       string   `json:"sns_topic_arn"`
       AlarmsCreated     []string `json:"alarms_created"`
       FiltersCreated    []string `json:"filters_created"`
       AlarmsSkipped     []string `json:"alarms_skipped,omitempty"`
       Errors            []string `json:"errors,omitempty"`
   }
   ```

4. Define default alarm configurations as constants:
   - KMS key state changes: Filter pattern for DisableKey, ScheduleKeyDeletion events
   - DynamoDB DeleteTable: Filter pattern for DeleteTable eventName with sentinel table prefix
   - SSM DeleteParameter: Filter pattern for DeleteParameter eventName with /sentinel/ path
   - AssumeRole without SourceIdentity: Filter pattern for AssumeRole missing sourceIdentity field

5. Implement CreateOrGetSNSTopic:
   ```go
   // CreateOrGetSNSTopic creates an SNS topic for alarm notifications or returns existing ARN.
   func (m *MonitoringSetup) CreateOrGetSNSTopic(ctx context.Context, topicName string) (string, error)
   ```

6. Implement SubscribeEmail:
   ```go
   // SubscribeEmail adds an email subscription to the SNS topic.
   func (m *MonitoringSetup) SubscribeEmail(ctx context.Context, topicARN, email string) error
   ```

7. Implement CreateMetricFilter:
   ```go
   // CreateMetricFilter creates a CloudWatch Logs metric filter for CloudTrail events.
   func (m *MonitoringSetup) CreateMetricFilter(ctx context.Context, config MetricFilterConfig) error
   ```

8. Implement CreateAlarm:
   ```go
   // CreateAlarm creates a CloudWatch alarm for a metric.
   func (m *MonitoringSetup) CreateAlarm(ctx context.Context, config AlarmConfig, snsTopicARN string) error
   ```

9. Implement SetupSentinelMonitoring (main entry point):
   ```go
   // SetupSentinelMonitoring creates all recommended alarms for Sentinel infrastructure.
   // Requires CloudTrail log group name where CloudTrail events are delivered.
   func (m *MonitoringSetup) SetupSentinelMonitoring(ctx context.Context, cloudTrailLogGroup string, snsTopicName string, email string) (*MonitoringResult, error)
   ```

10. Implement GetDefaultMetricFilters returning the 4 standard filters:
    - sentinel-kms-key-changes: `{ ($.eventName = "DisableKey") || ($.eventName = "ScheduleKeyDeletion") }`
    - sentinel-dynamodb-delete: `{ ($.eventName = "DeleteTable") && ($.requestParameters.tableName = "sentinel-*") }`
    - sentinel-ssm-delete: `{ ($.eventName = "DeleteParameter") && ($.requestParameters.name = "/sentinel/*") }`
    - sentinel-unmanaged-assume-role: `{ ($.eventName = "AssumeRole") && NOT ($.requestParameters.sourceIdentity = *) }`

11. Implement GetDefaultAlarms returning alarm configs for each metric filter.
    - Threshold: 1 (single occurrence triggers)
    - Period: 300 seconds (5 minutes)
    - EvaluationPeriods: 1
    - ComparisonOperator: GreaterThanOrEqualToThreshold

12. Add NewMonitoringSetup and NewMonitoringSetupWithClients constructors.

13. Create tests in deploy/monitoring_test.go covering:
    - CreateOrGetSNSTopic creates new topic
    - CreateOrGetSNSTopic with existing topic
    - SubscribeEmail creates subscription
    - CreateMetricFilter creates filter
    - CreateAlarm creates alarm with SNS action
    - SetupSentinelMonitoring creates all resources
    - AccessDenied error handling
  </action>
  <verify>go test ./deploy/... -run TestMonitoring -v passes</verify>
  <done>MonitoringSetup creates SNS topic, metric filters, and CloudWatch alarms for Sentinel security events</done>
</task>

<task type="auto">
  <name>Task 2: Add sentinel monitoring setup CLI command</name>
  <files>cli/monitoring.go, cli/monitoring_test.go</files>
  <action>
Create cli/monitoring.go with monitoring setup command:

1. MonitoringSetupCommandInput struct:
   ```go
   type MonitoringSetupCommandInput struct {
       CloudTrailLogGroup string   // CloudTrail log group name (required)
       SNSTopicName       string   // SNS topic name (default: "sentinel-security-alerts")
       Email              string   // Email for notifications (optional)
       Alarms             []string // Specific alarms to create (empty = all)
       DryRun             bool     // Preview without creating
       Force              bool     // Skip confirmation prompt
       JSONOutput         bool     // Output in JSON format
       AWSProfile         string   // AWS profile for credentials
       Region             string   // AWS region

       // For testing
       Setup  *deploy.MonitoringSetup
       Stdout *os.File
       Stderr *os.File
       Stdin  *os.File
   }
   ```

2. ConfigureMonitoringCommands:
   - Create "monitoring" command group under app
   - Add "setup" subcommand: `sentinel monitoring setup`
   - Flags:
     - `--log-group, -l` - CloudTrail log group name (required)
     - `--topic-name` - SNS topic name (default: "sentinel-security-alerts")
     - `--email, -e` - Email address for notifications
     - `--alarm` - Specific alarm to create (repeatable): kms, dynamodb, ssm, assume-role
     - `--dry-run` - Preview what would be created
     - `--force, -f` - Skip confirmation prompt
     - `--json` - Output in JSON format
     - `--aws-profile` - AWS profile
     - `--region` - AWS region

3. MonitoringSetupCommand logic:
   - Validate --log-group is provided (error if not)
   - Get list of alarms to create (all if --alarm not specified)
   - Show what will be created:
     ```
     Sentinel CloudTrail Monitoring Setup
     =====================================

     CloudTrail Log Group: aws-cloudtrail-logs-123456789012
     SNS Topic: sentinel-security-alerts

     Alarms to create (4):

       Alarm Name                         Event Type              Trigger
       ----------                         ----------              -------
       sentinel-kms-key-changes           KMS DisableKey/Delete   Single occurrence
       sentinel-dynamodb-delete           DynamoDB DeleteTable    Single occurrence
       sentinel-ssm-delete                SSM DeleteParameter     Single occurrence
       sentinel-unmanaged-assume-role     AssumeRole no identity  Single occurrence

     [If --email provided:]
     Notifications will be sent to: security@example.com

     Create monitoring resources? [Y/n]
     ```
   - If --dry-run, show preview and exit (exit code 0)
   - If not --force, prompt for confirmation (default Y for setup since non-destructive)
   - Call SetupSentinelMonitoring and report results
   - If --email provided, note that confirmation email will be sent

4. Human-readable output format:
   ```
   Creating SNS topic...
   ✓ SNS topic created: arn:aws:sns:us-west-2:123456789012:sentinel-security-alerts

   Creating metric filters...
   ✓ sentinel-kms-key-changes filter created
   ✓ sentinel-dynamodb-delete filter created
   ✓ sentinel-ssm-delete filter created
   ✓ sentinel-unmanaged-assume-role filter created

   Creating CloudWatch alarms...
   ✓ sentinel-kms-key-changes alarm created
   ✓ sentinel-dynamodb-delete alarm created
   ✓ sentinel-ssm-delete alarm created
   ✓ sentinel-unmanaged-assume-role alarm created

   [If email provided:]
   Email subscription requested: security@example.com
   Note: Check inbox and confirm subscription to receive alerts.

   Summary: 4 alarms created, notifications to sentinel-security-alerts
   ```

5. JSON output format:
   ```json
   {
     "sns_topic_arn": "arn:aws:sns:us-west-2:123456789012:sentinel-security-alerts",
     "alarms_created": ["sentinel-kms-key-changes", "sentinel-dynamodb-delete", "sentinel-ssm-delete", "sentinel-unmanaged-assume-role"],
     "filters_created": ["sentinel-kms-key-changes", "sentinel-dynamodb-delete", "sentinel-ssm-delete", "sentinel-unmanaged-assume-role"],
     "email_subscribed": "security@example.com"
   }
   ```

6. Exit codes:
   - 0: Success (all alarms created)
   - 1: Failure (missing log group, access denied, creation failed)
   - 2: User cancelled at confirmation prompt

7. Create tests covering:
   - Setup with all default alarms
   - Setup with specific --alarm selection
   - Setup with --email subscription
   - --dry-run shows preview without creating
   - Confirmation prompt works correctly
   - --force bypasses confirmation
   - JSON output format
   - Missing --log-group error
   - AccessDenied error handling
  </action>
  <verify>go test ./cli/... -run TestMonitoring -v passes</verify>
  <done>sentinel monitoring setup command creates CloudWatch alarms with SNS notification for Sentinel security events</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test ./deploy/... -v passes
- [ ] go test ./cli/... -run Monitoring -v passes
- [ ] gofmt -l . shows no formatting issues
- [ ] No new lint warnings introduced
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- MonitoringSetup creates SNS topic for notifications
- MonitoringSetup creates metric filters for CloudTrail log group
- MonitoringSetup creates CloudWatch alarms for 4 security event types
- Alarms trigger on single occurrence (threshold=1)
- CLI shows preview before creating resources
- --dry-run allows viewing without creating
- Email subscription with confirmation note
- Exit codes reflect operation status
</success_criteria>

<output>
After completion, create `.planning/phases/149-cloudtrail-monitoring/149-01-SUMMARY.md`
</output>
