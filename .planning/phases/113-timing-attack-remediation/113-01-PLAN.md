---
phase: 113-timing-attack-remediation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/ecsserver.go
  - sentinel/server.go
  - sentinel/server_security_test.go
autonomous: true
---

<objective>
Fix bearer token comparison timing attack vulnerability using crypto/subtle.ConstantTimeCompare().

Purpose: Prevent timing-based attacks that could extract bearer tokens by measuring response time variations during string comparison.

Output: Both ECS server and Sentinel server use constant-time comparison for Authorization header validation, with security regression tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@server/ecsserver.go
@sentinel/server.go
@sentinel/threat_model_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix timing attack in withAuthorizationCheck functions</name>
  <files>server/ecsserver.go, sentinel/server.go</files>
  <action>
Replace direct string comparison with constant-time comparison in both withAuthorizationCheck functions:

**server/ecsserver.go line 31:**
Change:
```go
if r.Header.Get("Authorization") != authToken {
```
To:
```go
if subtle.ConstantTimeCompare([]byte(r.Header.Get("Authorization")), []byte(authToken)) != 1 {
```

Add import at top of file:
```go
"crypto/subtle"
```

**sentinel/server.go line 436:**
Same change - replace direct comparison with subtle.ConstantTimeCompare.
Add "crypto/subtle" import.

WHY: Direct string comparison `!=` returns early on first mismatched byte, leaking timing information. An attacker can measure response times to extract the token byte-by-byte. ConstantTimeCompare always compares all bytes regardless of mismatch position.

NOTE: Both strings should be converted to []byte for the comparison. The function returns 1 if equal, 0 otherwise.
  </action>
  <verify>
```bash
# Verify both files compile
go build ./server/...
go build ./sentinel/...

# Verify import is correct
grep -n "crypto/subtle" server/ecsserver.go sentinel/server.go

# Verify the fix is applied
grep -n "ConstantTimeCompare" server/ecsserver.go sentinel/server.go
```
  </verify>
  <done>Both withAuthorizationCheck functions use subtle.ConstantTimeCompare() instead of direct string comparison</done>
</task>

<task type="auto">
  <name>Task 2: Add security regression tests for timing-safe comparison</name>
  <files>sentinel/server_security_test.go</files>
  <action>
Create new test file sentinel/server_security_test.go with security regression tests following the TestThreat_* pattern from threat_model_test.go.

Tests to add:

1. **TestThreat_TimingAttack_AuthorizationUsesConstantTimeCompare**
   - Document the threat: timing attacks on bearer token comparison
   - Document the mitigation: crypto/subtle.ConstantTimeCompare
   - Test: Use reflection or source inspection to verify subtle package is imported and used
   - Alternative: Test that both valid and invalid tokens take similar time (flaky in CI, prefer static analysis)

2. **TestSecurityRegression_AuthorizationHeaderTiming**
   - Create a test server with known auth token
   - Make requests with correct token (should succeed with 200)
   - Make requests with wrong token (should fail with 403)
   - Make requests with empty token (should fail with 403)
   - Make requests with partial token prefix (should fail with 403)
   - Verify the correct status codes are returned
   - Mark test with "// SECURITY: Verifies constant-time auth comparison"

3. **TestSecurityRegression_AuthorizationRejectsPartialMatch**
   - Test that a partial prefix of the correct token still fails
   - This proves we're not doing early-exit comparison
   - Use token "secret123" and test with "secret", "secre", "sec" etc.

Follow existing patterns in sentinel/threat_model_test.go for documentation style.
Add package comment explaining this file tests timing attack mitigations.
  </action>
  <verify>
```bash
# Run the new security tests
go test -v ./sentinel/... -run "TestThreat_TimingAttack|TestSecurityRegression_Authorization"

# Verify test file exists with expected content
grep -l "ConstantTimeCompare\|TimingAttack" sentinel/server_security_test.go
```
  </verify>
  <done>Security regression tests exist in sentinel/server_security_test.go validating constant-time authorization comparison</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds without errors
- [ ] `go test ./server/... ./sentinel/...` passes all tests
- [ ] Both ecsserver.go and server.go use subtle.ConstantTimeCompare
- [ ] Security regression tests document and validate the timing attack fix
- [ ] No other string comparisons for sensitive values remain in auth code
</verification>

<success_criteria>

- Both withAuthorizationCheck functions use crypto/subtle.ConstantTimeCompare()
- Security regression tests validate timing-safe comparison
- All existing tests pass
- Build succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/113-timing-attack-remediation/113-01-SUMMARY.md`
</output>
