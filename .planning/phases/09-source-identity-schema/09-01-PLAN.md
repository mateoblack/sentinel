---
phase: 09-source-identity-schema
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [identity/types.go, identity/request_id.go, identity/types_test.go, identity/request_id_test.go]
autonomous: true
---

<objective>
Define SourceIdentity format and request-id generation for AWS STS SourceIdentity stamping.

Purpose: SourceIdentity (`sentinel:<user>:<request-id>`) will be stamped on all AssumeRole calls, making Sentinel's access decisions visible and enforceable inside AWS. This phase defines the data structures and generation logic.

Output: `identity` package with SourceIdentity type, request-id generation, and validation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Relevant source files
@logging/decision.go - See DecisionLogEntry pattern for structured types
@policy/types.go - See Effect type pattern with IsValid/String methods
</context>

<constraints>
**AWS SourceIdentity constraints:**
- Maximum 64 characters
- Allowed: alphanumeric, `=,.@-` characters
- Set once on AssumeRole, immutable for session lifetime
- Propagates through role chaining (session tags)

**Format design:**
- Format: `sentinel:<user>:<request-id>`
- User: sanitized username (alphanumeric, max 20 chars)
- Request-ID: 8-character hex string (32 bits of entropy)
- Total max: `sentinel:` (9) + user (20) + `:` (1) + request-id (8) = 38 chars (well under 64)
</constraints>

<tasks>

<task type="auto">
  <name>Task 1: Create SourceIdentity type with format and validation</name>
  <files>identity/types.go</files>
  <action>
Create new `identity` package with:

1. `SourceIdentity` struct with User and RequestID fields
2. `Format()` method returning `sentinel:<user>:<request-id>` string
3. `IsValid()` method checking:
   - User is non-empty and ≤20 chars
   - User contains only alphanumeric chars (sanitize or reject)
   - RequestID is exactly 8 hex characters
   - Total formatted length ≤64 chars
4. `Parse(s string) (*SourceIdentity, error)` function to parse existing SourceIdentity strings
5. Document the format in package-level GoDoc

Follow existing type patterns from policy/types.go (Effect type with IsValid/String methods).
  </action>
  <verify>go build ./identity/... compiles without errors</verify>
  <done>SourceIdentity type exists with Format, IsValid, Parse, and String methods</done>
</task>

<task type="auto">
  <name>Task 2: Implement request-id generation</name>
  <files>identity/request_id.go</files>
  <action>
Create request-id generation:

1. `NewRequestID() string` - generates 8-character lowercase hex string
2. Use `crypto/rand` for cryptographic randomness (not math/rand)
3. Generate 4 random bytes, encode as hex = 8 chars
4. `ValidateRequestID(id string) bool` - checks format (8 hex chars, lowercase)

Request-ID provides:
- Uniqueness per credential request
- Correlation between Sentinel logs and CloudTrail events
- No PII or sensitive data (just random identifier)
  </action>
  <verify>go build ./identity/... compiles without errors</verify>
  <done>NewRequestID generates valid 8-char hex IDs, ValidateRequestID validates format</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for SourceIdentity and request-id</name>
  <files>identity/types_test.go, identity/request_id_test.go</files>
  <action>
Create comprehensive tests:

**types_test.go:**
- TestSourceIdentity_Format: verify format string output
- TestSourceIdentity_IsValid: valid cases, invalid user (empty, too long, special chars), invalid request-id
- TestParse: round-trip Format -> Parse, invalid inputs
- TestSourceIdentity_LengthConstraint: verify total length ≤64

**request_id_test.go:**
- TestNewRequestID_Format: verify 8 hex chars
- TestNewRequestID_Uniqueness: generate 1000 IDs, verify no collisions
- TestValidateRequestID: valid IDs, invalid (too short, too long, non-hex, uppercase)

Use table-driven test pattern consistent with policy/*_test.go.
  </action>
  <verify>go test ./identity/... -v passes all tests</verify>
  <done>All tests pass, coverage includes edge cases and validation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./identity/...` succeeds
- [ ] `go test ./identity/...` passes all tests
- [ ] `go vet ./identity/...` reports no issues
- [ ] SourceIdentity.Format() produces `sentinel:<user>:<request-id>` format
- [ ] Format length never exceeds 64 characters
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- identity package compiles and tests pass
- SourceIdentity format matches spec: `sentinel:<user>:<request-id>`
- Request-ID is cryptographically random 8-char hex
</success_criteria>

<output>
After completion, create `.planning/phases/09-source-identity-schema/09-01-SUMMARY.md`
</output>
