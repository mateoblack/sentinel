---
phase: 122-policy-pull-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [cli/policy.go, cli/policy_test.go]
autonomous: true
---

<objective>
Implement `sentinel policy pull` command to fetch policy from SSM Parameter Store and output to stdout or file.

Purpose: Enable developers to fetch policies for local editing, review, or backup before making changes.
Output: cli/policy.go with PolicyPullCommand and comprehensive tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/121-policy-schema-enhancements/121-01-SUMMARY.md

# Phase 121 provides:
# - policy.MarshalPolicy for serializing Policy to YAML
# - policy.MarshalPolicyToWriter for writing to io.Writer
# - policy.ValidatePolicy for validation (used later in Phase 125)

# Existing patterns to follow:
@cli/config.go (CLI command structure, AWS config loading, SSM fetch pattern)
@policy/loader.go (SSM loading via SSMAPI interface)
@bootstrap/types.go (DefaultPolicyRoot, DefaultPolicyParameterName constants)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create policy command with pull subcommand</name>
  <files>cli/policy.go</files>
  <action>
Create cli/policy.go with PolicyPullCommand:

1. PolicyPullCommandInput struct with fields:
   - Profile string (positional arg - the AWS profile name to pull policy for)
   - PolicyRoot string (--policy-root flag, default bootstrap.DefaultPolicyRoot)
   - PolicyParameter string (--policy-parameter flag, explicit SSM path override)
   - OutputFile string (--output / -o flag, empty = stdout)
   - Region string (--region flag for SSM operations)
   - AWSProfile string (--aws-profile flag for credentials)
   - Stdout/Stderr *os.File (for testing)
   - SSMClient policy.SSMAPI (for testing, nil = create from AWS config)

2. ConfigurePolicyCommand function:
   - Creates `policy` parent command
   - Creates `pull` subcommand with profile positional argument
   - Flags match existing patterns from cli/config.go

3. PolicyPullCommand function:
   - Determines SSM parameter path:
     a. If PolicyParameter provided, use it directly
     b. Otherwise, use bootstrap.DefaultPolicyParameterName(PolicyRoot, Profile)
   - Loads AWS config with optional region and profile (awsconfig.WithSharedConfigProfile, awsconfig.WithRegion)
   - Creates policy.Loader (or uses injected SSMClient for testing)
   - Calls loader.Load(ctx, parameterPath)
   - On ErrPolicyNotFound: print error to stderr with suggestion, return exit code 1
   - On other error: print error to stderr, return exit code 1
   - On success: Marshal policy with policy.MarshalPolicy
   - If OutputFile specified: write to file with os.WriteFile
   - Otherwise: write to stdout
   - Return exit code 0 on success

4. Output format:
   - YAML to stdout (clean, no prefix)
   - If writing to file: print "Policy written to {filename}" to stderr

Follow cli/config.go patterns exactly for:
- AWS config loading with profile and region options
- Error formatting with suggestions
- Exit code handling
- I/O injection for testing
  </action>
  <verify>go build ./... succeeds</verify>
  <done>cli/policy.go exists with ConfigurePolicyCommand and PolicyPullCommand functions</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for policy pull command</name>
  <files>cli/policy_test.go</files>
  <action>
Create cli/policy_test.go with comprehensive test coverage:

1. MockSSMClient struct implementing policy.SSMAPI:
   - Policies map[string]string (parameter name -> YAML content)
   - GetParameter returns policy from map or ParameterNotFound error
   - Follow pattern from policy/loader_test.go

2. Test cases for PolicyPullCommand:
   a. TestPolicyPullCommand_Success:
      - Mock SSM returns valid policy YAML
      - Verify output is valid YAML
      - Verify exit code 0

   b. TestPolicyPullCommand_WriteToFile:
      - Mock SSM returns valid policy
      - Use temp file for output
      - Verify file contains expected YAML
      - Verify stderr message "Policy written to..."
      - Verify exit code 0

   c. TestPolicyPullCommand_NotFound:
      - Mock SSM returns ParameterNotFound
      - Verify stderr contains error message
      - Verify exit code 1

   d. TestPolicyPullCommand_ExplicitPolicyParameter:
      - Provide --policy-parameter flag
      - Verify that explicit path is used (not derived from profile)
      - Verify exit code 0

   e. TestPolicyPullCommand_DefaultPolicyRoot:
      - Only profile provided
      - Verify parameter path is {DefaultPolicyRoot}/{profile}

   f. TestPolicyPullCommand_CustomPolicyRoot:
      - Provide --policy-root flag
      - Verify parameter path uses custom root

3. Use bytes.Buffer for stdout/stderr capture
4. Use t.TempDir() for file output tests
5. Follow existing test patterns from cli/config_test.go

Test policy YAML should be minimal but valid:
```yaml
version: "1"
rules:
  - effect: allow
    profiles: ["*"]
```
  </action>
  <verify>go test ./cli -run TestPolicyPull -v passes</verify>
  <done>All policy pull tests pass, covering success, file output, not found, and parameter resolution</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `go test ./cli -run TestPolicyPull -v` passes
- [ ] `go vet ./cli` passes
- [ ] No linting errors from golangci-lint (if configured)
</verification>

<success_criteria>

- Policy pull command registered under `sentinel policy pull <profile>`
- Fetches policy from SSM and outputs clean YAML
- Supports --output flag for file writing
- Supports --policy-root and --policy-parameter for path customization
- Supports --region and --aws-profile for AWS configuration
- Returns exit code 1 with helpful error message on not found
- All tests pass with good coverage of edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/122-policy-pull-command/122-01-SUMMARY.md`
</output>
