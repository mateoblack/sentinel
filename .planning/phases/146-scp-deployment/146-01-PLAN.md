---
phase: 146-scp-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - deploy/scp.go
  - deploy/scp_test.go
  - cli/scp.go
  - cli/scp_test.go
autonomous: true
---

<objective>
Implement SCP deployment command for deploying recommended SCPs to enforce Sentinel requirements.

Purpose: Enable users to deploy SourceIdentity enforcement SCPs to their AWS organization with a single command, preventing credential bypass attacks where non-Sentinel credentials could be used.

Output: New `sentinel scp deploy` command with dry-run preview, OU targeting, and permission validation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summary (deployment validation patterns, SCP audit)
@.planning/phases/145-deployment-validation/145-01-SUMMARY.md

# Existing SCP auditing code
@deploy/scp.go
@deploy/scp_test.go

# CLI patterns
@cli/deploy.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend deploy/scp.go with SCP deployment capabilities</name>
  <files>deploy/scp.go, deploy/scp_test.go</files>
  <action>
Extend the existing SCPAuditor to add SCP deployment capabilities:

1. Define organizationsDeployAPI interface extending existing organizationsAuditAPI:
   ```go
   // organizationsDeployAPI extends audit operations with deployment capabilities.
   type organizationsDeployAPI interface {
       // Audit operations (existing)
       ListPolicies(ctx context.Context, params *organizations.ListPoliciesInput, optFns ...func(*organizations.Options)) (*organizations.ListPoliciesOutput, error)
       DescribePolicy(ctx context.Context, params *organizations.DescribePolicyInput, optFns ...func(*organizations.Options)) (*organizations.DescribePolicyOutput, error)
       ListTargetsForPolicy(ctx context.Context, params *organizations.ListTargetsForPolicyInput, optFns ...func(*organizations.Options)) (*organizations.ListTargetsForPolicyOutput, error)

       // Deployment operations (new)
       CreatePolicy(ctx context.Context, params *organizations.CreatePolicyInput, optFns ...func(*organizations.Options)) (*organizations.CreatePolicyOutput, error)
       AttachPolicy(ctx context.Context, params *organizations.AttachPolicyInput, optFns ...func(*organizations.Options)) (*organizations.AttachPolicyOutput, error)
       UpdatePolicy(ctx context.Context, params *organizations.UpdatePolicyInput, optFns ...func(*organizations.Options)) (*organizations.UpdatePolicyOutput, error)
       ListRoots(ctx context.Context, params *organizations.ListRootsInput, optFns ...func(*organizations.Options)) (*organizations.ListRootsOutput, error)
       ListOrganizationalUnitsForParent(ctx context.Context, params *organizations.ListOrganizationalUnitsForParentInput, optFns ...func(*organizations.Options)) (*organizations.ListOrganizationalUnitsForParentOutput, error)
   }
   ```

2. Create SCPDeployer struct:
   ```go
   type SCPDeployer struct {
       orgs organizationsDeployAPI
   }
   ```

3. Define SentinelSCPPolicy constant with recommended SCP JSON:
   ```go
   const SentinelSCPPolicy = `{
     "Version": "2012-10-17",
     "Statement": [
       {
         "Sid": "DenyAssumeRoleWithoutSourceIdentity",
         "Effect": "Deny",
         "Action": "sts:AssumeRole",
         "Resource": "*",
         "Condition": {
           "Null": {
             "sts:SourceIdentity": "true"
           }
         }
       }
     ]
   }`

   const SentinelSCPName = "SentinelSourceIdentityEnforcement"
   const SentinelSCPDescription = "Enforces SourceIdentity for all AssumeRole operations to enable Sentinel credential tracking"
   ```

4. Implement DeploySCP method:
   ```go
   // DeployResult contains the result of an SCP deployment.
   type DeployResult struct {
       PolicyID   string
       PolicyARN  string
       Created    bool   // true if new policy created, false if updated
       Targets    []string // IDs of targets the policy is attached to
   }

   // DeploySCP creates or updates the Sentinel SCP and attaches it to the specified target.
   // If targetID is empty, attaches to the organization root.
   func (d *SCPDeployer) DeploySCP(ctx context.Context, targetID string) (*DeployResult, error)
   ```

5. Implement helper methods:
   - `GetOrganizationRoot(ctx) (string, error)` - returns root ID
   - `FindExistingSentinelSCP(ctx) (string, error)` - returns policy ID if exists, empty if not
   - `ValidatePermissions(ctx) error` - validates required IAM permissions before deployment

6. Implement permission validation that checks:
   - organizations:CreatePolicy
   - organizations:AttachPolicy
   - organizations:UpdatePolicy
   - organizations:ListPolicies
   - organizations:ListRoots

7. Add tests covering:
   - Create new SCP when none exists
   - Update existing SCP with same name
   - Attach to root when no target specified
   - Attach to specific OU when target specified
   - Permission validation errors (AccessDenied)
   - Not in organization error handling
  </action>
  <verify>go test ./deploy/... -run TestSCPDeploy -v passes</verify>
  <done>SCPDeployer creates/updates Sentinel SCP and attaches to specified target with permission validation</done>
</task>

<task type="auto">
  <name>Task 2: Add sentinel scp deploy CLI command</name>
  <files>cli/scp.go, cli/scp_test.go</files>
  <action>
Create cli/scp.go with SCPDeployCommand:

1. SCPDeployCommandInput struct:
   ```go
   type SCPDeployCommandInput struct {
       DryRun     bool     // Preview policy without deploying
       TargetOU   string   // OU ID to attach policy (empty = root)
       Force      bool     // Skip confirmation prompt
       AWSProfile string   // AWS profile for credentials
       Region     string   // AWS region

       // For testing
       Deployer *deploy.SCPDeployer
       Stdout   *os.File
       Stderr   *os.File
       Stdin    *os.File  // For confirmation prompt
   }
   ```

2. ConfigureSCPDeployCommand:
   - Create "scp" command group under app
   - Add "deploy" subcommand: `sentinel scp deploy`
   - Flags:
     - `--dry-run` - Preview SCP policy document without deploying
     - `--target-ou` - OU ID to attach (default: organization root)
     - `--force, -f` - Skip confirmation prompt
     - `--aws-profile` - AWS profile
     - `--region` - AWS region

3. SCPDeployCommand logic:
   - If --dry-run: Print SCP policy JSON and target info, then exit 0
   - Otherwise:
     a. Validate IAM permissions (via deployer.ValidatePermissions)
     b. Show what will be deployed and target
     c. If not --force, prompt for confirmation: "Deploy SCP to {target}? [y/N]"
     d. Create/update SCP via deployer.DeploySCP
     e. Output results

4. Human-readable output format:
   ```
   Sentinel SCP Deployment
   =======================

   Policy Name: SentinelSourceIdentityEnforcement
   Target:      Organization Root (r-xxxx)
   Action:      Create new policy

   Policy Content:
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Sid": "DenyAssumeRoleWithoutSourceIdentity",
         "Effect": "Deny",
         "Action": "sts:AssumeRole",
         "Resource": "*",
         "Condition": {
           "Null": {
             "sts:SourceIdentity": "true"
           }
         }
       }
     ]
   }

   Deploy SCP to Organization Root (r-xxxx)? [y/N] y

   âœ“ SCP deployed successfully
     Policy ID: p-xxxxxxxxxx
     Policy ARN: arn:aws:organizations::123456789012:policy/o-xxxx/service_control_policy/p-xxxxxxxxxx
     Attached to: r-xxxx
   ```

5. Dry-run output:
   ```
   Sentinel SCP Deployment (Dry Run)
   ==================================

   Policy Name: SentinelSourceIdentityEnforcement
   Target:      Organization Root (r-xxxx)
   Action:      Would create new policy

   Policy Content:
   {policy JSON}

   Run without --dry-run to deploy this SCP.
   ```

6. Exit codes:
   - 0: Success (or dry-run completed)
   - 1: Deployment failed or permission denied
   - 2: User cancelled at confirmation prompt

7. Create tests:
   - Dry-run outputs policy without deploying
   - Confirmation prompt works correctly
   - --force bypasses confirmation
   - Permission validation failure
   - Successful deployment with root target
   - Successful deployment with OU target
  </action>
  <verify>go test ./cli/... -run TestSCPDeploy -v passes</verify>
  <done>sentinel scp deploy command with dry-run preview, OU targeting, confirmation prompt, and permission validation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test ./deploy/... -v passes
- [ ] go test ./cli/... -run SCP -v passes
- [ ] gofmt -l . shows no formatting issues
- [ ] No new lint warnings introduced
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- SCPDeployer implements create/update/attach operations
- Permission validation prevents partial failures
- Dry-run flag previews policy without deploying
- Target OU flag allows scoped deployment (not just root)
- Confirmation prompt unless --force
- Exit codes reflect deployment status
</success_criteria>

<output>
After completion, create `.planning/phases/146-scp-deployment/146-01-SUMMARY.md`
</output>
