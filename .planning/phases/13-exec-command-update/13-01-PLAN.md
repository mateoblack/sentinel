---
phase: 13-exec-command-update
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [cli/sentinel_exec.go]
autonomous: true
---

<objective>
Update exec command to use GetCredentialsWithSourceIdentity for SourceIdentity stamping.

Purpose: Apply the same two-hop credential pattern from Phase 12 (credentials command) to the exec command, ensuring all Sentinel-issued credentials carry SourceIdentity for CloudTrail correlation.

Output: Updated sentinel_exec.go that stamps SourceIdentity on role-assumed credentials.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 12 established the pattern - exec follows identical approach
@.planning/phases/12-credential-process-update/12-01-SUMMARY.md

# Current implementation to update
@cli/sentinel_exec.go
@cli/credentials.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update exec command to use GetCredentialsWithSourceIdentity</name>
  <files>cli/sentinel_exec.go</files>
  <action>
Update SentinelExecCommand to use GetCredentialsWithSourceIdentity instead of GetCredentials:

1. Change the credential request creation (around line 166-172) to include the User field:
   ```go
   credReq := SentinelCredentialRequest{
       ProfileName:     input.ProfileName,
       Region:          input.Region,
       NoSession:       input.NoSession,
       SessionDuration: input.SessionDuration,
       User:            username, // For SourceIdentity stamping on role assumption
   }
   ```

2. Change the credential retrieval call (line 173) from:
   `creds, err := s.GetCredentials(ctx, credReq)`
   to:
   `creds, err := s.GetCredentialsWithSourceIdentity(ctx, credReq)`

This mirrors exactly what was done in credentials.go in Phase 12.
  </action>
  <verify>go build ./... succeeds with no errors</verify>
  <done>sentinel_exec.go uses GetCredentialsWithSourceIdentity with User field populated</done>
</task>

<task type="auto">
  <name>Task 2: Verify exec command works end-to-end</name>
  <files>cli/sentinel_exec.go</files>
  <action>
Run the exec command to verify it still works correctly:

1. Build the sentinel binary: `go build ./cmd/sentinel`
2. Test basic execution (will fail policy check without SSM, but verifies compilation and startup)
3. Verify the code path is correct by inspection

No functional test changes needed - the GetCredentialsWithSourceIdentity method was already tested in Phase 12. The exec command is just switching to use it.
  </action>
  <verify>go build ./cmd/sentinel succeeds</verify>
  <done>sentinel exec command builds and is ready for integration testing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds without errors
- [ ] `go vet ./...` reports no issues
- [ ] sentinel_exec.go uses GetCredentialsWithSourceIdentity with User field
</verification>

<success_criteria>

- sentinel_exec.go updated to use GetCredentialsWithSourceIdentity
- User field populated from username variable (already available in function)
- Build succeeds with no errors
- Pattern matches credentials.go implementation
</success_criteria>

<output>
After completion, create `.planning/phases/13-exec-command-update/13-01-SUMMARY.md`
</output>
