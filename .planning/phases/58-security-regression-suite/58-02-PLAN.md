---
phase: 58-security-regression-suite
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - sentinel/threat_model_test.go
  - identity/threat_model_test.go
autonomous: true
---

<objective>
Create threat model validation tests using STRIDE framework.

Purpose: Document and validate the threat model through executable tests. Each test corresponds to a threat category (Spoofing, Tampering, Repudiation, Information Disclosure, Denial of Service, Elevation of Privilege) and proves the mitigation is effective.

Output: Threat model test files that serve as living documentation of security properties.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@sentinel/provider.go
@identity/types.go
@identity/request_id.go
@policy/evaluate.go
@breakglass/checker.go
@request/checker.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Identity spoofing prevention tests</name>
  <files>identity/threat_model_test.go</files>
  <action>
Create STRIDE-based threat model tests for identity components:

**SPOOFING (Identity) Tests:**
1. SourceIdentity format enforcement:
   - Prefix "sentinel:" cannot be modified or omitted
   - User component cannot contain colons (escape/rejection)
   - Request-ID must be exactly 16 hex characters
   - Malformed SourceIdentity strings are rejected by Parse()

2. User sanitization security:
   - Characters outside [a-zA-Z0-9_+=,.@-] are rejected or sanitized
   - Control characters (0x00-0x1F) cannot be injected
   - Unicode lookalikes (e.g., Cyrillic 'a' vs Latin 'a') are sanitized
   - Empty user after sanitization is rejected

3. Request-ID entropy:
   - Request-IDs are cryptographically random (crypto/rand)
   - Birthday collision probability test (generate many, check uniqueness)
   - Cannot predict next request-ID from previous ones

**TAMPERING Tests:**
1. SourceIdentity immutability:
   - Once created, SourceIdentity components cannot be modified
   - Format() returns consistent output
   - No mutation methods exposed

Use test function names that document the threat: "TestThreat_Spoofing_SourceIdentityPrefixCannotBeOmitted".
  </action>
  <verify>go test -v ./identity/... -run "TestThreat" passes all tests</verify>
  <done>Identity spoofing and tampering threats have validation tests</done>
</task>

<task type="auto">
  <name>Task 2: Sentinel provider threat model tests</name>
  <files>sentinel/threat_model_test.go</files>
  <action>
Create STRIDE-based threat model tests for the credential provider:

**SPOOFING Tests:**
1. User validation at provider level:
   - Empty user rejected before credential retrieval
   - Nil BaseCredsProvider rejected
   - Missing RoleARN rejected

**REPUDIATION Tests:**
1. SourceIdentity presence:
   - Every credential retrieval stamps SourceIdentity
   - LastSourceIdentity is populated after successful Retrieve()
   - SourceIdentity cannot be nil after successful Retrieve()

2. Correlation guarantee:
   - Request-ID in SourceIdentity matches any logging output
   - SourceIdentity format is parseable after round-trip

**ELEVATION OF PRIVILEGE Tests:**
1. Policy bypass prevention:
   - Credentials are NOT issued when policy returns EffectDeny
   - Credentials are NOT issued when policy returns EffectRequireApproval (without approval)
   - Test using mock policy evaluator that always denies

2. Break-glass boundary:
   - Break-glass credentials respect profile isolation
   - Break-glass cannot extend beyond its ExpiresAt
   - Break-glass credentials include SourceIdentity stamp

3. Approval boundary:
   - Approved request only grants access to approved profile
   - Approved request duration caps credential duration
   - Approval cannot grant access to different user

**DENIAL OF SERVICE Tests:**
1. Input validation fails fast:
   - Invalid inputs rejected before expensive operations
   - Nil checks happen before AWS API calls

**INFORMATION DISCLOSURE Tests:**
1. Error messages:
   - Credential denial errors do not leak policy details
   - Error messages indicate denial without exposing rules

Use test function names that document the threat: "TestThreat_ElevationOfPrivilege_PolicyBypassPrevention".
  </action>
  <verify>go test -v ./sentinel/... -run "TestThreat" passes all tests</verify>
  <done>Sentinel provider has comprehensive threat model validation tests</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test -v ./identity/... -run "TestThreat"` passes
- [ ] `go test -v ./sentinel/... -run "TestThreat"` passes
- [ ] `go test -race ./...` passes (no race conditions)
- [ ] Test names document STRIDE category and specific threat
- [ ] All six STRIDE categories represented where applicable
</verification>

<success_criteria>
- All tasks completed
- STRIDE-based tests document security properties
- Test names serve as threat documentation
- No existing tests broken
- Each threat test proves a specific mitigation works
</success_criteria>

<output>
After completion, create `.planning/phases/58-security-regression-suite/58-02-SUMMARY.md`
</output>
