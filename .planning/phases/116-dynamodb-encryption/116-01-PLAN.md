---
phase: 116-dynamodb-encryption
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infrastructure/schema.go
  - infrastructure/provisioner.go
  - infrastructure/provisioner_test.go
  - cli/init_approvals.go
  - cli/init_breakglass.go
  - cli/init_sessions.go
autonomous: true
---

<objective>
Add KMS encryption support to DynamoDB table provisioning for all Sentinel tables.

Purpose: DynamoDB tables store sensitive data (approval requests, break-glass events, sessions). Currently tables are created with AWS-owned encryption (DEFAULT). This plan adds explicit KMS encryption support for compliance and security hardening.

Output: Updated TableSchema with encryption settings, provisioner that sets SSESpecification on CreateTable, and CLI commands that enable encryption by default.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files to modify:
@infrastructure/schema.go
@infrastructure/provisioner.go
@cli/init_approvals.go
@cli/init_breakglass.go
@cli/init_sessions.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add encryption configuration to TableSchema</name>
  <files>infrastructure/schema.go</files>
  <action>
Add encryption configuration to the infrastructure schema:

1. Add EncryptionType type with constants:
   - EncryptionDefault (AWS_OWNED - default for DynamoDB)
   - EncryptionKMS (KMS - AWS managed key)
   - EncryptionCustomerKey (KMS with customer-provided CMK ARN)

2. Add EncryptionConfig struct with fields:
   - Type EncryptionType (required)
   - KMSKeyARN string (only used when Type is EncryptionCustomerKey)

3. Add Encryption field to TableSchema struct (pointer so nil means default/no change)

4. Add Validate() method to EncryptionConfig:
   - EncryptionDefault: KMSKeyARN must be empty
   - EncryptionKMS: KMSKeyARN must be empty (AWS managed)
   - EncryptionCustomerKey: KMSKeyARN must be non-empty ARN

5. Update TableSchema.Validate() to validate Encryption if set

6. Add helper function DefaultEncryptionKMS() that returns EncryptionConfig with Type=EncryptionKMS

Note: Using AWS managed KMS keys (EncryptionKMS) is the recommended default - provides encryption at rest without the complexity of managing custom CMKs.
  </action>
  <verify>
go build ./infrastructure/... compiles without errors
go test ./infrastructure/... -run TestTableSchema passes
  </verify>
  <done>
TableSchema has Encryption field with validation. EncryptionType constants defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update provisioner to set SSESpecification on CreateTable</name>
  <files>infrastructure/provisioner.go, infrastructure/provisioner_test.go</files>
  <action>
Update schemaToCreateTableInput function in provisioner.go:

1. Add SSESpecification to CreateTableInput when schema.Encryption is set:
   - EncryptionDefault: SSEEnabled=true, SSEType=AES256 (or omit - AWS default)
   - EncryptionKMS: SSEEnabled=true, SSEType=KMS (uses AWS managed key)
   - EncryptionCustomerKey: SSEEnabled=true, SSEType=KMS, KMSMasterKeyId=ARN

2. Import the types package if not already: "github.com/aws/aws-sdk-go-v2/service/dynamodb/types"

3. Add test in provisioner_test.go for schemaToCreateTableInput with encryption:
   - Test EncryptionKMS sets SSEType=KMS
   - Test EncryptionCustomerKey sets KMSMasterKeyId
   - Test nil Encryption doesn't set SSESpecification (backward compatible)

Key DynamoDB SDK types:
- types.SSESpecification{Enabled: aws.Bool(true), SSEType: types.SSETypeKms}
- For CMK: types.SSESpecification{Enabled: aws.Bool(true), SSEType: types.SSETypeKms, KMSMasterKeyId: aws.String(arn)}
  </action>
  <verify>
go build ./infrastructure/... compiles
go test ./infrastructure/... passes (including new encryption tests)
  </verify>
  <done>
CreateTable sets SSESpecification based on schema.Encryption. Tests verify encryption behavior.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update table schema functions to enable KMS encryption by default</name>
  <files>infrastructure/schema.go, cli/init_approvals.go, cli/init_breakglass.go, cli/init_sessions.go</files>
  <action>
Update the table schema helper functions to enable KMS encryption by default:

1. In infrastructure/schema.go, update these functions to set Encryption:
   - ApprovalTableSchema(tableName string) - add Encryption: &EncryptionConfig{Type: EncryptionKMS}
   - BreakGlassTableSchema(tableName string) - add Encryption: &EncryptionConfig{Type: EncryptionKMS}
   - SessionTableSchema(tableName string) - add Encryption: &EncryptionConfig{Type: EncryptionKMS}

2. Update ProvisionPlan struct (if shown to users) to include encryption info:
   - Add EncryptionType string field
   - Set it in Plan() method from schema.Encryption.Type

This enables encryption by default for all new tables while maintaining backward compatibility with existing tables (DynamoDB doesn't require migration for encryption changes - SSESpecification is set at creation time).

Note: CLI commands (init approvals/breakglass/sessions) use these schema functions, so they will automatically get KMS encryption without code changes to the CLI files themselves. Only need to verify the schema functions are called correctly.
  </action>
  <verify>
go build ./... compiles
go test ./infrastructure/... passes
go test ./cli/... passes (init command tests)
  </verify>
  <done>
All table schema functions enable KMS encryption by default. New tables created with AWS managed KMS encryption.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go build ./... succeeds
- [ ] go test ./infrastructure/... passes
- [ ] go test ./cli/... passes
- [ ] EncryptionType constants defined (DEFAULT, KMS, CUSTOMER_KEY)
- [ ] TableSchema has Encryption field with validation
- [ ] schemaToCreateTableInput sets SSESpecification when Encryption is configured
- [ ] ApprovalTableSchema, BreakGlassTableSchema, SessionTableSchema all default to KMS encryption
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- New DynamoDB tables will be created with AWS managed KMS encryption
- Existing tables unaffected (encryption is set at creation time)
- Code is backward compatible (nil Encryption means no SSE change)
</success_criteria>

<output>
After completion, create `.planning/phases/116-dynamodb-encryption/116-01-SUMMARY.md`
</output>
