---
phase: 15-cloudtrail-correlation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [docs/CLOUDTRAIL.md]
autonomous: true
---

<objective>
Create CloudTrail correlation documentation explaining how to trace Sentinel access decisions through to AWS API calls.

Purpose: Enable users to correlate Sentinel decision logs with CloudTrail events using the SourceIdentity and request-id fields added in Phase 14. This completes the audit story: who requested access (Sentinel) → what they did inside AWS (CloudTrail).

Output: docs/CLOUDTRAIL.md with correlation concepts, log format reference, and example queries.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 14 established the enhanced logging fields
@.planning/phases/14-enhanced-decision-logging/14-01-SUMMARY.md

# Source identity format reference
@identity/types.go

# Decision log entry structure
@logging/decision.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create docs directory and CLOUDTRAIL.md with correlation guide</name>
  <files>docs/CLOUDTRAIL.md</files>
  <action>
Create docs/CLOUDTRAIL.md with comprehensive CloudTrail correlation documentation:

1. **Overview section** explaining the correlation story:
   - Sentinel logs capture who requested credentials and why (allow/deny)
   - CloudTrail logs capture what actions were taken with those credentials
   - The request-id and source_identity fields link the two

2. **Sentinel Log Format section** documenting DecisionLogEntry fields:
   - Standard fields: timestamp, user, profile, effect, rule, rule_index, reason, policy_path
   - CloudTrail correlation fields: request_id, source_identity, role_arn, session_duration_seconds
   - Include example JSON log entries (allow with correlation fields, deny without)

3. **SourceIdentity Format section** explaining:
   - Format: `sentinel:<user>:<request-id>`
   - Example: `sentinel:alice:a1b2c3d4`
   - How this appears in CloudTrail's userIdentity.sourceIdentity field
   - AWS constraints (max 64 chars, propagates through role chaining)

4. **Correlation Workflow section** with numbered steps:
   - Step 1: Find Sentinel log entry (grep by user, timestamp, or request_id)
   - Step 2: Extract source_identity value
   - Step 3: Search CloudTrail for matching sourceIdentity
   - Step 4: View all API calls made during that session

Use markdown formatting with code blocks for examples. Keep technical but accessible.
  </action>
  <verify>cat docs/CLOUDTRAIL.md shows complete documentation with all four sections</verify>
  <done>docs/CLOUDTRAIL.md exists with Overview, Log Format, SourceIdentity Format, and Correlation Workflow sections</done>
</task>

<task type="auto">
  <name>Task 2: Add AWS CLI CloudTrail lookup examples</name>
  <files>docs/CLOUDTRAIL.md</files>
  <action>
Append "AWS CLI Examples" section to docs/CLOUDTRAIL.md with practical commands:

1. **Lookup by SourceIdentity** using aws cloudtrail lookup-events:
   ```bash
   aws cloudtrail lookup-events \
     --lookup-attributes AttributeKey=Username,AttributeValue="sentinel:alice:a1b2c3d4" \
     --start-time "2024-01-15T00:00:00Z" \
     --end-time "2024-01-15T23:59:59Z"
   ```

2. **Filter results with jq** to extract key fields:
   - Event time, event name, source IP, resources accessed
   - Example showing how to format output for review

3. **Search by time window** for operational scenarios:
   - Find all Sentinel-issued sessions in the last hour
   - Filter by specific AWS service (ec2, s3, etc.)

4. **Cross-reference example** showing full workflow:
   - Start with Sentinel log entry
   - Extract request_id
   - Run CloudTrail lookup
   - Correlate the results

Include note that CloudTrail lookup-events searches the last 90 days of management events.
  </action>
  <verify>grep -c "aws cloudtrail" docs/CLOUDTRAIL.md shows at least 2 CLI examples</verify>
  <done>AWS CLI Examples section added with lookup-events commands and jq filtering</done>
</task>

<task type="auto">
  <name>Task 3: Add Athena query examples for log analysis</name>
  <files>docs/CLOUDTRAIL.md</files>
  <action>
Append "Athena Queries" section to docs/CLOUDTRAIL.md for advanced analysis:

1. **Prerequisites note** explaining:
   - Requires CloudTrail logs exported to S3
   - Requires Athena table for CloudTrail logs (link to AWS docs)

2. **Find all actions by Sentinel session** query:
   ```sql
   SELECT eventTime, eventSource, eventName, sourceIPAddress, userIdentity.sourceIdentity
   FROM cloudtrail_logs
   WHERE userIdentity.sourceIdentity = 'sentinel:alice:a1b2c3d4'
   ORDER BY eventTime;
   ```

3. **Aggregate Sentinel usage by user** query:
   ```sql
   SELECT
     REGEXP_EXTRACT(userIdentity.sourceIdentity, 'sentinel:([^:]+):', 1) as sentinel_user,
     COUNT(*) as api_calls,
     COUNT(DISTINCT eventName) as unique_actions
   FROM cloudtrail_logs
   WHERE userIdentity.sourceIdentity LIKE 'sentinel:%'
   GROUP BY 1
   ORDER BY api_calls DESC;
   ```

4. **Cross-reference with Sentinel logs** note:
   - Explain that for full correlation, Sentinel logs should also be in S3/Athena
   - Suggest JSON Lines format is Athena-compatible
   - Show example of joining Sentinel logs with CloudTrail

Keep queries practical and tested for common analysis patterns.
  </action>
  <verify>grep -c "SELECT" docs/CLOUDTRAIL.md shows at least 2 SQL queries</verify>
  <done>Athena Queries section added with session lookup and aggregation queries</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] docs/CLOUDTRAIL.md exists and is well-formatted markdown
- [ ] Document covers: Overview, Log Format, SourceIdentity, Correlation Workflow
- [ ] AWS CLI examples are syntactically correct
- [ ] Athena queries use correct CloudTrail schema
- [ ] All code blocks have appropriate language tags
</verification>

<success_criteria>
- All tasks completed
- docs/CLOUDTRAIL.md is comprehensive and actionable
- Users can follow the guide to correlate Sentinel → CloudTrail
- Examples are copy-paste ready
</success_criteria>

<output>
After completion, create `.planning/phases/15-cloudtrail-correlation/15-01-SUMMARY.md`
</output>
