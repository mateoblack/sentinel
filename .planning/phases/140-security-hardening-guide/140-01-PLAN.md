---
phase: 140-security-hardening-guide
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [docs/SECURITY_HARDENING.md, docs/CHANGELOG.md, README.md]
autonomous: true
---

<objective>
Create comprehensive SECURITY_HARDENING.md guide documenting v1.16 security hardening features with practical configuration examples.

Purpose: Enable security teams and operators to implement all v1.16 hardening features with clear configuration steps, understanding threat context, and verification procedures.
Output: Complete SECURITY_HARDENING.md guide with timing attack mitigation, Secrets Manager integration, rate limiting, error sanitization, and DynamoDB encryption documentation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# v1.16 security hardening implementation references
@sentinel/server.go
@server/ecsserver.go
@lambda/secrets.go
@ratelimit/types.go
@ratelimit/dynamodb.go
@infrastructure/schema.go

# Existing security documentation (contains v1.16 overview section)
@docs/SECURITY.md

# Documentation patterns
@docs/POLICY_SIGNING.md
@docs/DEVICE_POSTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SECURITY_HARDENING.md with complete guide structure</name>
  <files>docs/SECURITY_HARDENING.md</files>
  <action>
Create comprehensive SECURITY_HARDENING.md covering:

**1. Overview section:**
- Brief description: v1.16 addresses findings from comprehensive security audit
- List of hardening areas: timing attack mitigation, secrets management, rate limiting, error sanitization, DynamoDB encryption, CI/CD scanning
- When to apply: production deployments, regulated environments, security-conscious organizations

**2. Threat Model section:**
- Table of attacks prevented (timing oracle on bearer tokens, credential stuffing on rate limited endpoints, information leakage via error messages, unencrypted data at rest)
- Defense in depth diagram showing: Client → Rate Limit → Token Validation (timing-safe) → Policy → Credentials → Audit (sanitized)
- Fail-closed vs fail-open decisions (rate limiting fails open to avoid denial of service)

**3. Timing Attack Mitigation:**
- Explain the threat: comparing bearer tokens with `==` leaks timing information
- Solution: `crypto/subtle.ConstantTimeCompare()` for all token comparisons
- Affected components: sentinel/server.go, server/ecsserver.go
- Code pattern example:
```go
import "crypto/subtle"

// WRONG - vulnerable to timing attack
if token == expectedToken { ... }

// CORRECT - constant-time comparison
if subtle.ConstantTimeCompare([]byte(token), []byte(expectedToken)) == 1 { ... }
```
- Verification: run `go test ./... -run Security` to validate AST checks

**4. Secrets Manager Integration:**
- Why: avoid storing sensitive tokens in environment variables (visible in Lambda console, logs)
- How: CachedSecretsLoader with 1-hour TTL
- Configuration steps:
  1. Create secret in AWS Secrets Manager
  2. Grant Lambda/server IAM role `secretsmanager:GetSecretValue` permission
  3. Set environment variable `MDM_SECRET_ARN=arn:aws:secretsmanager:...`
- Example Terraform:
```hcl
resource "aws_secretsmanager_secret" "mdm_token" {
  name = "sentinel/mdm-api-token"
}

resource "aws_secretsmanager_secret_version" "mdm_token" {
  secret_id     = aws_secretsmanager_secret.mdm_token.id
  secret_string = var.mdm_api_token
}
```
- Cache behavior: TTL defaults to 1 hour, configurable via `WithTTL()`
- Backward compatibility: falls back to environment variable with deprecation warning

**5. Rate Limiting Configuration:**
Document both implementations from ratelimit/:

**Memory-based (single instance):**
- Use case: Local credential server, dev environments
- Config: RequestsPerWindow, Window, BurstSize
```go
limiter := ratelimit.NewMemoryRateLimiter(ratelimit.Config{
    RequestsPerWindow: 100,
    Window:            time.Minute,
    BurstSize:         10,
})
```

**DynamoDB-based (distributed):**
- Use case: Lambda TVM, multiple credential servers
- Table schema: PK="RL#"+key, WindowStart, Count, TTL
- Atomic operations using UpdateItem with condition expression
- Fail-open behavior: DynamoDB errors log warning and allow request
```go
limiter, err := ratelimit.NewDynamoDBRateLimiter(dynamoClient, "sentinel-ratelimit", ratelimit.Config{
    RequestsPerWindow: 100,
    Window:            time.Minute,
})
```

**Response headers:**
- RFC 7231 compliant `Retry-After` header on rate limit
- Example: `429 Too Many Requests` with `Retry-After: 45`

**6. Error Sanitization Pattern:**
- Principle: Log detailed errors internally, return generic messages to clients
- What's sanitized: SSM paths, ARN parsing errors, MDM provider failures, credential retrieval errors
- What's preserved: Rate limit retry-after, policy deny reasons (intentional user-facing)
- Code pattern:
```go
// Internal logging with full details
log.Printf("error: failed to load policy from %s: %v", ssmPath, err)

// External response with generic message
return &Response{Error: "internal error"}, nil
```
- Verification: `go test ./... -run Sanitiz` to validate no internal details leaked

**7. DynamoDB Encryption:**
- All Sentinel tables use AWS-managed KMS encryption
- Tables: approval requests, break-glass events, server sessions, rate limit counters
- Configuration in infrastructure/schema.go EncryptionConfig:
  - EncryptionDefault: AWS-owned keys (default)
  - EncryptionKMS: AWS-managed KMS key
  - EncryptionCustomerKey: Customer-provided CMK ARN
- Terraform example:
```hcl
resource "aws_dynamodb_table" "sessions" {
  name = "sentinel-sessions"

  server_side_encryption {
    enabled     = true
    kms_key_arn = aws_kms_key.sentinel.arn  # Optional: use CMK
  }
}
```

**8. CI/CD Security Scanning:**
- Tools integrated: govulncheck, gosec, Trivy
- Trigger points: PR, Push, Weekly scheduled
- GitHub Actions workflow references
- Local scanning commands:
```bash
# Go vulnerability database
govulncheck ./...

# Static application security testing
gosec ./...

# Filesystem scanning
trivy fs .
```

**9. Security Regression Tests:**
- Purpose: Prevent reintroduction of security issues
- Categories: timing-safe comparison (AST check), rate limiter bypass, error sanitization
- Running tests: `go test ./... -run Security`
- Test file locations: *_security_test.go

**10. Troubleshooting section:**
- "Rate limit triggered unexpectedly" - check window configuration, DynamoDB latency
- "Secrets Manager access denied" - verify IAM permissions, secret ARN format
- "Security test failures" - ensure crypto/subtle used for token comparison

Format following docs/POLICY_SIGNING.md and docs/DEVICE_POSTURE.md patterns:
- Use markdown tables for structured data
- Include ASCII diagrams for defense in depth
- Use code blocks with syntax highlighting (go, hcl, bash)
- Include practical examples throughout
  </action>
  <verify>cat docs/SECURITY_HARDENING.md | head -100 shows overview and threat model sections</verify>
  <done>SECURITY_HARDENING.md exists with all 10 sections: Overview, Threat Model, Timing Attack, Secrets Manager, Rate Limiting, Error Sanitization, DynamoDB Encryption, CI/CD Scanning, Regression Tests, Troubleshooting</done>
</task>

<task type="auto">
  <name>Task 2: Update CHANGELOG and README for v1.16 hardening guide</name>
  <files>docs/CHANGELOG.md, README.md</files>
  <action>
**CHANGELOG.md updates:**
- Ensure v1.16 entry mentions security hardening guide:
  - Link to new SECURITY_HARDENING.md guide
  - Note that guide provides practical configuration examples

**README.md updates:**
- Add "Security Hardening" to feature list if not present
- Brief mention: "Comprehensive security hardening guide covering timing attack mitigation, rate limiting, secrets management, and encryption"
- Link to docs/SECURITY_HARDENING.md in documentation section

**Documentation index:**
- Check if README.md has a Documentation section listing guides
- If yes, add SECURITY_HARDENING.md to the list (after SECURITY.md if present)
  </action>
  <verify>grep -c "SECURITY_HARDENING" docs/CHANGELOG.md README.md shows references in both files</verify>
  <done>CHANGELOG mentions security hardening guide, README links to SECURITY_HARDENING.md</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] docs/SECURITY_HARDENING.md exists with all required sections
- [ ] SECURITY_HARDENING.md follows same formatting patterns as POLICY_SIGNING.md
- [ ] Rate limiting configuration examples use correct ratelimit/ package types
- [ ] Secrets Manager examples match lambda/secrets.go implementation
- [ ] DynamoDB encryption examples match infrastructure/schema.go types
- [ ] Code examples compile-valid Go syntax
- [ ] CHANGELOG.md references SECURITY_HARDENING.md
- [ ] README.md links to security hardening documentation
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Security team can implement timing-safe token comparison following documented pattern
- Operator can configure Secrets Manager integration for MDM tokens
- Operator can configure distributed rate limiting with DynamoDB
- User understands error sanitization principle (log internal, return generic)
</success_criteria>

<output>
After completion, create `.planning/phases/140-security-hardening-guide/140-01-SUMMARY.md`
</output>
