---
phase: 11-two-hop-orchestration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sentinel/provider.go
  - sentinel/provider_test.go
autonomous: true
---

<objective>
Create a TwoHopCredentialProvider that chains aws-vault base credentials through SentinelAssumeRole to stamp SourceIdentity on all credentials.

Purpose: This provider implements the core credential flow for v1.1 Sentinel Fingerprint. It bridges aws-vault's credential resolution (session tokens, SSO, stored creds) with Sentinel's SourceIdentity stamping, ensuring all Sentinel-issued credentials carry a fingerprint.

Output: `sentinel/provider.go` implementing aws.CredentialsProvider interface with comprehensive tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase outputs:
@.planning/phases/09-source-identity-schema/09-01-SUMMARY.md
@.planning/phases/10-assume-role-provider/10-01-SUMMARY.md

# Source files to use:
@sentinel/assume_role.go
@identity/types.go
@identity/request_id.go

# Reference patterns:
@vault/vault.go
@vault/assumeroleprovider.go
@cli/sentinel_provider.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TwoHopCredentialProvider type and Retrieve method</name>
  <files>sentinel/provider.go</files>
  <action>
Create sentinel/provider.go with TwoHopCredentialProvider implementing aws.CredentialsProvider:

1. TwoHopCredentialProviderInput struct:
   - BaseCredsProvider aws.CredentialsProvider (required - from aws-vault)
   - RoleARN string (required - target role to assume)
   - User string (required - username for SourceIdentity)
   - Region string (for STS endpoint)
   - STSRegionalEndpoints string (optional)
   - EndpointURL string (optional)
   - ExternalID string (optional)
   - SessionDuration time.Duration (optional - defaults to 1 hour)

2. TwoHopCredentialProvider struct:
   - Input TwoHopCredentialProviderInput
   - (no mutex needed - providers are stateless per call)

3. NewTwoHopCredentialProvider(input TwoHopCredentialProviderInput) (*TwoHopCredentialProvider, error):
   - Validate required fields (BaseCredsProvider, RoleARN, User)
   - Return configured provider

4. Retrieve(ctx context.Context) (aws.Credentials, error) method:
   - Generate new request-id via identity.NewRequestID()
   - Sanitize username via identity.SanitizeUser(input.User)
   - Create SourceIdentity via identity.New(sanitizedUser, requestID)
   - Build SentinelAssumeRoleInput using input fields
   - Call sentinel.SentinelAssumeRole(ctx, assumeRoleInput)
   - Return aws.Credentials from result

Follow the pattern from vault/assumeroleprovider.go for the Retrieve method signature.
Keep it simple - no caching in the provider (caching is handled by CachedSessionProvider wrapper).
  </action>
  <verify>go build ./sentinel/... compiles without errors</verify>
  <done>TwoHopCredentialProvider implements aws.CredentialsProvider interface</done>
</task>

<task type="auto">
  <name>Task 2: Add input validation and NewTwoHopProvider helper</name>
  <files>sentinel/provider.go</files>
  <action>
Add input validation and a convenience constructor:

1. Define validation errors:
   - ErrMissingBaseCredsProvider = errors.New("BaseCredsProvider is required")
   - ErrMissingUser = errors.New("User is required for SourceIdentity")
   - (ErrMissingRoleARN already exists in assume_role.go)

2. Add validateProviderInput(input *TwoHopCredentialProviderInput) error:
   - Check BaseCredsProvider != nil
   - Check RoleARN != ""
   - Check User != ""
   - Return first validation error encountered

3. Add NewTwoHopProvider helper for common use case:
   ```go
   func NewTwoHopProvider(baseProvider aws.CredentialsProvider, roleARN, user, region string) (*TwoHopCredentialProvider, error)
   ```
   - Wraps NewTwoHopCredentialProvider with minimal inputs
   - Uses defaults for optional fields

4. Apply defaults in Retrieve:
   - SessionDuration: if zero, use 1 hour (DefaultDuration constant)
  </action>
  <verify>go build ./sentinel/... compiles without errors</verify>
  <done>Input validation rejects invalid inputs, NewTwoHopProvider helper exists</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for TwoHopCredentialProvider</name>
  <files>sentinel/provider_test.go</files>
  <action>
Create sentinel/provider_test.go with table-driven tests:

1. TestTwoHopCredentialProviderValidation:
   - Test missing BaseCredsProvider returns ErrMissingBaseCredsProvider
   - Test missing RoleARN returns ErrMissingRoleARN
   - Test missing User returns ErrMissingUser
   - Test valid input creates provider successfully

2. TestNewTwoHopProvider:
   - Test helper creates valid provider
   - Test helper rejects invalid inputs

3. TestTwoHopCredentialProviderSourceIdentity:
   - Verify SourceIdentity is generated correctly during Retrieve
   - Create a mock that captures the SentinelAssumeRoleInput
   - Check SourceIdentity format is sentinel:<user>:<request-id>
   - Check user is sanitized (alice@example.com -> aliceexamplecom)

4. TestTwoHopCredentialProviderDefaults:
   - Test default SessionDuration is 1 hour

Note: Full integration test (actual STS call) deferred to Phase 17.
Use testing patterns from sentinel/assume_role_test.go (table-driven, descriptive names).

For the mock approach, consider creating a testable interface or using the existing test patterns from the codebase.
  </action>
  <verify>go test ./sentinel/... -v passes all tests</verify>
  <done>All validation and unit tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./sentinel/...` succeeds
- [ ] `go test ./sentinel/...` passes all tests
- [ ] `go vet ./sentinel/...` reports no issues
- [ ] TwoHopCredentialProvider implements aws.CredentialsProvider
- [ ] Provider generates unique SourceIdentity per Retrieve call
</verification>

<success_criteria>

- TwoHopCredentialProvider created implementing aws.CredentialsProvider
- Provider chains base credentials through SentinelAssumeRole
- Each Retrieve() generates unique request-id for SourceIdentity
- User is sanitized for SourceIdentity format
- Unit tests cover validation and SourceIdentity generation
- Code follows existing vault/ and sentinel/ patterns
</success_criteria>

<output>
After completion, create `.planning/phases/11-two-hop-orchestration/11-01-SUMMARY.md`
</output>
