---
phase: 21-list-check-commands
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [cli/list.go, cli/list_test.go, cmd/sentinel/main.go]
autonomous: true
---

<objective>
Create `sentinel list` command to view approval requests with filtering options.

Purpose: Allow users to view their own requests and approvers to view pending requests awaiting action.
Output: Working list command with JSON output, Store interface injection for testing, and comprehensive test coverage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context - request command pattern
@.planning/phases/20-request-command/20-01-SUMMARY.md

# Source files for patterns
@cli/request.go
@cli/request_test.go
@request/store.go
@request/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create list command with CLI configuration and core logic</name>
  <files>cli/list.go</files>
  <action>
Create list command following the request command pattern:

1. Define ListCommandInput struct with fields:
   - Requester string (filter by specific user, empty = current user)
   - Status string (filter by status: pending, approved, denied, expired, cancelled, or empty for all)
   - Profile string (filter by AWS profile)
   - Limit int (max results, default 100)
   - RequestTable string (DynamoDB table name)
   - Region string (AWS region)
   - Store request.Store (optional, for testing)

2. Define ListCommandOutput struct for JSON output:
   - Requests []RequestSummary where RequestSummary has: ID, Profile, Status, Requester, CreatedAt, ExpiresAt

3. Implement ConfigureListCommand(app *kingpin.Application, s *Sentinel):
   - Register "list" command with description "List access requests"
   - --requester flag (optional, defaults to current user)
   - --status flag (optional, filter by status)
   - --profile flag (optional, filter by profile)
   - --limit flag (default 100)
   - --request-table flag (required)
   - --region flag (optional)

4. Implement ListCommand(ctx context.Context, input ListCommandInput) error:
   - Get current user if Requester not specified
   - Create DynamoDB store if Store is nil
   - Choose query method based on flags:
     - If Status specified: use ListByStatus
     - If Profile specified: use ListByProfile
     - Otherwise: use ListByRequester (default to current user's requests)
   - If Requester filter specified AND query returned results, filter to match requester
   - Format results as JSON array and output to stdout
   - Handle empty results gracefully (output empty JSON array)

Query logic priority:
1. --status flag → ListByStatus(status, limit), then filter by requester if specified
2. --profile flag → ListByProfile(profile, limit), then filter by requester if specified
3. Default → ListByRequester(requester, limit) where requester = flag value or current user

Use fmt.Fprintf(os.Stderr, ...) for errors, fmt.Println for JSON output (matching request.go pattern).
  </action>
  <verify>go build ./... succeeds</verify>
  <done>cli/list.go exists with ConfigureListCommand and ListCommand functions</done>
</task>

<task type="auto">
  <name>Task 2: Wire command in main.go and add unit tests</name>
  <files>cmd/sentinel/main.go, cli/list_test.go</files>
  <action>
1. In cmd/sentinel/main.go:
   - Add cli.ConfigureListCommand(app, &sentinel) after ConfigureRequestCommand

2. In cli/list_test.go, create comprehensive test suite:
   - Reuse mockStore from request_test.go (it already has all List methods)
   - Create testableListCommand helper that accepts profile validator (following request_test.go pattern)

Test cases (minimum 6):
- TestListCommand_DefaultListsCurrentUserRequests: No flags → ListByRequester with current user
- TestListCommand_FilterByStatus: --status pending → ListByStatus returns pending requests
- TestListCommand_FilterByProfile: --profile prod → ListByProfile returns profile requests
- TestListCommand_FilterByRequester: --requester other-user → ListByRequester with specified user
- TestListCommand_EmptyResults: Query returns empty slice → outputs empty JSON array []
- TestListCommand_StoreError: Store returns error → command returns error

Verify JSON output format includes all RequestSummary fields.
  </action>
  <verify>go test ./cli/... -run TestList -v passes all tests</verify>
  <done>List command wired in main.go, all 6+ tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `go test ./cli/... -run TestList -v` passes all tests
- [ ] `go vet ./...` reports no issues
- [ ] `sentinel list --help` shows expected flags
</verification>

<success_criteria>

- ListCommandInput and ListCommandOutput structs defined
- ConfigureListCommand registers command with all flags
- ListCommand implements query logic with filtering
- Mock store tests verify all query paths
- JSON output format matches RequestSummary structure
- Empty results handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/21-list-check-commands/21-01-SUMMARY.md`
</output>
