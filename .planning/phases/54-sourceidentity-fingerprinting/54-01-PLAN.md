---
phase: 54-sourceidentity-fingerprinting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [identity/types_test.go, identity/request_id_test.go, sentinel/assume_role_test.go]
autonomous: true
---

<objective>
Add security-focused edge case tests for fingerprint generation (identity package) and SentinelAssumeRole validation.

Purpose: Ensure SourceIdentity format security, request-id entropy validation, and SentinelAssumeRole input handling are thoroughly tested for security-critical edge cases.
Output: Enhanced test coverage for identity (target 98%+) and sentinel packages with security validation tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files for testing
@identity/types.go
@identity/types_test.go
@identity/request_id.go
@identity/request_id_test.go
@sentinel/assume_role.go
@sentinel/assume_role_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SourceIdentity security edge case tests</name>
  <files>identity/types_test.go</files>
  <action>
Add security-focused edge case tests to identity/types_test.go:

1. **AWS constraint boundary tests:**
   - Test MaxSourceIdentityLength (64 chars) is never exceeded even with max-length inputs
   - Test total formatted length calculation is correct for all user lengths (1 to 20)
   - Add test for unicode sanitization (multi-byte chars counted correctly)

2. **Format injection/parsing security tests:**
   - Test Parse rejects malformed inputs that could confuse downstream parsers
   - Test separator injection attempts (user containing colons)
   - Test null byte handling in user field
   - Test control character rejection

3. **SanitizeUser security edge cases:**
   - Test unicode characters beyond BMP (emoji, etc.)
   - Test mixed direction text (RTL + LTR)
   - Test very long usernames (>1000 chars) truncate correctly without panic
   - Test repeated special characters only

4. **Validation order tests:**
   - Test that Validate() checks user before request-id (error ordering)
   - Test that New() returns nil on first validation failure

Use table-driven tests consistent with existing test patterns in the file.
  </action>
  <verify>go test -v -run "Security|Boundary|Injection|Unicode" ./identity/... passes</verify>
  <done>All new security edge case tests pass, coverage remains >97%</done>
</task>

<task type="auto">
  <name>Task 2: Add request-id entropy and fallback tests</name>
  <files>identity/request_id_test.go</files>
  <action>
Add tests for request-id edge cases and entropy validation:

1. **Entropy distribution tests:**
   - Test character distribution across 10,000 IDs (no obvious bias toward specific hex chars)
   - Verify each position has reasonable distribution (chi-squared style check, informal)

2. **Fallback behavior test:**
   - The code has a fallback to "00000000" if crypto/rand fails - document this behavior
   - Add a test comment explaining why this is acceptable (crypto/rand failure is catastrophic anyway)

3. **Concurrency safety tests:**
   - Generate 1000 IDs concurrently from multiple goroutines
   - Verify no panics, no duplicate IDs across goroutines
   - Use sync.WaitGroup and verify uniqueness with sync.Map

4. **ValidateRequestID boundary tests:**
   - Test exactly 8 chars with non-hex at each position (0-7)
   - Test empty string edge case explicitly
   - Test single character
   - Test 7 and 9 character strings

Use subtests (t.Run) for organization.
  </action>
  <verify>go test -v -race -run "Entropy|Concurrent|Boundary" ./identity/... passes</verify>
  <done>Request-id tests cover entropy distribution, concurrency, and boundaries</done>
</task>

<task type="auto">
  <name>Task 3: Add SentinelAssumeRole security validation tests</name>
  <files>sentinel/assume_role_test.go</files>
  <action>
Add security validation tests for SentinelAssumeRole input handling:

1. **Input validation order tests:**
   - Verify validation order is consistent: CredsProvider → RoleARN → SourceIdentity → SourceIdentity.IsValid()
   - Test with multiple invalid fields, verify first error is returned

2. **SourceIdentity integration tests:**
   - Test that invalid SourceIdentity formats are rejected before STS call
   - Test SourceIdentity with exactly MaxUserLength (20 chars)
   - Test SourceIdentity format is preserved in output

3. **Duration edge cases:**
   - Test Duration = 0 gets default (1 hour)
   - Test Duration = 1 second (minimum)
   - Test Duration = 12 hours (AWS maximum for most roles)

4. **RoleARN validation edge cases:**
   - Test empty string rejected
   - Test whitespace-only rejected (trim if needed, or reject)
   - Document that AWS SDK does the actual ARN validation

5. **ExternalID handling:**
   - Test empty ExternalID is not passed to STS
   - Test non-empty ExternalID is included

Use existing mockCredentialsProvider pattern. Tests should verify input validation without making actual STS calls.
  </action>
  <verify>go test -v -run "Validation|Duration|ExternalID|SourceIdentity" ./sentinel/... passes</verify>
  <done>SentinelAssumeRole security validation tests added, coverage improved toward 90%+</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test -v -race ./identity/...` passes with coverage >97%
- [ ] `go test -v -race ./sentinel/...` passes with coverage >89%
- [ ] No new linting errors (`go vet ./identity/... ./sentinel/...`)
- [ ] All tests use table-driven patterns consistent with existing code
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- identity package coverage maintained at >97%
- sentinel package coverage improved or maintained at >89%
- Security edge cases documented and tested
</success_criteria>

<output>
After completion, create `.planning/phases/54-sourceidentity-fingerprinting/54-01-SUMMARY.md`
</output>
