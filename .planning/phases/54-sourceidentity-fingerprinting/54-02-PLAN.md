---
phase: 54-sourceidentity-fingerprinting
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [audit/types_test.go, audit/verifier_test.go]
autonomous: true
---

<objective>
Add comprehensive CloudTrail query tests for session verification, covering edge cases, error handling, and security classification.

Purpose: Ensure CloudTrail session verification correctly identifies Sentinel vs non-Sentinel sessions and handles edge cases robustly.
Output: Enhanced test coverage for audit package (target 95%+) with CloudTrail parsing and verification edge cases.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files for testing
@audit/types.go
@audit/types_test.go
@audit/verifier.go
@audit/verifier_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ParseSourceIdentity security edge case tests</name>
  <files>audit/types_test.go</files>
  <action>
Add security-focused edge case tests for ParseSourceIdentity:

1. **Prefix security tests:**
   - Test case sensitivity ("Sentinel:", "SENTINEL:", "sEnTiNeL:")
   - Test prefix with extra whitespace ("sentinel: alice:abc")
   - Test similar-looking prefixes ("sentinel\u200B:" with zero-width char)

2. **Request-ID extraction edge cases:**
   - Test request-id with embedded colons (already tested, verify behavior)
   - Test very long request-id (100+ chars)
   - Test request-id with special characters
   - Test request-id with only colons

3. **User field security:**
   - Test empty user with valid request-id
   - Test user with only whitespace
   - Test user with null bytes

4. **Format boundary tests:**
   - Test maximum valid SourceIdentity length
   - Test exactly at 64-char AWS limit
   - Test beyond 64-char limit (should still parse, AWS enforces)

Use table-driven tests extending TestParseSourceIdentity.
  </action>
  <verify>go test -v -run "ParseSourceIdentity" ./audit/... passes</verify>
  <done>ParseSourceIdentity edge cases thoroughly tested for security</done>
</task>

<task type="auto">
  <name>Task 2: Add CloudTrail event parsing robustness tests</name>
  <files>audit/verifier_test.go</files>
  <action>
Add robustness tests for parseCloudTrailEvent and Verifier:

1. **CloudTrail JSON parsing edge cases:**
   - Test deeply nested JSON (userIdentity with extra levels)
   - Test malformed JSON (truncated, extra braces)
   - Test JSON with unknown fields (should ignore gracefully)
   - Test JSON with null values for expected fields
   - Test JSON with wrong types (string vs object)

2. **SessionInfo field extraction:**
   - Test event with all fields nil (should not panic)
   - Test event with partial fields populated
   - Test username fallback from payload when event.Username nil
   - Test RoleARN extraction from sessionContext

3. **Verifier error handling:**
   - Test LookupEvents API error propagation
   - Test context cancellation mid-pagination
   - Test empty Events array response
   - Test single event with parse error (should increment UnknownSessions)

4. **Issue classification:**
   - Test non-Sentinel SourceIdentity creates correct issue type
   - Test missing SourceIdentity creates correct message
   - Test issue severity is always "warning" for missing SourceIdentity

Add tests using mockCloudTrailClient pattern from existing tests.
  </action>
  <verify>go test -v -run "Parse|Error|Issue" ./audit/... passes</verify>
  <done>CloudTrail parsing is robust against malformed input</done>
</task>

<task type="auto">
  <name>Task 3: Add verification result edge case and statistical tests</name>
  <files>audit/types_test.go, audit/verifier_test.go</files>
  <action>
Add edge case tests for VerificationResult calculations and statistics:

1. **PassRate edge cases (audit/types_test.go):**
   - Test with 1 total session, 0 sentinel (0%)
   - Test with 1 total session, 1 sentinel (100%)
   - Test with large numbers (1,000,000 sessions)
   - Test floating point precision (e.g., 1/3 sessions)

2. **HasIssues consistency (audit/types_test.go):**
   - Test adding issue changes HasIssues from false to true
   - Test multiple issues still returns true
   - Test after clearing issues (if possible)

3. **VerifyInput time window validation (audit/verifier_test.go):**
   - Test StartTime == EndTime
   - Test StartTime > EndTime (inverted window)
   - Test very wide time window (30 days)
   - Test future time window

4. **Concurrent verification (audit/verifier_test.go):**
   - Test multiple Verify calls concurrently with same verifier
   - Ensure no race conditions (test with -race flag)
   - Test concurrent calls don't interfere with each other's results

5. **Type validation tests (audit/types_test.go):**
   - Test IssueSeverity.IsValid() with empty string
   - Test IssueType.IsValid() with unknown types
   - Test SessionIssue with nil SessionInfo

Use t.Parallel() where appropriate for concurrent test execution.
  </action>
  <verify>go test -v -race -run "PassRate|HasIssues|Time|Concurrent" ./audit/... passes</verify>
  <done>VerificationResult edge cases and concurrent safety tested</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test -v -race ./audit/...` passes with coverage >91%
- [ ] No new linting errors (`go vet ./audit/...`)
- [ ] All tests use table-driven patterns consistent with existing code
- [ ] Concurrent tests pass with -race flag
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- audit package coverage improved to >91%
- CloudTrail parsing handles malformed input gracefully
- Concurrent verification is thread-safe
</success_criteria>

<output>
After completion, create `.planning/phases/54-sourceidentity-fingerprinting/54-02-SUMMARY.md`
</output>
