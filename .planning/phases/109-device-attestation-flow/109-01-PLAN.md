---
phase: 109-device-attestation-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cli/remote_credentials.go
  - cli/remote_credentials_test.go
  - cli/sentinel_exec.go
  - cli/sentinel_exec_test.go
autonomous: true
---

<objective>
Wire device ID into CLI credential requests so TVM can query MDM for server-verified device posture.

Purpose: Enable device attestation flow where CLI collects stable device ID, passes to TVM, and TVM queries MDM for actual posture (clients cannot fake compliance).
Output: CLI passes device_id query parameter to remote TVM for MDM-based device posture verification.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Prior phases - device posture infrastructure is complete:
@.planning/phases/106-local-device-collector/106-01-SUMMARY.md
@.planning/phases/107-mdm-api-integration/107-03-SUMMARY.md
@.planning/phases/108-policy-device-conditions/108-01-SUMMARY.md

Key source files:
@device/identity.go
@cli/remote_credentials.go
@cli/sentinel_exec.go
@lambda/handler.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add device_id parameter to RemoteCredentialClient</name>
  <files>cli/remote_credentials.go, cli/remote_credentials_test.go</files>
  <action>
Extend RemoteCredentialClient to accept optional device ID:

1. Add DeviceID field to RemoteCredentialClient struct (string, optional)
2. In GetCredentials(), if DeviceID is non-empty, append device_id query parameter to URL
3. Use url.Parse() and url.Values to properly construct URL with query params (preserve existing params)
4. Add test cases:
   - TestRemoteCredentialClient_WithDeviceID - verifies device_id is appended to request URL
   - TestRemoteCredentialClient_WithoutDeviceID - verifies backward compatibility (no param added)
   - TestRemoteCredentialClient_WithExistingQueryParams - verifies device_id is added alongside existing params

Pattern to follow from lambda/handler.go line 81: device_id is a 64-char lowercase hex string.
Validation not needed in client - TVM validates via extractDeviceID().
  </action>
  <verify>go test ./cli/... -run TestRemoteCredential -v passes</verify>
  <done>RemoteCredentialClient accepts DeviceID and appends as query parameter when set</done>
</task>

<task type="auto">
  <name>Task 2: Wire device_id into CLI exec --remote-server mode</name>
  <files>cli/sentinel_exec.go, cli/sentinel_exec_test.go</files>
  <action>
Collect device ID and pass to remote TVM:

1. In SentinelExecCommand, before remote server mode section (~line 179):
   - Import "github.com/byteness/aws-vault/v7/device"
   - Call device.GetDeviceID() to get local device identifier
   - Log if device ID collection fails (warning, not error - fail-open like TVM)

2. In remote server mode section (line 179-204):
   - If device ID was collected successfully, append device_id query param to RemoteServer URL
   - Use url.Parse() and url.Values to properly construct URL
   - Log: "Including device_id in remote TVM request" (don't log the actual ID - privacy)

3. Add test coverage:
   - TestSentinelExec_RemoteServerWithDeviceID - mock device.GetDeviceID, verify URL includes device_id param
   - Update existing remote server tests to verify device_id handling

Note: Don't fail credential flow if device ID unavailable - TVM handles missing device_id gracefully (fail-open by default per 107-03-SUMMARY.md).
  </action>
  <verify>go test ./cli/... -run TestSentinelExec -v passes</verify>
  <done>CLI exec --remote-server includes device_id query parameter when device ID is available</done>
</task>

<task type="auto">
  <name>Task 3: Add integration test for device ID flow</name>
  <files>cli/sentinel_exec_test.go</files>
  <action>
Add integration test that verifies end-to-end device ID flow:

1. Create TestSentinelExec_DeviceIDFlow:
   - Set up mock HTTP server that captures request URL
   - Call exec with --remote-server pointing to mock server
   - Verify request includes device_id query parameter
   - Verify device_id format is 64-char lowercase hex (if available)

2. Test edge cases:
   - Device ID collection fails (e.g., no /etc/machine-id) - should still make request without device_id
   - Empty device ID - should not add device_id param

This ensures the full flow works from CLI through to TVM request construction.
  </action>
  <verify>go test ./cli/... -run TestSentinelExec_DeviceID -v passes</verify>
  <done>Integration test validates device ID flows from CLI to TVM request</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go build ./... succeeds
- [ ] go test ./cli/... passes
- [ ] go test ./device/... passes (device identity tests)
- [ ] RemoteCredentialClient with DeviceID appends query param correctly
- [ ] CLI exec --remote-server includes device_id when available
- [ ] Backward compatible - requests without device_id still work
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Device ID flows from CLI to TVM via query parameter
- Fail-open behavior preserved (missing device_id doesn't block credentials)
</success_criteria>

<output>
After completion, create `.planning/phases/109-device-attestation-flow/109-01-SUMMARY.md`
</output>
