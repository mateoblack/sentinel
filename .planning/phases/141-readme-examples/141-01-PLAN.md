---
phase: 141-readme-examples
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - README.md
  - terraform/sentinel-tvm/variables.tf
  - terraform/sentinel-tvm/main.tf
  - terraform/sentinel-tvm/iam.tf
  - docs/examples/policy-device-posture.yaml
  - docs/examples/policy-signing-workflow.md
autonomous: true
---

<objective>
Update README feature list for v1.18 completeness and add Terraform module variables for policy signing.

Purpose: Ensure README accurately reflects all shipped features and Terraform module supports signature verification configuration as documented in POLICY_SIGNING.md.
Output: Updated README, enhanced Terraform module, example documentation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 140 shows prior documentation pattern
@.planning/phases/140-security-hardening-guide/140-01-SUMMARY.md

# Current state of files to modify
@README.md
@terraform/sentinel-tvm/variables.tf
@terraform/sentinel-tvm/main.tf
@docs/POLICY_SIGNING.md
@docs/DEVICE_POSTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update README feature tables for v1.18 completeness</name>
  <files>README.md</files>
  <action>
Update README.md feature tables to include:

**Core section additions:**
- Add "Lambda TVM" row: "Server-side credential vending via Lambda (trust boundary enforcement)"

**Access Control section additions:**
- Add "Policy signing" row: "KMS-based cryptographic policy integrity verification"

**Real-time Revocation section:**
- Add "Lambda TVM deployment" row: "Server-side credential vending with policy evaluation at the trust boundary"
- This section already covers server mode; add Lambda TVM as enterprise option

**Operations & Onboarding section additions:**
- Add "Policy management" row: "`sentinel policy pull/push/diff/validate/sign/verify` for policy lifecycle"
- Add "Lambda TVM" row: "Terraform module and CDK example for Lambda TVM deployment"

Also verify existing entries are accurate for v1.18:
- Device posture already listed (correct)
- Session tracking already listed (correct)
- require_server already listed (correct)

Keep README concise - features are brief, documentation table links to full guides.
  </action>
  <verify>grep -E "Lambda TVM|Policy signing|policy pull" README.md confirms new features mentioned</verify>
  <done>README feature tables mention Lambda TVM, policy signing, and policy commands; feature list complete through v1.18</done>
</task>

<task type="auto">
  <name>Task 2: Add policy signing variables to Terraform sentinel-tvm module</name>
  <files>terraform/sentinel-tvm/variables.tf, terraform/sentinel-tvm/main.tf, terraform/sentinel-tvm/iam.tf</files>
  <action>
Add policy signing configuration to Terraform module to match POLICY_SIGNING.md documentation:

**variables.tf additions:**
```hcl
variable "policy_signing_key_arn" {
  description = "KMS key ARN or alias for policy signature verification. When set, policies must have valid signatures."
  type        = string
  default     = ""
}

variable "enforce_policy_signing" {
  description = "When true, reject policies without valid signatures. Defaults to true when policy_signing_key_arn is set."
  type        = bool
  default     = null  # Will default to true when signing key is set
}
```

**main.tf updates:**
Add to local.environment_variables:
```hcl
var.policy_signing_key_arn != "" ? {
  SENTINEL_POLICY_SIGNING_KEY     = var.policy_signing_key_arn
  SENTINEL_ENFORCE_POLICY_SIGNING = coalesce(var.enforce_policy_signing, true) ? "true" : "false"
} : {}
```

**iam.tf additions:**
Add KMS verify permission when signing key is provided. Add conditional statement:
```hcl
dynamic "statement" {
  for_each = var.policy_signing_key_arn != "" ? [1] : []
  content {
    sid       = "AllowPolicySignatureVerification"
    effect    = "Allow"
    actions   = ["kms:Verify", "kms:DescribeKey"]
    resources = [var.policy_signing_key_arn]
  }
}
```

Use the existing pattern in iam.tf for dynamic statements. Match existing code style.
  </action>
  <verify>terraform fmt -check terraform/sentinel-tvm/ && grep "policy_signing_key" terraform/sentinel-tvm/variables.tf</verify>
  <done>Terraform module has policy_signing_key_arn, enforce_policy_signing variables; Lambda gets environment variables; IAM role gets kms:Verify permission</done>
</task>

<task type="auto">
  <name>Task 3: Create example policy files for device posture and signing workflow</name>
  <files>docs/examples/policy-device-posture.yaml, docs/examples/policy-signing-workflow.md</files>
  <action>
Create docs/examples/ directory if it doesn't exist.

**Create docs/examples/policy-device-posture.yaml:**
```yaml
# Example Sentinel policy with device posture conditions
# Requires MDM enrollment and disk encryption for production access
version: "1"
rules:
  # Production access requires managed, encrypted device
  - name: prod-secure-device
    effect: allow
    conditions:
      profiles: [production]
      device:
        require_mdm: true
        require_encryption: true
    reason: Production access from MDM-enrolled device with disk encryption

  # Staging allows MDM-enrolled devices without encryption requirement
  - name: staging-mdm
    effect: allow
    conditions:
      profiles: [staging]
      device:
        require_mdm: true
    reason: Staging access from MDM-enrolled device

  # Development access without device requirements
  - name: dev-any-device
    effect: allow
    conditions:
      profiles: [dev]
    reason: Development access
```

**Create docs/examples/policy-signing-workflow.md:**
```markdown
# Policy Signing Workflow Example

This example shows the complete workflow for signing and deploying a Sentinel policy.

## Prerequisites

- KMS signing key created (see POLICY_SIGNING.md)
- `kms:Sign` permission for CI/CD or policy author
- Lambda TVM with `kms:Verify` permission

## Workflow

### 1. Create or Edit Policy

```yaml
# production-policy.yaml
version: "1"
rules:
  - name: prod-access
    effect: allow
    conditions:
      profiles: [production]
      device:
        require_mdm: true
    reason: Production access from managed device
```

### 2. Validate Locally

```bash
sentinel policy validate production-policy.yaml
```

### 3. Diff Against Current

```bash
sentinel policy diff production production-policy.yaml
```

### 4. Sign and Push

```bash
# Sign and push in one command
sentinel policy push production production-policy.yaml \
  --sign --key-id alias/sentinel-policy-signing

# This creates:
# /sentinel/policies/production - policy YAML
# /sentinel/signatures/production - signature JSON
```

### 5. Verify Deployment

```bash
# Pull and verify the deployed policy
sentinel policy pull production -o deployed.yaml
sentinel policy verify deployed.yaml \
  --key-id alias/sentinel-policy-signing \
  -s /tmp/sig.json
```

## CI/CD Integration

```yaml
# GitHub Actions example
- name: Sign and Deploy Policy
  run: |
    sentinel policy validate policy.yaml
    sentinel policy push production policy.yaml \
      --sign --key-id alias/sentinel-policy-signing \
      --force
  env:
    AWS_REGION: us-east-1
```
```

Keep examples focused and practical. Reference POLICY_SIGNING.md and DEVICE_POSTURE.md for full details.
  </action>
  <verify>ls docs/examples/*.yaml docs/examples/*.md && cat docs/examples/policy-device-posture.yaml | head -10</verify>
  <done>Example files created in docs/examples/ demonstrating device posture conditions and policy signing workflow</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] README feature tables include Lambda TVM, policy signing, policy commands
- [ ] terraform fmt -check terraform/sentinel-tvm/ passes (no formatting issues)
- [ ] Terraform module has policy_signing_key_arn and enforce_policy_signing variables
- [ ] Lambda environment includes SENTINEL_POLICY_SIGNING_KEY when signing key configured
- [ ] IAM role gets kms:Verify permission when signing key configured
- [ ] docs/examples/policy-device-posture.yaml demonstrates require_mdm and require_encryption
- [ ] docs/examples/policy-signing-workflow.md shows sign/push/verify workflow
</verification>

<success_criteria>

- All tasks completed
- README mentions Lambda TVM, policy signing, policy commands in feature tables
- Terraform module variables match POLICY_SIGNING.md documented interface
- Example files demonstrate v1.18 features (device posture, policy signing)
- No terraform fmt errors
</success_criteria>

<output>
After completion, create `.planning/phases/141-readme-examples/141-01-SUMMARY.md`
</output>
