---
phase: 89-breakglass-table-provisioning
plan: 02
type: execute
wave: 2
depends_on: ["89-01"]
files_modified: [cli/init_breakglass.go, cli/init_breakglass_test.go, cmd/sentinel/main.go]
autonomous: true
---

<objective>
Create `sentinel init breakglass` CLI command for DynamoDB break-glass table provisioning.

Purpose: Enable one-command creation of sentinel-breakglass table with correct schema.
Output: Working CLI command with --plan, --generate-iam, --table, --region, --aws-profile, --yes flags.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/88-approval-table-provisioning/88-03-SUMMARY.md
@.planning/phases/89-breakglass-table-provisioning/89-01-SUMMARY.md

@cli/init_approvals.go
@infrastructure/schema.go
@cmd/sentinel/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create init breakglass CLI command</name>
  <files>cli/init_breakglass.go</files>
  <action>
Create cli/init_breakglass.go following the exact pattern of cli/init_approvals.go:

1. Define DefaultBreakGlassTableName = "sentinel-breakglass"

2. Create InitBreakGlassCommandInput struct (copy InitApprovalsCommandInput exactly):
   - TableName, Region, AWSProfile, Plan, Yes, GenerateIAM
   - Provisioner, Stdin, Stdout, Stderr for testing

3. Create ConfigureInitBreakGlassCommand function:
   - Get or create "init" command
   - Add "breakglass" subcommand with description "Provision the DynamoDB break-glass events table"
   - Add flags: --table (default DefaultBreakGlassTableName), --region (required), --aws-profile, --plan, --yes/-y, --generate-iam
   - Action calls InitBreakGlassCommand

4. Create InitBreakGlassCommand function:
   - Handle --generate-iam using generateBreakGlassTableIAMPolicy helper
   - Load AWS config with profile and region
   - Get schema via infrastructure.BreakGlassTableSchema(tableName)
   - Handle --plan flag (show what would be created)
   - Show confirmation prompt unless --yes
   - Call provisioner.Create(ctx, schema)
   - Print result with next steps (mention --breakglass-table flag and SENTINEL_BREAKGLASS_TABLE env var)

5. Create generateBreakGlassTableIAMPolicy function:
   - Same pattern as generateTableIAMPolicy but with different Sid values:
     - SentinelBreakGlassTableProvisioning (CreateTable, DescribeTable, UpdateTimeToLive)
     - SentinelBreakGlassTableOperations (CRUD + Query/Scan)
  </action>
  <verify>gofmt -l cli/init_breakglass.go returns empty (no formatting issues)</verify>
  <done>init_breakglass.go follows init_approvals.go pattern exactly</done>
</task>

<task type="auto">
  <name>Task 2: Register command and add tests</name>
  <files>cmd/sentinel/main.go, cli/init_breakglass_test.go</files>
  <action>
1. In cmd/sentinel/main.go, add registration call:
   - Add: cli.ConfigureInitBreakGlassCommand(app, s)
   - Place after ConfigureInitApprovalsCommand for consistency

2. Create cli/init_breakglass_test.go following init_approvals_test.go pattern:
   - TestGenerateBreakGlassTableIAMPolicy: Verify:
     - Policy has correct Version
     - Has 2 statements with Sids: SentinelBreakGlassTableProvisioning, SentinelBreakGlassTableOperations
     - Provisioning actions: CreateTable, DescribeTable, UpdateTimeToLive
     - Operations actions: GetItem, PutItem, UpdateItem, DeleteItem, Query, Scan
     - Resource ARNs include table and index/*
   - TestInitBreakGlassCommandInput_Defaults: Verify struct has expected default values
  </action>
  <verify>gofmt -l cli/init_breakglass_test.go returns empty; go build ./cmd/sentinel compiles</verify>
  <done>Command registered in main.go, tests validate IAM policy generation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./cmd/sentinel` succeeds
- [ ] `gofmt -l cli/init_breakglass.go cli/init_breakglass_test.go` returns empty
- [ ] IAM policy Sids are SentinelBreakGlassTableProvisioning and SentinelBreakGlassTableOperations
- [ ] Next steps mention --breakglass-table and SENTINEL_BREAKGLASS_TABLE
</verification>

<success_criteria>

- sentinel init breakglass command created following init approvals pattern
- All flags work: --table, --region, --aws-profile, --plan, --yes, --generate-iam
- IAM policy generation uses correct Sid names for break-glass
- Command registered in main.go
- Tests validate IAM policy structure
</success_criteria>

<output>
After completion, create `.planning/phases/89-breakglass-table-provisioning/89-02-SUMMARY.md`
</output>
