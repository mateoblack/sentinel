---
phase: 56-integration-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cli/credential_flow_test.go
autonomous: true
---

<objective>
Create end-to-end credential flow integration tests that verify the complete credential issuance path with all policy evaluation, approval, and break-glass integrations.

Purpose: Validate that the CredentialsCommand function works correctly through all decision paths (allow, deny, approved-request-override, break-glass-override) with properly mocked AWS and store dependencies.
Output: cli/credential_flow_test.go with comprehensive integration tests achieving >80% path coverage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@cli/credentials.go
@cli/credentials_test.go
@testutil/mock_aws.go
@testutil/mock_stores.go
@policy/evaluate.go
@request/finder.go
@breakglass/finder.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create credential flow integration test file</name>
  <files>cli/credential_flow_test.go</files>
  <action>
Create cli/credential_flow_test.go with end-to-end integration tests for CredentialsCommand. The tests should use the existing testutil mocks and cover:

1. **Policy Allow Path:**
   - Test CredentialsCommand with allow policy decision
   - Verify credentials are issued when policy allows
   - Verify decision log entry is created with CredentialIssuanceFields

2. **Policy Deny Path:**
   - Test CredentialsCommand with deny policy decision
   - Verify "access denied" error is returned
   - Verify no credentials are issued

3. **Approved Request Override Path:**
   - Test CredentialsCommand with deny policy but valid approved request
   - Mock request.Store with approved request for user+profile
   - Verify credentials are issued despite policy deny
   - Verify ApprovedRequestID appears in log entry

4. **Break-Glass Override Path:**
   - Test CredentialsCommand with deny policy but active break-glass
   - Mock breakglass.Store with active break-glass event
   - Verify credentials are issued despite policy deny
   - Verify BreakGlassEventID appears in log entry
   - Verify session duration is capped to remaining break-glass time

5. **Priority Order Tests:**
   - Approved request checked before break-glass
   - If both exist, approved request takes precedence

Use testutil mocks: MockSSMClient (for policy loading), MockRequestStore (for approval), MockBreakGlassStore (for break-glass), MockLogger (for log verification).

Create a testable wrapper or mock for the Sentinel struct to avoid needing real AWS credentials. The key is testing the decision paths in CredentialsCommand, not the actual AWS credential retrieval.

Use table-driven tests where appropriate. Each test should be independent and not rely on external state.
  </action>
  <verify>go test -v -run TestCredentialFlow ./cli/... passes all new tests</verify>
  <done>All 5 decision path scenarios have passing tests with proper mock verification</done>
</task>

<task type="auto">
  <name>Task 2: Add logging integration verification tests</name>
  <files>cli/credential_flow_test.go</files>
  <action>
Extend cli/credential_flow_test.go with tests that verify the complete logging integration:

1. **Log Entry Field Verification:**
   - Test that DecisionLogEntry contains correct User, Profile, Effect, Rule fields
   - Test that CredentialIssuanceFields contains RequestID, SourceIdentity, RoleARN
   - Test that ApprovedRequestID is populated when using approved request
   - Test that BreakGlassEventID is populated when using break-glass

2. **Multi-Writer Logging:**
   - Test that logs go to both file and stderr when both are configured
   - Test that logs append to existing file (JSON Lines format)

3. **Drift Status Logging:**
   - Test that DriftStatus and DriftMessage appear in log when RequireSentinel is enabled
   - Test all drift status values (OK, Partial, None, Unknown)

Use MockLogger to capture and verify log entries. Test that logging failures don't prevent credential issuance (best-effort logging).
  </action>
  <verify>go test -v -run TestCredentialFlowLogging ./cli/... passes</verify>
  <done>Logging integration tests verify all log fields and multi-destination behavior</done>
</task>

<task type="auto">
  <name>Task 3: Add error handling integration tests</name>
  <files>cli/credential_flow_test.go</files>
  <action>
Add tests for error handling throughout the credential flow:

1. **Policy Loading Errors:**
   - Test behavior when SSM GetParameter fails
   - Test behavior when policy YAML is malformed
   - Verify appropriate error message to stderr

2. **Store Errors (Non-Fatal):**
   - Test that request.Store errors are logged but don't fail credential issuance
   - Test that breakglass.Store errors are logged but don't fail credential issuance
   - Verify credentials are still denied if store error prevents finding approval

3. **Profile Validation Errors:**
   - Test that missing profile returns clear error with available profiles listed

4. **Drift Check Errors (Non-Fatal):**
   - Test that drift checking errors don't prevent credential issuance
   - Verify warning is logged to stderr

All error tests should verify:
- Correct error message format
- Appropriate exit behavior (return error vs continue)
- No panic conditions
  </action>
  <verify>go test -v -run TestCredentialFlowErrors ./cli/... passes</verify>
  <done>Error handling tests cover all error paths with proper error propagation verification</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test -v ./cli/... passes with no failures
- [ ] go test -race ./cli/... passes (no race conditions)
- [ ] New tests cover allow, deny, approved-override, breakglass-override paths
- [ ] Logging integration tests verify all log fields
- [ ] Error handling tests cover all error paths
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- cli/credential_flow_test.go contains comprehensive end-to-end tests
- Tests use testutil mocks properly
- No race conditions in concurrent tests
</success_criteria>

<output>
After completion, create `.planning/phases/56-integration-testing/56-01-SUMMARY.md`
</output>
