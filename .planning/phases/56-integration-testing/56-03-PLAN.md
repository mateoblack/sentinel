---
phase: 56-integration-testing
plan: 03
type: execute
wave: 2
depends_on: ["56-01", "56-02"]
files_modified:
  - cli/command_integration_test.go
autonomous: true
---

<objective>
Create CLI command integration tests that verify Sentinel CLI commands work correctly with mock infrastructure, testing the full command execution path including kingpin parsing and output formatting.

Purpose: Validate that CLI commands integrate correctly with their dependencies and produce expected outputs, catching command configuration and output formatting bugs.
Output: cli/command_integration_test.go with tests for key Sentinel commands.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-integration-testing/56-01-SUMMARY.md
@.planning/phases/56-integration-testing/56-02-SUMMARY.md

@cli/request.go
@cli/approve.go
@cli/deny.go
@cli/list.go
@cli/check.go
@cli/breakglass.go
@cli/breakglass_list.go
@cli/breakglass_check.go
@cli/breakglass_close.go
@cli/bootstrap.go
@cli/enforce.go
@cli/audit.go
@testutil/mock_stores.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create approval workflow command integration tests</name>
  <files>cli/command_integration_test.go</files>
  <action>
Create cli/command_integration_test.go with integration tests for approval workflow commands:

1. **Request Command Integration:**
   - Test RequestCommand creates request with correct fields
   - Verify request is stored in mock store
   - Test output format (human-readable with request ID)
   - Test auto-approve path when ApprovalPolicy matches

2. **List Command Integration:**
   - Test ListCommand retrieves pending requests
   - Verify output format shows request details
   - Test with --profile filter
   - Test with empty results

3. **Check Command Integration:**
   - Test CheckCommand retrieves request by ID
   - Verify output shows request status and details
   - Test with non-existent request ID (error handling)

4. **Approve/Deny Command Integration:**
   - Test ApproveCommand updates request status
   - Test DenyCommand updates request status
   - Verify approver is recorded
   - Test authorization check (CanApprove from ApprovalPolicy)

Use testutil.MockRequestStore with in-memory storage. Test both human and JSON output formats where applicable.
  </action>
  <verify>go test -v -run TestCommandIntegration_Approval ./cli/... passes</verify>
  <done>Approval workflow command tests verify request, list, check, approve, deny commands</done>
</task>

<task type="auto">
  <name>Task 2: Create break-glass command integration tests</name>
  <files>cli/command_integration_test.go</files>
  <action>
Extend cli/command_integration_test.go with integration tests for break-glass commands:

1. **Breakglass Command Integration:**
   - Test BreakglassCommand creates event with correct fields
   - Verify event is stored in mock store
   - Test rate limiting check is called
   - Test policy authorization check
   - Verify notification is sent (mock notifier)

2. **Breakglass-List Command Integration:**
   - Test listing active break-glass events
   - Test with --profile filter
   - Test with --status filter
   - Verify output format

3. **Breakglass-Check Command Integration:**
   - Test retrieving break-glass event by ID
   - Verify output shows all event fields
   - Test with non-existent event ID

4. **Breakglass-Close Command Integration:**
   - Test closing active break-glass event
   - Verify ClosedBy and ClosedReason are recorded
   - Test closing already-closed event (error)
   - Verify notification is sent on close

Use testutil.MockBreakGlassStore with in-memory storage and MockNotifier for notification verification.
  </action>
  <verify>go test -v -run TestCommandIntegration_BreakGlass ./cli/... passes</verify>
  <done>Break-glass command tests verify breakglass, breakglass-list, breakglass-check, breakglass-close commands</done>
</task>

<task type="auto">
  <name>Task 3: Create bootstrap and enforcement command integration tests</name>
  <files>cli/command_integration_test.go</files>
  <action>
Extend cli/command_integration_test.go with integration tests for bootstrap and enforcement commands:

1. **Bootstrap Plan Command Integration:**
   - Test BootstrapCommand plan subcommand
   - Mock SSM to return existing/missing parameters
   - Verify plan output shows create/skip/exists states
   - Test IAM policy document generation

2. **Bootstrap Apply Command Integration:**
   - Test BootstrapCommand apply subcommand
   - Verify SSM PutParameter is called correctly
   - Test continue-on-error behavior
   - Test dry-run mode (no actual writes)

3. **Bootstrap Status Command Integration:**
   - Test StatusCommand retrieves SSM parameters
   - Verify output shows parameter status
   - Test with no parameters (clean output)

4. **Enforce Command Integration:**
   - Test EnforceCommand analyzes role trust policy
   - Mock IAM GetRole to return trust policy
   - Verify enforcement status output
   - Test generate subcommand outputs correct template

5. **Audit Verify Command Integration:**
   - Test AuditVerifyCommand queries CloudTrail
   - Mock CloudTrail LookupEvents
   - Verify pass rate calculation
   - Test output format with issues found

Use testutil.MockSSMClient, MockIAMClient, MockCloudTrailClient.
  </action>
  <verify>go test -v -run TestCommandIntegration_Bootstrap ./cli/... && go test -v -run TestCommandIntegration_Enforce ./cli/... passes</verify>
  <done>Bootstrap and enforcement command tests verify all subcommands with mock AWS services</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test -v ./cli/... passes with all new integration tests
- [ ] go test -race ./cli/... passes (no race conditions)
- [ ] Tests cover approval workflow commands (request, list, check, approve, deny)
- [ ] Tests cover break-glass commands (breakglass, breakglass-list, breakglass-check, breakglass-close)
- [ ] Tests cover bootstrap commands (plan, apply, status)
- [ ] Tests cover enforcement commands (enforce, enforce generate, audit verify)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- cli/command_integration_test.go contains comprehensive command tests
- Tests use testutil mocks for all AWS and store dependencies
- Output format verification for both human and JSON modes
</success_criteria>

<output>
After completion, create `.planning/phases/56-integration-testing/56-03-SUMMARY.md`
</output>
