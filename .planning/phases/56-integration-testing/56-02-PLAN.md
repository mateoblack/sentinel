---
phase: 56-integration-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - policy/integration_test.go
  - request/integration_test.go
autonomous: true
---

<objective>
Create multi-service integration tests that verify the interactions between policy evaluation, request approval, break-glass, and notification systems.

Purpose: Validate that the core domain packages work correctly together in realistic scenarios, catching integration bugs that unit tests miss.
Output: Integration test files in policy/ and request/ packages testing cross-service scenarios.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@policy/evaluate.go
@policy/schema.go
@policy/approval.go
@request/request.go
@request/finder.go
@request/store.go
@breakglass/event.go
@breakglass/finder.go
@notification/notifier.go
@notification/store.go
@testutil/mock_stores.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create policy-approval integration tests</name>
  <files>policy/integration_test.go</files>
  <action>
Create policy/integration_test.go testing the integration between policy evaluation and approval workflow:

1. **EffectRequireApproval Flow:**
   - Create policy with EffectRequireApproval rule
   - Evaluate request → verify RequireApproval effect
   - Create approval request in mock store
   - Approve request
   - Re-evaluate with approved request → verify access granted

2. **Auto-Approve Policy Integration:**
   - Create ApprovalPolicy with auto-approve conditions (user list, time window)
   - Test ShouldAutoApprove with matching conditions
   - Test that auto-approved requests don't need manual approval

3. **Approver Authorization Integration:**
   - Create ApprovalPolicy with specific approvers
   - Test CanApprove returns true for authorized approvers
   - Test CanApprove returns false for unauthorized users

4. **Time Window Policy Evaluation:**
   - Test policy rules with time windows
   - Verify time-based allow/deny decisions
   - Test edge cases: exactly at boundary times

Use policy_test package to avoid import cycles. Use testutil.MockRequestStore for request storage.
  </action>
  <verify>go test -v -run TestIntegration ./policy/... passes</verify>
  <done>Policy-approval integration tests cover EffectRequireApproval flow, auto-approve, and approver authorization</done>
</task>

<task type="auto">
  <name>Task 2: Create request-notification integration tests</name>
  <files>request/integration_test.go</files>
  <action>
Create request/integration_test.go testing the integration between request lifecycle and notification system:

1. **Request Lifecycle Notifications:**
   - Create request → verify RequestCreated notification sent
   - Approve request → verify RequestApproved notification sent
   - Deny request → verify RequestDenied notification sent
   - Cancel request → verify RequestCancelled notification sent

2. **NotifyStore Wrapper Integration:**
   - Test that NotifyStore wraps Store and sends notifications
   - Verify notification contains correct request details
   - Test that store errors propagate correctly even with notification

3. **Multiple Notifier Integration:**
   - Test NotifyStore with multiple notifiers (SNS + Webhook pattern)
   - Verify all notifiers receive notification
   - Test that one notifier failure doesn't block others (fire-and-forget)

4. **Break-Glass Notification Integration:**
   - Test break-glass event creation triggers notification
   - Test break-glass close triggers notification
   - Verify notification contains incident correlation fields

Use testutil.MockNotifier to capture and verify notifications.
  </action>
  <verify>go test -v -run TestIntegration ./request/... passes</verify>
  <done>Request-notification integration tests verify all lifecycle events trigger correct notifications</done>
</task>

<task type="auto">
  <name>Task 3: Create finder function integration tests</name>
  <files>request/integration_test.go</files>
  <action>
Extend request/integration_test.go with tests for finder functions that query multiple objects:

1. **FindApprovedRequest Integration:**
   - Create multiple requests for same user (pending, approved, expired)
   - Test FindApprovedRequest returns only valid approved request
   - Test that expired approved requests are not returned
   - Test profile matching (approved for different profile not returned)

2. **FindActiveBreakGlass Integration:**
   - Create multiple break-glass events (active, closed, expired)
   - Test FindActiveBreakGlass returns only active event
   - Test that expired events are not returned
   - Test user+profile matching

3. **Concurrent Access Tests:**
   - Test finder functions with concurrent store operations
   - Use goroutines to simulate simultaneous queries
   - Verify no race conditions with -race flag

4. **Edge Cases:**
   - Test with empty store
   - Test with nil store (should return nil, not panic)
   - Test with store returning errors

Use testutil.MockRequestStore and testutil.MockBreakGlassStore with in-memory storage for stateful tests.
  </action>
  <verify>go test -v -race -run TestIntegration ./request/... passes</verify>
  <done>Finder integration tests verify correct object retrieval across complex scenarios</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test -v ./policy/... passes with integration tests
- [ ] go test -v ./request/... passes with integration tests
- [ ] go test -race ./policy/... ./request/... passes (no race conditions)
- [ ] Tests verify cross-service interactions
- [ ] Notification integration tests verify fire-and-forget behavior
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Integration tests cover policy-approval, request-notification, and finder scenarios
- No race conditions detected
- Tests use in-memory mock stores for stateful scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/56-integration-testing/56-02-SUMMARY.md`
</output>
