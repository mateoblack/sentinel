---
phase: 101-client-integration
plan: 02
type: execute
wave: 2
depends_on: ["101-01"]
files_modified: [docs/LAMBDA_TVM_DEPLOYMENT.md, docs/LAMBDA_TVM_SCP.md, docs/CHANGELOG.md]
autonomous: true
---

<objective>
Document client integration patterns and SCP enforcement for TVM-only access.

Purpose: Enable users to configure clients for TVM integration and enforce TVM-only access via AWS SCPs.
Output: Updated deployment guide with client examples, new SCP patterns document, CHANGELOG update.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/101-client-integration/101-01-PLAN.md

Existing documentation:
@docs/LAMBDA_TVM_DEPLOYMENT.md
@docs/CHANGELOG.md

SCP enforcement concept:
- SCPs can deny AssumeRole unless called by specific principal (Lambda execution role)
- This forces all credential access through TVM
- Pattern: Deny sts:AssumeRole unless aws:PrincipalArn matches Lambda execution role
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SCP patterns document</name>
  <files>docs/LAMBDA_TVM_SCP.md</files>
  <action>
Create docs/LAMBDA_TVM_SCP.md with Service Control Policy patterns for TVM enforcement:

1. Overview section explaining why SCPs matter for TVM security
   - TVM is only secure if clients CAN'T bypass it
   - SCPs enforce TVM-only access at the AWS control plane level

2. Basic SCP pattern: Deny AssumeRole to protected roles except from TVM
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyDirectAssumeRole",
      "Effect": "Deny",
      "Action": "sts:AssumeRole",
      "Resource": "arn:aws:iam::*:role/Protected*",
      "Condition": {
        "StringNotEquals": {
          "aws:PrincipalArn": "arn:aws:iam::ACCOUNT:role/SentinelTVMExecutionRole"
        }
      }
    }
  ]
}
```

3. Advanced pattern: Allow TVM Lambda + deny all others
   - Use aws:PrincipalServiceName condition for Lambda
   - Combine with SourceArn for specific function

4. Pattern for multi-account: Allow TVM in central account
   - Cross-account trust setup
   - Organization-wide SCP

5. Testing section:
   - How to verify SCP is working
   - Common mistakes (forgetting to allow the TVM itself)

6. Gradual rollout strategy:
   - Start with audit mode (CloudTrail alerts, no deny)
   - Identify violators
   - Apply deny SCP

Keep document focused and practical - ~150 lines max.
  </action>
  <verify>Test file exists: ls docs/LAMBDA_TVM_SCP.md</verify>
  <done>SCP patterns document created with deny-except-TVM examples</done>
</task>

<task type="auto">
  <name>Task 2: Update deployment guide with client integration</name>
  <files>docs/LAMBDA_TVM_DEPLOYMENT.md</files>
  <action>
Add new section "Client Integration" to LAMBDA_TVM_DEPLOYMENT.md after the API Gateway section:

## Client Integration

### Using Sentinel CLI

```bash
# Use --remote-server to fetch credentials from TVM
sentinel exec --remote-server https://api.example.com/sentinel --profile production -- aws sts get-caller-identity
```

The CLI sets `AWS_CONTAINER_CREDENTIALS_FULL_URI` and the AWS SDK handles credential refresh automatically.

### Direct SDK Integration (No Sentinel CLI)

For applications using AWS SDKs directly:

```bash
# Set environment variable pointing to TVM
export AWS_CONTAINER_CREDENTIALS_FULL_URI=https://api.example.com/sentinel

# SDK automatically fetches credentials from this URL
# Request is signed with caller's existing credentials (SigV4)
aws sts get-caller-identity
```

**Important:** The TVM requires IAM authorization (SigV4). Callers must have valid AWS credentials to call the TVM endpoint. The TVM then issues role credentials based on Sentinel policy evaluation.

### Credential Flow

1. Client has base credentials (SSO, IAM user, instance role)
2. Client calls TVM with SigV4-signed request
3. TVM extracts caller identity from API Gateway
4. TVM evaluates Sentinel policy for caller
5. TVM calls AssumeRole with SourceIdentity stamping
6. TVM returns temporary role credentials
7. Client uses role credentials for AWS access

### IAM Permissions for Clients

Clients need permission to invoke the API Gateway endpoint:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "execute-api:Invoke",
      "Resource": "arn:aws:execute-api:REGION:ACCOUNT:API_ID/STAGE/GET/*"
    }
  ]
}
```

Also add reference to SCP document:

## Enforcement with SCPs

To ensure all access goes through the TVM, use AWS Service Control Policies (SCPs) to deny direct AssumeRole calls. See [LAMBDA_TVM_SCP.md](LAMBDA_TVM_SCP.md) for patterns.
  </action>
  <verify>grep -q "Client Integration" docs/LAMBDA_TVM_DEPLOYMENT.md</verify>
  <done>Client integration section added with CLI and direct SDK examples</done>
</task>

<task type="auto">
  <name>Task 3: Update CHANGELOG</name>
  <files>docs/CHANGELOG.md</files>
  <action>
Add Phase 101 changes to the [Unreleased - v1.14] section in CHANGELOG.md:

Under the existing v1.14 section, add:

### Phase 101: Client Integration
- **Remote TVM flag**: `sentinel exec --remote-server <url>` connects to Lambda TVM
- **Container credentials**: Sets `AWS_CONTAINER_CREDENTIALS_FULL_URI` for SDK integration
- **SCP patterns**: Documentation for enforcing TVM-only access via AWS SCPs
- **Client examples**: Direct SDK integration without Sentinel CLI changes

Ensure the entry follows the existing changelog format and style.
  </action>
  <verify>grep -q "Phase 101" docs/CHANGELOG.md</verify>
  <done>CHANGELOG updated with Phase 101 changes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] docs/LAMBDA_TVM_SCP.md exists with SCP patterns
- [ ] docs/LAMBDA_TVM_DEPLOYMENT.md has Client Integration section
- [ ] docs/CHANGELOG.md has Phase 101 entry
</verification>

<success_criteria>
- SCP patterns document explains TVM enforcement
- Deployment guide includes CLI and SDK client examples
- CHANGELOG reflects Phase 101 additions
- Documentation is practical and actionable
</success_criteria>

<output>
After completion, create `.planning/phases/101-client-integration/101-02-SUMMARY.md`
</output>
