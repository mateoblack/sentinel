---
phase: 101-client-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [cli/sentinel_exec.go, cli/sentinel_exec_test.go, cli/remote_credentials.go, cli/remote_credentials_test.go]
autonomous: true
---

<objective>
Add --remote-server flag to sentinel exec command for TVM integration.

Purpose: Enable clients to fetch credentials from Lambda TVM via AWS_CONTAINER_CREDENTIALS_FULL_URI, using SigV4-signed requests to the API Gateway endpoint.
Output: Working --remote-server flag with credential fetching and subprocess environment setup.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/100-api-gateway/100-01-SUMMARY.md
@.planning/phases/100-api-gateway/100-02-SUMMARY.md

Existing exec command:
@cli/sentinel_exec.go

Lambda TVM response format:
@lambda/handler.go (CredentialResponse struct)

AWS container credentials spec:
The TVM returns credentials in AWS container credentials format:
{
  "AccessKeyId": "...",
  "SecretAccessKey": "...",
  "Token": "...",
  "Expiration": "2024-01-01T00:00:00Z"
}

Client must:
1. Sign requests with SigV4 to API Gateway
2. Receive credentials in container format
3. Set AWS_CONTAINER_CREDENTIALS_FULL_URI for SDK integration
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create remote credentials client</name>
  <files>cli/remote_credentials.go</files>
  <action>
Create RemoteCredentialClient struct that:

1. Takes TVM URL and optional auth token (for local server compatibility)
2. For --remote-server mode (API Gateway): Uses SigV4-signed HTTP requests
3. Fetches credentials from TVM URL (GET request)
4. Parses AWS container credentials format response
5. Returns credentials with expiration

Key types:
```go
type RemoteCredentialClient struct {
    URL       string
    AuthToken string // For local server mode compatibility (optional)
    HTTPClient *http.Client
}

func NewRemoteCredentialClient(url string, authToken string) *RemoteCredentialClient

// Fetch credentials from remote TVM. Uses SigV4 if authToken is empty.
func (c *RemoteCredentialClient) GetCredentials(ctx context.Context) (*RemoteCredentialResult, error)

type RemoteCredentialResult struct {
    AccessKeyID     string
    SecretAccessKey string
    SessionToken    string
    Expiration      time.Time
}
```

For SigV4 signing:
- Load default AWS config
- Create SigV4 signer
- Sign GET request to TVM URL
- API Gateway extracts caller identity from signature

Do NOT add complex retry logic - keep it simple. Do NOT use external HTTP client libraries.
  </action>
  <verify>gofmt -l cli/remote_credentials.go returns empty (no formatting issues)</verify>
  <done>RemoteCredentialClient type exists with GetCredentials method that handles both SigV4 and token auth</done>
</task>

<task type="auto">
  <name>Task 2: Add --remote-server flag to exec command</name>
  <files>cli/sentinel_exec.go</files>
  <action>
Add --remote-server flag to SentinelExecCommandInput and command configuration:

1. Add to SentinelExecCommandInput:
```go
RemoteServer string // Remote TVM URL (e.g., https://api.example.com/sentinel)
```

2. Add flag in ConfigureSentinelExecCommand:
```go
cmd.Flag("remote-server", "Remote TVM URL for credential vending (uses AWS_CONTAINER_CREDENTIALS_FULL_URI)").
    StringVar(&input.RemoteServer)
```

3. In SentinelExecCommand, after server mode flag validation, add remote-server mode:
- If RemoteServer is set, this is a DIFFERENT mode from --server (local server)
- Remote mode: fetch credentials from TVM and set as env vars OR use container credentials URI
- Skip local policy evaluation - TVM handles it
- Skip local credential retrieval

4. Implementation approach for remote mode:
```go
if input.RemoteServer != "" {
    // Remote TVM mode - credentials come from external TVM
    // Set AWS_CONTAINER_CREDENTIALS_FULL_URI to point to TVM
    // SDK handles credential refresh automatically

    // Note: Can't validate profile exists locally - TVM has different profiles

    // Create env with container credentials pointing to TVM
    cmdEnv := createEnv(input.ProfileName, input.Region, "")
    cmdEnv.Set("AWS_CONTAINER_CREDENTIALS_FULL_URI", input.RemoteServer)

    // Prevent AWS SDK from reading config files
    cmdEnv.Set("AWS_CONFIG_FILE", "/dev/null")
    cmdEnv.Set("AWS_SHARED_CREDENTIALS_FILE", "/dev/null")

    // Default to shell if no command
    command := input.Command
    if command == "" {
        command = getDefaultShell()
    }

    return runSubProcess(command, input.Args, cmdEnv)
}
```

5. Add validation: --remote-server cannot be used with --server, --policy-parameter (TVM has its own policy)

6. Make --policy-parameter NOT required when --remote-server is set (TVM has its own policy config)
  </action>
  <verify>gofmt -l cli/sentinel_exec.go returns empty</verify>
  <done>--remote-server flag added, remote TVM mode implemented setting AWS_CONTAINER_CREDENTIALS_FULL_URI</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for remote credentials</name>
  <files>cli/remote_credentials_test.go, cli/sentinel_exec_test.go</files>
  <action>
1. In cli/remote_credentials_test.go:
   - Test GetCredentials parses valid container credentials JSON
   - Test GetCredentials handles HTTP errors
   - Test GetCredentials with auth token header
   - Use httptest.NewServer for mock TVM

2. In cli/sentinel_exec_test.go:
   - Test --remote-server flag is recognized (command parsing)
   - Test --remote-server conflicts with --server
   - Test --remote-server doesn't require --policy-parameter
   - No actual credential fetching in unit tests (requires real SigV4)

Test helper for mock TVM response:
```go
func mockTVMServer(t *testing.T) *httptest.Server {
    return httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        resp := `{
            "AccessKeyId": "ASIATESTACCESSKEY",
            "SecretAccessKey": "testsecret",
            "Token": "testtoken",
            "Expiration": "2024-01-01T00:00:00Z"
        }`
        w.Header().Set("Content-Type", "application/json")
        w.Write([]byte(resp))
    }))
}
```
  </action>
  <verify>gofmt -l cli/remote_credentials_test.go cli/sentinel_exec_test.go returns empty</verify>
  <done>Tests for remote credential client and exec flag conflicts exist</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] gofmt -l cli/remote_credentials.go cli/sentinel_exec.go returns empty
- [ ] gofmt -l cli/remote_credentials_test.go cli/sentinel_exec_test.go returns empty
- [ ] New types compile without errors (verify via gofmt as proxy)
</verification>

<success_criteria>
- --remote-server flag added to sentinel exec
- RemoteCredentialClient fetches credentials from TVM
- Flag conflicts validated (--remote-server vs --server)
- --policy-parameter not required with --remote-server
- Tests cover credential parsing and flag validation
</success_criteria>

<output>
After completion, create `.planning/phases/101-client-integration/101-01-SUMMARY.md`
</output>
