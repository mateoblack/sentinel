---
phase: 35-bootstrap-schema
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [bootstrap/types.go, bootstrap/types_test.go, bootstrap/validate.go, bootstrap/validate_test.go]
autonomous: true
---

<objective>
Define bootstrap configuration types, resource specifications, and state tracking for AWS setup automation.

Purpose: Establish the foundation for `sentinel init bootstrap` to create SSM policy parameters and generate IAM policy documents with deterministic, reversible operations.
Output: Bootstrap config types with resource specs, state tracking, and comprehensive validation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Pattern reference - follow these exactly:
@policy/types.go
@policy/loader.go
@breakglass/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bootstrap configuration and resource types</name>
  <files>bootstrap/types.go, bootstrap/types_test.go</files>
  <action>
Create new `bootstrap` package following established patterns from `policy` and `breakglass` packages:

**bootstrap/types.go:**

1. Package doc comment explaining bootstrap purpose: "Package bootstrap provides configuration and state management for Sentinel AWS setup automation. It defines types for specifying which SSM parameters to create and tracking what resources exist."

2. Constants:
   - `DefaultPolicyRoot = "/sentinel/policies"` (default SSM parameter path prefix)
   - `PolicyVersion = "1"` (current policy schema version)
   - `MaxProfileNameLength = 64` (AWS profile name limit)
   - `MaxPolicyRootLength = 512` (SSM parameter path limit)

3. `ResourceType` type (string) with constants:
   - `ResourceTypeSSMParameter` = "ssm_parameter" (policy parameter in SSM)
   - `ResourceTypeIAMPolicy` = "iam_policy" (generated IAM policy document)
   - Method: `IsValid() bool`

4. `ResourceState` type (string) with constants:
   - `StateExists` = "exists" (resource already in AWS)
   - `StateCreate` = "create" (needs to be created)
   - `StateUpdate` = "update" (exists but needs update)
   - `StateSkip` = "skip" (no action needed)
   - Method: `IsValid() bool`

5. `BootstrapConfig` struct - top-level bootstrap specification:
   - `PolicyRoot` string (SSM parameter path prefix, e.g., "/sentinel/policies")
   - `Profiles` []ProfileConfig (profiles to bootstrap)
   - `GenerateIAMPolicies` bool (whether to generate IAM policy docs)
   - `Region` string (AWS region, optional - uses default if empty)
   - yaml/json tags with omitempty for optional fields

6. `ProfileConfig` struct - per-profile bootstrap config:
   - `Name` string (AWS profile name)
   - `Description` string (profile description for policy comments)
   - `PolicyParameterName` string (full SSM parameter name, auto-generated if empty)
   - `InitialPolicy` string (initial policy YAML content, optional)
   - yaml/json tags with omitempty

7. `ResourceSpec` struct - planned resource operation:
   - `Type` ResourceType
   - `Name` string (resource identifier - SSM param name or IAM policy name)
   - `State` ResourceState (what action to take)
   - `CurrentVersion` string (existing version if any)
   - `Description` string (human-readable description)
   - yaml/json tags with omitempty

8. `BootstrapPlan` struct - full bootstrap plan output:
   - `Config` BootstrapConfig (input config)
   - `Resources` []ResourceSpec (planned operations)
   - `Summary` PlanSummary (counts by state)
   - `GeneratedAt` time.Time

9. `PlanSummary` struct - operation counts:
   - `ToCreate` int
   - `ToUpdate` int
   - `ToSkip` int
   - `Total` int

10. Helper functions:
    - `DefaultPolicyParameterName(policyRoot, profile string) string` - returns "{policyRoot}/{profile}"
    - `IAMPolicyName(prefix, suffix string) string` - returns "Sentinel{Prefix}{Suffix}" format

**bootstrap/types_test.go:**

Table-driven tests for:
- `ResourceType.IsValid()` - all valid values and invalid
- `ResourceState.IsValid()` - all valid values and invalid
- `DefaultPolicyParameterName()` - various inputs
- `IAMPolicyName()` - prefix/suffix combinations
  </action>
  <verify>go test ./bootstrap/... -run "TestResourceType|TestResourceState|TestDefaultPolicyParameterName|TestIAMPolicyName" -v</verify>
  <done>All bootstrap types defined with passing tests, ready for validation in Task 2</done>
</task>

<task type="auto">
  <name>Task 2: Implement validation and state tracking helpers</name>
  <files>bootstrap/validate.go, bootstrap/validate_test.go</files>
  <action>
Create validation following established patterns from `breakglass/validate.go` and `policy/validate.go`:

**bootstrap/validate.go:**

1. `Validate()` method on `*BootstrapConfig`:
   - PolicyRoot must not be empty
   - PolicyRoot must start with "/" (SSM parameter path convention)
   - PolicyRoot length <= MaxPolicyRootLength
   - PolicyRoot must not contain invalid chars (only alphanumeric, /, -, _)
   - At least one profile required
   - Each profile must pass validation
   - Return descriptive error messages with field context

2. `Validate()` method on `*ProfileConfig`:
   - Name must not be empty
   - Name length <= MaxProfileNameLength
   - Name must be valid AWS profile name (alphanumeric, -, _)
   - If InitialPolicy provided, must be valid YAML (parse check only)
   - Return descriptive error messages

3. `Validate()` method on `*ResourceSpec`:
   - Type must be valid
   - Name must not be empty
   - State must be valid

4. `Validate()` method on `*BootstrapPlan`:
   - Config must be valid
   - All resources must be valid

5. State tracking helpers:
   - `(p *BootstrapPlan) HasChanges() bool` - returns true if any resource is create/update
   - `(p *BootstrapPlan) CountByState(state ResourceState) int` - count resources in given state
   - `(s *PlanSummary) Compute(resources []ResourceSpec)` - populate summary from resource list

6. Path validation helper (internal):
   - `isValidSSMPath(path string) bool` - validates SSM parameter path format
   - `isValidProfileName(name string) bool` - validates AWS profile name format

**bootstrap/validate_test.go:**

Table-driven tests for:
- `BootstrapConfig.Validate()`:
  - Valid config passes
  - Empty PolicyRoot fails
  - PolicyRoot not starting with "/" fails
  - PolicyRoot too long fails
  - PolicyRoot with invalid chars fails
  - Empty profiles fails
  - Invalid profile fails (propagates error)

- `ProfileConfig.Validate()`:
  - Valid profile passes
  - Empty name fails
  - Name too long fails
  - Name with invalid chars fails
  - Boundary tests (exactly max length)

- `ResourceSpec.Validate()`:
  - Valid spec passes
  - Invalid type fails
  - Empty name fails
  - Invalid state fails

- `BootstrapPlan.HasChanges()`:
  - All skip = false
  - Has create = true
  - Has update = true
  - Empty resources = false

- `BootstrapPlan.CountByState()`:
  - Various resource mixes

- `PlanSummary.Compute()`:
  - Counts correctly categorized
  </action>
  <verify>go test ./bootstrap/... -v</verify>
  <done>All validation tests pass, comprehensive coverage for config, profile, resource spec, and state tracking</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `go test ./bootstrap/...` passes all tests
- [ ] `go vet ./bootstrap/...` reports no issues
- [ ] Types follow established patterns from policy/ and breakglass/ packages
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- BootstrapConfig ready for planner (Phase 36 dependency)
- ResourceSpec enables dry-run planning (Phase 36 dependency)
- State tracking enables existence checks (Phase 40-41 dependency)
</success_criteria>

<output>
After completion, create `.planning/phases/35-bootstrap-schema/35-01-SUMMARY.md`
</output>
