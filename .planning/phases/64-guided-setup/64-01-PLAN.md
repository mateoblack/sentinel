---
phase: 64-guided-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cli/init_wizard.go
  - cli/init_wizard_test.go
  - cmd/sentinel/main.go
autonomous: true
---

<objective>
Create `sentinel init` interactive wizard for guided first-time configuration.

Purpose: Walk new users through Sentinel setup step-by-step, discovering profiles, selecting features, and generating deployment artifacts without requiring prior knowledge of Sentinel's architecture.

Output: Interactive CLI wizard that produces configuration guidance, IAM policies, and optional sample policies.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/61-permissions-command/61-01-SUMMARY.md
@.planning/phases/62-feature-detection/62-01-SUMMARY.md
@.planning/phases/63-permission-validation/63-01-SUMMARY.md

@cli/bootstrap.go
@cli/permissions.go
@permissions/types.go
@permissions/registry.go
@permissions/detection.go
@bootstrap/generator.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create wizard types and flow logic</name>
  <files>cli/init_wizard.go</files>
  <action>
Create wizard infrastructure in cli/init_wizard.go:

**WizardState struct:**
```go
type WizardState struct {
    // User selections
    Profiles        []string           // AWS profiles to configure
    Features        []permissions.Feature // Selected features
    Region          string             // AWS region
    GenerateIAM     bool               // Generate IAM policy
    GenerateSample  bool               // Generate sample policies

    // Detection results (optional)
    DetectionResult *permissions.DetectionResult

    // Outputs
    IAMPolicy       string             // Generated IAM policy JSON
    SamplePolicies  map[string]string  // profile -> sample policy YAML
}
```

**WizardStep type:**
```go
type WizardStep int
const (
    StepWelcome WizardStep = iota
    StepProfiles
    StepFeatures
    StepRegion
    StepOutputOptions
    StepSummary
    StepComplete
)
```

**InitWizardCommandInput struct:**
```go
type InitWizardCommandInput struct {
    // Non-interactive mode flags (for scripting)
    Profiles       []string
    Features       []string
    Region         string
    SkipDetection  bool
    OutputFormat   string  // human, json

    // I/O for testing
    Stdin  *bufio.Scanner
    Stdout *os.File
    Stderr *os.File

    // Detector for testing
    Detector permissions.DetectorInterface
}
```

**Helper functions:**

1. `discoverProfiles()` - Parse ~/.aws/config to find available profiles using vault.LoadConfig pattern
2. `promptMultiSelect(prompt string, options []string, stdin, stdout)` - Interactive multi-select with numbered options, returns selected indices
3. `promptYesNo(prompt string, defaultYes bool, stdin, stdout)` - Yes/no prompt with default
4. `promptSingleSelect(prompt string, options []string, stdin, stdout)` - Single select from options

**Flow logic:**
- Each step checks if values already provided via flags (non-interactive mode)
- If no flags provided, prompt interactively
- Store selections in WizardState
- Generate outputs based on state
- Human output shows clear step progress (Step 1/6, Step 2/6, etc.)

Use existing patterns from:
- cli/bootstrap.go for confirmation prompts (bufio.Scanner pattern)
- permissions.FormatTerraform/FormatJSON for IAM output
- bootstrap.GenerateSamplePolicy for sample policy generation

Do NOT use third-party prompt libraries - keep it simple with bufio.Scanner like bootstrap.go does.
  </action>
  <verify>go build ./cli compiles without errors</verify>
  <done>WizardState, WizardStep, InitWizardCommandInput types defined; helper functions implemented; flow logic handles both interactive and non-interactive modes</done>
</task>

<task type="auto">
  <name>Task 2: Create `sentinel init` wizard CLI command</name>
  <files>cli/init_wizard.go, cli/init_wizard_test.go, cmd/sentinel/main.go</files>
  <action>
Add wizard command implementation:

**ConfigureInitWizardCommand function:**
Register `sentinel init` command (as the default init subcommand, with bootstrap as sibling):
- `--profile` flag (repeatable) - Pre-select profiles
- `--feature` flag (repeatable) - Pre-select features
- `--region` flag - AWS region
- `--skip-detection` flag - Skip auto-detection step
- `--format` flag - Output format (human, json)

Since `sentinel init bootstrap` already exists in bootstrap.go, the wizard becomes the parent command action. Structure:
```
sentinel init           # Runs wizard
sentinel init bootstrap # Runs bootstrap (existing)
```

**InitWizardCommand function:**
Implements the wizard flow:

```
Step 1/6: Welcome
══════════════════════════════════════════
Welcome to Sentinel!

This wizard will help you configure Sentinel for your AWS environment.

Step 2/6: Profile Selection
══════════════════════════════════════════
Found 5 AWS profiles in ~/.aws/config:

  [1] production
  [2] staging
  [3] development
  [4] sandbox
  [5] shared-services

Which profiles should Sentinel manage? (comma-separated, e.g., 1,2,3)
> 1,2

Selected: production, staging

Step 3/6: Feature Selection
══════════════════════════════════════════
Which features do you need?

  [1] policy_load        - Load policies from SSM (required)
  [2] credential_issue   - Issue credentials with SourceIdentity (required)
  [3] approval_workflow  - Request/approve access flow
  [4] breakglass        - Emergency access bypass
  [5] audit_verify      - CloudTrail session verification
  [6] enforce_analyze   - IAM trust policy analysis
  [7] bootstrap_plan    - Bootstrap planning
  [8] bootstrap_apply   - Bootstrap SSM parameter creation
  [9] notify_sns        - SNS notifications (optional)

Select features (comma-separated, or 'all' for all required):
> 1,2,3,4

Selected: policy_load, credential_issue, approval_workflow, breakglass

Step 4/6: AWS Region
══════════════════════════════════════════
Which AWS region for SSM/DynamoDB resources?
(Press Enter for us-east-1):
> us-west-2

Selected: us-west-2

Step 5/6: Output Options
══════════════════════════════════════════
Generate IAM policy document? [Y/n]: y
Generate sample Sentinel policies? [Y/n]: y

Step 6/6: Summary
══════════════════════════════════════════
Configuration Summary:

Profiles: production, staging
Features: policy_load, credential_issue, approval_workflow, breakglass
Region: us-west-2
IAM Policy: Yes
Sample Policies: Yes

Proceed? [Y/n]: y

════════════════════════════════════════
Output
════════════════════════════════════════

--- IAM Policy ---
{
  "Version": "2012-10-17",
  ...
}

--- Sample Policy: production ---
# Sentinel policy for profile: production
...

--- Sample Policy: staging ---
# Sentinel policy for profile: staging
...

════════════════════════════════════════
Next Steps
════════════════════════════════════════

1. Create the IAM policy and attach to your Sentinel user/role
2. Save the sample policies to files:
   sentinel init bootstrap --profile production --profile staging --region us-west-2

3. Verify permissions:
   sentinel permissions check --auto-detect

4. Configure credential_process in ~/.aws/config:
   [profile production]
   credential_process = sentinel credentials --profile production

```

**JSON output mode:**
When --format=json, output structured JSON:
```json
{
  "profiles": ["production", "staging"],
  "features": ["policy_load", "credential_issue", ...],
  "region": "us-west-2",
  "iam_policy": {...},
  "sample_policies": {
    "production": "...",
    "staging": "..."
  },
  "next_steps": [...]
}
```

**Tests in cli/init_wizard_test.go:**
- Test non-interactive mode with all flags
- Test profile discovery from mock config
- Test feature selection parsing
- Test IAM policy generation matches permissions.FormatJSON output
- Test sample policy generation uses bootstrap.GenerateSamplePolicy
- Test JSON output format

**Wire in cmd/sentinel/main.go:**
Add `cli.ConfigureInitWizardCommand(app, s)` in the Sentinel commands section.

Important: The init command must work alongside existing `init bootstrap` subcommand. Use kingpin's parent command action pattern.
  </action>
  <verify>go test ./cli -run TestInitWizard -v passes; sentinel init --help shows wizard options; sentinel init --profile prod --feature policy_load --feature credential_issue --format json outputs valid JSON</verify>
  <done>`sentinel init` wizard runs interactively; --profile/--feature/--format flags work for scripting; JSON output includes all fields; tests cover interactive and non-interactive modes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds without errors
- [ ] `go test ./cli -run TestInitWizard -v` passes all tests
- [ ] `sentinel init --help` shows wizard command with flags
- [ ] `sentinel init bootstrap --help` still works (existing command)
- [ ] Interactive mode works: prompts for input, generates output
- [ ] Non-interactive mode works: flags bypass prompts
- [ ] JSON output is valid and parseable
</verification>

<success_criteria>
- All tasks completed
- Wizard guides users through profile/feature/region selection
- Generates IAM policy using existing permissions.FormatJSON
- Generates sample policies using bootstrap.GenerateSamplePolicy
- Shows next steps for deployment
- Both interactive and non-interactive modes work
- Tests cover key paths
</success_criteria>

<output>
After completion, create `.planning/phases/64-guided-setup/64-01-SUMMARY.md`
</output>
