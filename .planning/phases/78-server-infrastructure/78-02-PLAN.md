---
phase: 78-server-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["78-01"]
files_modified: [cli/sentinel_exec.go, cli/sentinel_exec_test.go]
autonomous: true
---

<objective>
Add --server flag to sentinel exec command to run in credential server mode.

Purpose: Enable users to run `sentinel exec --server --profile X --policy-parameter /sentinel/policies/default -- command` to use server-based credential provisioning with per-request policy evaluation.
Output: Working --server flag on sentinel exec command that starts SentinelServer instead of env var injection.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan output:
@.planning/phases/78-server-infrastructure/78-01-SUMMARY.md

# Key source files:
@cli/sentinel_exec.go
@cli/exec.go
@sentinel/server.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --server flag and server startup logic to sentinel exec</name>
  <files>cli/sentinel_exec.go</files>
  <action>
Modify cli/sentinel_exec.go to add server mode:

1. Add to SentinelExecCommandInput struct:
   - StartServer (bool) - Run credential server instead of env var injection
   - ServerPort (int) - Port for server (0 = auto-assign)
   - Lazy (bool) - Lazily fetch credentials in server mode

2. Add to ConfigureSentinelExecCommand flags:
   ```go
   cmd.Flag("server", "Run a credential server in the background for per-request policy evaluation (the SDK or app must support AWS_CONTAINER_CREDENTIALS_FULL_URI)").
       Short('s').
       BoolVar(&input.StartServer)

   cmd.Flag("server-port", "Port for credential server (0 for auto-assign)").
       Default("0").
       IntVar(&input.ServerPort)

   cmd.Flag("lazy", "When using --server, lazily fetch credentials").
       BoolVar(&input.Lazy)
   ```

3. Add validation in SentinelExecCommand:
   - If StartServer && NoSession: error "Can't use --server with --no-session"
   - If StartServer && MfaPromptMethod == "terminal": error "Can't use --prompt=terminal with --server"

4. Modify SentinelExecCommand flow - after policy load and identity retrieval (step 5), add server mode branch:

   ```go
   if input.StartServer {
       // Server mode: start SentinelServer for per-request policy evaluation
       serverConfig := sentinel.SentinelServerConfig{
           ProfileName:     input.ProfileName,
           PolicyParameter: input.PolicyParameter,
           Region:          input.Region,
           NoSession:       input.NoSession,
           SessionDuration: input.SessionDuration,
           User:            username,
           Logger:          logger,
           Store:           input.Store,
           BreakGlassStore: input.BreakGlassStore,
           PolicyLoader:    cachedLoader,
           Sentinel:        s,
           LazyLoad:        input.Lazy,
       }

       sentinelServer, err := sentinel.NewSentinelServer(ctx, serverConfig, "", input.ServerPort)
       if err != nil {
           return 0, fmt.Errorf("Failed to start credential server: %w", err)
       }

       go func() {
           if err := sentinelServer.Serve(); err != http.ErrServerClosed {
               log.Fatalf("credential server: %s", err.Error())
           }
       }()

       // Set environment for subprocess
       cmdEnv.Set("AWS_CONTAINER_CREDENTIALS_FULL_URI", sentinelServer.BaseURL())
       cmdEnv.Set("AWS_CONTAINER_AUTHORIZATION_TOKEN", sentinelServer.AuthToken())

       log.Printf("Starting Sentinel credential server at %s", sentinelServer.BaseURL())

       // Remove AWS_SENTINEL since credentials come from server, not env
       cmdEnv.Unset("AWS_SENTINEL")

       // Run subprocess (can't use exec syscall with server)
       return runSubProcess(command, input.Args, cmdEnv)
   }
   ```

5. Update existing flow comments to clarify it's the "env var mode" branch.

Key differences from standard env var mode:
- Policy evaluated per request (by server), not once at startup
- Credentials come from HTTP server, not env vars
- Cannot use exec syscall (need to keep server running)
- Must run as subprocess to keep server alive
  </action>
  <verify>go build ./cmd/sentinel/... compiles without errors</verify>
  <done>--server flag added to sentinel exec with server startup logic</done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for server mode</name>
  <files>cli/sentinel_exec_test.go</files>
  <action>
Add tests to cli/sentinel_exec_test.go for server mode:

1. TestSentinelExecCommand_ServerMode_PolicyAllow:
   - Mock policy loader returning allow policy
   - Mock STS client returning test identity
   - Set StartServer=true
   - Verify server starts and AWS_CONTAINER_CREDENTIALS_FULL_URI is set
   - Note: Can't easily test full subprocess flow, focus on server startup

2. TestSentinelExecCommand_ServerMode_ValidationErrors:
   - Test --server with --no-session returns error
   - Test --server with --prompt=terminal returns error

3. TestSentinelExecCommand_ServerMode_Lazy:
   - Verify Lazy=true defers credential prefetch

Test helper needed:
- testableSentinelExecServerCommand() that exposes SentinelServer for testing without subprocess

Pattern: Follow existing test patterns in sentinel_exec_test.go using mock stores and policy loaders.
  </action>
  <verify>go test ./cli/... -run SentinelExec.*Server -v passes all tests</verify>
  <done>Integration tests cover server mode startup, validation, and configuration</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go build ./cmd/sentinel/... succeeds
- [ ] go test ./cli/... -run SentinelExec passes
- [ ] No race conditions: go test ./cli/... -race passes
- [ ] Manual test: sentinel exec --server --profile test --policy-parameter /test -- aws sts get-caller-identity
</verification>

<success_criteria>

- --server flag added to sentinel exec command
- Server mode starts SentinelServer and sets AWS_CONTAINER_CREDENTIALS_FULL_URI
- Validation prevents incompatible flag combinations
- Tests cover server mode scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/78-server-infrastructure/78-02-SUMMARY.md`
</output>
