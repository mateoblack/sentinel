---
phase: 39-iam-policy-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [bootstrap/iam.go, bootstrap/iam_test.go]
autonomous: true
---

<objective>
Generate IAM policy documents for SentinelPolicyReader and SentinelPolicyAdmin roles.

Purpose: Enable users to set up least-privilege IAM roles for accessing Sentinel policy parameters in SSM. Reader policy allows policy consumers to read parameters, Admin policy allows policy maintainers to manage parameters.
Output: Two IAM policy generator functions that produce valid AWS IAM policy JSON documents.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-bootstrap-schema/35-01-SUMMARY.md
@.planning/phases/36-bootstrap-planner/36-01-SUMMARY.md

Source files:
@bootstrap/types.go
@bootstrap/generator.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IAM policy document types and generator functions</name>
  <files>bootstrap/iam.go</files>
  <action>
Create IAM policy document types and generator functions following AWS IAM policy structure:

1. Define IAM policy document types:
```go
// IAMPolicyDocument represents an AWS IAM policy document.
type IAMPolicyDocument struct {
    Version   string           `json:"Version"`
    Statement []IAMStatement   `json:"Statement"`
}

// IAMStatement represents a single statement in an IAM policy.
type IAMStatement struct {
    Sid      string   `json:"Sid,omitempty"`
    Effect   string   `json:"Effect"`
    Action   []string `json:"Action"`
    Resource []string `json:"Resource"`
}
```

2. Create GenerateReaderPolicy(policyRoot string) function:
   - Returns IAMPolicyDocument with single statement
   - Sid: "SentinelPolicyRead"
   - Effect: "Allow"
   - Actions: ssm:GetParameter, ssm:GetParameters, ssm:GetParametersByPath
   - Resource: arn:aws:ssm:*:*:parameter{policyRoot}/* (use policyRoot from input)
   - Always include Version "2012-10-17"

3. Create GenerateAdminPolicy(policyRoot string) function:
   - Returns IAMPolicyDocument with single statement
   - Sid: "SentinelPolicyAdmin"
   - Effect: "Allow"
   - Actions: Reader actions + ssm:PutParameter, ssm:DeleteParameter, ssm:AddTagsToResource, ssm:RemoveTagsFromResource
   - Same Resource pattern as reader
   - Version "2012-10-17"

4. Create FormatIAMPolicy(doc IAMPolicyDocument) (string, error) function:
   - Marshal document to indented JSON (2-space indent)
   - Return formatted JSON string

Note: Use * wildcards for region/account in ARN for portability. Users can restrict if needed.
  </action>
  <verify>go build ./bootstrap/... succeeds</verify>
  <done>IAMPolicyDocument types defined, GenerateReaderPolicy, GenerateAdminPolicy, and FormatIAMPolicy functions implemented</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for IAM policy generation</name>
  <files>bootstrap/iam_test.go</files>
  <action>
Create table-driven tests for IAM policy generation:

1. TestGenerateReaderPolicy:
   - Test with default policy root (/sentinel/policies)
   - Test with custom policy root (/custom/path)
   - Verify Version is "2012-10-17"
   - Verify Statement count is 1
   - Verify Sid is "SentinelPolicyRead"
   - Verify Effect is "Allow"
   - Verify all 3 read actions present: ssm:GetParameter, ssm:GetParameters, ssm:GetParametersByPath
   - Verify Resource ARN pattern matches expected format

2. TestGenerateAdminPolicy:
   - Test with default policy root
   - Test with custom policy root
   - Verify all 7 actions present (3 read + 4 write)
   - Verify Sid is "SentinelPolicyAdmin"
   - Verify Resource ARN matches expected format

3. TestFormatIAMPolicy:
   - Test produces valid JSON
   - Test JSON can be unmarshaled back (round-trip)
   - Test indentation is present (contains newlines)

4. TestIAMPolicyResourceARN:
   - Test policy root without trailing slash produces correct ARN
   - Test policy root with trailing slash is handled correctly
   - Test ARN ends with /* for wildcard matching
  </action>
  <verify>go test ./bootstrap/... -v -run "IAM" passes</verify>
  <done>All IAM policy generation tests pass with comprehensive coverage</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go build ./bootstrap/... succeeds
- [ ] go test ./bootstrap/... -v passes
- [ ] GenerateReaderPolicy produces valid IAM policy JSON
- [ ] GenerateAdminPolicy produces valid IAM policy JSON
- [ ] Policy resource ARNs correctly reference the policy root
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- IAM policy documents follow AWS IAM policy structure
- Resource ARNs correctly constructed with policy root
</success_criteria>

<output>
After completion, create `.planning/phases/39-iam-policy-generation/39-01-SUMMARY.md`
</output>
