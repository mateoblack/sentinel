---
phase: 83-server-mode-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [sentinel/server_test.go]
autonomous: true
---

<objective>
Add comprehensive tests for server-side session revocation checking in SentinelServer.

Purpose: The server code (server.go lines 270-283) checks for session revocation before serving credentials, implementing fail-closed security (revoked = deny) and fail-open availability (store errors = allow). These security-critical paths have NO test coverage.
Output: Server revocation tests verifying security semantics (revoked sessions denied, store errors logged but don't block).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@sentinel/server.go
@sentinel/server_test.go
@session/revoke.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add server revocation deny test</name>
  <files>sentinel/server_test.go</files>
  <action>
Add test `TestSentinelServer_SessionRevoked_DeniesCredentials` that:
1. Creates a MockSessionStore with a session that has Status=revoked
2. Creates server with SessionStore configured
3. Manually sets server.sessionID to the revoked session's ID (for test setup)
4. Makes credential request
5. Verifies HTTP 403 response with "Session revoked" message
6. Verifies credentials NOT issued (MockCredentialProvider not called)

The mock store's Get method should return a session with Status=StatusRevoked.

Use the existing MockSessionStore and modify Get to return a revoked session when GetResult is set:
```go
func TestSentinelServer_SessionRevoked_DeniesCredentials(t *testing.T) {
    mockStore := NewMockSessionStore()
    revokedSession := &session.ServerSession{
        ID:     "abc1234567890def",
        Status: session.StatusRevoked,
        // ... other fields
    }
    mockStore.GetResult = revokedSession
    // ... create server and make request
}
```
  </action>
  <verify>go test -v -run TestSentinelServer_SessionRevoked ./sentinel/</verify>
  <done>Test passes, proving revoked sessions are denied credentials (fail-closed security)</done>
</task>

<task type="auto">
  <name>Task 2: Add server revocation store error test</name>
  <files>sentinel/server_test.go</files>
  <action>
Add test `TestSentinelServer_SessionRevocationStoreError_AllowsCredentials` that:
1. Creates a MockSessionStore that returns an error on Get (simulating DynamoDB connectivity issue)
2. Creates server with SessionStore configured and a valid sessionID
3. Makes credential request
4. Verifies HTTP 200 response with credentials (fail-open for availability)
5. Verifies warning was logged (optional - depends on capturing log output)

Configure the mock:
```go
mockStore.GetErr = errors.New("DynamoDB timeout")
```

This tests the fail-open behavior: store errors don't block credential issuance.
  </action>
  <verify>go test -v -run TestSentinelServer_SessionRevocationStoreError ./sentinel/</verify>
  <done>Test passes, proving store errors allow credentials (fail-open availability)</done>
</task>

<task type="auto">
  <name>Task 3: Add server active session allows credentials test</name>
  <files>sentinel/server_test.go</files>
  <action>
Add test `TestSentinelServer_SessionActive_AllowsCredentials` that:
1. Creates a MockSessionStore with an active session
2. Creates server with SessionStore configured
3. Makes credential request
4. Verifies HTTP 200 response with credentials
5. Verifies Touch was called (session tracking working)

This confirms the happy path where active sessions serve credentials normally.

The existing TestSentinelServer_SessionTouch test partially covers this but doesn't explicitly verify the revocation check doesn't block active sessions.
  </action>
  <verify>go test -v -run TestSentinelServer_SessionActive ./sentinel/</verify>
  <done>Test passes, proving active sessions serve credentials normally</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test -v ./sentinel/... passes all tests
- [ ] New tests cover fail-closed (revoked → deny) security semantic
- [ ] New tests cover fail-open (store error → allow) availability semantic
- [ ] No test regressions introduced
</verification>

<success_criteria>

- All tasks completed
- Server revocation behavior fully tested
- Fail-closed security verified (revoked sessions denied)
- Fail-open availability verified (store errors don't block)
</success_criteria>

<output>
After completion, create `.planning/phases/83-server-mode-testing/83-01-SUMMARY.md`
</output>
