---
phase: 83-server-mode-testing
plan: 03
type: execute
wave: 2
depends_on: ["83-01"]
files_modified: [sentinel/load_test.go]
autonomous: true
---

<objective>
Add HTTP server load tests verifying revocation timing under sustained load.

Purpose: Existing load tests (sentinel/load_test.go) cover policy evaluation but NOT the HTTP server pathway. Server mode is designed for real-time revocation - we need to verify that revocation takes effect within acceptable latency under load.
Output: Server load tests verifying revocation timing and concurrent access patterns.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@sentinel/server.go
@sentinel/server_test.go
@sentinel/load_test.go
@testutil/load_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add server HTTP load test</name>
  <files>sentinel/load_test.go</files>
  <action>
Add test `TestLoad_ServerCredentialRequests` (with `//go:build loadtest` tag) that:
1. Creates SentinelServer with mock policy loader (allow policy)
2. Creates HTTP test server or uses server's listener
3. Makes concurrent HTTP requests (100 req/sec for 10 seconds)
4. Verifies >99% success rate
5. Verifies P99 latency <50ms

Use httptest.NewRequest and call DefaultRoute directly for better performance (avoid network overhead):

```go
func TestLoad_ServerCredentialRequests(t *testing.T) {
    // Create server with allow policy
    mockLoader := &mockPolicyLoader{
        policy: &policy.Policy{
            Rules: []policy.Rule{
                {Name: "allow-all", Effect: policy.EffectAllow},
            },
        },
    }

    mockProvider := &MockCredentialProvider{
        CredentialResult: &CredentialResult{
            AccessKeyID:     "AKIA...",
            SecretAccessKey: "secret",
            SessionToken:    "token",
            Expiration:      time.Now().Add(15 * time.Minute),
            CanExpire:       true,
        },
    }

    config := SentinelServerConfig{
        ProfileName:        "test",
        PolicyParameter:    "/sentinel/test",
        User:               "testuser",
        PolicyLoader:       mockLoader,
        CredentialProvider: mockProvider,
        LazyLoad:           true,
    }

    server, err := NewSentinelServer(context.Background(), config, "test-token", 0)
    // ... run load test against server.DefaultRoute
}
```

Target: 100 req/sec for 10 seconds, >99% success, P99 <50ms
  </action>
  <verify>go test -v -tags loadtest -run TestLoad_ServerCredentialRequests ./sentinel/ -timeout 120s</verify>
  <done>Server HTTP load test passes thresholds</done>
</task>

<task type="auto">
  <name>Task 2: Add revocation timing test</name>
  <files>sentinel/load_test.go</files>
  <action>
Add test `TestLoad_RevocationTiming` (with `//go:build loadtest` tag) that:
1. Creates SentinelServer with session store
2. Starts background goroutine making credential requests at 50 req/sec
3. After 5 seconds, revokes the session
4. Verifies requests BEFORE revocation succeed
5. Verifies requests AFTER revocation fail within 100ms (revocation latency)
6. Measures time from revocation to first denied request

This tests the real-time revocation promise:
```go
func TestLoad_RevocationTiming(t *testing.T) {
    mockStore := NewMockSessionStore()
    // ... create server with session tracking

    var preRevocationSuccesses, postRevocationDenials int64
    var revocationTime time.Time

    // Start credential request loop
    stopCh := make(chan struct{})
    go func() {
        for {
            select {
            case <-stopCh:
                return
            default:
                // Make credential request
                // Track if before/after revocation
            }
            time.Sleep(20 * time.Millisecond) // 50 req/sec
        }
    }()

    // Wait 5 seconds
    time.Sleep(5 * time.Second)

    // Revoke session
    revocationTime = time.Now()
    mockStore.sessions[sessionID].Status = session.StatusRevoked

    // Wait for denial to propagate
    time.Sleep(500 * time.Millisecond)

    close(stopCh)

    // Verify pre/post revocation behavior
    // ...
}
```
  </action>
  <verify>go test -v -tags loadtest -run TestLoad_RevocationTiming ./sentinel/ -timeout 60s</verify>
  <done>Revocation timing test passes, proving real-time revocation works</done>
</task>

<task type="auto">
  <name>Task 3: Add concurrent revocation stress test</name>
  <files>sentinel/load_test.go</files>
  <action>
Add test `TestLoad_ConcurrentRevocationCheck` (with `//go:build loadtest` tag) that:
1. Creates SentinelServer with session store
2. Makes concurrent requests from multiple goroutines
3. Verifies no race conditions in revocation checking
4. Uses -race flag detection

This tests thread-safety under concurrent access:
```go
func TestLoad_ConcurrentRevocationCheck(t *testing.T) {
    mockStore := NewMockSessionStore()
    // ... setup

    // Launch 50 concurrent goroutines each making 100 requests
    var wg sync.WaitGroup
    for i := 0; i < 50; i++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            for j := 0; j < 100; j++ {
                // Make credential request
                req := httptest.NewRequest("GET", "/", nil)
                req.Header.Set("Authorization", authToken)
                rec := httptest.NewRecorder()
                server.DefaultRoute(rec, req)
            }
        }()
    }
    wg.Wait()

    // Verify no errors, no race conditions
}
```

Run with: `go test -v -race -tags loadtest -run TestLoad_ConcurrentRevocationCheck`
  </action>
  <verify>go test -v -race -tags loadtest -run TestLoad_ConcurrentRevocationCheck ./sentinel/ -timeout 60s</verify>
  <done>Concurrent revocation stress test passes with race detector</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test -v -tags loadtest ./sentinel/... passes all load tests
- [ ] Server HTTP load test achieves >99% success rate
- [ ] Revocation timing test proves real-time denial
- [ ] Race detector finds no issues in concurrent test
</verification>

<success_criteria>

- All tasks completed
- Server HTTP pathway tested under load
- Revocation timing verified (<100ms propagation)
- No race conditions detected
</success_criteria>

<output>
After completion, create `.planning/phases/83-server-mode-testing/83-03-SUMMARY.md`
</output>
