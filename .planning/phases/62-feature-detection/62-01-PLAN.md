---
phase: 62-feature-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - permissions/detection.go
  - permissions/detection_test.go
  - cli/permissions.go
  - cli/permissions_test.go
autonomous: true
---

<objective>
Add feature detection to auto-discover which Sentinel subsystems are configured and suggest minimal permissions.

Purpose: Help users understand which AWS permissions they actually need based on their Sentinel configuration, avoiding over-permissioning.
Output: `sentinel permissions --detect` command that probes AWS resources and outputs only required permissions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/60-permissions-schema/60-01-SUMMARY.md
@.planning/phases/61-permissions-command/61-01-SUMMARY.md

@permissions/types.go
@permissions/registry.go
@permissions/format.go
@cli/permissions.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create detection types and logic</name>
  <files>permissions/detection.go, permissions/detection_test.go</files>
  <action>
Create detection infrastructure for auto-discovering configured Sentinel features.

**Types to create:**

```go
// DetectionResult contains the features detected in the current environment.
type DetectionResult struct {
    Features        []Feature           // Detected features
    FeatureDetails  map[Feature]string  // Reason for detection (e.g., "table exists", "env var set")
    Errors          []DetectionError    // Non-fatal detection errors
}

// DetectionError represents a non-fatal error during detection.
type DetectionError struct {
    Feature Feature
    Message string
}

// Detector checks AWS resources to determine which Sentinel features are configured.
type Detector struct {
    ssmClient      ssmAPI           // For checking SSM parameters
    dynamoClient   dynamoAPI        // For checking DynamoDB tables
    region         string
}

// ssmAPI interface for SSM operations (GetParameter)
// dynamoAPI interface for DynamoDB operations (DescribeTable)
```

**Detection logic per feature:**

| Feature | Detection Method |
|---------|-----------------|
| policy_load | SSM: Check if /sentinel/policies/* parameter exists |
| credential_issue | Always detected (base feature) |
| approval_workflow | DynamoDB: Check if sentinel-requests table exists |
| breakglass | DynamoDB: Check if sentinel-breakglass table exists |
| notify_sns | Skip (optional, detected via config not resources) |
| notify_webhook | Skip (no AWS permissions needed) |
| audit_verify | Always detected (CloudTrail available in all accounts) |
| enforce_analyze | Always detected (IAM available in all accounts) |
| bootstrap_plan | Same as policy_load (SSM read) |
| bootstrap_apply | Skip (optional write operation) |

**Constructor:**
```go
// NewDetector creates a Detector using the provided AWS configuration.
func NewDetector(cfg aws.Config) *Detector

// newDetectorWithClients creates a Detector with custom clients (for testing).
func newDetectorWithClients(ssmClient ssmAPI, dynamoClient dynamoAPI) *Detector
```

**Methods:**
```go
// Detect probes AWS resources to determine which features are configured.
// It returns all detected features, even if some checks fail.
// Errors are collected but don't stop detection of other features.
func (d *Detector) Detect(ctx context.Context) (*DetectionResult, error)

// checkSSMPolicyExists checks if any /sentinel/policies/* parameter exists.
func (d *Detector) checkSSMPolicyExists(ctx context.Context) (bool, error)

// checkDynamoTableExists checks if a DynamoDB table exists by name.
func (d *Detector) checkDynamoTableExists(ctx context.Context, tableName string) (bool, error)
```

**Key behaviors:**
- Detection is best-effort: errors for one feature don't block others
- credential_issue always detected (required for all Sentinel use)
- audit_verify and enforce_analyze always detected (IAM/CloudTrail universally available)
- Optional features (notify_sns, notify_webhook, bootstrap_apply) not auto-detected
- Results include reason strings for user clarity

**Tests:**
- Mock SSM and DynamoDB clients
- Test detection when all resources exist
- Test detection when some resources missing
- Test error handling (API failures don't crash detection)
- Test always-detected features (credential_issue, audit_verify, enforce_analyze)
  </action>
  <verify>go test ./permissions/... -v -run TestDetect</verify>
  <done>
- DetectionResult, DetectionError types defined
- Detector type with SSM and DynamoDB client interfaces
- Detect() method returns detected features with reasons
- Tests cover success, partial failure, and error cases
- Coverage >90% for detection.go
  </done>
</task>

<task type="auto">
  <name>Task 2: Add --detect flag to permissions command</name>
  <files>cli/permissions.go, cli/permissions_test.go</files>
  <action>
Enhance the `sentinel permissions` command with auto-detection capability.

**CLI changes:**

Add `--detect` flag:
```go
cmd.Flag("detect", "Auto-detect configured features and show only required permissions").
    BoolVar(&input.Detect)
```

Add AWS config fields to input:
```go
type PermissionsCommandInput struct {
    // ... existing fields ...
    Detect bool
    Region string  // AWS region for detection

    // For testing
    Detector permissions.DetectorInterface  // Optional custom detector
}
```

**Command logic changes:**

```go
func PermissionsCommand(input PermissionsCommandInput) error {
    // ... existing I/O setup ...

    var perms []permissions.FeaturePermissions

    if input.Detect {
        // Create detector
        detector := input.Detector
        if detector == nil {
            awsCfg, err := config.LoadDefaultConfig(ctx, ...)
            if err != nil {
                return fmt.Errorf("failed to load AWS config for detection: %w", err)
            }
            detector = permissions.NewDetector(awsCfg)
        }

        // Run detection
        result, err := detector.Detect(ctx)
        if err != nil {
            return fmt.Errorf("detection failed: %w", err)
        }

        // Show detection summary to stderr (human format only)
        if input.Format == "human" {
            fmt.Fprintf(stderr, "Detected features:\n")
            for _, f := range result.Features {
                fmt.Fprintf(stderr, "  - %s: %s\n", f, result.FeatureDetails[f])
            }
            if len(result.Errors) > 0 {
                fmt.Fprintf(stderr, "\nDetection warnings:\n")
                for _, e := range result.Errors {
                    fmt.Fprintf(stderr, "  - %s: %s\n", e.Feature, e.Message)
                }
            }
            fmt.Fprintf(stderr, "\n")
        }

        // Get permissions for detected features
        for _, f := range result.Features {
            if fp, ok := permissions.GetFeaturePermissions(f); ok {
                perms = append(perms, fp)
            }
        }
    } else {
        // ... existing filter logic ...
    }

    // ... rest of command unchanged ...
}
```

**Add region flag:**
```go
cmd.Flag("region", "AWS region for detection (only used with --detect)").
    StringVar(&input.Region)
```

**Tests:**
- Test --detect with mock detector returning various features
- Test --detect error handling when detection fails
- Test --detect + --format combinations (human shows summary, others don't)
- Test --detect mutual exclusivity with --subsystem/--feature (error if combined)
- Test human format shows detection summary on stderr
  </action>
  <verify>go test ./cli/... -v -run TestPermissions</verify>
  <done>
- --detect flag added to permissions command
- --region flag added for detection
- Detection results shown in human format
- All format outputs work with detection
- Mutual exclusivity enforced (--detect cannot combine with --subsystem/--feature)
- Tests cover all flag combinations
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `go test ./permissions/... -v` passes with >90% coverage on detection.go
- [ ] `go test ./cli/... -v -run TestPermissions` passes
- [ ] Manual test: `sentinel permissions --detect` shows detected features
- [ ] Manual test: `sentinel permissions --detect --format json` outputs minimal IAM policy
</verification>

<success_criteria>

- Detection infrastructure created in permissions package
- Detector probes SSM and DynamoDB to find configured features
- CLI enhanced with --detect and --region flags
- Human format shows detection summary on stderr
- All formats output permissions for detected features only
- Tests cover detection logic and CLI integration
</success_criteria>

<output>
After completion, create `.planning/phases/62-feature-detection/62-01-SUMMARY.md`
</output>
