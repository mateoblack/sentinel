# Phase 86: Shell Completions - Research

**Researched:** 2026-01-20
**Domain:** Bash and Zsh tab completion systems for generated shell wrapper functions
**Confidence:** HIGH

<research_summary>
## Summary

Researched how to implement tab completion for dynamically-generated shell wrapper functions (`sentinel-production`, `sentinel-staging-server`, etc.) across bash and zsh shells. The core challenge is that these functions wrap `sentinel exec` which already passes commands to AWS, so completion should either: (a) provide profile-aware suggestions, or (b) delegate to generic command completion.

Key finding: Kingpin (Sentinel's CLI framework) already provides `--completion-script-bash` and `--completion-script-zsh` flags for the main `sentinel` command. For the generated wrapper functions, the simplest and most maintainable approach is to delegate completion to bash/zsh's default filename/command completion since the wrapper functions pass arbitrary commands to `sentinel exec -- "$@"`.

**Primary recommendation:** Generate simple completion registrations that provide file and command completion for the generated wrapper functions. Avoid complex custom completion logic since the functions are pass-through wrappers for arbitrary AWS CLI commands.
</research_summary>

<standard_stack>
## Standard Stack

### Core (Built-in Shell Features)
| Component | Version | Purpose | Why Standard |
|-----------|---------|---------|--------------|
| bash `complete` builtin | bash 4.0+ | Register completion functions | POSIX-like, universally available |
| bash `compgen` builtin | bash 4.0+ | Generate completions from patterns | Native, no dependencies |
| zsh `compdef` | zsh 5.2+ | Register completion functions | Standard zsh completion system |
| zsh `compinit` | zsh 5.2+ | Initialize completion system | Required for custom completions |

### Supporting (for advanced scenarios)
| Component | Purpose | When to Use |
|-----------|---------|-------------|
| `bashcompinit` (zsh) | Enable bash completion in zsh | Reusing existing bash completions |
| `_gnu_generic` (zsh) | Auto-complete from --help | Commands with standard GNU-style help |
| `_files` (zsh) | File completion | Wrapper commands executing file-based commands |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Custom completion logic | `-o default -o bashdefault` | Simpler, leverages shell defaults |
| Complex argument parsing | Pass-through completion | Wrapper functions don't need arg awareness |
| Separate completion files | Inline in generated script | Single eval source, no file management |

**No package installation required** - shell completions use built-in features.
</standard_stack>

<architecture_patterns>
## Architecture Patterns

### Recommended: Inline Completion in Generated Script

The generated shell script should include completion registrations alongside the function definitions:

```bash
# Sentinel shell functions - generated by sentinel shell init
# Add to your .bashrc/.zshrc: eval "$(sentinel shell init)"

sentinel-production() {
    sentinel exec --profile production --policy-parameter /sentinel/policies/production -- "$@"
}

sentinel-staging() {
    sentinel exec --profile staging --policy-parameter /sentinel/policies/staging -- "$@"
}

# Completion registrations (bash)
if [[ -n "${BASH_VERSION:-}" ]]; then
    complete -o default -o bashdefault sentinel-production
    complete -o default -o bashdefault sentinel-staging
fi

# Completion registrations (zsh)
if [[ -n "${ZSH_VERSION:-}" ]]; then
    compdef _command_names sentinel-production
    compdef _command_names sentinel-staging
fi
```

### Pattern 1: Bash Default File/Command Completion
**What:** Use `-o default -o bashdefault` to provide standard filename and command completion
**When to use:** Wrapper functions that pass arbitrary commands to another program
**Example:**
```bash
# Source: GNU Bash Manual - Programmable Completion Builtins
# -o bashdefault: Bash defaults for filename completion
# -o default: Readline defaults if no completions found
complete -o default -o bashdefault sentinel-production
```

### Pattern 2: Zsh Delegation to Command Completion
**What:** Use `compdef _command_names` or `compdef _files` to delegate
**When to use:** Wrapper functions where argument is a command or filename
**Example:**
```zsh
# Source: zsh completion system docs
# _command_names: Complete with command names (like what follows exec)
# _files: Complete with filenames
compdef _command_names sentinel-production
```

### Pattern 3: Shell-Detection Guard
**What:** Detect which shell is running and register appropriate completions
**When to use:** Scripts that must work in both bash and zsh
**Example:**
```bash
if [[ -n "${BASH_VERSION:-}" ]]; then
    # Bash-specific completion
    complete -o default -o bashdefault my-func
elif [[ -n "${ZSH_VERSION:-}" ]]; then
    # Zsh-specific completion
    compdef _files my-func
fi
```

### Project Structure (Generated Script Layout)
```
# Generated by sentinel shell init:
eval "$(sentinel shell init)"

# Which outputs:
# ├── Header comments
# ├── Function definitions (sentinel-{profile})
# ├── Server variants if --include-server (sentinel-{profile}-server)
# ├── Bash completion registrations (if BASH_VERSION)
# └── Zsh completion registrations (if ZSH_VERSION)
```

### Anti-Patterns to Avoid
- **Complex custom completion functions:** The wrapper functions pass arbitrary commands; custom completion for AWS commands would be enormous and maintenance burden
- **Separate completion files:** Requires users to install files in `/etc/bash_completion.d/` or `~/.zsh/completions/`, adds friction
- **Assuming single shell:** Always include both bash and zsh support with guards
- **Forgetting compinit requirement:** Zsh requires `compinit` to be loaded, but most users already have this
</architecture_patterns>

<dont_hand_roll>
## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| AWS CLI completion | Custom AWS command/arg completion | Shell default completion | AWS CLI has hundreds of commands and thousands of options |
| Command argument parsing | Custom COMP_WORDS parsing | `-o default -o bashdefault` | Bash handles it automatically |
| Zsh completion from scratch | Custom `_arguments` spec | `compdef _command_names` | Zsh has built-in command completion |
| Cross-shell compatibility | Shell-specific scripts | Detection guards (`BASH_VERSION`/`ZSH_VERSION`) | Single script works everywhere |
| Completion file installation | Separate installer/setup | Inline in eval output | Single `eval` command handles everything |

**Key insight:** Shell completion for wrapper functions that pass arbitrary commands (`"$@"`) should delegate to the shell's default completion rather than trying to understand what commands might be passed. The `sentinel exec` command can run any AWS CLI command, so custom completion would be impractical.
</dont_hand_roll>

<common_pitfalls>
## Common Pitfalls

### Pitfall 1: Forgetting -o default/-o bashdefault in Bash
**What goes wrong:** Tab completion shows nothing when function returns empty COMPREPLY
**Why it happens:** Without these options, empty COMPREPLY means no completions
**How to avoid:** Always use `complete -o default -o bashdefault func-name` for pass-through wrappers
**Warning signs:** Tab completion works for some inputs but not file paths

### Pitfall 2: Zsh compdef Without compinit
**What goes wrong:** `compdef: command not found` error
**Why it happens:** compdef is provided by compinit, which must be loaded first
**How to avoid:** Most users have compinit in their .zshrc; document the requirement
**Warning signs:** Completion works in some shells but not others

### Pitfall 3: Shell Detection Mistakes
**What goes wrong:** Wrong completion style used, or completion not registered
**Why it happens:** Using `$SHELL` instead of `$BASH_VERSION`/`$ZSH_VERSION`
**How to avoid:** `$SHELL` is the login shell, not current shell; use version variables
**Warning signs:** Works when sourced interactively but not in scripts

### Pitfall 4: Performance Impact on Shell Startup
**What goes wrong:** Noticeable delay when starting new shells
**Why it happens:** Heavy computation or external calls during completion registration
**How to avoid:** Keep completion registration lightweight; no external commands
**Warning signs:** Shell startup time increases after adding completions

### Pitfall 5: Quoting Issues in Generated Code
**What goes wrong:** Functions break for profiles with special characters
**Why it happens:** Profile names not properly escaped in generated shell code
**How to avoid:** Use existing `shellEscape` function for all dynamic values
**Warning signs:** Works for simple profiles ("production") but fails for complex ones ("my-team/staging")
</common_pitfalls>

<code_examples>
## Code Examples

Verified patterns for shell completion implementation:

### Bash Completion Registration (Simple)
```bash
# Source: GNU Bash Manual - Programmable Completion Builtins
# For wrapper functions that pass commands through, use default completion
complete -o default -o bashdefault sentinel-production

# -o default: If completion returns empty, use readline defaults
# -o bashdefault: If still empty, use bash defaults (filenames)
```

### Zsh Completion Registration (Simple)
```zsh
# Source: Zsh Completion System documentation
# _command_names: Complete with executable command names
compdef _command_names sentinel-production

# Alternative: File-based completion
compdef _files sentinel-production

# Alternative: Combination (commands and files)
compdef '_files -g "*"' sentinel-production
```

### Shell-Agnostic Script Structure
```bash
# Source: Common pattern from AWS CLI, kubectl, and other tools
# Generated by: sentinel shell init

# Function definitions
sentinel-production() {
    sentinel exec --profile production --policy-parameter /sentinel/policies/production -- "$@"
}

sentinel-staging() {
    sentinel exec --profile staging --policy-parameter /sentinel/policies/staging -- "$@"
}

# Register completions based on current shell
if [[ -n "${BASH_VERSION:-}" ]]; then
    # Bash: Use default file and command completion
    complete -o default -o bashdefault sentinel-production
    complete -o default -o bashdefault sentinel-staging
elif [[ -n "${ZSH_VERSION:-}" ]]; then
    # Zsh: Delegate to command name completion
    compdef _command_names sentinel-production
    compdef _command_names sentinel-staging
fi
```

### Go Implementation Pattern
```go
// In shell/shell.go - GenerateCompletions function
func GenerateCompletions(funcNames []string, format ShellFormat) string {
    var sb strings.Builder

    switch format {
    case FormatBash:
        for _, name := range funcNames {
            sb.WriteString(fmt.Sprintf("complete -o default -o bashdefault %s\n", name))
        }
    case FormatZsh:
        for _, name := range funcNames {
            sb.WriteString(fmt.Sprintf("compdef _command_names %s\n", name))
        }
    }

    return sb.String()
}
```

### Kingpin Built-in Completion (For Reference)
```bash
# Source: Kingpin documentation
# Sentinel already supports these via kingpin:
eval "$(sentinel --completion-script-bash)"  # For bash
eval "$(sentinel --completion-script-zsh)"   # For zsh

# These complete the main sentinel command, not generated wrapper functions
```
</code_examples>

<sota_updates>
## State of the Art (2025-2026)

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Separate completion files | Inline in eval output | Modern convention | No file installation needed |
| Bash-only completion | Multi-shell support | Universal | bash, zsh, fish, powershell |
| Complex custom completion | Delegate to shell defaults | Best practice | Simpler, more maintainable |
| `$SHELL` detection | `$BASH_VERSION`/`$ZSH_VERSION` | Long-standing | Correct current shell detection |

**New tools/patterns to consider:**
- **Kingpin built-in:** Sentinel already has `--completion-script-bash` and `--completion-script-zsh`; could potentially reuse infrastructure
- **bashcompinit in zsh:** Allows reusing bash completion in zsh if needed for complex scenarios

**Deprecated/outdated:**
- **zsh compctl:** Replaced by compdef/compsys; don't use compctl
- **Separate completion installer scripts:** Modern tools use `eval "$(tool completion bash)"` pattern
</sota_updates>

<open_questions>
## Open Questions

Things that couldn't be fully resolved:

1. **Should Kingpin's completion infrastructure be reused?**
   - What we know: Kingpin provides `--completion-script-bash/zsh` for the main `sentinel` command
   - What's unclear: Whether generated wrapper functions should delegate to sentinel's completion or use shell defaults
   - Recommendation: Use shell defaults for simplicity; wrapper functions pass arbitrary commands

2. **Should completions be opt-in via a flag?**
   - What we know: Completions add minimal overhead but increase generated script size
   - What's unclear: Whether some users want functions without completions
   - Recommendation: Include completions by default; the overhead is negligible (~100 bytes per profile)
</open_questions>

<sources>
## Sources

### Primary (HIGH confidence)
- [GNU Bash Manual - Programmable Completion Builtins](https://www.gnu.org/software/bash/manual/html_node/Programmable-Completion-Builtins.html) - complete builtin, options, COMPREPLY
- [Zsh Completion System](https://zsh.sourceforge.io/Doc/Release/Completion-System.html) - compdef, compinit, completion functions
- [Kingpin GitHub Repository](https://github.com/alecthomas/kingpin) - Sentinel's CLI framework, completion support

### Secondary (MEDIUM confidence)
- [kubectl completion documentation](https://kubernetes.io/docs/reference/kubectl/generated/kubectl_completion/) - verified pattern for eval-based completion
- [AWS CLI completion guide](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-completion.html) - verified pattern for shell-agnostic completion
- [zsh-users/zsh-completions How-To](https://github.com/zsh-users/zsh-completions/blob/master/zsh-completions-howto.org) - compdef usage patterns
- [Cobra shell completion docs](https://cobra.dev/docs/how-to-guides/shell-completion/) - verified pattern for Go CLI tools

### Tertiary (LOW confidence - needs validation)
- None - all findings verified against official documentation
</sources>

<metadata>
## Metadata

**Research scope:**
- Core technology: Bash complete builtin, Zsh compdef/compinit
- Ecosystem: Kingpin CLI framework, shell completion conventions
- Patterns: Delegation, shell detection, inline completion
- Pitfalls: Shell startup performance, quoting, cross-shell compatibility

**Confidence breakdown:**
- Standard stack: HIGH - built-in shell features, well-documented
- Architecture: HIGH - pattern used by kubectl, AWS CLI, and other major tools
- Pitfalls: HIGH - documented in official manuals and community resources
- Code examples: HIGH - verified against official documentation

**Research date:** 2026-01-20
**Valid until:** 2026-03-20 (60 days - shell completion systems are stable)
</metadata>

---

*Phase: 86-shell-completions*
*Research completed: 2026-01-20*
*Ready for planning: yes*
