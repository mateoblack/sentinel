---
phase: 86-shell-completions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [shell/shell.go, shell/shell_test.go]
autonomous: true
---

<objective>
Add tab completion registrations to generated shell functions for bash and zsh.

Purpose: Improve developer UX by providing tab completion for dynamically-generated Sentinel wrapper functions (sentinel-production, sentinel-staging-server, etc.).
Output: Extended GenerateScriptWithOptions that adds completion registrations after function definitions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/86-shell-completions/86-RESEARCH.md
@.planning/phases/84-shell-init-command/84-01-SUMMARY.md
@.planning/phases/85-server-mode-variants/85-01-SUMMARY.md
@shell/shell.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend GenerateScriptWithOptions to include completion registrations</name>
  <files>shell/shell.go</files>
  <action>
Extend the generated shell script to include completion registrations after all function definitions.

**Implementation:**

1. After the function definitions block in GenerateScriptWithOptions, add shell-detection guarded completion sections:

2. Collect all generated function names (both standard and -server variants if IncludeServer is true).

3. Add bash completion block:
```go
// Bash completion
sb.WriteString("# Completion registrations (bash)\n")
sb.WriteString("if [[ -n \"${BASH_VERSION:-}\" ]]; then\n")
for _, funcName := range allFuncNames {
    sb.WriteString(fmt.Sprintf("    complete -o default -o bashdefault %s\n", funcName))
}
sb.WriteString("fi\n\n")
```

4. Add zsh completion block:
```go
// Zsh completion
sb.WriteString("# Completion registrations (zsh)\n")
sb.WriteString("if [[ -n \"${ZSH_VERSION:-}\" ]]; then\n")
for _, funcName := range allFuncNames {
    sb.WriteString(fmt.Sprintf("    compdef _command_names %s\n", funcName))
}
sb.WriteString("fi\n")
```

**Key points:**
- Collect function names as they're generated to avoid duplicate logic
- Shell detection uses `${BASH_VERSION:-}` and `${ZSH_VERSION:-}` with default empty string to avoid unbound variable errors
- Bash uses `-o default -o bashdefault` for file and command completion fallback
- Zsh uses `compdef _command_names` to complete with executable command names
- Completions included for both standard and -server variants
- No external commands called during completion registration (performance)
  </action>
  <verify>go build ./shell/... succeeds</verify>
  <done>GenerateScriptWithOptions output includes bash and zsh completion blocks after function definitions</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for completion generation</name>
  <files>shell/shell_test.go</files>
  <action>
Add tests to verify completion registrations are generated correctly.

**Test cases to add:**

1. **TestGenerateScript_IncludesCompletions**: Verify basic script includes completion sections
   - Generate script for 2 profiles
   - Assert output contains "if [[ -n \"${BASH_VERSION:-}\" ]]"
   - Assert output contains "complete -o default -o bashdefault sentinel-production"
   - Assert output contains "if [[ -n \"${ZSH_VERSION:-}\" ]]"
   - Assert output contains "compdef _command_names sentinel-production"

2. **TestGenerateScript_CompletionsWithServerVariants**: Verify server variants get completions
   - Generate script with IncludeServer=true
   - Assert output contains completions for both sentinel-production AND sentinel-production-server
   - Assert both bash and zsh sections include -server variants

3. **TestGenerateScript_EmptyProfiles_NoCompletions**: Verify no completion sections for empty profiles
   - Generate script with empty profiles slice
   - Assert output does NOT contain completion registration blocks (no "complete -o" or "compdef")

4. **TestGenerateScript_CompletionSanitizedNames**: Verify completions use sanitized function names
   - Generate script for profile with special characters (e.g., "my-team/staging")
   - Assert bash completion uses sanitized name "sentinel-my-team-staging"
   - Assert zsh completion uses same sanitized name

**Test pattern:**
- Use strings.Contains for presence assertions
- Use !strings.Contains for absence assertions
- Follow existing test style in shell_test.go
  </action>
  <verify>go test ./shell/... -run "Completion" passes all tests</verify>
  <done>All completion generation tests pass with comprehensive coverage of standard, server-variant, empty, and sanitized name cases</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go build ./shell/... succeeds
- [ ] go test ./shell/... passes all tests
- [ ] gofmt -l shell/shell.go shell/shell_test.go returns no output
- [ ] Generated script contains bash completion block with shell detection
- [ ] Generated script contains zsh completion block with shell detection
- [ ] Server variants (when enabled) get completion registrations
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- GenerateScriptWithOptions produces script with completion registrations for all generated functions
- Shell detection guards prevent errors in non-matching shells
</success_criteria>

<output>
After completion, create `.planning/phases/86-shell-completions/86-01-SUMMARY.md`
</output>
