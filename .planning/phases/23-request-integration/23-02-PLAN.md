---
phase: 23-request-integration
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified: [cli/credentials.go, cli/sentinel_exec.go, cli/credentials_test.go, cli/sentinel_exec_test.go]
autonomous: true
---

<objective>
Wire approved request checking into credential issuance flow so users with approved requests can get credentials even when policy denies.

Purpose: Complete the approval workflow by allowing approved requests to override policy denial.
Output: credentials.go and sentinel_exec.go check for approved requests when policy denies, with tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-request-integration/23-01-SUMMARY.md

@cli/credentials.go
@cli/sentinel_exec.go
@request/checker.go
@request/store.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add approved request check to credentials command</name>
  <files>cli/credentials.go</files>
  <action>
Modify CredentialsCommand to check for approved requests when policy denies:

1. Add Store field to CredentialsCommandInput:
   ```go
   Store request.Store // Optional: for approved request checking
   ```

2. After policy evaluation returns deny (step 7), before returning error:
   ```go
   if decision.Effect == policy.EffectDeny {
       // Check for approved request before denying
       if input.Store != nil {
           approvedReq, err := request.FindApprovedRequest(ctx, input.Store, username, input.ProfileName)
           if err != nil {
               // Log store error but don't fail - fall through to deny
               log.Printf("Warning: failed to check approved requests: %v", err)
           }
           if approvedReq != nil {
               // Approved request found - override policy denial
               // Continue to credential issuance (step 8)
               goto issueCredentials
           }
       }
       // No approved request - proceed with deny
       if input.Logger != nil {
           entry := logging.NewDecisionLogEntry(policyRequest, decision, input.PolicyParameter)
           input.Logger.LogDecision(entry)
       }
       fmt.Fprintf(os.Stderr, "Access denied: %s\n", decision.String())
       return fmt.Errorf("access denied")
   }
   ```

3. Add label before step 8:
   ```go
   issueCredentials:
   // 8. Generate request-id and retrieve credentials
   ```

4. Add import for "github.com/byteness/aws-vault/v7/request"

5. Update logging for approved request case - log that credentials were issued via approved request:
   - Add ApprovedRequestID field to logging if available
   - Include approver info in log entry

Note: Store is optional (nil) for backward compatibility. When nil, behaves as before (no approved request checking).
  </action>
  <verify>go build ./cli/...</verify>
  <done>credentials.go compiles with approved request checking logic</done>
</task>

<task type="auto">
  <name>Task 2: Add approved request check to sentinel exec command</name>
  <files>cli/sentinel_exec.go</files>
  <action>
Modify SentinelExecCommand with same pattern as credentials.go:

1. Add Store field to SentinelExecCommandInput:
   ```go
   Store request.Store // Optional: for approved request checking
   ```

2. After policy evaluation returns deny (step 8), before returning error:
   ```go
   if decision.Effect == policy.EffectDeny {
       // Check for approved request before denying
       if input.Store != nil {
           approvedReq, err := request.FindApprovedRequest(ctx, input.Store, username, input.ProfileName)
           if err != nil {
               log.Printf("Warning: failed to check approved requests: %v", err)
           }
           if approvedReq != nil {
               // Approved request found - override policy denial
               goto issueCredentials
           }
       }
       // No approved request - proceed with deny
       if logger != nil {
           entry := logging.NewDecisionLogEntry(policyRequest, decision, input.PolicyParameter)
           logger.LogDecision(entry)
       }
       fmt.Fprintf(os.Stderr, "Access denied: %s\n", decision.String())
       return 1, fmt.Errorf("access denied: %s", decision.String())
   }
   ```

3. Add label before step 9:
   ```go
   issueCredentials:
   // 9. Generate request-id and retrieve credentials
   ```

4. Add import for "github.com/byteness/aws-vault/v7/request"

Mirror the credentials.go implementation exactly for consistency.
  </action>
  <verify>go build ./cli/...</verify>
  <done>sentinel_exec.go compiles with approved request checking logic</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for approved request integration</name>
  <files>cli/credentials_test.go, cli/sentinel_exec_test.go</files>
  <action>
Add tests to verify approved request override behavior.

For cli/credentials_test.go, add:
1. TestCredentialsCommand_ApprovedRequestOverridesDeny
   - Setup: Policy denies, but approved request exists in mock store
   - Verify: Command succeeds (credentials issued)

2. TestCredentialsCommand_NoApprovedRequestStillDenied
   - Setup: Policy denies, no approved request in store
   - Verify: Command fails with access denied

3. TestCredentialsCommand_StoreNilNoCheck
   - Setup: Policy denies, Store is nil
   - Verify: Command fails (backward compatible behavior)

For cli/sentinel_exec_test.go, add similar tests:
1. TestSentinelExecCommand_ApprovedRequestOverridesDeny
2. TestSentinelExecCommand_NoApprovedRequestStillDenied
3. TestSentinelExecCommand_StoreNilNoCheck

Use mockStore from request package tests as reference.
Create mockPolicyLoader or use existing test patterns for policy evaluation mocking.
  </action>
  <verify>go test -v ./cli/... -run TestCredentialsCommand_Approved && go test -v ./cli/... -run TestSentinelExecCommand_Approved</verify>
  <done>All 6 new tests pass, verifying approved request override behavior</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `go test ./cli/...` passes all tests including new ones
- [ ] When policy denies and approved request exists, credentials are issued
- [ ] When policy denies and no approved request exists, access is denied
- [ ] When Store is nil, behavior is unchanged (backward compatible)
</verification>

<success_criteria>

- credentials.go checks for approved requests on policy deny
- sentinel_exec.go checks for approved requests on policy deny
- Both commands remain backward compatible (Store optional)
- 6 new test cases verify the integration
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-request-integration/23-02-SUMMARY.md`
</output>
