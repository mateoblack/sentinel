---
phase: 07-exec-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cli/sentinel_exec.go
  - cmd/sentinel/main.go
autonomous: true
---

<objective>
Create the sentinel exec command that evaluates policy before spawning a subprocess with credentials.

Purpose: Provide `sentinel exec --profile X -- cmd` for direct command invocation with policy-gated credentials.
Output: Working exec command that evaluates policy, retrieves credentials, and spawns subprocess.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/05-credential-process/05-01-SUMMARY.md
@.planning/phases/06-decision-logging/06-02-SUMMARY.md

# Implementation patterns
@cli/credentials.go
@cli/exec.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SentinelExecCommandInput and ConfigureSentinelExecCommand</name>
  <files>cli/sentinel_exec.go</files>
  <action>
Create cli/sentinel_exec.go with:

1. SentinelExecCommandInput struct containing:
   - ProfileName string
   - PolicyParameter string (SSM path, required)
   - Command string
   - Args []string
   - Region string
   - NoSession bool
   - SessionDuration time.Duration
   - LogFile string
   - LogStderr bool

2. ConfigureSentinelExecCommand(app *kingpin.Application, s *Sentinel) that:
   - Creates "exec" command with description "Execute a command with policy-gated AWS credentials"
   - Adds --profile flag (required, positional arg like aws-vault)
   - Adds --policy-parameter flag (required)
   - Adds --region, --no-session, --duration flags (match credentials.go)
   - Adds --log-file and --log-stderr flags (match credentials.go)
   - Adds positional cmd and args arguments using Arg() not Flag()
   - Uses "--" separator pattern: sentinel exec --profile X --policy-parameter Y -- cmd args

Follow the aws-vault exec.go ConfigureExecCommand pattern for command/args handling:
```go
cmd.Arg("cmd", "Command to execute, defaults to $SHELL").StringVar(&input.Command)
cmd.Arg("args", "Command arguments").StringsVar(&input.Args)
```

Action handler calls SentinelExecCommand and uses app.FatalIfError pattern.
  </action>
  <verify>go build ./cmd/sentinel/... compiles</verify>
  <done>SentinelExecCommandInput struct and ConfigureSentinelExecCommand function exist</done>
</task>

<task type="auto">
  <name>Task 2: Implement SentinelExecCommand with policy evaluation</name>
  <files>cli/sentinel_exec.go</files>
  <action>
Add SentinelExecCommand(ctx context.Context, input SentinelExecCommandInput, s *Sentinel) (int, error) that:

1. Creates logger (same pattern as CredentialsCommand):
   - If LogFile or LogStderr set, create writers slice
   - Use io.MultiWriter and logging.NewJSONLogger

2. Gets current user (os/user.Current())

3. Creates AWS config for SSM (config.LoadDefaultConfig with region option)

4. Creates policy loader chain (NewLoader + NewCachedLoader with 5min TTL)

5. Loads policy from SSM

6. Builds policy.Request with user, profile, time.Now()

7. Evaluates policy

8. Logs decision (before handling, so both allow/deny logged)

9. If denied: return 1, fmt.Errorf("access denied: %s", decision.String())

10. If allowed: proceed to credential retrieval using s.GetCredentials() (same as credentials.go)

11. If input.Command is empty, use getDefaultShell() helper (copy from exec.go or call it)

12. Create subprocess environment - for now, just prepare the environ type (env injection in plan 02)

13. Return 0, nil (subprocess execution in plan 02)

Import osexec "os/exec" to avoid conflict with potential exec package.
  </action>
  <verify>go build ./cmd/sentinel/... compiles without errors</verify>
  <done>SentinelExecCommand implements policy evaluation flow, returns exit code</done>
</task>

<task type="auto">
  <name>Task 3: Register exec command in main.go</name>
  <files>cmd/sentinel/main.go</files>
  <action>
Add call to cli.ConfigureSentinelExecCommand(app, sentinel) in main.go, after ConfigureCredentialsCommand.

The registration order should be:
1. ConfigureCredentialsCommand (already exists)
2. ConfigureSentinelExecCommand (add this)
  </action>
  <verify>go build ./cmd/sentinel/... && ./sentinel/sentinel --help shows exec command</verify>
  <done>exec command appears in sentinel --help output</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./cmd/sentinel/...` succeeds
- [ ] `./sentinel/sentinel --help` shows "exec" command
- [ ] `./sentinel/sentinel exec --help` shows all expected flags
- [ ] Code follows established patterns from credentials.go and exec.go
</verification>

<success_criteria>

- All tasks completed
- exec command registered and visible in help
- Policy evaluation logic implemented (matching credentials.go pattern)
- Logging integration complete
- No build errors
  </success_criteria>

<output>
After completion, create `.planning/phases/07-exec-command/07-01-SUMMARY.md`
</output>
