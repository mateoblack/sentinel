---
phase: 102-infrastructure-as-code
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [terraform/sentinel-tvm/main.tf, terraform/sentinel-tvm/variables.tf, terraform/sentinel-tvm/outputs.tf, terraform/sentinel-tvm/iam.tf, terraform/sentinel-tvm/README.md]
autonomous: true
---

<objective>
Create Terraform module for Lambda TVM + API Gateway deployment with least-privilege IAM roles.

Purpose: Enable infrastructure-as-code deployment of the Lambda TVM, replacing manual AWS CLI commands from LAMBDA_TVM_DEPLOYMENT.md.
Output: Complete Terraform module in terraform/sentinel-tvm/ that deploys working Lambda TVM with API Gateway.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/LAMBDA_TVM_DEPLOYMENT.md
@cmd/lambda-tvm/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Terraform TVM module structure</name>
  <files>terraform/sentinel-tvm/main.tf, terraform/sentinel-tvm/variables.tf, terraform/sentinel-tvm/outputs.tf</files>
  <action>
Create terraform/sentinel-tvm/ directory with:

**variables.tf** - Required inputs:
- `function_name` (string, default "sentinel-tvm")
- `lambda_zip_path` (string) - Path to Lambda zip file
- `policy_parameter` (string) - SSM parameter path for policy
- `policy_root` (string, optional) - SSM path root for profile discovery
- `session_table` (string, optional) - DynamoDB session table name
- `approval_table` (string, optional) - DynamoDB approval table name
- `breakglass_table` (string, optional) - DynamoDB breakglass table name
- `memory_size` (number, default 256)
- `timeout` (number, default 30)
- `tags` (map(string), optional)

**main.tf** - Resources:
- `aws_lambda_function.tvm` with provided.al2023 runtime, environment variables from inputs
- `aws_apigatewayv2_api.tvm` HTTP API
- `aws_apigatewayv2_integration.tvm` AWS_PROXY integration
- `aws_apigatewayv2_route.root_get` for GET / (IAM auth)
- `aws_apigatewayv2_route.root_post` for POST / (IAM auth)
- `aws_apigatewayv2_route.profiles` for GET /profiles (IAM auth)
- `aws_apigatewayv2_stage.default` with auto_deploy=true
- `aws_lambda_permission.apigw` allowing API Gateway invocation

**outputs.tf** - Outputs:
- `api_endpoint` - API Gateway invoke URL
- `function_arn` - Lambda function ARN
- `execution_role_arn` - IAM execution role ARN (from iam.tf)

Do NOT use deprecated `aws_api_gateway_*` resources. Use `aws_apigatewayv2_*` for HTTP APIs.
  </action>
  <verify>terraform fmt -check terraform/sentinel-tvm/ && terraform validate terraform/sentinel-tvm/</verify>
  <done>Terraform files parse without errors, all required variables and outputs defined</done>
</task>

<task type="auto">
  <name>Task 2: Create IAM execution role configuration</name>
  <files>terraform/sentinel-tvm/iam.tf</files>
  <action>
Create iam.tf with:

**aws_iam_role.tvm_execution** - Lambda execution role:
- Trust policy allows lambda.amazonaws.com
- Name: "${var.function_name}-execution-role"

**aws_iam_role_policy.assume_protected_roles** - AssumeRole permission:
- Allow sts:AssumeRole on "arn:aws:iam::*:role/SentinelProtected-*"
- Condition: StringLike sts:SourceIdentity = "sentinel:*"

**aws_iam_role_policy.read_policies** - SSM read permission:
- Allow ssm:GetParameter, ssm:GetParametersByPath
- Resource: arn:aws:ssm:*:*:parameter/sentinel/policies/*

**aws_iam_role_policy.session_tracking** (conditional, count based on var.session_table):
- Allow dynamodb:PutItem, GetItem, UpdateItem, Query
- Resource: session table ARN and index

**aws_iam_role_policy.cloudwatch_logs**:
- Allow logs:CreateLogGroup, CreateLogStream, PutLogEvents
- Resource: logs ARN pattern

Use locals to build ARNs with data.aws_region.current and data.aws_caller_identity.current.
Include `data "aws_region" "current" {}` and `data "aws_caller_identity" "current" {}`.
  </action>
  <verify>terraform validate terraform/sentinel-tvm/</verify>
  <done>IAM role with least-privilege policies created, conditional DynamoDB access based on table variables</done>
</task>

<task type="auto">
  <name>Task 3: Create module README with usage example</name>
  <files>terraform/sentinel-tvm/README.md</files>
  <action>
Create README.md documenting the module:

**Sections:**
1. **Overview** - What the module deploys (Lambda TVM + API Gateway)
2. **Prerequisites** - Lambda zip file, SSM policies configured
3. **Usage** - Basic example:
```hcl
module "sentinel_tvm" {
  source = "./terraform/sentinel-tvm"

  lambda_zip_path  = "bin/lambda-tvm-linux-amd64.zip"
  policy_parameter = "/sentinel/policies/production"
}
```
4. **Inputs** - Table of all variables with types, defaults, descriptions
5. **Outputs** - Table of outputs with descriptions
6. **IAM Permissions** - What the execution role can do
7. **Protected Role Setup** - Reference to protected role module

Keep concise - under 150 lines. Reference LAMBDA_TVM_DEPLOYMENT.md for detailed setup.
  </action>
  <verify>test -f terraform/sentinel-tvm/README.md && wc -l terraform/sentinel-tvm/README.md</verify>
  <done>README exists with usage example and variable documentation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `terraform fmt -check terraform/sentinel-tvm/` passes
- [ ] `terraform validate terraform/sentinel-tvm/` passes (may need init with -backend=false)
- [ ] All required variables documented
- [ ] All outputs defined
- [ ] IAM policies follow least-privilege principle
</verification>

<success_criteria>

- All tasks completed
- Terraform module validates without errors
- IAM execution role has least-privilege permissions
- Module is reusable with sensible defaults
</success_criteria>

<output>
After completion, create `.planning/phases/102-infrastructure-as-code/102-01-SUMMARY.md`
</output>
