---
phase: 102-infrastructure-as-code
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [cdk/sentinel-tvm/lib/sentinel-tvm-stack.ts, cdk/sentinel-tvm/bin/sentinel-tvm.ts, cdk/sentinel-tvm/package.json, cdk/sentinel-tvm/tsconfig.json, cdk/sentinel-tvm/cdk.json, cdk/sentinel-tvm/README.md]
autonomous: true
---

<objective>
Create AWS CDK TypeScript example for Lambda TVM + API Gateway deployment.

Purpose: Provide alternative infrastructure-as-code option for teams using CDK instead of Terraform.
Output: Complete CDK stack in cdk/sentinel-tvm/ that deploys working Lambda TVM with API Gateway.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/LAMBDA_TVM_DEPLOYMENT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CDK project structure</name>
  <files>cdk/sentinel-tvm/package.json, cdk/sentinel-tvm/tsconfig.json, cdk/sentinel-tvm/cdk.json, cdk/sentinel-tvm/bin/sentinel-tvm.ts</files>
  <action>
Create cdk/sentinel-tvm/ directory with standard CDK TypeScript project structure:

**package.json**:
```json
{
  "name": "sentinel-tvm-cdk",
  "version": "1.0.0",
  "scripts": {
    "build": "tsc",
    "cdk": "cdk"
  },
  "devDependencies": {
    "typescript": "~5.3.0",
    "aws-cdk": "^2.170.0"
  },
  "dependencies": {
    "aws-cdk-lib": "^2.170.0",
    "constructs": "^10.0.0"
  }
}
```

**tsconfig.json** - Standard CDK TypeScript config

**cdk.json**:
```json
{
  "app": "npx ts-node --prefer-ts-exts bin/sentinel-tvm.ts",
  "context": {
    "@aws-cdk/aws-apigateway:usagePlanKeyOrderInsensitiveId": true
  }
}
```

**bin/sentinel-tvm.ts**:
- Import SentinelTvmStack from lib/
- Instantiate stack with app
- Read props from context or environment (policyParameter, lambdaZipPath)
  </action>
  <verify>cd cdk/sentinel-tvm && cat package.json && cat cdk.json</verify>
  <done>CDK project structure created with proper dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create CDK stack implementation</name>
  <files>cdk/sentinel-tvm/lib/sentinel-tvm-stack.ts</files>
  <action>
Create lib/sentinel-tvm-stack.ts with:

**SentinelTvmStackProps** interface:
- lambdaZipPath: string
- policyParameter: string
- policyRoot?: string
- sessionTable?: string
- approvalTable?: string
- breakglassTable?: string
- memorySize?: number (default 256)
- timeout?: number (default 30)

**SentinelTvmStack** class extends cdk.Stack:

1. **IAM Execution Role** (iam.Role):
   - assumedBy: new iam.ServicePrincipal('lambda.amazonaws.com')
   - Add policies for:
     - AssumeRole on SentinelProtected-* with SourceIdentity condition
     - SSM GetParameter/GetParametersByPath on /sentinel/policies/*
     - CloudWatch Logs
     - DynamoDB (conditional, if session_table provided)

2. **Lambda Function** (lambda.Function):
   - runtime: lambda.Runtime.PROVIDED_AL2023
   - handler: 'bootstrap'
   - code: lambda.Code.fromAsset(props.lambdaZipPath)
   - role: execution role
   - environment: SENTINEL_POLICY_PARAMETER, optional tables
   - memorySize, timeout from props

3. **HTTP API** (apigatewayv2.HttpApi):
   - apiName: 'sentinel-tvm'
   - Use HttpLambdaIntegration

4. **Routes**:
   - GET / with IAM authorization (HttpIamAuthorizer)
   - POST / with IAM authorization
   - GET /profiles with IAM authorization

5. **CfnOutput**:
   - apiEndpoint: HTTP API URL
   - executionRoleArn: Role ARN

Use aws-cdk-lib constructs. Import from 'aws-cdk-lib/aws-lambda', 'aws-cdk-lib/aws-iam', etc.
Use HttpIamAuthorizer from '@aws-cdk/aws-apigatewayv2-authorizers'.

Wait - @aws-cdk/aws-apigatewayv2-authorizers may need separate dependency. Check CDK docs.
For HTTP API with IAM auth, use `authorizationType: apigatewayv2.HttpAuthorizationType.AWS_IAM` on routes.
  </action>
  <verify>cd cdk/sentinel-tvm && npx tsc --noEmit 2>/dev/null || echo "TypeScript check (install deps first)"</verify>
  <done>CDK stack compiles and defines Lambda, API Gateway, IAM role</done>
</task>

<task type="auto">
  <name>Task 3: Create CDK README with deployment instructions</name>
  <files>cdk/sentinel-tvm/README.md</files>
  <action>
Create README.md documenting the CDK stack:

**Sections:**
1. **Overview** - What the stack deploys
2. **Prerequisites** - Node.js, CDK CLI, Lambda zip file, SSM policies
3. **Installation**:
```bash
cd cdk/sentinel-tvm
npm install
```
4. **Configuration** - How to set props via context or environment
5. **Deployment**:
```bash
cdk bootstrap  # first time only
cdk deploy --context policyParameter=/sentinel/policies/production
```
6. **Stack Outputs** - What gets exported (API endpoint, role ARN)
7. **Customization** - How to modify for production use

Keep concise - under 100 lines. This is an example, not a production-ready construct library.
  </action>
  <verify>test -f cdk/sentinel-tvm/README.md</verify>
  <done>README exists with deployment instructions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] CDK project structure exists with package.json, tsconfig.json, cdk.json
- [ ] Stack defines Lambda, HTTP API, IAM role
- [ ] Routes configured with IAM authorization
- [ ] README documents deployment steps
</verification>

<success_criteria>

- All tasks completed
- CDK stack structure is complete
- TypeScript compiles (after npm install)
- IAM role follows least-privilege principle
</success_criteria>

<output>
After completion, create `.planning/phases/102-infrastructure-as-code/102-02-SUMMARY.md`
</output>
