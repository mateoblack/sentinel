---
phase: 102-infrastructure-as-code
plan: 03
type: execute
wave: 2
depends_on: ["102-01"]
files_modified: [terraform/sentinel-protected-role/main.tf, terraform/sentinel-protected-role/variables.tf, terraform/sentinel-protected-role/outputs.tf, terraform/sentinel-protected-role/README.md, docs/LAMBDA_TVM_COSTS.md, docs/CHANGELOG.md]
autonomous: true
---

<objective>
Create protected role Terraform module, cost optimization documentation, and update CHANGELOG.

Purpose: Complete Phase 102 with protected role template and cost guidance for production planning.
Output: Protected role module, cost optimization docs, and CHANGELOG entry for Phase 102.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/LAMBDA_TVM_DEPLOYMENT.md
@.planning/phases/102-infrastructure-as-code/102-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Terraform protected role module</name>
  <files>terraform/sentinel-protected-role/main.tf, terraform/sentinel-protected-role/variables.tf, terraform/sentinel-protected-role/outputs.tf, terraform/sentinel-protected-role/README.md</files>
  <action>
Create terraform/sentinel-protected-role/ module for roles that trust ONLY the TVM:

**variables.tf**:
- `role_name` (string) - Name of the protected role
- `tvm_execution_role_arn` (string) - ARN of the TVM execution role
- `assume_role_policy_additions` (list(object), optional) - Additional trust policy statements
- `managed_policy_arns` (list(string), optional) - Managed policies to attach
- `inline_policies` (map(string), optional) - Inline policies (name -> JSON)
- `tags` (map(string), optional)

**main.tf**:
```hcl
resource "aws_iam_role" "protected" {
  name = var.role_name

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = concat([
      {
        Effect = "Allow"
        Principal = {
          AWS = var.tvm_execution_role_arn
        }
        Action = "sts:AssumeRole"
        Condition = {
          StringLike = {
            "sts:SourceIdentity" = "sentinel:*"
          }
        }
      }
    ], var.assume_role_policy_additions)
  })

  tags = var.tags
}

# Attach managed policies
resource "aws_iam_role_policy_attachment" "managed" {
  for_each   = toset(var.managed_policy_arns)
  role       = aws_iam_role.protected.name
  policy_arn = each.value
}

# Inline policies
resource "aws_iam_role_policy" "inline" {
  for_each = var.inline_policies
  name     = each.key
  role     = aws_iam_role.protected.name
  policy   = each.value
}
```

**outputs.tf**:
- `role_arn` - Protected role ARN
- `role_name` - Protected role name

**README.md** (~50 lines):
- Overview: What this module creates
- Usage example with sentinel_tvm module reference
- Inputs/outputs tables
- Security note: Role trusts ONLY the TVM, ensuring policy enforcement
  </action>
  <verify>terraform fmt -check terraform/sentinel-protected-role/ && terraform validate terraform/sentinel-protected-role/</verify>
  <done>Protected role module validates, trust policy requires TVM and SourceIdentity</done>
</task>

<task type="auto">
  <name>Task 2: Create cost optimization documentation</name>
  <files>docs/LAMBDA_TVM_COSTS.md</files>
  <action>
Create LAMBDA_TVM_COSTS.md with cost guidance for production deployments:

**Sections:**

1. **Overview** - Lambda TVM pricing components (Lambda, API Gateway, DynamoDB, CloudWatch)

2. **Cost Breakdown**:
```
Lambda: $0.20 per 1M requests + $0.0000166667/GB-second
API Gateway: $1.00 per 1M requests (HTTP API)
DynamoDB: $1.25 per million WCU, $0.25 per million RCU (on-demand)
CloudWatch Logs: $0.50 per GB ingested
```

3. **Volume Patterns**:

**Low Volume** (<100K requests/month):
- Estimated cost: <$5/month
- Configuration: Default Lambda settings, on-demand DynamoDB
- Use case: Small teams, dev environments

**Medium Volume** (100K-1M requests/month):
- Estimated cost: $5-50/month
- Configuration: Default Lambda, on-demand DynamoDB
- Use case: Mid-size organizations, staging environments

**High Volume** (>1M requests/month):
- Estimated cost: $50-500/month depending on volume
- Configuration: Consider provisioned concurrency if latency-sensitive
- Use case: Large enterprises, production workloads

4. **Optimization Tips**:
- Enable API Gateway caching for /profiles endpoint
- Use DynamoDB provisioned capacity for predictable workloads
- Set appropriate Lambda memory (256MB usually sufficient)
- Consider Graviton2 (ARM64) for ~20% cost reduction
- Use log retention policies to manage CloudWatch costs

5. **Provisioned Concurrency**:
- Cost: ~$0.015 per provisioned GB-hour
- When to use: Consistent latency requirements, cold start sensitivity
- Example: 2 provisioned instances at 256MB = ~$5.50/month

6. **DynamoDB Capacity Modes**:
- On-demand: Best for unpredictable traffic, no capacity planning
- Provisioned: 25% cheaper for predictable workloads, requires planning

Keep practical with real numbers. Under 150 lines.
  </action>
  <verify>test -f docs/LAMBDA_TVM_COSTS.md && grep -q "Volume Patterns" docs/LAMBDA_TVM_COSTS.md</verify>
  <done>Cost optimization docs exist with low/medium/high volume patterns</done>
</task>

<task type="auto">
  <name>Task 3: Update CHANGELOG with Phase 102</name>
  <files>docs/CHANGELOG.md</files>
  <action>
Update docs/CHANGELOG.md to add Phase 102 under the v1.14 unreleased section.

Add after Phase 101 entry:

```markdown
### Phase 102: Infrastructure as Code

- Added Terraform module for Lambda TVM deployment (`terraform/sentinel-tvm/`)
- Added Terraform module for protected roles (`terraform/sentinel-protected-role/`)
- Added CDK TypeScript example for Lambda TVM (`cdk/sentinel-tvm/`)
- Added cost optimization guide (`docs/LAMBDA_TVM_COSTS.md`)
```

Maintain existing format and style. Do not modify other sections.
  </action>
  <verify>grep -A5 "Phase 102" docs/CHANGELOG.md</verify>
  <done>CHANGELOG updated with Phase 102 entry</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `terraform validate terraform/sentinel-protected-role/` passes
- [ ] Protected role trust policy requires TVM execution role and SourceIdentity
- [ ] Cost docs include all three volume patterns
- [ ] CHANGELOG has Phase 102 entry
</verification>

<success_criteria>

- All tasks completed
- Protected role module validates and enforces TVM-only trust
- Cost optimization documentation provides practical guidance
- CHANGELOG updated for Phase 102
</success_criteria>

<output>
After completion, create `.planning/phases/102-infrastructure-as-code/102-03-SUMMARY.md`
</output>
