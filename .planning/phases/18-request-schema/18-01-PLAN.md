---
phase: 18-request-schema
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [request/types.go, request/types_test.go, request/validate.go, request/validate_test.go]
autonomous: true
---

<objective>
Define the approval request data model with state machine, validation, and Go types.

Purpose: Establish the foundational schema for v1.2 approval workflows - requests, states, and transitions.
Output: New `request` package with types, validation, and comprehensive tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing patterns to follow:
@policy/types.go
@policy/validate.go
@identity/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create request types with state machine</name>
  <files>request/types.go</files>
  <action>
Create new `request` package with approval request types following existing patterns from `policy/types.go` and `identity/types.go`:

**Request struct:**
- ID: string (unique request identifier, 16 lowercase hex chars like identity but longer)
- Requester: string (username requesting access)
- Profile: string (AWS profile requested)
- Justification: string (why access is needed)
- Duration: time.Duration (how long access is requested for)
- Status: RequestStatus (state machine value)
- CreatedAt: time.Time
- UpdatedAt: time.Time
- ExpiresAt: time.Time (when pending request times out)
- Approver: string (who approved/denied, empty until actioned)
- ApproverComment: string (optional comment from approver)

**RequestStatus type (string type alias like Effect):**
- StatusPending = "pending"
- StatusApproved = "approved"
- StatusDenied = "denied"
- StatusExpired = "expired"
- StatusCancelled = "cancelled"
- Add IsValid() and String() methods

**State transitions (document in comments):**
- pending → approved (by approver)
- pending → denied (by approver)
- pending → expired (by TTL)
- pending → cancelled (by requester)
- approved/denied/expired/cancelled are terminal states

**Constants:**
- DefaultRequestTTL = 24 * time.Hour (pending requests expire after 24h)
- MaxJustificationLength = 500
- MinJustificationLength = 10
- RequestIDLength = 16

Include NewRequestID() function using crypto/rand (following identity/request_id.go pattern).

Use yaml/json struct tags for serialization. Follow existing package doc comment pattern.
  </action>
  <verify>go build ./request/...</verify>
  <done>Request type, RequestStatus type with constants, NewRequestID function, state transitions documented</done>
</task>

<task type="auto">
  <name>Task 2: Implement validation with comprehensive tests</name>
  <files>request/validate.go, request/validate_test.go, request/types_test.go</files>
  <action>
**validate.go:**
Create validation methods following policy/validate.go patterns:

- (r *Request) Validate() error - validates all fields
  - ID must be valid (16 lowercase hex)
  - Requester non-empty
  - Profile non-empty
  - Justification length between min/max
  - Status must be valid
  - Duration > 0 and <= reasonable max (e.g., 8 hours)
  - CreatedAt, UpdatedAt, ExpiresAt must be non-zero

- (r *Request) CanTransitionTo(newStatus RequestStatus) bool
  - Only pending can transition to approved/denied/expired/cancelled
  - Terminal states cannot transition

- ValidateRequestID(id string) bool - validates 16 lowercase hex format

**types_test.go:**
- TestRequestStatusIsValid - all valid statuses return true, invalid return false
- TestRequestStatusString - string conversion works
- TestNewRequestID - generates valid 16-char hex, no duplicates in 1000 iterations

**validate_test.go:**
- TestRequestValidate_Valid - fully valid request passes
- TestRequestValidate_EmptyID - fails validation
- TestRequestValidate_EmptyRequester - fails validation
- TestRequestValidate_EmptyProfile - fails validation
- TestRequestValidate_JustificationTooShort - fails validation
- TestRequestValidate_JustificationTooLong - fails validation
- TestRequestValidate_InvalidStatus - fails validation
- TestRequestValidate_ZeroDuration - fails validation
- TestRequestValidate_ExcessiveDuration - fails validation (>8h)
- TestCanTransitionTo_FromPending - all valid transitions
- TestCanTransitionTo_FromTerminal - no transitions allowed

Use table-driven tests where appropriate.
  </action>
  <verify>go test ./request/... -v</verify>
  <done>Validate() method, CanTransitionTo() method, all tests pass with good coverage</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./request/...` succeeds
- [ ] `go test ./request/...` passes all tests
- [ ] `go vet ./request/...` reports no issues
- [ ] Types follow existing codebase patterns (policy/types.go, identity/types.go)
- [ ] State machine transitions are correctly constrained
</verification>

<success_criteria>

- Request type with all required fields
- RequestStatus type with IsValid() and String() methods
- NewRequestID() generates valid unique IDs
- Validate() catches all invalid states
- CanTransitionTo() enforces state machine rules
- All tests pass
- Code follows existing conventions
</success_criteria>

<output>
After completion, create `.planning/phases/18-request-schema/18-01-SUMMARY.md`
</output>
