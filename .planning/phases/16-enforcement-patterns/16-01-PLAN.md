---
phase: 16-enforcement-patterns
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [docs/ENFORCEMENT.md]
autonomous: true
---

<objective>
Document IAM trust policy and SCP patterns for optional Sentinel enforcement.

Purpose: Enable teams to require Sentinel-issued credentials for sensitive roles, making Sentinel's policy decisions enforceable at the AWS IAM level rather than just advisory.
Output: docs/ENFORCEMENT.md with trust policy examples, SCP patterns, and deployment guidance.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-cloudtrail-correlation/15-01-SUMMARY.md

# Reference for SourceIdentity format and constraints
@identity/types.go

# Reference for how Sentinel stamps SourceIdentity
@sentinel/assume_role.go

# Related documentation for consistency
@docs/CLOUDTRAIL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ENFORCEMENT.md with trust policy patterns</name>
  <files>docs/ENFORCEMENT.md</files>
  <action>
Create docs/ENFORCEMENT.md with the following sections:

1. **Overview** - Explain that Sentinel enforcement is optional and progressive:
   - Level 1: Advisory only (Sentinel logs but doesn't enforce)
   - Level 2: Trust policy enforcement (roles require Sentinel SourceIdentity)
   - Level 3: Organization-wide SCP enforcement

2. **How Enforcement Works** - Explain the mechanism:
   - Sentinel stamps every session with `sentinel:<user>:<request-id>` SourceIdentity
   - Trust policies can require this prefix using `sts:SourceIdentity` condition
   - Without valid Sentinel SourceIdentity, AssumeRole fails

3. **Trust Policy Patterns** - Document IAM role trust policy patterns:

   Pattern A: Require ANY Sentinel-issued credentials
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Principal": {"AWS": "arn:aws:iam::ACCOUNT:root"},
         "Action": "sts:AssumeRole",
         "Condition": {
           "StringLike": {
             "sts:SourceIdentity": "sentinel:*"
           }
         }
       }
     ]
   }
   ```

   Pattern B: Require Sentinel AND specific users
   ```json
   {
     "Condition": {
       "StringLike": {
         "sts:SourceIdentity": ["sentinel:alice:*", "sentinel:bob:*"]
       }
     }
   }
   ```

   Pattern C: Allow Sentinel OR legacy (migration period)
   ```json
   {
     "Statement": [
       {
         "Effect": "Allow",
         "Principal": {"AWS": "arn:aws:iam::ACCOUNT:root"},
         "Action": "sts:AssumeRole",
         "Condition": {
           "StringLike": {"sts:SourceIdentity": "sentinel:*"}
         }
       },
       {
         "Effect": "Allow",
         "Principal": {"AWS": "arn:aws:iam::ACCOUNT:role/LegacyRole"},
         "Action": "sts:AssumeRole"
       }
     ]
   }
   ```

4. **Important Notes**:
   - SourceIdentity condition key is `sts:SourceIdentity` (not aws:SourceIdentity)
   - StringLike required for wildcard matching
   - Trust policy changes take effect immediately (no propagation delay)
  </action>
  <verify>cat docs/ENFORCEMENT.md | grep -q "sts:SourceIdentity" && echo "Trust policy patterns documented"</verify>
  <done>ENFORCEMENT.md exists with Overview, How Enforcement Works, and Trust Policy Patterns sections including 3 policy patterns (any Sentinel, specific users, migration)</done>
</task>

<task type="auto">
  <name>Task 2: Add SCP patterns for organization-wide enforcement</name>
  <files>docs/ENFORCEMENT.md</files>
  <action>
Add sections to docs/ENFORCEMENT.md:

5. **SCP Patterns** - Service Control Policies for organization-wide enforcement:

   Pattern A: Deny AssumeRole without Sentinel SourceIdentity (strict)
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Sid": "RequireSentinelSourceIdentity",
         "Effect": "Deny",
         "Action": "sts:AssumeRole",
         "Resource": "*",
         "Condition": {
           "StringNotLike": {
             "sts:SourceIdentity": "sentinel:*"
           }
         }
       }
     ]
   }
   ```

   Pattern B: Deny only for sensitive roles (targeted)
   ```json
   {
     "Statement": [
       {
         "Sid": "RequireSentinelForProductionRoles",
         "Effect": "Deny",
         "Action": "sts:AssumeRole",
         "Resource": [
           "arn:aws:iam::*:role/Production*",
           "arn:aws:iam::*:role/*Admin*"
         ],
         "Condition": {
           "StringNotLike": {
             "sts:SourceIdentity": "sentinel:*"
           }
         }
       }
     ]
   }
   ```

   Pattern C: Deny with exceptions for service roles
   ```json
   {
     "Statement": [
       {
         "Sid": "RequireSentinelExceptServiceRoles",
         "Effect": "Deny",
         "Action": "sts:AssumeRole",
         "Resource": "*",
         "Condition": {
           "StringNotLike": {
             "sts:SourceIdentity": "sentinel:*"
           },
           "ArnNotLike": {
             "aws:PrincipalArn": [
               "arn:aws:iam::*:role/aws-service-role/*",
               "arn:aws:iam::*:role/AWSServiceRole*"
             ]
           }
         }
       }
     ]
   }
   ```

6. **SCP Considerations**:
   - SCPs cannot grant permissions, only restrict
   - Apply to OU or account level via AWS Organizations
   - Service-linked roles may need exceptions
   - Test in non-production OUs first
   - SCP evaluation happens BEFORE IAM policies
  </action>
  <verify>cat docs/ENFORCEMENT.md | grep -q "StringNotLike" && echo "SCP patterns documented"</verify>
  <done>ENFORCEMENT.md includes SCP Patterns section with 3 patterns (strict, targeted, with exceptions) and SCP Considerations</done>
</task>

<task type="auto">
  <name>Task 3: Add deployment guidance and troubleshooting</name>
  <files>docs/ENFORCEMENT.md</files>
  <action>
Add final sections to docs/ENFORCEMENT.md:

7. **Deployment Guide** - Progressive rollout strategy:

   **Phase 1: Audit Mode** (1-2 weeks)
   - Deploy Sentinel without enforcement
   - Review decision logs to identify access patterns
   - Verify SourceIdentity appears in CloudTrail

   **Phase 2: Pilot Enforcement** (1-2 weeks)
   - Select low-risk role for trust policy enforcement
   - Update trust policy to require Sentinel SourceIdentity
   - Monitor for access failures

   **Phase 3: Expand to Sensitive Roles**
   - Update trust policies for production/admin roles
   - Add migration period policy if needed (Pattern C from Task 1)

   **Phase 4: Organization-wide SCP** (optional)
   - Apply targeted SCP to production OUs
   - Expand to organization-wide if desired

8. **Troubleshooting** - Common issues and solutions:

   **"AccessDenied when assuming role"**
   - Check: Is Sentinel being used? (credential_process or exec)
   - Check: Does trust policy have correct condition key (sts:SourceIdentity, not aws:SourceIdentity)
   - Check: Is StringLike used (not StringEquals) for wildcard matching

   **"SCP blocking service roles"**
   - Check: Add exceptions for AWS service-linked roles
   - Check: ArnNotLike condition for service role patterns

   **"SourceIdentity not appearing in CloudTrail"**
   - Check: AssumeRole must complete successfully to stamp SourceIdentity
   - Check: CloudTrail lookup uses Username attribute for SourceIdentity search
   - Check: Data events may require separate trail configuration

9. **Security Considerations**:
   - Sentinel's effectiveness depends on controlling the credential_process path
   - Users with direct IAM user credentials can bypass Sentinel
   - Consider removing IAM user access keys for full enforcement
   - SCPs provide defense-in-depth but don't replace credential controls
  </action>
  <verify>cat docs/ENFORCEMENT.md | grep -q "Deployment Guide" && grep -q "Troubleshooting" && echo "Deployment guidance complete"</verify>
  <done>ENFORCEMENT.md includes Deployment Guide (4 phases), Troubleshooting section with 3 common issues, and Security Considerations</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] docs/ENFORCEMENT.md exists with all 9 sections
- [ ] Trust policy patterns include 3 examples (any Sentinel, specific users, migration)
- [ ] SCP patterns include 3 examples (strict, targeted, with exceptions)
- [ ] Deployment guide covers 4 phases (audit, pilot, expand, org-wide)
- [ ] Troubleshooting covers common access denied scenarios
- [ ] JSON policy examples are valid syntax
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Documentation follows same style as docs/CLOUDTRAIL.md
- Policy examples are copy-paste ready
</success_criteria>

<output>
After completion, create `.planning/phases/16-enforcement-patterns/16-01-SUMMARY.md`
</output>
