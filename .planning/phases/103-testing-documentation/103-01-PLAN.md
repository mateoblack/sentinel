---
phase: 103-testing-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [lambda/security_test.go, docs/LAMBDA_TVM_TESTING.md]
autonomous: true
---

<objective>
Add TVM security regression tests and end-to-end testing documentation.

Purpose: Validate that the Lambda TVM cannot be bypassed and provide testing guidance for production deployments.
Output: Security test suite + testing documentation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (TVM implementation context)
@.planning/phases/102-infrastructure-as-code/102-01-SUMMARY.md

# Existing lambda tests for patterns
@lambda/handler_test.go
@lambda/vend_test.go

# Existing TVM documentation
@docs/LAMBDA_TVM_DEPLOYMENT.md
@docs/LAMBDA_TVM_SCP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TVM security regression tests</name>
  <files>lambda/security_test.go</files>
  <action>
Create security regression test file with TestSecurityRegression_ prefix (consistent with existing security tests in the codebase). Tests should validate:

1. **Policy bypass prevention**: Verify that requests are rejected when policy denies access, even with valid caller credentials. Test that a deny policy returns 403.

2. **SourceIdentity enforcement**: Verify SourceIdentity is always stamped on credentials. Use mock STS client to capture AssumeRole parameters and assert SourceIdentity starts with "sentinel:".

3. **Caller identity extraction**: Verify caller identity is extracted from API Gateway request context, not from request body or headers that could be spoofed. Test with mock API Gateway events.

4. **Session tracking enforcement**: When session table configured, verify session is created and session ID returned. When session revoked, verify credentials are denied.

5. **Approval/break-glass checks**: Verify that when policy requires approval, unapproved requests are denied. Verify break-glass allows access when policy would deny.

Follow existing test patterns in handler_test.go (testSTSClient, mockPolicyLoader, testTVMConfig helpers).
  </action>
  <verify>go test -v -run TestSecurityRegression ./lambda/...</verify>
  <done>Security regression tests pass, covering policy bypass, SourceIdentity, caller identity, session, and approval/break-glass scenarios.</done>
</task>

<task type="auto">
  <name>Task 2: Create end-to-end testing documentation</name>
  <files>docs/LAMBDA_TVM_TESTING.md</files>
  <action>
Create comprehensive testing documentation covering:

**1. Unit Test Coverage**
- Document existing test coverage in lambda/ package (~2,771 lines)
- How to run tests: `go test ./lambda/...`
- How to run with race detector: `go test -race ./lambda/...`
- How to generate coverage: `go test -coverprofile=coverage.out ./lambda/...`

**2. Integration Testing Guide**
- Local testing with mock API Gateway events (using go test)
- Testing deployed Lambda with AWS CLI:
  ```bash
  aws lambda invoke --function-name sentinel-tvm \
    --payload '{"requestContext":{"authorizer":{"iam":{"userArn":"..."}}}}' \
    response.json
  ```
- Testing API Gateway endpoint with curl + SigV4
- Profile discovery endpoint testing

**3. Security Testing Checklist**
- [ ] Direct AssumeRole blocked by SCP
- [ ] TVM can still assume protected roles
- [ ] Policy deny returns 403
- [ ] Invalid duration returns 400
- [ ] Session revocation blocks credentials
- [ ] SourceIdentity present in CloudTrail

**4. Load Testing Guidance**
- Target latency: <200ms p99
- Use AWS Lambda Power Tuning for memory optimization
- Load test with Artillery or k6
- Sample Artillery config for credential vending endpoint
- Expected throughput: Lambda scales automatically, monitor ConcurrentExecutions

**5. Troubleshooting Common Issues**
- "POLICY_DENY" error troubleshooting
- "CREDENTIAL_ERROR" troubleshooting (trust policy issues)
- Cold start latency (provisioned concurrency recommendation)
- Session table not found errors

Reference existing docs (LAMBDA_TVM_DEPLOYMENT.md, LAMBDA_TVM_SCP.md) where appropriate.
  </action>
  <verify>cat docs/LAMBDA_TVM_TESTING.md | head -100</verify>
  <done>Testing documentation exists with unit test, integration test, security test, and load test sections.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test -v -run TestSecurityRegression ./lambda/...` passes
- [ ] docs/LAMBDA_TVM_TESTING.md exists and covers all sections
- [ ] No new errors introduced
</verification>

<success_criteria>

- Security regression tests exist with 5+ test scenarios
- Testing documentation covers unit, integration, security, and load testing
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/103-testing-documentation/103-01-SUMMARY.md`
</output>
