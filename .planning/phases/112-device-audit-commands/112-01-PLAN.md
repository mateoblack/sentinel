---
phase: 112-device-audit-commands
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cli/device_sessions.go
  - cli/device_sessions_test.go
autonomous: true
---

<objective>
Add CLI commands for device-based session audit: query sessions by device ID and list unique devices with session history.

Purpose: Enable security teams to investigate device-based access patterns, correlate sessions across devices, and identify anomalies for forensic analysis.
Output: Two new CLI commands: `sentinel device-sessions <device-id>` and `sentinel devices`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/110-session-device-binding/110-01-SUMMARY.md
@.planning/phases/111-decision-logging-enhancement/111-01-SUMMARY.md

# Key prior work:
# - Phase 110 added ServerSession.DeviceID field and ListByDeviceID query method
# - Phase 111 added device ID to decision logs for forensic correlation
# - session.Store interface already has ListByDeviceID(ctx, deviceID, limit)
# - device.ValidateDeviceIdentifier(id) validates 64-char lowercase hex format

# Existing patterns to follow:
@cli/sentinel_server.go  # server-sessions, server-session, server-revoke commands
@session/store.go        # Store interface with ListByDeviceID
@device/identity.go      # ValidateDeviceIdentifier function
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add device-sessions command to query sessions by device ID</name>
  <files>cli/device_sessions.go</files>
  <action>
Create `sentinel device-sessions <device-id>` command following server-sessions pattern:

1. Command structure:
   - Positional arg: device-id (required, 64-char lowercase hex)
   - Flags: --region (required), --table (required), --status, --limit, --output (human/json/csv), --aws-profile

2. Implementation:
   - Validate device ID format using device.ValidateDeviceIdentifier()
   - Load AWS config with optional profile
   - Create DynamoDB store from session package
   - Call store.ListByDeviceID(ctx, deviceID, limit)
   - Apply optional status filter client-side
   - Output in requested format (reuse ServerSessionSummary type)

3. Output formats:
   - Human: Table with ID, User, Profile, Status, Started, Requests
   - JSON: {"sessions": [...]} with full session details
   - CSV: Header + data rows for export

4. Error handling:
   - Invalid device ID format → clear error message with expected format
   - No sessions found → "No sessions found for device <device-id>"
   - DynamoDB errors → wrapped with context

5. Add DeviceID field to ServerSessionSummary (it currently lacks this)
  </action>
  <verify>go build ./cli/... compiles without errors</verify>
  <done>
    - device-sessions command accepts device ID positional argument
    - Validates 64-char lowercase hex format
    - Queries sessions using existing ListByDeviceID
    - Outputs in human/json/csv formats
    - Includes DeviceID field in session summaries
  </done>
</task>

<task type="auto">
  <name>Task 2: Add devices command to list unique devices with sessions</name>
  <files>cli/device_sessions.go</files>
  <action>
Add `sentinel devices` command to list unique devices that have session history:

1. Command structure:
   - Flags: --region (required), --table (required), --since (duration filter), --limit, --output (human/json), --aws-profile

2. Implementation:
   - Load AWS config and create DynamoDB store
   - Query sessions using ListByTimeRange (if --since) or ListByStatus(active) (default)
   - Extract unique device IDs from sessions
   - For each unique device, aggregate:
     - session_count: number of sessions
     - unique_users: set of users who accessed from this device
     - latest_session: most recent session timestamp
     - profiles_accessed: set of profiles accessed
   - Flag anomalies:
     - Multiple users from same device (potential shared device or compromise)
     - Single device accessing many profiles (potential lateral movement)

3. Output format (human):
   ```
   Device ID (truncated)  Sessions  Users  Profiles  Latest Access        Flags
   a1b2c3d4e5f6...       12        1      3         2026-01-25 10:30
   f9e8d7c6b5a4...        5        3      2         2026-01-24 15:22    MULTI_USER
   ```

4. Output format (JSON):
   ```json
   {
     "devices": [
       {
         "device_id": "...",
         "session_count": 12,
         "unique_users": ["alice"],
         "profiles_accessed": ["staging", "dev", "prod"],
         "latest_session": "...",
         "anomalies": []
       }
     ]
   }
   ```

5. Anomaly flags:
   - MULTI_USER: >1 unique user from same device
   - HIGH_PROFILE_COUNT: >5 different profiles from single device (configurable via flag)
  </action>
  <verify>go build ./cli/... compiles without errors</verify>
  <done>
    - devices command lists unique devices with session history
    - Shows aggregated stats per device
    - Flags anomalies (MULTI_USER, HIGH_PROFILE_COUNT)
    - Supports human/json output formats
    - Filters by --since duration
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for device audit commands</name>
  <files>cli/device_sessions_test.go</files>
  <action>
Add comprehensive tests for both commands following sentinel_server_test.go patterns:

1. DeviceSessionsCommand tests:
   - TestDeviceSessionsCommand_Success: Valid device ID returns sessions
   - TestDeviceSessionsCommand_InvalidDeviceID: Rejects invalid format
   - TestDeviceSessionsCommand_NoSessions: Empty result handling
   - TestDeviceSessionsCommand_StatusFilter: Filters by status
   - TestDeviceSessionsCommand_JSONOutput: JSON format output
   - TestDeviceSessionsCommand_CSVOutput: CSV format output

2. DevicesCommand tests:
   - TestDevicesCommand_Success: Lists unique devices
   - TestDevicesCommand_MultiUserAnomaly: Flags devices with multiple users
   - TestDevicesCommand_HighProfileAnomaly: Flags devices with many profiles
   - TestDevicesCommand_SinceFilter: Respects time filter
   - TestDevicesCommand_JSONOutput: JSON format output
   - TestDevicesCommand_NoDevices: Empty sessions handling

3. Use mockSessionStore pattern from sentinel_server_test.go:
   - Implement ListByDeviceID in mock
   - Return test data with varied device IDs, users, profiles

4. Test anomaly detection logic:
   - Device with 1 user → no anomaly
   - Device with 3 users → MULTI_USER flag
   - Device with 6 profiles → HIGH_PROFILE_COUNT flag
  </action>
  <verify>go test ./cli/... -run "Device" -v passes</verify>
  <done>
    - Tests cover device-sessions command functionality
    - Tests cover devices command functionality
    - Tests verify anomaly detection logic
    - All tests pass with mock store
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./cli/...` succeeds
- [ ] `go test ./cli/... -run "Device"` passes all tests
- [ ] `go vet ./cli/...` reports no issues
- [ ] Commands are wired up in main.go or appropriate entry point
</verification>

<success_criteria>

- `sentinel device-sessions <device-id>` queries sessions by device
- `sentinel devices` lists unique devices with aggregated stats
- Anomaly flags (MULTI_USER, HIGH_PROFILE_COUNT) detect suspicious patterns
- All commands support --output (human/json/csv) flags
- Tests validate functionality and edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/112-device-audit-commands/112-01-SUMMARY.md`
</output>
