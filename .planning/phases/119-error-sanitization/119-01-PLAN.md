---
phase: 119-error-sanitization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [lambda/handler.go, sentinel/server.go, server/ec2server.go, server/ecsserver.go, lambda/handler_test.go, sentinel/server_test.go]
autonomous: true
---

<objective>
Sanitize error messages in Lambda TVM, Sentinel server, and credential servers to prevent information leakage.

Purpose: Fix critical security issue where raw error details (SSM paths, ARN parsing errors, MDM provider failures, credential retrieval errors) are exposed to HTTP clients. Proper pattern: log details internally, return generic messages to clients.
Output: All public-facing error responses use generic messages while detailed errors are logged internally for debugging.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/117-api-rate-limiting/117-02-SUMMARY.md
@.planning/phases/118-dependency-security-audit/118-01-SUMMARY.md

# Files to modify:
@lambda/handler.go
@sentinel/server.go
@server/ec2server.go
@server/ecsserver.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sanitize Lambda TVM handler error responses</name>
  <files>lambda/handler.go</files>
  <action>
Fix information leakage in Lambda TVM handler. The handler correctly uses generic messages in some places (line 276-277) but leaks details in others. Apply consistent pattern:

**Lines to fix (replace with generic messages, keep detailed logging):**

1. **Line 51** - Config error leaks err.Error():
   ```go
   // BEFORE: "Failed to load configuration: "+err.Error()
   // AFTER:
   log.Printf("ERROR: Failed to load configuration: %v", err)
   return errorResponse(http.StatusInternalServerError, "CONFIG_ERROR", "Failed to load configuration")
   ```

2. **Line 60** - IAM auth error leaks err details:
   ```go
   // BEFORE: fmt.Sprintf("IAM authorization required: %v", err)
   // AFTER:
   log.Printf("ERROR: IAM authorization required: %v", err)
   return errorResponse(http.StatusForbidden, "IAM_AUTH_REQUIRED", "IAM authorization required")
   ```

3. **Line 67** - Username extraction leaks parsing details:
   ```go
   // BEFORE: fmt.Sprintf("Could not extract username: %v", err)
   // AFTER:
   log.Printf("ERROR: Could not extract username from ARN: %v", err)
   return errorResponse(http.StatusBadRequest, "INVALID_IDENTITY", "Could not extract username from identity")
   ```

4. **Line 112** - MDM error leaks provider details:
   ```go
   // BEFORE: fmt.Sprintf("Device verification failed: %v", mdmErr)
   // AFTER:
   log.Printf("ERROR: Device verification failed for device=%s: %v", deviceID, mdmErr)
   return errorResponse(http.StatusForbidden, "DEVICE_VERIFICATION_FAILED", "Device verification failed")
   ```

5. **Line 123** - Duration error is acceptable (user input validation) but sanitize internal details:
   ```go
   // BEFORE: fmt.Sprintf("Invalid duration: %v", err)
   // AFTER:
   return errorResponse(http.StatusBadRequest, "INVALID_DURATION", "Invalid duration parameter")
   ```

6. **Line 206** - Policy deny reason is OK (business logic) but sanitize:
   ```go
   // BEFORE: fmt.Sprintf("Policy denied: %s", decision.Reason)
   // AFTER: Keep as-is - Reason is intentional user-facing message from policy
   ```

7. **Line 348-349** - Marshal error leaks type info:
   ```go
   // BEFORE: fmt.Sprintf("Failed to marshal credentials: %v", err)
   // AFTER:
   log.Printf("ERROR: Failed to marshal credentials: %v", err)
   return errorResponse(http.StatusInternalServerError, "MARSHAL_ERROR", "Failed to marshal credentials")
   ```

**Pattern to follow:** Lines 273-277 are the correct pattern - log details to CloudWatch, return generic message to client.
  </action>
  <verify>
- `go build ./lambda/...` succeeds
- `go test ./lambda/...` passes
- Grep for `err.Error()` in errorResponse calls - should find none
  </verify>
  <done>
- All Lambda TVM error responses use generic messages
- Detailed errors logged internally via log.Printf
- No error details leaked to HTTP clients
  </done>
</task>

<task type="auto">
  <name>Task 2: Sanitize Sentinel server error responses</name>
  <files>sentinel/server.go</files>
  <action>
Fix information leakage in Sentinel credential server (sentinel/server.go). Some places are correct (line 311 "Policy denied access"), others leak details.

**Lines to fix:**

1. **Line 274** - Policy load error leaks SSM path details:
   ```go
   // BEFORE: writeErrorMessage(w, fmt.Sprintf("Failed to load policy: %v", err), http.StatusInternalServerError)
   // AFTER:
   log.Printf("ERROR: Failed to load policy from %s: %v", s.config.PolicyParameter, err)
   writeErrorMessage(w, "Failed to load policy", http.StatusInternalServerError)
   ```

2. **Line 376** - Credential retrieval error leaks provider details:
   ```go
   // BEFORE: writeErrorMessage(w, fmt.Sprintf("Failed to retrieve credentials: %v", err), http.StatusInternalServerError)
   // AFTER:
   log.Printf("ERROR: Failed to retrieve credentials for profile=%s: %v", s.config.ProfileName, err)
   writeErrorMessage(w, "Failed to retrieve credentials", http.StatusInternalServerError)
   ```

**Already correct (no changes needed):**
- Line 311: "Policy denied access" - generic
- Line 327: "Session revoked" - generic
- Line 481: "invalid Authorization token" - generic
- Line 502: "Rate limit exceeded. Retry after..." - OK (rate limit info is not sensitive)
  </action>
  <verify>
- `go build ./sentinel/...` succeeds
- `go test ./sentinel/...` passes
- Grep for `fmt.Sprintf` in writeErrorMessage calls - should find only rate limit message
  </verify>
  <done>
- All Sentinel server error responses use generic messages
- Policy/credential errors logged internally with context
- No SSM paths or provider details leaked
  </done>
</task>

<task type="auto">
  <name>Task 3: Sanitize EC2/ECS credential server error responses</name>
  <files>server/ec2server.go, server/ecsserver.go</files>
  <action>
Fix information leakage in EC2 and ECS metadata credential servers. These expose raw err.Error() to HTTP clients.

**server/ec2server.go fixes:**

1. **Line 67** - net.SplitHostPort error leaks network details:
   ```go
   // BEFORE: http.Error(w, err.Error(), http.StatusBadRequest)
   // AFTER:
   log.Printf("ERROR: Invalid remote address: %v", err)
   http.Error(w, "Invalid request", http.StatusBadRequest)
   ```

2. **Line 91** - Credential retrieval error leaks provider chain details:
   ```go
   // BEFORE: http.Error(w, err.Error(), http.StatusGatewayTimeout)
   // AFTER:
   log.Printf("ERROR: Failed to retrieve credentials: %v", err)
   http.Error(w, "Failed to retrieve credentials", http.StatusGatewayTimeout)
   ```

3. **Line 110** - JSON encode error leaks type info:
   ```go
   // BEFORE: http.Error(w, err.Error(), http.StatusInternalServerError)
   // AFTER:
   log.Printf("ERROR: Failed to encode credentials response: %v", err)
   http.Error(w, "Internal server error", http.StatusInternalServerError)
   ```

**server/ecsserver.go fixes:**

1. **Line 52** - JSON encode error (in writeCredsToResponse):
   ```go
   // BEFORE: writeErrorMessage(w, err.Error(), http.StatusInternalServerError)
   // AFTER:
   log.Printf("ERROR: Failed to encode credentials response: %v", err)
   writeErrorMessage(w, "Failed to encode response", http.StatusInternalServerError)
   ```

2. **Line 120** - Base credential retrieval error:
   ```go
   // BEFORE: writeErrorMessage(w, err.Error(), http.StatusInternalServerError)
   // AFTER:
   log.Printf("ERROR: Failed to retrieve base credentials: %v", err)
   writeErrorMessage(w, "Failed to retrieve credentials", http.StatusInternalServerError)
   ```

3. **Line 150** - AssumeRole error leaks role ARN and STS details:
   ```go
   // BEFORE: writeErrorMessage(w, err.Error(), http.StatusInternalServerError)
   // AFTER:
   log.Printf("ERROR: Failed to assume role %s: %v", roleArn, err)
   writeErrorMessage(w, "Failed to retrieve credentials", http.StatusInternalServerError)
   ```

**Note:** The panic in generateRandomString (line 60) is acceptable - crypto/rand failure is a critical system error that should crash.
  </action>
  <verify>
- `go build ./server/...` succeeds
- `go test ./server/...` passes
- Grep for `err.Error()` in http.Error or writeErrorMessage calls - should find none
  </verify>
  <done>
- All EC2/ECS server error responses use generic messages
- Credential retrieval and encoding errors logged internally
- No AWS provider chain or role ARN details leaked
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds without errors
- [ ] `go test ./...` passes all tests
- [ ] No `err.Error()` appears in client-facing error responses (grep verification)
- [ ] All error responses are generic (no paths, ARNs, or internal details)
- [ ] Detailed errors are logged via log.Printf for debugging
</verification>

<success_criteria>

- All HTTP error responses use generic, safe messages
- Detailed errors logged internally (CloudWatch for Lambda, stdout for servers)
- Consistent error handling pattern across all credential endpoints
- No regression in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/119-error-sanitization/119-01-SUMMARY.md`
</output>
