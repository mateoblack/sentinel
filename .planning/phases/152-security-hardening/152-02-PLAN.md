---
phase: 152-security-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [cli/scp.go, cli/scp_test.go, deploy/scp.go]
autonomous: true
---

<objective>
Replace SCP deployment command with template-only output to eliminate organization lockout risk.

Purpose: SEC-02 - The `sentinel scp deploy` command can deploy SCPs that affect the entire AWS Organization. Per SCP-T-01 threat model, misconfigured SCPs can lock out all accounts including management account. Replace with template output that users manually deploy through their change management process.

Output: `sentinel scp deploy` replaced with `sentinel scp template` that outputs the SCP policy document for manual deployment. Actual SCP deployment logic removed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing SCP implementation:
@cli/scp.go
@deploy/scp.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace scp deploy with scp template command</name>
  <files>cli/scp.go</files>
  <action>
Replace the SCP deploy command with a template-only command:

1. **Rename command from "deploy" to "template"**:
   ```go
   cmd := scpCmd.Command("template", "Output Sentinel SCP policy template for manual deployment")
   ```

2. **Remove deployment-related flags**:
   - Remove --target-ou flag (deployment specific)
   - Remove --aws-profile flag (no AWS calls needed)
   - Remove --region flag (no AWS calls needed)
   - Keep --format flag for output format options

3. **Add new flags**:
   ```go
   cmd.Flag("format", "Output format: json, yaml, terraform, cloudformation").
       Default("json").
       EnumVar(&input.Format, "json", "yaml", "terraform", "cloudformation")

   cmd.Flag("output", "Output file (default: stdout)").
       Short('o').
       StringVar(&input.OutputFile)
   ```

4. **Replace SCPDeployCommandInput with SCPTemplateCommandInput**:
   ```go
   type SCPTemplateCommandInput struct {
       Format     string  // json, yaml, terraform, cloudformation
       OutputFile string  // "" means stdout
       Stdout     *os.File
       Stderr     *os.File
   }
   ```

5. **Replace SCPDeployCommand with SCPTemplateCommand**:
   ```go
   func SCPTemplateCommand(ctx context.Context, input SCPTemplateCommandInput) int {
       // Output the SCP policy document in requested format
       // NO AWS API calls - purely local template generation
   }
   ```
   - JSON: Output raw SCP policy JSON
   - YAML: Convert to YAML format
   - Terraform: Output aws_organizations_policy resource
   - CloudFormation: Output AWS::Organizations::Policy resource

6. **Add deprecation warning if user tries old command**:
   Keep a hidden "deploy" command that just prints:
   ```
   Error: The 'sentinel scp deploy' command has been removed for security reasons (SCP-T-01).

   SCPs can lock out entire AWS Organizations including management accounts.
   Use 'sentinel scp template' to generate the SCP policy, then deploy through
   your organization's change management process.

   Example: sentinel scp template --format terraform > sentinel-scp.tf
   ```

**Output formats:**

JSON (default):
```json
{
  "Version": "2012-10-17",
  "Statement": [...policy from deploy.SentinelSCPPolicy...]
}
```

Terraform:
```hcl
resource "aws_organizations_policy" "sentinel_source_identity" {
  name        = "SentinelSourceIdentityEnforcement"
  description = "Require SourceIdentity on all AssumeRole operations"
  type        = "SERVICE_CONTROL_POLICY"
  content     = jsonencode({...})
}

resource "aws_organizations_policy_attachment" "sentinel_root" {
  policy_id = aws_organizations_policy.sentinel_source_identity.id
  target_id = "r-xxxx"  # Replace with your organization root ID
}
```

CloudFormation:
```yaml
AWSTemplateFormatVersion: '2010-09-09'
Resources:
  SentinelSCP:
    Type: AWS::Organizations::Policy
    Properties:
      Name: SentinelSourceIdentityEnforcement
      Type: SERVICE_CONTROL_POLICY
      Content: ...
```

**AVOID:**
- Don't make any AWS API calls in template command
- Don't remove SentinelSCPPolicy constant from deploy package (templates need it)
- Don't remove the warning about SCP impact
  </action>
  <verify>go build ./cli/... compiles without errors</verify>
  <done>scp template command outputs policy in multiple formats, no AWS calls</done>
</task>

<task type="auto">
  <name>Task 2: Remove SCP deployment logic from deploy package</name>
  <files>deploy/scp.go</files>
  <action>
Simplify deploy/scp.go to only provide the SCP policy template:

1. **Keep the SCP policy constant**:
   ```go
   const SentinelSCPName = "SentinelSourceIdentityEnforcement"
   const SentinelSCPPolicy = `{...}`  // Keep this
   ```

2. **Remove SCPDeployer struct and methods**:
   - Remove SCPDeployer struct
   - Remove NewSCPDeployer
   - Remove DeploySCP method
   - Remove GetOrganizationRoot method
   - Remove FindExistingSentinelSCP method
   - Remove ValidatePermissions method
   - Remove organizationsAPI interface

3. **Add template generation functions**:
   ```go
   // GetSCPPolicyJSON returns the SCP policy as formatted JSON
   func GetSCPPolicyJSON() string

   // GetSCPPolicyYAML returns the SCP policy as YAML
   func GetSCPPolicyYAML() (string, error)

   // GetSCPTerraform returns a Terraform resource definition
   func GetSCPTerraform() string

   // GetSCPCloudFormation returns a CloudFormation resource definition
   func GetSCPCloudFormation() string
   ```

4. **Keep the policy document** for reference but remove all deployment code.

5. **Add comment explaining removal**:
   ```go
   // NOTE: SCP deployment functionality was removed in v2.0 (SEC-02/SCP-T-01).
   // SCPs can lock out entire AWS Organizations. Users should deploy SCPs
   // through their organization's change management process.
   // Use sentinel scp template to generate the policy.
   ```

**AVOID:**
- Don't remove the SCP policy constants
- Don't remove the package entirely (templates still need it)
  </action>
  <verify>go build ./deploy/... compiles without errors</verify>
  <done>deploy/scp.go provides templates only, no deployment logic</done>
</task>

<task type="auto">
  <name>Task 3: Update tests for template command</name>
  <files>cli/scp_test.go</files>
  <action>
Update tests for the new template command:

1. **Remove deployment tests**:
   - Remove tests for SCPDeployCommand
   - Remove tests for SCPDeployer mocks
   - Remove tests for organization API calls

2. **Add template output tests**:
   - Test JSON format output is valid JSON
   - Test YAML format output is valid YAML
   - Test Terraform format includes correct resource type
   - Test CloudFormation format includes correct resource type
   - Test --output flag writes to file
   - Test default stdout output

3. **Add deprecation warning test**:
   - Test that hidden "deploy" command shows deprecation message
   - Test exit code is non-zero for deploy attempt

4. **Test template content**:
   - Verify SCP policy includes SourceIdentity condition
   - Verify policy name is consistent
   - Verify all output formats contain the same policy

5. **Remove deploy package tests**:
   - Update deploy/scp_test.go to only test template functions
   - Remove organization API mock tests
  </action>
  <verify>go test ./cli/... -run SCP -v passes all tests</verify>
  <done>All SCP tests pass for template command, deployment tests removed</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./cli/... ./deploy/...` succeeds
- [ ] `go test ./cli/... -run SCP -v` passes
- [ ] `go test ./deploy/... -v` passes (scp.go tests)
- [ ] `go vet ./cli/... ./deploy/...` reports no issues
- [ ] `sentinel scp template --format json` outputs valid JSON
- [ ] `sentinel scp deploy` shows deprecation error
- [ ] No AWS API calls in scp.go or deploy/scp.go
</verification>

<success_criteria>

- SCP deploy command replaced with template command
- Template outputs JSON, YAML, Terraform, CloudFormation formats
- No AWS API calls in SCP functionality
- Deprecation warning for old deploy command
- All tests updated for new behavior
</success_criteria>

<output>
After completion, create `.planning/phases/152-security-hardening/152-02-SUMMARY.md`
</output>
