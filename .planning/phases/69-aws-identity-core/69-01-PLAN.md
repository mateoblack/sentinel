---
phase: 69-aws-identity-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [identity/aws_identity.go, identity/aws_identity_test.go]
autonomous: true
---

<objective>
Create AWS identity extraction module that extracts username from AWS ARNs for all identity types.

Purpose: The current codebase uses `user.Current()` (OS username) for policy evaluation, which is a security vulnerability. The OS username can differ from the AWS identity, allowing policy bypass. This phase creates the foundation for extracting the AWS-authenticated username from STS GetCallerIdentity.

Output: New `identity/aws_identity.go` with ARN parsing functions and comprehensive tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing identity package (for patterns)
@identity/types.go
@identity/request_id.go

# Existing STS usage in codebase (for patterns)
@permissions/checker.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ARN parsing and username extraction</name>
  <files>identity/aws_identity.go</files>
  <action>
Create `identity/aws_identity.go` with:

1. **AWSIdentity struct** containing:
   - ARN (full ARN string)
   - AccountID (12-digit AWS account)
   - Type (user, assumed-role, federated-user, root)
   - Username (extracted from ARN, sanitized for policy matching)
   - RawUsername (unsanitized version for display)

2. **ParseARN(arn string) (*AWSIdentity, error)** function that handles:
   - IAM User: `arn:aws:iam::123456789012:user/alice` → Username: `alice`
   - IAM User with path: `arn:aws:iam::123456789012:user/division/team/alice` → Username: `alice`
   - SSO assumed-role: `arn:aws:sts::123456789012:assumed-role/AWSReservedSSO_DeveloperAccess_abc123/alice@company.com` → Username: `alicecompanycom` (sanitized email)
   - Regular assumed-role: `arn:aws:sts::123456789012:assumed-role/MyRole/session-name` → Username: `sessionname`
   - Federated user: `arn:aws:sts::123456789012:federated-user/alice` → Username: `alice`
   - Root: `arn:aws:iam::123456789012:root` → Username: `root`

3. **ExtractUsername(arn string) (string, error)** convenience function that returns just the sanitized username.

4. **IdentityType** type alias with constants: `IdentityTypeUser`, `IdentityTypeAssumedRole`, `IdentityTypeFederatedUser`, `IdentityTypeRoot`, `IdentityTypeUnknown`

Key implementation notes:
- Use existing `SanitizeUser()` from types.go for username sanitization
- ARN format: `arn:partition:service:region:account:resource`
- For assumed-role, resource format is `assumed-role/role-name/session-name` - extract session-name
- For SSO, session-name is typically the email address - sanitize to remove @ and .
- For user with path, resource format is `user/path/username` - extract last component
- Return clear errors with ErrInvalidARN, ErrUnsupportedIdentityType

Pattern to follow: Keep it similar to existing identity package style (simple types, validation methods, clear errors).
  </action>
  <verify>go build ./identity/... compiles without errors</verify>
  <done>AWSIdentity type and ParseARN function exist and handle all ARN formats</done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive tests for ARN parsing</name>
  <files>identity/aws_identity_test.go</files>
  <action>
Create `identity/aws_identity_test.go` with table-driven tests covering:

1. **TestParseARN** with cases:
   - IAM user: `arn:aws:iam::123456789012:user/alice` → alice
   - IAM user with single path: `arn:aws:iam::123456789012:user/admins/alice` → alice
   - IAM user with deep path: `arn:aws:iam::123456789012:user/division/team/alice` → alice
   - SSO assumed-role (email): `arn:aws:sts::123456789012:assumed-role/AWSReservedSSO_DeveloperAccess_abc/alice@company.com` → alicecompanycom
   - Regular assumed-role: `arn:aws:sts::123456789012:assumed-role/AdminRole/session123` → session123
   - Federated user: `arn:aws:sts::123456789012:federated-user/alice` → alice
   - Root user: `arn:aws:iam::123456789012:root` → root
   - GovCloud partition: `arn:aws-us-gov:iam::123456789012:user/alice` → alice
   - China partition: `arn:aws-cn:iam::123456789012:user/alice` → alice

2. **TestParseARN_Errors** with cases:
   - Empty ARN
   - Invalid format (missing parts)
   - Invalid partition
   - Unknown resource type

3. **TestExtractUsername** as convenience function tests

4. **TestIdentityType** verifying correct type detection for each ARN pattern

5. **TestSanitization** verifying:
   - Email addresses have @ and . removed
   - Special characters removed
   - Long usernames truncated to 20 chars

Security tests:
- Verify no username spoofing via crafted ARNs
- Verify @ in email is sanitized (not usable for injection)
  </action>
  <verify>go test ./identity/... -v passes all tests</verify>
  <done>All ARN parsing tests pass with >95% coverage on new code</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./identity/...` succeeds
- [ ] `go test ./identity/...` passes all tests
- [ ] `go test ./identity/... -cover` shows >95% coverage on new code
- [ ] No new linting errors from `golangci-lint run ./identity/...`
</verification>

<success_criteria>
- All tasks completed
- AWSIdentity type handles all 6 ARN patterns correctly
- Tests cover edge cases (paths, emails, special chars)
- No security vulnerabilities in parsing logic
- Clean integration with existing identity package
</success_criteria>

<output>
After completion, create `.planning/phases/69-aws-identity-core/69-01-SUMMARY.md`
</output>
