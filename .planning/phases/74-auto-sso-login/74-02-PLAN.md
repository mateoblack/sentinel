---
phase: 74-auto-sso-login
plan: 02
type: execute
wave: 2
depends_on: ["74-01"]
files_modified: [sso/retry.go, sso/retry_test.go, cli/credentials.go, cli/credentials_test.go, cli/sentinel_exec.go]
autonomous: true
---

<objective>
Integrate auto-login into Sentinel commands.

Purpose: Automatically trigger SSO login when credential errors occur, providing seamless UX for SSO users.
Output: credentials and exec commands automatically prompt for SSO login on expired/missing tokens.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan outputs (SSO error detection and login trigger)
@.planning/phases/74-auto-sso-login/74-01-SUMMARY.md

# Commands to modify
@cli/credentials.go
@cli/sentinel_exec.go

# Profile config for SSO detection
@vault/config.go

# Existing error handling patterns
@cli/errors.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auto-login retry wrapper</name>
  <files>sso/retry.go, sso/retry_test.go</files>
  <action>
Create `sso/retry.go` with:

1. `AutoLoginConfig` struct:
```go
type AutoLoginConfig struct {
    ProfileName string              // Profile to check for SSO config
    ConfigFile  *vault.ConfigFile   // AWS config file for profile lookup
    Keyring     keyring.Keyring     // For storing refreshed OIDC token
    UseStdout   bool                // Print URL instead of opening browser
    Stderr      io.Writer           // For user messages (default os.Stderr)
}
```

2. `WithAutoLogin[T any](ctx context.Context, config AutoLoginConfig, fn func() (T, error)) (T, error)`:
   - Execute fn()
   - If error is nil, return result
   - If error and IsSSOCredentialError returns false, return error
   - If SSO error:
     a. Load profile config to get SSOStartURL and SSORegion
     b. If profile has no SSO config, return original error (can't auto-login)
     c. Print message to stderr: "SSO credentials expired. Initiating login..."
     d. Call TriggerSSOLogin with profile's SSO config
     e. If login fails, return login error wrapped with original error
     f. Store new OIDC token in keyring (OIDCTokenKeyring pattern)
     g. Retry fn() once
     h. Return retry result (success or failure)

3. Helper `GetSSOConfigForProfile(configFile *vault.ConfigFile, profileName string) (*SSOLoginConfig, error)`:
   - Load profile config
   - Return nil if profile doesn't have SSOStartURL
   - Return SSOLoginConfig with StartURL, Region from profile

Tests in `sso/retry_test.go`:
- Test successful operation (no retry needed)
- Test non-SSO error (returns immediately)
- Test SSO error with successful retry after login
- Test SSO error on non-SSO profile (returns original error)
- Test login failure (returns wrapped error)
  </action>
  <verify>go test ./sso/... -v -run TestWithAutoLogin</verify>
  <done>WithAutoLogin retries operations after SSO login for retriable errors</done>
</task>

<task type="auto">
  <name>Task 2: Integrate auto-login into credentials command</name>
  <files>cli/credentials.go, cli/credentials_test.go</files>
  <action>
Modify `cli/credentials.go`:

1. Add `AutoLogin bool` and `UseStdout bool` fields to `CredentialsCommandInput`

2. Add CLI flags in `ConfigureCredentialsCommand`:
   - `--auto-login` flag to enable automatic SSO login on credential errors
   - `--stdout` flag to print SSO URL instead of opening browser

3. In `CredentialsCommand`, wrap the AWS identity retrieval in auto-login:
   - After loading AWS config (step 2)
   - Before calling identity.GetAWSUsername (step 3)
   - Wrap like:
```go
if input.AutoLogin {
    autoConfig := sso.AutoLoginConfig{
        ProfileName: input.ProfileName,
        ConfigFile:  configFile, // Need to load this earlier
        Keyring:     keyringImpl,
        UseStdout:   input.UseStdout,
        Stderr:      stderr,
    }
    username, err = sso.WithAutoLogin(ctx, autoConfig, func() (string, error) {
        return identity.GetAWSUsername(ctx, stsClient)
    })
} else {
    username, err = identity.GetAWSUsername(ctx, stsClient)
}
```

4. Need to restructure command to load ConfigFile and Keyring earlier (before AWS config) for auto-login config

Update tests in `cli/credentials_test.go`:
- Test with --auto-login flag enabled
- Mock SSO error and verify login triggered
- Test without --auto-login (existing behavior unchanged)
  </action>
  <verify>go test ./cli/... -v -run TestCredentials</verify>
  <done>credentials command supports --auto-login flag for SSO re-authentication</done>
</task>

<task type="auto">
  <name>Task 3: Integrate auto-login into exec command</name>
  <files>cli/sentinel_exec.go</files>
  <action>
Modify `cli/sentinel_exec.go`:

1. Add `AutoLogin bool` and `UseStdout bool` fields to `SentinelExecCommandInput`

2. Add CLI flags in `ConfigureSentinelExecCommand`:
   - `--auto-login` flag to enable automatic SSO login
   - `--stdout` flag already exists in aws-vault exec pattern

3. In `SentinelExecCommand`, wrap AWS identity retrieval:
   - Same pattern as credentials command
   - After loading AWS config, before GetAWSUsername
   - Need to load ConfigFile and Keyring earlier

4. Ensure consistent behavior with credentials command:
   - Same flag names and behavior
   - Same error messages

Note: The exec command already has structured logging and error handling. Integrate auto-login without disrupting existing flow.

No new test file needed - existing tests cover base functionality. Add test case for auto-login path if time permits.
  </action>
  <verify>go build ./cli/... && go test ./cli/... -v -run TestSentinelExec</verify>
  <done>exec command supports --auto-login flag for SSO re-authentication</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `go test ./...` passes all tests
- [ ] `sentinel credentials --help` shows --auto-login flag
- [ ] `sentinel exec --help` shows --auto-login flag
- [ ] Auto-login triggers on SSO credential errors when flag enabled
- [ ] Non-SSO profiles work unchanged with --auto-login
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Both credentials and exec commands support --auto-login
- Auto-login only triggers for retriable SSO errors
- Non-SSO profiles unaffected
- User sees clear messaging during SSO login flow
</success_criteria>

<output>
After completion, create `.planning/phases/74-auto-sso-login/74-02-SUMMARY.md`
</output>
