---
phase: 74-auto-sso-login
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [sso/errors.go, sso/errors_test.go, sso/login.go, sso/login_test.go]
autonomous: true
---

<objective>
Create SSO error detection and login trigger infrastructure.

Purpose: Enable automatic SSO login by providing utilities to detect SSO credential errors and trigger the OIDC device authorization flow.
Output: `sso/` package with error classification and login manager functions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# SSO credential provider (existing implementation to learn from)
@vault/ssorolecredentialsprovider.go

# Existing error infrastructure
@errors/types.go

# Profile config with SSO fields
@vault/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SSO error classification utilities</name>
  <files>sso/errors.go, sso/errors_test.go</files>
  <action>
Create `sso/errors.go` with:

1. `SSOErrorType` enum:
   - `SSOErrorTypeNone` - not an SSO error
   - `SSOErrorTypeExpiredToken` - OIDC token expired
   - `SSOErrorTypeNoCredentials` - no cached credentials
   - `SSOErrorTypeInvalidToken` - token rejected by AWS
   - `SSOErrorTypeNetworkError` - SSO service unreachable

2. `ClassifySSOError(err error) SSOErrorType` function that examines error:
   - Check for `ssooidctypes.ExpiredTokenException` via errors.As
   - Check for `keyring.ErrKeyNotFound` (no cached token)
   - Check for HTTP 401 responses (invalid/expired access token)
   - Check for "The SSO session associated with this profile has expired" text
   - Check for "InvalidTokenException" in error message
   - Check for network errors (timeout, connection refused)

3. `IsSSOCredentialError(err error) bool` - returns true if error is SSO-related and retriable via login

4. Add error codes to `errors/types.go`:
   - `ErrCodeSSOExpiredToken = "SSO_EXPIRED_TOKEN"`
   - `ErrCodeSSONoCredentials = "SSO_NO_CREDENTIALS"`
   - `ErrCodeSSOInvalidToken = "SSO_INVALID_TOKEN"`

Tests in `sso/errors_test.go`:
- Test classification of various AWS SSO error types
- Test detection of ExpiredTokenException
- Test detection of keyring.ErrKeyNotFound
- Test non-SSO errors return SSOErrorTypeNone
  </action>
  <verify>go test ./sso/... -v -run TestClassify</verify>
  <done>IsSSOCredentialError correctly identifies retriable SSO errors</done>
</task>

<task type="auto">
  <name>Task 2: Create SSO login manager</name>
  <files>sso/login.go, sso/login_test.go</files>
  <action>
Create `sso/login.go` with:

1. `SSOLoginConfig` struct:
```go
type SSOLoginConfig struct {
    StartURL   string // SSO portal URL (from profile sso_start_url)
    Region     string // SSO region (from profile sso_region)
    UseStdout  bool   // Print URL instead of opening browser
}
```

2. `SSOLoginManager` struct with:
   - `OIDCClient *ssooidc.Client`
   - Methods mirroring `SSORoleCredentialsProvider.newOIDCToken()` logic

3. `TriggerSSOLogin(ctx context.Context, config SSOLoginConfig) error`:
   - Create OIDC client for SSO region
   - Call RegisterClient (client_name: "sentinel")
   - Call StartDeviceAuthorization with StartURL
   - Output verification URL to stderr (or stdout if UseStdout)
   - Open browser with open-golang (unless UseStdout)
   - Poll CreateToken with device code until success or timeout
   - Return nil on success, error on failure

4. `SSOLoginResult` struct with token expiration time for logging

The implementation should closely follow `vault/ssorolecredentialsprovider.go:139-202` but:
- Take SSOLoginConfig instead of using struct fields
- Return error instead of caching token (caching handled by caller)
- Use "sentinel" as client name instead of "aws-vault"

Tests in `sso/login_test.go`:
- Mock OIDC client interface for testing
- Test successful login flow (mock AuthorizationPending then success)
- Test timeout handling
- Test SlowDownException handling
  </action>
  <verify>go test ./sso/... -v -run TestTrigger</verify>
  <done>TriggerSSOLogin can complete the OIDC device authorization flow</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `go test ./sso/...` passes all tests
- [ ] No new linter warnings: `golangci-lint run ./sso/...`
- [ ] IsSSOCredentialError detects expired/missing SSO tokens
- [ ] TriggerSSOLogin implements OIDC device authorization flow
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- sso/ package exports IsSSOCredentialError and TriggerSSOLogin
- Error classification matches AWS SDK error types
- Login flow follows RFC 8628 device authorization pattern
</success_criteria>

<output>
After completion, create `.planning/phases/74-auto-sso-login/74-01-SUMMARY.md`
</output>
