---
phase: 71-whoami-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [cli/whoami.go, cli/whoami_test.go]
autonomous: true
---

<objective>
Add `sentinel whoami` command showing AWS identity and extracted policy username.

Purpose: Provide users visibility into their AWS identity and how Sentinel interprets it for policy evaluation. Essential for debugging policy matching issues.

Output: New `sentinel whoami` command with human and JSON output formats.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 69 and 70 summaries - AWS identity extraction foundation
@.planning/phases/69-aws-identity-core/69-01-SUMMARY.md
@.planning/phases/70-identity-integration/70-01-SUMMARY.md

# Identity package with GetAWSIdentity
@identity/aws_identity.go

# CLI patterns to follow
@cli/status.go
@cli/sentinel.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create whoami command with AWS identity display</name>
  <files>cli/whoami.go</files>
  <action>
Create `cli/whoami.go` following the status.go pattern:

1. **WhoamiCommandInput struct**:
```go
type WhoamiCommandInput struct {
    Region     string
    JSONOutput bool

    // STSClient is an optional STS client for testing.
    // If nil, a new client will be created from AWS config.
    STSClient identity.STSAPI

    // Stdout is an optional writer for output (for testing).
    Stdout *os.File

    // Stderr is an optional writer for errors (for testing).
    Stderr *os.File
}
```

2. **WhoamiResult struct** for JSON output:
```go
type WhoamiResult struct {
    ARN         string `json:"arn"`
    AccountID   string `json:"account_id"`
    IdentityType string `json:"identity_type"`
    RawUsername string `json:"raw_username"`
    PolicyUsername string `json:"policy_username"`
}
```

3. **ConfigureWhoamiCommand function**:
- Register as top-level command: `app.Command("whoami", "Show current AWS identity and policy username")`
- Add `--region` flag for AWS region
- Add `--json` flag for JSON output
- Wire to WhoamiCommand

4. **WhoamiCommand function**:
- Create STS client if not provided (follow status.go AWS config pattern)
- Call `identity.GetAWSIdentity(ctx, stsClient)`
- On error: display helpful error message using FormatErrorWithSuggestionTo
- Build WhoamiResult from AWSIdentity

5. **Human output format**:
```
AWS Identity
============

ARN:            arn:aws:sts::123456789012:assumed-role/MyRole/alice@example.com
Account:        123456789012
Identity Type:  assumed-role
Raw Username:   alice@example.com
Policy Username: aliceexamplecom

The policy username is used for matching against Sentinel policy rules.
```

6. **JSON output format**:
```json
{
  "arn": "arn:aws:sts::123456789012:assumed-role/MyRole/alice@example.com",
  "account_id": "123456789012",
  "identity_type": "assumed-role",
  "raw_username": "alice@example.com",
  "policy_username": "aliceexamplecom"
}
```

Import identity package and use existing STSAPI interface for testability.
  </action>
  <verify>go build ./cli/... succeeds</verify>
  <done>whoami command registered and builds without errors</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for whoami command</name>
  <files>cli/whoami_test.go</files>
  <action>
Create `cli/whoami_test.go` with table-driven tests:

1. **Mock STS client** (reuse pattern from identity tests):
```go
type mockSTSClient struct {
    GetCallerIdentityFunc func(ctx context.Context, params *sts.GetCallerIdentityInput, optFns ...func(*sts.Options)) (*sts.GetCallerIdentityOutput, error)
}
```

2. **TestWhoamiCommand** with test cases:
   - IAM user: `arn:aws:iam::123456789012:user/alice` → raw_username: alice, policy_username: alice
   - Assumed role with email: `arn:aws:sts::123456789012:assumed-role/SSO/bob@company.com` → raw_username: bob@company.com, policy_username: bobcompanycom
   - Federated user: `arn:aws:sts::123456789012:federated-user/carol` → identity_type: federated-user
   - Root user: `arn:aws:iam::123456789012:root` → identity_type: root

3. **TestWhoamiCommand_Errors** with test cases:
   - STS API error (simulate access denied)
   - Empty ARN returned
   - Invalid ARN format

4. **TestWhoamiCommand_JSONOutput**:
   - Verify JSON output is valid JSON
   - Verify all fields present
   - Verify values match expected

5. **Output capture**:
   - Use bytes.Buffer or temp file for stdout capture
   - Verify human output format contains expected strings
   - Verify JSON output unmarshals correctly

Use `testing` package and follow existing cli/status_test.go patterns.
  </action>
  <verify>go test ./cli/... -run "Whoami" -v passes all tests</verify>
  <done>All whoami tests pass with good coverage of identity types and error cases</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `go test ./cli/... -run "Whoami"` passes all tests
- [ ] `golangci-lint run ./cli/whoami.go ./cli/whoami_test.go` shows no errors
- [ ] Human output format is clear and matches specification
- [ ] JSON output is valid and contains all fields
</verification>

<success_criteria>
- All tasks completed
- `sentinel whoami` command works with real AWS credentials
- Human and JSON output formats implemented
- Tests cover all identity types (user, assumed-role, federated-user, root)
- Error cases properly handled with helpful messages
</success_criteria>

<output>
After completion, create `.planning/phases/71-whoami-command/71-01-SUMMARY.md`
</output>
