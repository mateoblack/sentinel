---
phase: 51-policy-engine-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [policy/loader_test.go]
autonomous: true
---

<objective>
Add comprehensive tests for SSM-based policy loading to fill the 0% coverage gap.

Purpose: The Loader.Load function has 0% test coverage because it requires SSM integration. Using MockSSMClient from testutil, we can test all code paths including error handling.
Output: policy/loader_test.go with tests achieving >90% coverage for loader.go
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-test-infrastructure/50-02-SUMMARY.md

@policy/loader.go
@policy/loader_test.go
@testutil/mock_aws.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SSM loader tests with MockSSMClient</name>
  <files>policy/loader_test.go</files>
  <action>
Add comprehensive tests for the Loader type using testutil.MockSSMClient:

1. TestLoader_Load_Success - Successfully loads and parses policy from SSM:
   - Configure MockSSMClient.GetParameterFunc to return valid policy YAML
   - Call Load() and verify the returned policy matches expected structure
   - Verify GetParameterInput had correct Name and WithDecryption=true

2. TestLoader_Load_ParameterNotFound - Returns wrapped ErrPolicyNotFound:
   - Configure MockSSMClient.GetParameterFunc to return ssm types.ParameterNotFound error
   - Call Load() and verify error wraps ErrPolicyNotFound using errors.Is()
   - Verify error message includes parameter name

3. TestLoader_Load_GenericSSMError - Returns wrapped SSM error:
   - Configure MockSSMClient.GetParameterFunc to return generic error
   - Call Load() and verify error message includes "ssm GetParameter"
   - Verify original error is accessible via errors.Unwrap()

4. TestLoader_Load_InvalidYAML - Returns parse error for malformed policy:
   - Configure MockSSMClient.GetParameterFunc to return invalid YAML content
   - Call Load() and verify error is returned (parse failure)

5. TestNewLoader - Verify Loader creation:
   - Call NewLoader with aws.Config and verify returned loader is non-nil

The tests need to work around the fact that Loader.client is private - either:
- Add a package-level function that accepts an ssmAPI interface (like bootstrap does)
- Or create a new constructor that accepts an interface for testing
- Prefer the interface approach following the pattern in bootstrap/planner.go

Check bootstrap/planner.go for the ssmAPI interface pattern - the Loader should follow the same pattern to enable testing.
  </action>
  <verify>go test -v -cover ./policy/... -run TestLoader</verify>
  <done>Loader.Load has >90% coverage, all test cases pass</done>
</task>

<task type="auto">
  <name>Task 2: Add interface-based loader for testability</name>
  <files>policy/loader.go, policy/loader_test.go</files>
  <action>
If not already testable, refactor Loader to accept an interface for SSM operations:

1. Define ssmAPI interface in loader.go (if needed):
```go
type ssmAPI interface {
    GetParameter(ctx context.Context, params *ssm.GetParameterInput, optFns ...func(*ssm.Options)) (*ssm.GetParameterOutput, error)
}
```

2. Update Loader struct to use interface internally (client field type)

3. Add NewLoaderWithClient constructor for testing:
```go
func NewLoaderWithClient(client ssmAPI) *Loader {
    return &Loader{client: client}
}
```

4. Ensure NewLoader still works by creating ssm.Client from config

5. Update tests to use NewLoaderWithClient with MockSSMClient

This follows the established pattern from notification/sns.go and bootstrap/planner.go.
  </action>
  <verify>go test -v -cover ./policy/... -run TestLoader && go build ./...</verify>
  <done>Loader accepts interface for testing, existing code unchanged, >90% coverage</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test -cover ./policy/...` shows loader.go at >90% coverage
- [ ] `go build ./...` succeeds without errors
- [ ] All new tests pass
- [ ] Existing tests still pass
</verification>

<success_criteria>

- All tasks completed
- Loader.Load function tested via MockSSMClient
- Error paths tested (ParameterNotFound, generic errors, parse errors)
- Coverage for loader.go increased from 0% to >90%
</success_criteria>

<output>
After completion, create `.planning/phases/51-policy-engine-testing/51-01-SUMMARY.md`
</output>
