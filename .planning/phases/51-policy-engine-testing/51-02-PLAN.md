---
phase: 51-policy-engine-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [policy/evaluate_test.go, policy/cache_test.go]
autonomous: true
---

<objective>
Fill coverage gaps for weekday conversion, hour parsing, and cache error paths.

Purpose: Raise policy package coverage from 92.3% to >95% by testing edge cases in goWeekdayToWeekday (44.4%), parseHourMinute (83.3%), and cache.Load (92.9%).
Output: Additional tests in evaluate_test.go and cache_test.go achieving comprehensive coverage
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@policy/evaluate.go
@policy/evaluate_test.go
@policy/cache.go
@policy/cache_test.go
@testutil/mock_stores.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add weekday conversion tests for full coverage</name>
  <files>policy/evaluate_test.go</files>
  <action>
Add tests for goWeekdayToWeekday to achieve 100% coverage (currently 44.4%):

1. TestGoWeekdayToWeekday_AllDays - Table-driven test covering all 7 days:
   - time.Sunday → Sunday
   - time.Monday → Monday
   - time.Tuesday → Tuesday
   - time.Wednesday → Wednesday
   - time.Thursday → Thursday
   - time.Friday → Friday
   - time.Saturday → Saturday

2. Test that an invalid weekday value returns empty string (the default case)

Current test coverage likely only tests Monday-Friday (5/9 = ~44%). The function has 9 cases (7 days + 1 default), so all must be exercised.

Add tests to the existing evaluate_test.go file, following the table-driven pattern already used.
  </action>
  <verify>go test -v -cover ./policy/... -run TestGoWeekdayToWeekday</verify>
  <done>goWeekdayToWeekday at 100% coverage, all 7 days tested plus default case</done>
</task>

<task type="auto">
  <name>Task 2: Add hour parsing edge case tests</name>
  <files>policy/evaluate_test.go</files>
  <action>
Add tests for parseHourMinute edge cases (currently 83.3%):

1. TestParseHourMinute_EdgeCases - Test the missing path:
   - Normal case: "09:00" → hour=9, minute=0
   - Normal case: "17:30" → hour=17, minute=30
   - Edge case: Invalid format without colon returns (0, 0)
   - The missing 16.7% is likely the `len(parts) != 2` return path

2. Ensure empty string input is tested
3. Ensure string without colon is tested (e.g., "0900")
4. Ensure string with multiple colons is tested (e.g., "09:00:00")

Note: parseHourMinute is a private function. Test it indirectly via matchesHours by providing HourRange with edge-case inputs, or make a simple wrapper test if the function is exported (check current access level).
  </action>
  <verify>go test -v -cover ./policy/... -run TestParseHourMinute</verify>
  <done>parseHourMinute at 100% coverage, edge cases tested</done>
</task>

<task type="auto">
  <name>Task 3: Add cache error path tests</name>
  <files>policy/cache_test.go</files>
  <action>
Add tests for CachedLoader.Load error handling (currently 92.9%):

1. TestCachedLoader_Load_UnderlyingError - Test error propagation:
   - Create CachedLoader with a MockPolicyLoader that returns an error
   - Call Load() and verify error is propagated correctly
   - Verify cache is NOT populated on error

2. TestCachedLoader_Load_CacheInvalidation - If applicable, test:
   - First call succeeds and caches
   - Underlying loader behavior changes
   - After TTL, second call uses underlying loader

3. Review cache.go to identify the uncovered 7.1% path and add test for it:
   - Likely the error return path in Line 46 area
   - May be the "cache miss then load fails" path

Use testutil.MockPolicyLoader which has LoadFunc field for configurable behavior.
  </action>
  <verify>go test -v -cover ./policy/... -run TestCachedLoader</verify>
  <done>cache.Load at 100% coverage, error paths tested</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test -cover ./policy/...` shows >95% overall coverage
- [ ] goWeekdayToWeekday at 100% (all weekdays tested)
- [ ] parseHourMinute at 100% (edge cases tested)
- [ ] cache.Load at 100% (error paths tested)
- [ ] All tests pass
</verification>

<success_criteria>

- All tasks completed
- Policy package coverage >95%
- All edge cases for time/day parsing tested
- Cache error handling fully tested
</success_criteria>

<output>
After completion, create `.planning/phases/51-policy-engine-testing/51-02-SUMMARY.md`
</output>
