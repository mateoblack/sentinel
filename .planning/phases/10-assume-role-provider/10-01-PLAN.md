---
phase: 10-assume-role-provider
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sentinel/assume_role.go
  - sentinel/assume_role_test.go
autonomous: true
---

<objective>
Create Sentinel's AssumeRole provider that stamps SourceIdentity on STS AssumeRole calls.

Purpose: Enable Sentinel to control the SourceIdentity stamp on all credentials it issues, making access decisions visible and enforceable inside AWS. This is the core mechanism for v1.1 Sentinel Fingerprint.

Output: `sentinel/assume_role.go` with SentinelAssumeRole function and comprehensive tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-source-identity-schema/09-01-SUMMARY.md

# Reference patterns:
@vault/assumeroleprovider.go
@vault/vault.go

# Use SourceIdentity from Phase 9:
@identity/types.go
@identity/request_id.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SentinelAssumeRole types and function</name>
  <files>sentinel/assume_role.go</files>
  <action>
Create sentinel/assume_role.go with:

1. Package sentinel (create new package if needed)

2. SentinelAssumeRoleInput struct:
   - CredsProvider aws.CredentialsProvider (base credentials from aws-vault)
   - RoleARN string (required - role to assume)
   - RoleSessionName string (optional - defaults to sentinel-{timestamp})
   - Duration time.Duration (optional - defaults to 1 hour)
   - SourceIdentity *identity.SourceIdentity (required - from identity package)
   - Region string (for STS endpoint)
   - STSRegionalEndpoints string (optional - legacy vs regional)
   - ExternalID string (optional - for cross-account)

3. SentinelAssumeRoleOutput struct:
   - Credentials aws.Credentials
   - SourceIdentity string (the stamped value)
   - AssumedRoleArn string
   - AssumedRoleId string

4. SentinelAssumeRole function:
   - Validates input (RoleARN required, SourceIdentity required and valid)
   - Creates STS client using vault.NewAwsConfigWithCredsProvider pattern
   - Builds sts.AssumeRoleInput with SourceIdentity.Format()
   - Calls StsClient.AssumeRole
   - Returns SentinelAssumeRoleOutput with credentials and metadata

Follow vault/assumeroleprovider.go patterns for STS client creation and error handling.
Do NOT include MFA handling - Sentinel assumes base credentials already have MFA if needed.
  </action>
  <verify>go build ./sentinel/... compiles without errors</verify>
  <done>SentinelAssumeRole function exists and compiles</done>
</task>

<task type="auto">
  <name>Task 2: Add validation and error handling</name>
  <files>sentinel/assume_role.go</files>
  <action>
Add input validation to SentinelAssumeRole:

1. Define sentinel errors:
   - ErrMissingRoleARN = errors.New("RoleARN is required")
   - ErrMissingSourceIdentity = errors.New("SourceIdentity is required")
   - ErrMissingCredsProvider = errors.New("CredsProvider is required")

2. Validate before STS call:
   - CredsProvider != nil
   - RoleARN != ""
   - SourceIdentity != nil && SourceIdentity.IsValid()

3. Set defaults:
   - RoleSessionName: if empty, use fmt.Sprintf("sentinel-%d", time.Now().UTC().UnixNano())
   - Duration: if zero, use 1 hour (match aws-vault default)

4. Wrap STS errors with context:
   - Return fmt.Errorf("failed to assume role %s: %w", input.RoleARN, err)

5. Log the assumption (following vault pattern):
   - log.Printf("Assumed role %s with SourceIdentity %s, expires in %s", ...)
  </action>
  <verify>go build ./sentinel/... compiles without errors</verify>
  <done>Input validation rejects invalid inputs with clear errors</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for SentinelAssumeRole</name>
  <files>sentinel/assume_role_test.go</files>
  <action>
Create sentinel/assume_role_test.go with table-driven tests:

1. TestSentinelAssumeRoleValidation:
   - Test missing RoleARN returns ErrMissingRoleARN
   - Test missing SourceIdentity returns ErrMissingSourceIdentity
   - Test missing CredsProvider returns ErrMissingCredsProvider
   - Test invalid SourceIdentity (e.g., empty user) returns validation error

2. TestSentinelAssumeRoleDefaults:
   - Test default RoleSessionName starts with "sentinel-"
   - Test default Duration is 1 hour

3. TestSentinelAssumeRoleInput (integration-style, may need mock):
   - Verify AssumeRoleInput is built correctly with SourceIdentity.Format()
   - Check all optional fields are passed through when provided

Use identity.New() and identity.NewRequestID() to create test SourceIdentity values.
Follow testing patterns from identity/types_test.go (table-driven, descriptive names).

Note: Full STS integration test will be in Phase 17. Unit tests focus on input validation and struct building.
  </action>
  <verify>go test ./sentinel/... -v passes</verify>
  <done>All validation tests pass, test coverage for input handling</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./sentinel/...` succeeds
- [ ] `go test ./sentinel/...` passes all tests
- [ ] `go vet ./sentinel/...` reports no issues
- [ ] SentinelAssumeRole accepts valid input and rejects invalid input
</verification>

<success_criteria>

- SentinelAssumeRole function created with proper validation
- Function stamps SourceIdentity on AssumeRole calls
- Unit tests cover validation edge cases
- Code follows existing vault/ patterns
- Package compiles and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-assume-role-provider/10-01-SUMMARY.md`
</output>
