---
phase: 82-server-mode-enforcement
plan: 02
type: execute
wave: 2
depends_on: ["82-01"]
files_modified: [cli/credentials.go, cli/sentinel_exec.go, docs/guide/policy-reference.md]
autonomous: true
---

<objective>
Integrate require_server denial handling in CLI commands and document the new effect.

Purpose: Provide clear error messages when require_server denies access and document the feature for users.
Output: CLI commands show actionable error message; policy-reference.md documents require_server effect.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/82-server-mode-enforcement/82-01-SUMMARY.md

# Key source files
@cli/credentials.go
@cli/sentinel_exec.go
@docs/guide/policy-reference.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add require_server error handling to credentials command</name>
  <files>cli/credentials.go</files>
  <action>
After policy evaluation in CredentialsCommand, check for RequiresServerMode flag on denial:

Find the existing deny handling code block (after `decision := policy.Evaluate(...)`) and add a check for the RequiresServerMode flag:

```go
if decision.Effect == policy.EffectDeny {
    // Check if denial is due to server mode requirement
    if decision.RequiresServerMode {
        return nil, fmt.Errorf("policy requires server mode for profile %q - use 'sentinel exec --server %s -- <command>' for real-time revocation control", input.ProfileName, input.ProfileName)
    }
    // ... existing deny handling
}
```

This provides an actionable error message that tells the user exactly how to use server mode.

The error message should appear BEFORE any check for approved requests or break-glass, as require_server is an explicit policy choice that shouldn't be bypassed by those mechanisms.
  </action>
  <verify>grep -n "RequiresServerMode" cli/credentials.go shows the error handling</verify>
  <done>credentials command shows actionable error for require_server denial</done>
</task>

<task type="auto">
  <name>Task 2: Add require_server error handling to exec command</name>
  <files>cli/sentinel_exec.go</files>
  <action>
Add the same require_server error handling to the sentinel exec command (non-server path).

Find the deny handling code block after policy evaluation and add:

```go
if decision.Effect == policy.EffectDeny {
    // Check if denial is due to server mode requirement
    if decision.RequiresServerMode {
        return fmt.Errorf("policy requires server mode for profile %q - add '--server' flag for real-time revocation control", input.ProfileName)
    }
    // ... existing deny handling
}
```

The exec command error message should suggest adding --server flag since the user is already using exec.
  </action>
  <verify>grep -n "RequiresServerMode" cli/sentinel_exec.go shows the error handling</verify>
  <done>exec command shows actionable error for require_server denial</done>
</task>

<task type="auto">
  <name>Task 3: Document require_server effect in policy reference</name>
  <files>docs/guide/policy-reference.md</files>
  <action>
Update the Effects table to include require_server:

In the Effects section (after the schema), update the table:

```markdown
### Effects

| Effect | Description |
|--------|-------------|
| `allow` | Grant access - issue credentials |
| `deny` | Reject access - no credentials issued |
| `require_approval` | Request must be approved before access |
| `require_server` | Grant access only via server mode (`sentinel exec --server`) |
```

Add a new section after the Effects table explaining require_server:

```markdown
### require_server Effect

The `require_server` effect enforces server mode for credential delivery. This is the recommended pattern for sensitive profiles requiring:

- **Instant revocation**: Server mode evaluates policy per-request, so policy changes take effect immediately
- **Per-request audit**: Every credential fetch is logged with policy decision
- **Short-lived credentials**: Server mode enforces shorter credential TTLs (default 15 minutes)

**Example:**

```yaml
version: "1"
rules:
  # Production requires server mode for instant revocation capability
  - name: prod-requires-server
    effect: require_server
    conditions:
      profiles: [production]
    reason: Production requires server mode for instant revocation

  # Development allows any mode
  - name: dev-allow
    effect: allow
    conditions:
      profiles: [development]
```

**Behavior:**

| Request Mode | Effect |
|--------------|--------|
| `sentinel exec --server prod -- aws s3 ls` | Allow |
| `sentinel exec prod -- aws s3 ls` | Deny with message: "policy requires server mode" |
| `sentinel credentials --profile prod` | Deny with message: "policy requires server mode" |

**Note:** `require_server` denials cannot be bypassed by approval workflows or break-glass. If you need emergency access that bypasses server mode, use a separate rule with `allow` effect that checks for break-glass context.
```

Place this section immediately after the Effects table, before the "Complete Example" section.
  </action>
  <verify>grep -n "require_server" docs/guide/policy-reference.md shows the documentation</verify>
  <done>policy-reference.md documents require_server effect with examples</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds without errors
- [ ] grep confirms RequiresServerMode handling in credentials.go and sentinel_exec.go
- [ ] policy-reference.md includes require_server in Effects table
- [ ] policy-reference.md has require_server explanation section
</verification>

<success_criteria>
- credentials command shows "policy requires server mode" with actionable guidance
- exec command shows "add '--server' flag" with actionable guidance
- policy-reference.md documents require_server effect with examples
- All builds pass
</success_criteria>

<output>
After completion, create `.planning/phases/82-server-mode-enforcement/82-02-SUMMARY.md`
</output>
