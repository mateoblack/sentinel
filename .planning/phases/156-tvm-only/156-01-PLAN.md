---
phase: 156-tvm-only
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [cli/sentinel_exec.go, cli/credentials.go, cli/commands.go, sentinel/server.go, sentinel/server_unix.go]
autonomous: false
---

<objective>
Remove classic mode and CLI server mode, making TVM/Lambda the only credential vending path.

Purpose: Client-side credential handling is fakeable. Server-side (TVM) is verified. We don't ship fakeable security.
Output: Sentinel requires --remote-server for all credential operations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key files to understand:
@cli/sentinel_exec.go (main exec command with classic/server/remote modes)
@cli/credentials.go (credential_process command - to be removed)
@cli/commands.go (command registration)
@sentinel/server.go (local metadata server - to be removed)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove credentials command</name>
  <files>cli/credentials.go, cli/commands.go, main.go</files>
  <action>
1. Delete cli/credentials.go entirely (credential_process integration is fakeable)
2. Remove credentials command registration from cli/commands.go (ConfigureCredentialsCommand)
3. Update any imports or references in main.go
4. The `sentinel credentials` command should no longer exist

Rationale: credential_process outputs credentials to stdout where they can be captured, cached, and reused. This bypasses policy on subsequent uses.
  </action>
  <verify>go build ./... && ./sentinel credentials --help 2>&1 | grep -i "unknown\|not found\|error"</verify>
  <done>sentinel credentials command no longer exists, build succeeds</done>
</task>

<task type="auto">
  <name>Task 2: Remove classic mode from exec command</name>
  <files>cli/sentinel_exec.go</files>
  <action>
Remove the classic credential injection path (lines ~575-661):

1. Remove the code block that:
   - Calls GetCredentialsWithSourceIdentity() to fetch credentials once
   - Sets AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_SESSION_TOKEN in environment
   - Calls doExecSyscall or runSubProcess with injected credentials

2. After removal, if --remote-server is not set, return an error:
   "sentinel exec requires --remote-server. Classic mode (direct credential injection) has been removed. Deploy the Lambda TVM and use --remote-server <url>"

3. Keep the --remote-server code path (lines ~191-238) intact - this is the TVM mode we're keeping.

4. Remove now-unused flags: --mfa-token, --credential-profile, --pass-session-duration (these were for classic mode credential fetching)
  </action>
  <verify>go build ./... && ./sentinel exec staging -- echo test 2>&1 | grep -i "remote-server"</verify>
  <done>exec without --remote-server fails with clear error message requiring TVM</done>
</task>

<task type="auto">
  <name>Task 3: Remove CLI server mode from exec command</name>
  <files>cli/sentinel_exec.go</files>
  <action>
Remove the --server mode (lines ~462-572):

1. Remove flags: --server, --lazy, --session-table, --server-port
2. Remove the StartServer code path that creates a local SentinelServer
3. Remove the credentialProviderAdapter struct and related code

Rationale: Local server mode is client-side - user controls the server. TVM mode puts the trust boundary in AWS infrastructure.

After removal, exec should only work with --remote-server.
  </action>
  <verify>go build ./... && ./sentinel exec --help 2>&1 | grep -v "\-\-server"</verify>
  <done>--server flag no longer exists</done>
</task>

<task type="auto">
  <name>Task 4: Remove or deprecate local server packages</name>
  <files>sentinel/server.go, sentinel/server_unix.go, sentinel/server_test.go</files>
  <action>
Two options - choose deprecation for safer rollout:

OPTION A (Aggressive): Delete sentinel/server.go and sentinel/server_unix.go entirely
OPTION B (Recommended): Mark as deprecated with clear error if instantiated

Implement Option B:
1. Add deprecation notice at top of sentinel/server.go
2. Modify NewSentinelServer() to return error: "SentinelServer is deprecated in v2.1. Use Lambda TVM (--remote-server) instead."
3. Keep the code so dependent tests can be updated incrementally
4. Update tests to expect deprecation error or skip server tests

This allows a cleaner migration path - tests can be updated in a follow-up.
  </action>
  <verify>go build ./... && go test ./sentinel/... -v 2>&1 | head -50</verify>
  <done>sentinel/server.go marked deprecated, build passes</done>
</task>

<task type="auto">
  <name>Task 5: Update error messages and help text</name>
  <files>cli/sentinel_exec.go, cli/help.go</files>
  <action>
1. Update exec command help text to emphasize TVM requirement:
   "sentinel exec requires a Lambda TVM endpoint. Use --remote-server <url> to connect to your deployed TVM."

2. Add helpful error message when --remote-server is missing:
   ```
   Error: sentinel exec requires --remote-server <url>

   Classic mode has been removed in v2.1. Sentinel now requires server-side
   credential vending through Lambda TVM for verified security.

   To set up TVM:
   1. Deploy the Lambda TVM: sentinel tvm deploy --region us-east-1
   2. Configure your profile: sentinel config set tvm-url <url>
   3. Run: sentinel exec --remote-server <url> <profile> -- <command>

   See: https://github.com/avishayil/sentinel/docs/TVM_SETUP.md
   ```

3. Remove references to --server and credential_process from help text
  </action>
  <verify>./sentinel exec --help 2>&1 | grep -i "remote-server"</verify>
  <done>Help text reflects TVM-only operation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Removed classic mode and CLI server mode, making TVM mandatory</what-built>
  <how-to-verify>
    1. Build: go build -o sentinel .
    2. Verify credentials command removed:
       ./sentinel credentials --help
       Should show "unknown command" or similar error
    3. Verify exec requires --remote-server:
       ./sentinel exec staging -- echo test
       Should show error requiring --remote-server
    4. Verify --server flag removed:
       ./sentinel exec --server staging -- echo test
       Should show "unknown flag" error
    5. Verify --remote-server still works (if you have TVM deployed):
       ./sentinel exec --remote-server https://your-tvm.lambda-url.us-east-1.on.aws staging -- aws sts get-caller-identity
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go build ./... succeeds
- [ ] go test ./... passes (or known test failures documented)
- [ ] sentinel credentials command does not exist
- [ ] sentinel exec without --remote-server fails with helpful error
- [ ] sentinel exec --server flag does not exist
- [ ] Help text reflects TVM-only operation
</verification>

<success_criteria>
- All tasks completed
- Classic mode completely removed
- CLI server mode completely removed
- TVM (--remote-server) is the only credential vending path
- Clear error messages guide users to TVM setup
</success_criteria>

<output>
After completion, create `.planning/phases/156-tvm-only/156-01-SUMMARY.md`
</output>
