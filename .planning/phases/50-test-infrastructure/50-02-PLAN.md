---
phase: 50-test-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [testutil/mock_aws.go, testutil/mock_stores.go, testutil/helpers.go, testutil/doc.go]
autonomous: true
---

<objective>
Create reusable mock framework and test helpers for consistent testing patterns.

Purpose: Reduce test boilerplate and establish consistent mocking patterns across all packages, enabling faster test development in subsequent phases.
Output: testutil package with AWS service mocks, store mocks, and common test helpers.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bootstrap/planner_test.go
@notification/sns_test.go
@breakglass/dynamodb_test.go
@enforce/advisor_test.go
@audit/verifier_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create testutil package with AWS service mocks</name>
  <files>testutil/doc.go, testutil/mock_aws.go</files>
  <action>
Create the testutil package with reusable AWS service mocks.

testutil/doc.go:
```go
// Package testutil provides reusable test utilities, mock implementations,
// and helper functions for testing Sentinel components.
package testutil
```

testutil/mock_aws.go:
Consolidate common AWS service mock patterns from existing tests. Create configurable mocks for:

1. MockSSMClient - for SSM Parameter Store operations
   - GetParameter(ctx, input) with configurable responses/errors
   - GetParametersByPath(ctx, input) with configurable responses/errors
   - PutParameter(ctx, input) with configurable responses/errors

2. MockDynamoDBClient - for DynamoDB operations
   - PutItem, GetItem, DeleteItem, Query, UpdateItem
   - Configurable responses and error injection

3. MockSNSClient - for SNS notifications
   - Publish(ctx, input) with configurable responses/errors
   - Track published messages for assertions

4. MockSTSClient - for STS operations
   - AssumeRole(ctx, input) with configurable responses/errors
   - GetCallerIdentity(ctx, input) with configurable responses

5. MockIAMClient - for IAM operations
   - GetRole(ctx, input) with configurable responses/errors

6. MockCloudTrailClient - for CloudTrail queries
   - LookupEvents(ctx, input) with configurable responses/errors

Pattern: Each mock should:
- Embed function fields for configurable behavior (like existing mocks)
- Track call counts and arguments for assertions
- Have sensible defaults that return empty/success responses

Follow existing patterns from enforce/advisor_test.go and audit/verifier_test.go.
  </action>
  <verify>go build ./testutil compiles without errors</verify>
  <done>testutil/mock_aws.go contains all AWS service mocks that compile</done>
</task>

<task type="auto">
  <name>Task 2: Create store mocks for Sentinel services</name>
  <files>testutil/mock_stores.go</files>
  <action>
Create testutil/mock_stores.go with reusable store mocks:

1. MockRequestStore - implements request.Store interface
   - Create, Get, Update, Delete, ListByRequester, ListByStatus, ListByProfile
   - Configurable responses and in-memory storage for stateful tests

2. MockBreakGlassStore - implements breakglass.Store interface
   - Create, Get, Update, Close operations
   - FindActiveByInvokerAndProfile
   - ListActive, ListByInvoker, ListByProfile

3. MockPolicyLoader - implements policy.Loader interface
   - Load(profile) with configurable policy responses

4. MockNotifier - implements notification.Notifier interface
   - Notify(ctx, event) with call tracking

5. MockLogger - for audit logging
   - LogDecision, LogApproval, LogBreakGlass with call tracking

Each mock should:
- Have a Calls field to track method invocations
- Support error injection via Err fields
- Support response configuration via Result/Response fields

Follow existing patterns from cli/request_test.go and cli/breakglass_test.go.
  </action>
  <verify>go build ./testutil compiles without errors</verify>
  <done>testutil/mock_stores.go contains store mocks matching existing interfaces</done>
</task>

<task type="auto">
  <name>Task 3: Create test helper functions</name>
  <files>testutil/helpers.go</files>
  <action>
Create testutil/helpers.go with common test helper functions:

1. Time helpers:
   - MustParseTime(layout, value string) time.Time - panics on error, useful for test data
   - FixedClock(t time.Time) func() time.Time - returns a function that always returns t

2. Policy helpers:
   - MakeAllowPolicy(profile string) *policy.Policy - creates simple allow policy for profile
   - MakeDenyPolicy(profile string) *policy.Policy - creates simple deny policy for profile
   - MakeRequireApprovalPolicy(profile string) *policy.Policy - creates require-approval policy

3. Request helpers:
   - MakeRequest(user, profile string) *request.Request - creates test request with defaults
   - MakeApprovedRequest(user, profile string) *request.Request - creates approved request

4. Credential helpers:
   - MakeCredentials() aws.Credentials - creates test credentials with reasonable defaults
   - MakeExpiredCredentials() aws.Credentials - creates expired test credentials

5. Assertion helpers:
   - AssertErrorIs(t *testing.T, got, want error) - checks errors.Is
   - AssertContains(t *testing.T, got, substr string) - checks string contains

All helpers should use t.Helper() where applicable.
  </action>
  <verify>go build ./testutil compiles without errors</verify>
  <done>testutil/helpers.go contains reusable test helpers</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./testutil` compiles without errors
- [ ] `go test ./testutil` passes (if any tests added)
- [ ] Mocks implement expected interfaces (verify with type assertions)
- [ ] Package documentation is clear
</verification>

<success_criteria>

- All tasks completed
- testutil package compiles
- Mocks match existing interface patterns
- Helpers reduce boilerplate in typical test scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/50-test-infrastructure/50-02-SUMMARY.md`
</output>
