---
phase: 50-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [Makefile, scripts/coverage.sh, .github/workflows/test.yml]
autonomous: true
---

<objective>
Set up coverage tooling with baseline metrics and CI integration.

Purpose: Establish coverage infrastructure to track and enforce test coverage throughout the v1.6 Testing & Hardening milestone.
Output: Makefile targets for coverage, coverage threshold enforcement, baseline metrics documented.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add coverage Makefile targets</name>
  <files>Makefile</files>
  <action>
Add the following targets to the Makefile:

1. `coverage` target: Generate coverage profile
   - Run `go test -coverprofile=coverage.out -covermode=atomic ./...`
   - Generate HTML report with `go tool cover -html=coverage.out -o coverage.html`

2. `coverage-report` target: Display per-package coverage summary
   - Run `go test -cover ./... 2>&1 | grep -E "^(ok|---|\?)" | sort`

3. `coverage-check` target: Enforce minimum coverage threshold (80%)
   - Use `go test -cover ./... | grep -oP 'coverage: \K[0-9.]+'` or similar to extract coverage
   - Fail if any Sentinel package (audit, bootstrap, breakglass, enforce, identity, logging, notification, policy, request, sentinel) drops below 80%
   - Skip vault package (base aws-vault code, already at 31%)

Add targets to .PHONY declaration.
  </action>
  <verify>make coverage generates coverage.out and coverage.html; make coverage-report shows per-package stats</verify>
  <done>Coverage targets work and produce correct output</done>
</task>

<task type="auto">
  <name>Task 2: Create coverage enforcement script</name>
  <files>scripts/coverage.sh</files>
  <action>
Create scripts/coverage.sh that:

1. Runs `go test -cover ./...` and captures output
2. Parses coverage percentages for each Sentinel package
3. Compares against 80% threshold for Sentinel packages
4. Reports which packages pass/fail threshold
5. Exits with code 1 if any Sentinel package is below threshold
6. Exits with code 0 if all pass

Sentinel packages to check: audit, bootstrap, breakglass, enforce, identity, logging, notification, policy, request, sentinel

Exclude: vault (base aws-vault code), iso8601 (utility), cli (thin wrappers)

Output format:
```
Coverage Report
===============
✓ audit: 91.2% (threshold: 80%)
✓ bootstrap: 95.7% (threshold: 80%)
...
✗ some_package: 75.0% (threshold: 80%) BELOW THRESHOLD

Summary: 9/10 packages meet coverage threshold
```

Make the script executable.
  </action>
  <verify>./scripts/coverage.sh runs and reports coverage; exits 0 when all pass threshold</verify>
  <done>Script reports coverage per package and enforces 80% threshold on Sentinel packages</done>
</task>

<task type="auto">
  <name>Task 3: Update Makefile with coverage-check using script</name>
  <files>Makefile</files>
  <action>
Update the `coverage-check` target to use the coverage.sh script:

```makefile
coverage-check: ## Check coverage meets threshold (80% for Sentinel packages)
	@./scripts/coverage.sh
```

Also add a `test-coverage` target that runs tests and checks coverage in one step:
```makefile
test-coverage: coverage coverage-check ## Run tests with coverage enforcement
```
  </action>
  <verify>make coverage-check runs the script and reports results</verify>
  <done>make coverage-check enforces 80% threshold via script</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `make coverage` generates coverage.out and coverage.html files
- [ ] `make coverage-report` shows per-package coverage summary
- [ ] `make coverage-check` enforces 80% threshold on Sentinel packages
- [ ] All existing tests still pass (`make test`)
</verification>

<success_criteria>

- All tasks completed
- Coverage tooling produces accurate reports
- Threshold enforcement works correctly
- No regression in existing test behavior
</success_criteria>

<output>
After completion, create `.planning/phases/50-test-infrastructure/50-01-SUMMARY.md`
</output>
