---
phase: 155-internal-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [docs/internal/ARCHITECTURE_OVERVIEW.md, docs/internal/DEMO_SCRIPT.md, docs/internal/COMPONENT_DIAGRAM.md]
autonomous: false
---

<objective>
Create internal documentation for Sentinel maintainers including architecture overview, demo script, and component diagram.

Purpose: Enable new maintainers to understand Sentinel's architecture, run common workflows, and visualize component interactions.
Output: Three documentation files in docs/internal/ directory.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/STRUCTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Architecture Overview (Marshall Document)</name>
  <files>docs/internal/ARCHITECTURE_OVERVIEW.md</files>
  <action>
Create a comprehensive architecture overview document targeting maintainers. Structure:

## 1. System Overview
- Purpose: Policy-enforced credential access control layer for AWS
- Core principle: "No policy match = no credentials" (fail-closed)
- Integration point: credential_process and exec commands

## 2. Package Organization (30+ packages)
Group packages by domain:

**Core Credential Flow:**
- vault/ - AWS credential providers, keyring wrappers, config parsing
- server/ - EC2/ECS metadata emulation, HTTP credential servers
- sentinel/ - Policy-aware SentinelServer for credential vending
- lambda/ - Lambda TVM handler for server-side vending

**Policy Subsystem:**
- policy/ - YAML schema, parsing, validation, signing (KMS)
- enforce/ - Trust policy analysis, SCP validation
- validate/ - Input validation, sanitization

**Request/Response:**
- request/ - Approval workflow state machine (DynamoDB)
- breakglass/ - Emergency access with rate limiting
- session/ - Server-side session tracking and revocation

**Security:**
- security/ - Rate limiting, error sanitization
- ratelimit/ - Sliding window rate limiter
- logging/ - HMAC-signed audit logs

**Infrastructure:**
- bootstrap/ - SSM parameter setup
- infrastructure/ - DynamoDB table provisioning
- deploy/ - Deployment validation

**Device Posture:**
- device/ - Device ID generation
- mdm/ - MDM provider interface (Jamf, Intune)

**CLI:**
- cli/ - Command handlers (60+ commands)
- prompt/ - MFA input drivers
- shell/ - Shell integration

## 3. Key Data Flows
Document the three primary credential flows:

**Flow A: CLI Credential Process**
```
credential_process → cli/credentials.go → sentinel/SentinelServer
  → policy evaluation → vault provider chain → aws.Credentials
```

**Flow B: Exec with Server Mode**
```
exec --server → SentinelServer HTTP → per-request policy eval
  → session tracking (DynamoDB) → real-time revocation
```

**Flow C: Lambda TVM**
```
API Gateway → Lambda handler → policy eval (trust boundary)
  → STS AssumeRole → SourceIdentity stamping → session tracking
```

## 4. Security Boundaries
- Trust boundary: Lambda TVM (clients cannot bypass policy)
- Fail-closed: No policy match = deny (default deny)
- Policy signing: KMS signatures prevent tampering
- Session binding: DeviceID + SourceIdentity

## 5. State Storage
- Keyring: Local credentials (macOS Keychain, Linux keyctl, Windows Credential Manager)
- SSM: Policy YAML storage
- DynamoDB: Approvals, break-glass events, sessions
- Secrets Manager: MDM API tokens

## 6. Extension Points
- New MDM Provider: Implement mdm.Provider interface
- New CLI Command: Add to cli/, register in main.go
- New Policy Condition: Extend policy.Condition struct

Keep technical, no marketing language. Target audience: engineers joining the project.
  </action>
  <verify>test -f docs/internal/ARCHITECTURE_OVERVIEW.md && wc -l docs/internal/ARCHITECTURE_OVERVIEW.md | awk '$1 > 100'</verify>
  <done>docs/internal/ARCHITECTURE_OVERVIEW.md exists with 100+ lines covering all package domains</done>
</task>

<task type="auto">
  <name>Task 2: Create Demo Script</name>
  <files>docs/internal/DEMO_SCRIPT.md</files>
  <action>
Create an executable demo script document showing common Sentinel workflows. Structure:

## Prerequisites
- AWS credentials configured
- Sentinel binary built (`go build -o sentinel .`)
- SSM parameter for policy exists

## Demo 1: Basic Credential Flow (2 min)
```bash
# 1. Validate configuration
./sentinel config validate

# 2. Check identity
./sentinel whoami

# 3. Get credentials (policy evaluated)
./sentinel credentials --profile staging

# 4. Exec with credentials
./sentinel exec staging -- aws sts get-caller-identity
```

## Demo 2: Policy Management (3 min)
```bash
# 1. Pull current policy
./sentinel policy pull staging > staging-policy.yaml

# 2. Validate locally
./sentinel policy validate staging-policy.yaml

# 3. Lint for issues
./sentinel policy lint staging-policy.yaml

# 4. Diff against SSM
./sentinel policy diff staging staging-policy.yaml

# 5. Push changes (with confirmation)
./sentinel policy push staging staging-policy.yaml
```

## Demo 3: Server Mode with Session Tracking (3 min)
```bash
# 1. Start server mode
./sentinel exec staging --server --session-table sentinel-sessions -- bash

# 2. (In new terminal) List active sessions
./sentinel server-sessions list --table sentinel-sessions

# 3. Revoke session
./sentinel server-sessions revoke --table sentinel-sessions --id <session-id>

# 4. Observe denied access in original terminal
```

## Demo 4: Approval Workflow (3 min)
```bash
# 1. Request access
./sentinel request production --duration 1h --reason "Deploy v2.0"

# 2. Check request status
./sentinel request list

# 3. (As approver) Approve request
./sentinel approve <request-id>

# 4. Access with approval
./sentinel credentials --profile production
```

## Demo 5: Break-Glass Emergency Access (2 min)
```bash
# 1. Invoke break-glass
./sentinel breakglass-invoke production --reason incident --justification "P1 outage"

# 2. List active break-glass events
./sentinel breakglass-list

# 3. Close event after incident
./sentinel breakglass-close <event-id>
```

## Demo 6: Device Posture (2 min)
```bash
# 1. Show device info
./sentinel devices list

# 2. Show device-bound sessions
./sentinel device-sessions --device-id <id>
```

## Demo 7: Audit and Compliance (2 min)
```bash
# 1. Verify audit log integrity
./sentinel audit verify-logs /var/log/sentinel.log --key <hmac-key>

# 2. Check session compliance
./sentinel audit session-compliance --since 24h

# 3. Find untracked sessions
./sentinel audit untracked-sessions --since 24h
```

Include expected output snippets. Target: 15-minute full demo.
  </action>
  <verify>test -f docs/internal/DEMO_SCRIPT.md && grep -c "^##" docs/internal/DEMO_SCRIPT.md | awk '$1 >= 7'</verify>
  <done>docs/internal/DEMO_SCRIPT.md exists with 7+ demo sections covering all major workflows</done>
</task>

<task type="auto">
  <name>Task 3: Create Component Diagram</name>
  <files>docs/internal/COMPONENT_DIAGRAM.md</files>
  <action>
Create an ASCII component diagram showing Sentinel architecture. Structure:

## Sentinel Component Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              USER INTERFACE                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  CLI Commands (cli/)                                                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │credentials│ │   exec   │ │  policy  │ │ request  │ │breakglass│          │
│  └─────┬────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘          │
└────────┼───────────┼────────────┼────────────┼────────────┼─────────────────┘
         │           │            │            │            │
         v           v            v            v            v
┌─────────────────────────────────────────────────────────────────────────────┐
│                           POLICY EVALUATION                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │  PolicyLoader   │───>│  PolicyEngine   │───>│  Decision Log   │         │
│  │  (SSM + Cache)  │    │  (First Match)  │    │  (JSON Lines)   │         │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘         │
│           │                     │                                           │
│           v                     v                                           │
│  ┌─────────────────┐    ┌─────────────────┐                                │
│  │  KMS Verifier   │    │  Device Posture │                                │
│  │  (Signatures)   │    │  (MDM Lookup)   │                                │
│  └─────────────────┘    └─────────────────┘                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   v
┌─────────────────────────────────────────────────────────────────────────────┐
│                         CREDENTIAL PROVIDERS                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  Keyring    │  │    SSO      │  │ AssumeRole  │  │  Cached     │        │
│  │  Provider   │  │  Provider   │  │  Provider   │  │  Session    │        │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘        │
│         └────────────────┴────────────────┴────────────────┘                │
│                                   │                                          │
│                                   v                                          │
│                    ┌─────────────────────────────┐                          │
│                    │     SourceIdentity          │                          │
│                    │  (sentinel:user:request-id) │                          │
│                    └─────────────────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    v                              v
┌─────────────────────────────────┐  ┌─────────────────────────────────┐
│       LOCAL SERVERS             │  │         LAMBDA TVM              │
├─────────────────────────────────┤  ├─────────────────────────────────┤
│  ┌───────────┐  ┌───────────┐   │  │  ┌───────────┐  ┌───────────┐  │
│  │ EC2 Meta  │  │ ECS Creds │   │  │  │  Lambda   │  │ API GW    │  │
│  │  Server   │  │  Server   │   │  │  │  Handler  │  │ HTTP API  │  │
│  └───────────┘  └───────────┘   │  │  └───────────┘  └───────────┘  │
│                                 │  │                                 │
│  ┌───────────────────────────┐  │  │  ┌───────────────────────────┐ │
│  │    Unix Socket Auth       │  │  │  │    IAM Auth (SigV4)       │ │
│  │   (Process Credentials)   │  │  │  │   (Trust Boundary)        │ │
│  └───────────────────────────┘  │  │  └───────────────────────────┘ │
└─────────────────────────────────┘  └─────────────────────────────────┘
                    │                              │
                    └──────────────┬──────────────┘
                                   v
┌─────────────────────────────────────────────────────────────────────────────┐
│                           STATE STORAGE                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Keyring   │  │  DynamoDB   │  │     SSM     │  │  Secrets    │        │
│  │ (Credentials│  │  (Sessions  │  │  (Policies) │  │  Manager    │        │
│  │   Cache)   │  │  Approvals) │  │             │  │  (MDM Keys) │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Package Dependency Graph

```
main.go
   │
   └──> cli/
         │
         ├──> sentinel/     (SentinelServer)
         │       │
         │       ├──> policy/    (evaluation)
         │       ├──> session/   (tracking)
         │       └──> mdm/       (device posture)
         │
         ├──> vault/        (credential providers)
         │       │
         │       ├──> server/    (EC2/ECS)
         │       └──> sso/       (SSO login)
         │
         ├──> request/      (approval workflow)
         │       └──> notification/
         │
         ├──> breakglass/   (emergency access)
         │       └──> ratelimit/
         │
         └──> infrastructure/ (provisioning)
                 └──> bootstrap/
```

## Data Flow: Credential Request

```
┌─────────┐    ┌──────────┐    ┌─────────────┐    ┌───────────┐
│  User   │───>│   CLI    │───>│   Policy    │───>│   Allow   │──> Credentials
│ Request │    │ Command  │    │   Engine    │    │   Deny    │──> Error
└─────────┘    └──────────┘    └─────────────┘    └───────────┘
                    │                 │                  │
                    v                 v                  v
              ┌──────────┐    ┌─────────────┐    ┌───────────┐
              │ Identity │    │   Policy    │    │  Decision │
              │   (STS)  │    │   (SSM)     │    │    Log    │
              └──────────┘    └─────────────┘    └───────────┘
```

Include legend and notes on key interactions.
  </action>
  <verify>test -f docs/internal/COMPONENT_DIAGRAM.md && grep -c "┌" docs/internal/COMPONENT_DIAGRAM.md | awk '$1 >= 10'</verify>
  <done>docs/internal/COMPONENT_DIAGRAM.md exists with ASCII diagrams showing architecture</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Three internal documentation files: architecture overview, demo script, and component diagram</what-built>
  <how-to-verify>
    1. Read docs/internal/ARCHITECTURE_OVERVIEW.md - verify it covers all package domains
    2. Read docs/internal/DEMO_SCRIPT.md - verify demos are executable
    3. Read docs/internal/COMPONENT_DIAGRAM.md - verify diagrams are accurate
    4. Check that commands in demo script match actual CLI (./sentinel --help)
    5. Verify ASCII diagrams render correctly in terminal/editor
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] docs/internal/ directory exists
- [ ] ARCHITECTURE_OVERVIEW.md has 100+ lines
- [ ] DEMO_SCRIPT.md has 7+ demo sections
- [ ] COMPONENT_DIAGRAM.md has ASCII diagrams
- [ ] All files committed to git
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- User has approved documentation content
- Milestone v2.0 documentation requirements (INT-01, INT-02, INT-03) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/155-internal-documentation/155-01-SUMMARY.md`
</output>
