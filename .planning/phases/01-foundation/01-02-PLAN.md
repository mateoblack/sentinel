---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [cli/sentinel_provider.go]
autonomous: true
---

<objective>
Integrate Sentinel with aws-vault's credential provider system, exposing the ability to retrieve credentials for a profile.

Purpose: Establish the credential access layer that Sentinel will wrap with policy evaluation.
Output: Function that retrieves credentials for a given profile using aws-vault's provider chain.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Credential provider patterns:
@vault/vault.go
@cli/exec.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Sentinel credential provider wrapper</name>
  <files>cli/sentinel_provider.go</files>
  <action>
Create `cli/sentinel_provider.go` that exposes credential retrieval through aws-vault's existing machinery.

Define a struct and function:

```go
// SentinelCredentialRequest contains the input for credential retrieval
type SentinelCredentialRequest struct {
    ProfileName     string
    NoSession       bool  // Skip STS session creation
    SessionDuration time.Duration
    Region          string
}

// SentinelCredentialResult contains retrieved credentials
type SentinelCredentialResult struct {
    AccessKeyID     string
    SecretAccessKey string
    SessionToken    string
    Expiration      time.Time
    CanExpire       bool
}

// GetCredentials retrieves AWS credentials for a profile using aws-vault's provider chain.
// This is the integration point where Sentinel will later inject policy evaluation.
func (s *Sentinel) GetCredentials(ctx context.Context, req SentinelCredentialRequest) (*SentinelCredentialResult, error)
```

Implementation:
1. Get config file via s.AwsConfigFile()
2. Get keyring via s.Keyring()
3. Create vault.ProfileConfig with Region and session duration
4. Use vault.NewConfigLoader to get profile config
5. Create provider with vault.NewTempCredentialsProvider
6. Call provider.Retrieve(ctx) to get credentials
7. Map aws.Credentials to SentinelCredentialResult

Follow the pattern from cli/exec.go ExecCommand function, specifically lines 183-191.

Do NOT add policy evaluation yet - that's Phase 4. This is purely the credential retrieval integration.
  </action>
  <verify>go build ./cli && go vet ./cli</verify>
  <done>GetCredentials function compiles and follows vault patterns</done>
</task>

<task type="auto">
  <name>Task 2: Add basic test for credential provider integration</name>
  <files>cli/sentinel_provider_test.go</files>
  <action>
Create `cli/sentinel_provider_test.go` with a basic compilation test that verifies the types are correctly defined.

```go
func TestSentinelCredentialRequestFields(t *testing.T) {
    // Verify struct has expected fields
    req := SentinelCredentialRequest{
        ProfileName:     "test-profile",
        NoSession:       true,
        SessionDuration: 1 * time.Hour,
        Region:          "us-west-2",
    }

    if req.ProfileName != "test-profile" {
        t.Errorf("ProfileName not set correctly")
    }
}

func TestSentinelCredentialResultFields(t *testing.T) {
    // Verify struct has expected fields
    result := SentinelCredentialResult{
        AccessKeyID:     "AKIA...",
        SecretAccessKey: "secret",
        SessionToken:    "token",
        Expiration:      time.Now(),
        CanExpire:       true,
    }

    if result.AccessKeyID != "AKIA..." {
        t.Errorf("AccessKeyID not set correctly")
    }
}
```

Do NOT test actual AWS calls - that requires real credentials. Just test the types compile and basic struct usage.
  </action>
  <verify>go test ./cli -run TestSentinelCredential -v</verify>
  <done>Tests pass, verifying type definitions are correct</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./cli` succeeds
- [ ] `go test ./cli -run TestSentinelCredential` passes
- [ ] `go vet ./cli` reports no issues
- [ ] GetCredentials function signature matches vault patterns
</verification>

<success_criteria>

- SentinelCredentialRequest and SentinelCredentialResult types defined
- GetCredentials integrates with vault.NewTempCredentialsProvider
- Tests verify type definitions
- No compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
