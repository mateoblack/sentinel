---
phase: 05-credential-process
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified: [cli/credentials.go, cli/credentials_test.go]
autonomous: true
---

<objective>
Implement AWS credential_process JSON output format for the credentials command.

Purpose: Make Sentinel compatible with AWS CLI's credential_process feature, enabling seamless integration via `~/.aws/config` profiles.
Output: JSON output to stdout matching AWS spec, proper error handling to stderr with non-zero exit codes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Prior plan context:
@.planning/phases/05-credential-process/05-01-SUMMARY.md

Source files for reference:
@cli/export.go
@iso8601/iso8601.go
@cli/credentials.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Output credential_process JSON format on ALLOW</name>
  <files>cli/credentials.go</files>
  <action>
Replace the placeholder output with proper credential_process JSON:

1. Define CredentialProcessOutput struct (or reuse AwsCredentialHelperData pattern from cli/export.go):
```go
type CredentialProcessOutput struct {
    Version         int    `json:"Version"`
    AccessKeyId     string `json:"AccessKeyId"`
    SecretAccessKey string `json:"SecretAccessKey"`
    SessionToken    string `json:"SessionToken,omitempty"`
    Expiration      string `json:"Expiration,omitempty"`
}
```

2. After successful GetCredentials call:
   - Create CredentialProcessOutput with Version: 1
   - Map SentinelCredentialResult fields to output struct
   - If result.CanExpire is true, format result.Expiration using iso8601.Format()
   - SessionToken and Expiration use omitempty for long-lived credentials

3. Marshal to JSON:
   - Use json.MarshalIndent for readable output (matches cli/export.go pattern)
   - Print to stdout with newline: fmt.Println(string(jsonBytes))

4. Return nil on success (exit code 0)

AWS credential_process spec requires:
- Version must be 1
- AccessKeyId and SecretAccessKey are required
- SessionToken required only for temporary credentials
- Expiration is RFC3339/ISO8601 format, optional

Reference cli/export.go printJSON function for the exact pattern.
  </action>
  <verify>go build ./cmd/sentinel && echo "Build succeeds"</verify>
  <done>ALLOW decisions output valid credential_process JSON to stdout</done>
</task>

<task type="auto">
  <name>Task 2: Error handling for DENY and failures</name>
  <files>cli/credentials.go</files>
  <action>
Implement proper error handling per credential_process conventions:

1. On policy DENY:
   - Print error message to stderr: fmt.Fprintf(os.Stderr, "Access denied: %s\n", decision.String())
   - Return error (kingpin will exit non-zero)

2. On policy load failure:
   - Print to stderr: fmt.Fprintf(os.Stderr, "Failed to load policy: %v\n", err)
   - Return error

3. On credential retrieval failure:
   - Print to stderr: fmt.Fprintf(os.Stderr, "Failed to retrieve credentials: %v\n", err)
   - Return error

4. Ensure NO secret information is ever written to stderr (AWS security guidance)
   - Error messages should be descriptive but never contain credentials or sensitive data

5. Exit codes:
   - 0: Success (credentials returned)
   - Non-zero: Any failure (kingpin handles this via returning error)

The credential_process spec states:
- Non-zero return code indicates error
- SDKs may log stderr, so never write secrets there
  </action>
  <verify>go build ./cmd/sentinel && echo "Build succeeds"</verify>
  <done>Errors go to stderr, return non-zero exit code, no secrets in error output</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for credentials command</name>
  <files>cli/credentials_test.go</files>
  <action>
Create cli/credentials_test.go with tests for the output format:

1. Test CredentialProcessOutput JSON marshaling:
   - Verify Version is 1
   - Verify field names match AWS spec (AccessKeyId not AccessKeyID)
   - Verify omitempty works for SessionToken and Expiration

2. Test with temporary credentials (has expiration):
   - Create mock SentinelCredentialResult with CanExpire=true
   - Verify Expiration field is present in JSON output
   - Verify Expiration format is RFC3339

3. Test with long-lived credentials (no expiration):
   - Create mock SentinelCredentialResult with CanExpire=false
   - Verify Expiration field is omitted from JSON
   - Verify SessionToken field is omitted if empty

Follow existing test patterns from cli/sentinel_provider_test.go.

Note: Full integration tests require SSM mock, keep these as unit tests for the output formatting logic.
  </action>
  <verify>go test ./cli/... -run TestCredential -v</verify>
  <done>Unit tests pass for credential_process JSON output format</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./cmd/sentinel` succeeds
- [ ] `go test ./cli/...` passes all tests
- [ ] JSON output has correct field names (AccessKeyId not AccessKeyID)
- [ ] Expiration uses RFC3339 format via iso8601.Format()
- [ ] Error messages go to stderr, credentials to stdout
</verification>

<success_criteria>

- All tasks completed
- JSON output matches AWS credential_process specification
- Version field is always 1
- Expiration field present only for temporary credentials
- Errors written to stderr with descriptive messages
- No secrets ever written to stderr
- Unit tests verify output format correctness
</success_criteria>

<output>
After completion, create `.planning/phases/05-credential-process/05-02-SUMMARY.md`
</output>
