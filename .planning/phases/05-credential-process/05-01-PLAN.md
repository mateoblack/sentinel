---
phase: 05-credential-process
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [cli/credentials.go, cmd/sentinel/main.go]
autonomous: true
---

<objective>
Create the `sentinel credentials` command with policy evaluation that fetches AWS credentials only when policy allows.

Purpose: This command integrates policy evaluation into the credential retrieval flow, implementing Sentinel's core value: credentials issued only when policy explicitly allows.
Output: Working `sentinel credentials --profile X --policy-parameter /path/to/policy` command that evaluates policy before returning credentials.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Prior phase context:
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/04-policy-evaluation/04-01-SUMMARY.md

Source files:
@cli/sentinel.go
@cli/sentinel_provider.go
@policy/evaluate.go
@policy/loader.go
@policy/cache.go
@cmd/sentinel/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create credentials command CLI skeleton</name>
  <files>cli/credentials.go</files>
  <action>
Create cli/credentials.go with ConfigureCredentialsCommand function following the kingpin pattern from cli/export.go.

Define CredentialsCommandInput struct with fields:
- ProfileName string
- PolicyParameter string (SSM parameter path, e.g., /sentinel/policies/default)
- Region string
- NoSession bool
- SessionDuration time.Duration

Register command with kingpin:
- Command name: "credentials"
- Description: "Retrieve AWS credentials after policy evaluation"
- Required flag: --profile (string)
- Required flag: --policy-parameter (string, SSM parameter path)
- Optional flags: --region, --no-session, --duration (mirror export.go patterns)

The command action should call CredentialsCommand(input, f, keyring) where f and keyring come from Sentinel struct.

Use ConfigureSentinelGlobals pattern - add a function that takes (*kingpin.Application, *Sentinel) to register the command.
  </action>
  <verify>go build ./cmd/sentinel && ./cmd/sentinel/sentinel credentials --help shows command with flags</verify>
  <done>credentials command appears in help, accepts --profile and --policy-parameter flags</done>
</task>

<task type="auto">
  <name>Task 2: Wire up policy loading and evaluation</name>
  <files>cli/credentials.go</files>
  <action>
Implement CredentialsCommand function that:

1. Get current user:
   - Use os/user.Current() to get current OS username
   - Extract Username field for policy evaluation

2. Create AWS config for SSM:
   - Use config.LoadDefaultConfig(ctx) from aws-sdk-go-v2/config
   - Apply region from input if specified

3. Create policy loader chain:
   - Create policy.NewLoader(cfg) for SSM loader
   - Wrap with policy.NewCachedLoader(loader, 5*time.Minute) for caching

4. Load policy:
   - Call cachedLoader.Load(ctx, input.PolicyParameter)
   - Handle ErrPolicyNotFound - return error with clear message

5. Build policy.Request:
   - User: current OS username
   - Profile: input.ProfileName
   - Time: time.Now()

6. Evaluate policy:
   - Call policy.Evaluate(loadedPolicy, &request)
   - Check decision.Effect

7. Handle decision:
   - If EffectDeny: return error with decision.String() message
   - If EffectAllow: proceed to credential retrieval (Task 3 completes this)

For now, on EffectAllow just print "ALLOW - credentials would be returned here" as placeholder.

Import required packages:
- "context"
- "os/user"
- "github.com/aws/aws-sdk-go-v2/config"
- "github.com/byteness/aws-vault/v7/policy"
  </action>
  <verify>go build ./cmd/sentinel && echo "policy content" | SSM mock test (manual verification that code compiles)</verify>
  <done>CredentialsCommand compiles with policy loading and evaluation logic, returns error on deny</done>
</task>

<task type="auto">
  <name>Task 3: Integrate credential retrieval on ALLOW</name>
  <files>cli/credentials.go, cmd/sentinel/main.go</files>
  <action>
Complete the credential retrieval flow when policy allows:

1. In CredentialsCommand, after EffectAllow decision:
   - Create SentinelCredentialRequest with ProfileName, Region, NoSession, SessionDuration from input
   - Call sentinel.GetCredentials(ctx, req) using the Sentinel struct passed to the command
   - Handle errors from GetCredentials

2. For now, on successful credential retrieval:
   - Print placeholder: fmt.Fprintf(os.Stderr, "Credentials retrieved for %s\n", input.ProfileName)
   - The actual JSON output will be implemented in 05-02

3. Update ConfigureCredentialsCommand signature:
   - Should accept (*kingpin.Application, *Sentinel) to access GetCredentials method
   - Store Sentinel reference in closure for command action

4. Register command in main.go:
   - Add cli.ConfigureCredentialsCommand(app, s) after ConfigureSentinelGlobals
   - Import the sentinel CLI package properly

Note: The command needs access to both the Sentinel struct (for GetCredentials) AND the policy loader. Structure the code so:
- Policy loading uses AWS SDK config.LoadDefaultConfig
- Credential retrieval uses existing Sentinel.GetCredentials which uses the keyring
  </action>
  <verify>go build ./cmd/sentinel succeeds with no errors</verify>
  <done>credentials command compiles and integrates policy evaluation with credential retrieval, ready for JSON output in 05-02</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./cmd/sentinel` succeeds
- [ ] `./cmd/sentinel/sentinel credentials --help` shows all flags
- [ ] Code follows existing patterns from cli/export.go and cli/sentinel_provider.go
- [ ] Policy evaluation logic properly denies with error message
</verification>

<success_criteria>

- All tasks completed
- credentials command registered and accessible
- Policy loading from SSM integrated
- Policy evaluation gates credential retrieval
- Allow path retrieves credentials (output format in 05-02)
- Deny path returns error with clear message
</success_criteria>

<output>
After completion, create `.planning/phases/05-credential-process/05-01-SUMMARY.md`
</output>
