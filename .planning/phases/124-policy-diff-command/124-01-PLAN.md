---
phase: 124-policy-diff-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [cli/policy.go, cli/policy_test.go]
autonomous: true
---

<objective>
Implement `sentinel policy diff` command to show pending changes between a local policy file and the SSM-stored policy using unified diff format.

Purpose: Enable policy developers to review changes before pushing, completing the pull → edit → diff → push workflow.
Output: CLI command that shows unified diff with exit code indicating whether changes exist.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/122-policy-pull-command/122-01-SUMMARY.md
@.planning/phases/123-policy-push-command/123-01-SUMMARY.md

# Relevant source files:
@cli/policy.go
@policy/validate.go
@policy/loader.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement PolicyDiffCommand</name>
  <files>cli/policy.go</files>
  <action>
Add PolicyDiffCommand to cli/policy.go with the following behavior:

1. **Input struct** (PolicyDiffCommandInput):
   - Profile string (positional arg - target profile)
   - InputFile string (positional arg - path to local policy YAML file)
   - PolicyRoot string (--policy-root flag, default bootstrap.DefaultPolicyRoot)
   - PolicyParameter string (--policy-parameter flag, explicit SSM path override)
   - Region string (--region flag)
   - AWSProfile string (--aws-profile flag)
   - NoColor bool (--no-color flag, disable colorized output)
   - Stdout/Stderr *os.File (for testing)
   - SSMClient policy.SSMAPI (for testing)

2. **Command flow**:
   a. Read local policy file from disk
   b. Validate local policy using policy.ValidatePolicy(data) - fail early on invalid YAML
   c. Determine SSM parameter path (PolicyParameter override or derived from profile)
   d. Fetch remote policy from SSM using Loader
   e. If remote not found, treat as comparing against empty (all lines are additions)
   f. Normalize both policies: unmarshal and re-marshal to ensure consistent formatting
   g. Generate unified diff using internal diff implementation
   h. Output diff to stdout:
      - Green (+) for additions
      - Red (-) for deletions
      - No color with --no-color flag
   i. Exit code: 0 if no changes, 1 if changes exist (for scripting)

3. **Diff implementation** - implement a simple unified diff:
   - Split both strings by newline
   - Compare line by line using simple diff algorithm
   - Output unified diff format with @@ markers
   - Header: --- a/<parameter-path> (remote) / +++ b/<file> (local)

4. **Registration**: Add diff subcommand under policyCmd in ConfigurePolicyCommand.

5. **Error handling**:
   - File not found: exit 1 with helpful message
   - Validation error: exit 1 with prefixed error (parse/validation)
   - SSM errors (except NotFound): exit 1 with error and suggestions
   - Remote not found: proceed with empty comparison, show all additions
  </action>
  <verify>go build ./cli/... succeeds with no errors</verify>
  <done>PolicyDiffCommand registered and compiles, generates unified diff output</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for PolicyDiffCommand</name>
  <files>cli/policy_test.go</files>
  <action>
Extend cli/policy_test.go with tests for PolicyDiffCommand:

1. **Test cases**:
   - TestPolicyDiffCommand_NoChanges: identical policies, exit 0, no output
   - TestPolicyDiffCommand_WithChanges: different policies, exit 1, unified diff output
   - TestPolicyDiffCommand_RemoteNotFound: new policy (no remote), all lines as additions
   - TestPolicyDiffCommand_ValidationError: invalid local YAML, exit 1
   - TestPolicyDiffCommand_FileNotFound: missing input file, exit 1
   - TestPolicyDiffCommand_SSMError: GetParameter fails (not NotFound), exit 1
   - TestPolicyDiffCommand_NoColorFlag: --no-color produces plain diff
   - TestPolicyDiffCommand_PolicyParameterOverride: explicit path used instead of derived

2. **Test helpers**:
   - Create temp file with valid/invalid policy content
   - Use existing MockSSMClient for SSM responses
   - Capture stdout to verify diff output format

3. **Verification**:
   - Verify exit codes match expected behavior (0 = no changes, 1 = changes)
   - Verify diff output contains expected +/- lines
   - Verify @@ markers present in diff
  </action>
  <verify>go test -v ./cli/... -run PolicyDiff passes all tests</verify>
  <done>All policy diff tests pass with coverage for success, no changes, and error paths</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds with no errors
- [ ] `go test ./cli/... -run PolicyDiff` passes all tests
- [ ] `go vet ./...` passes
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- PolicyDiffCommand compares local file vs SSM policy
- Unified diff format with +/- lines
- Exit code 0 for no changes, 1 for changes exist
- Tests cover no changes, with changes, remote not found, and error cases
</success_criteria>

<output>
After completion, create `.planning/phases/124-policy-diff-command/124-01-SUMMARY.md`
</output>
