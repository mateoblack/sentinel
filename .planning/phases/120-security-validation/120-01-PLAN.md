---
phase: 120-security-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [docs/SECURITY.md, lambda/handler_security_test.go, sentinel/security_integration_test.go]
autonomous: true
---

<objective>
Create security integration tests for v1.16 hardening fixes and update security documentation.

Purpose: Validate all v1.16 security hardening phases work together and document the complete security posture for milestone completion.
Output: Security integration tests verifying timing-safe comparisons, rate limiting, error sanitization, and updated SECURITY.md with v1.16 hardening section.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (v1.16 Security Hardening):
@.planning/phases/113-timing-attack-remediation/113-01-SUMMARY.md
@.planning/phases/117-api-rate-limiting/117-02-SUMMARY.md
@.planning/phases/119-error-sanitization/119-01-SUMMARY.md

# Existing security test patterns:
@sentinel/server_security_test.go
@ratelimit/security_test.go
@lambda/security_test.go

# Current security documentation:
@docs/SECURITY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Lambda TVM security integration tests</name>
  <files>lambda/handler_security_test.go</files>
  <action>
Create a new security integration test file for Lambda TVM that validates all v1.16 security fixes work together:

1. **Test error sanitization** - Verify error responses don't leak internal details:
   - TestSecurityIntegration_ConfigErrorSanitized: config load error returns generic message
   - TestSecurityIntegration_IAMAuthErrorSanitized: IAM auth error returns generic message
   - TestSecurityIntegration_MDMErrorSanitized: MDM verification error returns generic message
   - TestSecurityIntegration_CredentialMarshalErrorSanitized: marshal error returns generic message

2. **Test rate limiting integration** - Verify rate limiter is properly integrated:
   - TestSecurityIntegration_RateLimitReturns429: exceeded rate returns 429 with Retry-After
   - TestSecurityIntegration_RateLimitByIAMArn: rate limiting keys by IAM ARN not IP

3. **AST verification tests** - Verify timing-safe functions are used (pattern from sentinel/server_security_test.go):
   - TestSecurityIntegration_NoDirectBytesEqualInHandler: no bytes.Equal for token comparison
   - TestSecurityIntegration_UseConstantTimeCompare: verify subtle import used in relevant files

Test structure pattern:
```go
package lambda

import (
    "testing"
    "net/http"
    "net/http/httptest"
    "encoding/json"
)

func TestSecurityIntegration_ConfigErrorSanitized(t *testing.T) {
    // Create handler with invalid config that will fail
    // Verify response contains generic "Failed to load configuration" not internal details
}
```

Use table-driven tests where appropriate. Each test should have clear "SECURITY:" comment explaining what vulnerability it validates against.
  </action>
  <verify>
- `go test ./lambda/... -run TestSecurityIntegration` passes
- All tests have SECURITY: comments explaining the vulnerability being validated
  </verify>
  <done>
- Lambda TVM has security integration tests covering error sanitization and rate limiting
- Tests verify no information leakage in error responses
- AST verification confirms timing-safe comparisons
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Sentinel server security integration tests</name>
  <files>sentinel/security_integration_test.go</files>
  <action>
Create a new security integration test file for the Sentinel credential server that validates v1.16 security fixes:

1. **Error sanitization tests**:
   - TestSecurityIntegration_PolicyLoadErrorSanitized: verify "Failed to load policy" not SSM path
   - TestSecurityIntegration_CredentialRetrievalErrorSanitized: verify generic error not provider details

2. **Rate limiting tests** (complement existing tests in sentinel/server_test.go):
   - TestSecurityIntegration_RateLimitConcurrent: concurrent requests properly limited
   - TestSecurityIntegration_RateLimitRetryAfterHeader: 429 includes Retry-After header

3. **Combined security scenario**:
   - TestSecurityIntegration_EndToEndSecurityChain: test full request flow through auth → rate limit → policy → credential with appropriate error sanitization at each layer

Test pattern:
```go
package sentinel

import (
    "testing"
    "net/http"
    "net/http/httptest"
    "strings"
)

func TestSecurityIntegration_PolicyLoadErrorSanitized(t *testing.T) {
    // SECURITY: Validates Phase 119 error sanitization - policy load errors
    // must not expose SSM parameter paths to clients

    // Create server with mock policy loader that returns error with path details
    // Verify response body contains "Failed to load policy" not the path
}
```

Ensure tests validate the actual security properties, not just code coverage.
  </action>
  <verify>
- `go test ./sentinel/... -run TestSecurityIntegration` passes
- Tests verify actual security properties (error messages, rate limiting behavior)
  </verify>
  <done>
- Sentinel server has security integration tests
- Tests validate error sanitization across all error paths
- Rate limiting behavior verified with proper headers
  </done>
</task>

<task type="auto">
  <name>Task 3: Update SECURITY.md with v1.16 hardening section</name>
  <files>docs/SECURITY.md</files>
  <action>
Add a new "v1.16 Security Hardening" section to SECURITY.md documenting all security improvements from this milestone. Insert after the "SENTINEL-2026-001" section.

**Add this section:**

```markdown
## v1.16 Security Hardening

Version 1.16 addresses findings from a comprehensive security audit with the following improvements:

### Timing Attack Mitigation (Phase 113)

Bearer token comparisons in credential servers now use `crypto/subtle.ConstantTimeCompare()` instead of direct string comparison, preventing timing-based oracle attacks.

**Affected Components:**
- Sentinel credential server (`sentinel/server.go`)
- ECS credential server (`server/ecsserver.go`)

### Secrets Management (Phase 114)

MDM API tokens migrated from environment variables to AWS Secrets Manager with client-side caching:

- **Cache TTL**: 1 hour (optimized for Lambda cold start patterns)
- **Backward Compatible**: Environment variable fallback with deprecation warning
- **Interface-based**: `SecretsLoader` interface enables testing and future extension

### CI/CD Security Scanning (Phase 115)

Automated security scanning integrated into CI/CD pipeline:

| Tool | Coverage | Schedule |
|------|----------|----------|
| govulncheck | Go vulnerability database | PR, Push, Weekly |
| gosec | Static application security testing | PR, Push, Weekly |
| Trivy | Container/filesystem scanning | PR, Push, Weekly |

### DynamoDB Encryption (Phase 116)

All DynamoDB tables use AWS-managed KMS encryption:

- Approval requests table
- Break-glass events table
- Server sessions table

### API Rate Limiting (Phase 117)

Rate limiting protects credential endpoints from abuse:

| Endpoint | Default Limit | Key |
|----------|---------------|-----|
| Lambda TVM | 100 req/min | IAM User ARN |
| Credential Server | 100 req/min | Remote Address |

Rate limit responses include RFC 7231 compliant `Retry-After` header.

### Error Sanitization (Phase 119)

All credential endpoints sanitize error responses to prevent information leakage:

- **Pattern**: Log detailed errors internally, return generic messages to clients
- **Preserved**: Rate limit retry-after and policy deny reasons (intentional user-facing)
- **Protected**: SSM paths, ARN parsing errors, MDM provider failures, credential retrieval errors

### Security Regression Tests

Comprehensive security regression tests validate:

- Timing-safe token comparison (AST verification)
- Rate limiter bypass resistance (concurrent access tests)
- Error message sanitization (no internal details leaked)
- Memory bounds on rate limiters

Run security tests locally:

\`\`\`bash
go test ./... -run Security
\`\`\`
```

Also update the "Last Audit" date in the Dependency Security section to today's date (2026-01-26).
  </action>
  <verify>
- SECURITY.md contains v1.16 Security Hardening section
- All 7 phases (113-119) are documented
- Last Audit date updated to 2026-01-26
  </verify>
  <done>
- SECURITY.md documents complete v1.16 security hardening
- Each phase's security improvements clearly explained
- Users can understand and verify security posture
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test ./lambda/... -run TestSecurityIntegration` passes
- [ ] `go test ./sentinel/... -run TestSecurityIntegration` passes
- [ ] `go test ./... -run Security` passes (all security tests)
- [ ] SECURITY.md has v1.16 Security Hardening section with all phases documented
- [ ] No errors or warnings introduced
</verification>

<success_criteria>

- Security integration tests exist for Lambda TVM and Sentinel server
- Tests validate actual security properties (error sanitization, rate limiting, timing safety)
- SECURITY.md documents all v1.16 security hardening improvements
- All tests pass including existing security regression tests
</success_criteria>

<output>
After completion, create `.planning/phases/120-security-validation/120-01-SUMMARY.md`
</output>
