---
phase: 47-audit-verify-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [cli/audit.go, cli/audit_test.go, cmd/sentinel/main.go]
autonomous: true
---

<objective>
Create `sentinel audit verify` CLI command for CloudTrail session verification.

Purpose: Enable security teams to verify Sentinel enforcement by querying CloudTrail for sessions with/without SourceIdentity, detecting potential bypasses.
Output: Working CLI command with time window filtering, role/user filters, human and JSON output formats.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 46 built the Verifier and types we're wiring to CLI
@.planning/phases/46-cloudtrail-query-types/46-01-SUMMARY.md

# Existing patterns
@audit/verifier.go
@audit/types.go
@cli/enforce.go
@cmd/sentinel/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audit verify CLI command with AWS integration</name>
  <files>cli/audit.go, cli/audit_test.go</files>
  <action>
Create cli/audit.go with:

1. AuditVerifyCommandInput struct:
   - StartTime, EndTime time.Time (required)
   - RoleARN string (optional filter)
   - Username string (optional filter)
   - Region string (optional AWS region)
   - JSONOutput bool
   - Verifier *audit.Verifier (for testing, nil uses real AWS)
   - Stdout, Stderr *os.File (for testing)

2. ConfigureAuditVerifyCommand(app *kingpin.Application, s *Sentinel):
   - Create "audit" command group: "Audit and verification commands"
   - Create "verify" subcommand: "Verify CloudTrail sessions for Sentinel enforcement"
   - Required flags:
     - --start (time.Time): Start of time window (RFC3339 format)
     - --end (time.Time): End of time window (RFC3339 format)
   - Optional flags:
     - --role: Role ARN filter
     - --user: Username filter
     - --region: AWS region
     - --json: JSON output format
   - Action calls AuditVerifyCommand

3. AuditVerifyCommand(ctx context.Context, input AuditVerifyCommandInput) error:
   - Validate StartTime < EndTime
   - Load AWS config (with region if specified)
   - Create Verifier if input.Verifier is nil
   - Call Verifier.Verify with VerifyInput
   - Output results (human or JSON format)
   - Return non-nil error if HasIssues() (for scripting exit code)

4. Human output format (outputAuditHumanFormat):
   ```
   CloudTrail Session Verification
   ================================

   Time Window: 2026-01-16T00:00:00Z to 2026-01-16T12:00:00Z

   Summary
   -------
   Total sessions:       42
   Sentinel sessions:    40 (95.2%)
   Non-Sentinel:         2

   Issues (2)
   ----------
   [WARNING] Session without Sentinel SourceIdentity: alice (event: AssumeRole)
     Event ID: abc123
     Time: 2026-01-16T08:30:00Z

   [WARNING] Session without Sentinel SourceIdentity: bob (event: AssumeRole)
     Event ID: def456
     Time: 2026-01-16T10:15:00Z

   Result: 2 issue(s) found
   ```

5. JSON output format: Marshal VerificationResult directly

Create cli/audit_test.go with:
- Test with mock Verifier (all Sentinel sessions - no issues)
- Test with mock Verifier (mixed sessions - has issues)
- Test human output format
- Test JSON output format
- Test time validation (end before start)
- Test with role/user filters

Follow patterns from cli/enforce.go and cli/enforce_test.go for:
- Input struct with optional Verifier/Stdout/Stderr for testing
- AWS config loading with optional region
- Human vs JSON output branching
- Error handling and exit codes
  </action>
  <verify>go test -v ./cli -run TestAuditVerify</verify>
  <done>cli/audit.go exists with ConfigureAuditVerifyCommand and AuditVerifyCommand, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Wire audit verify command to main and verify integration</name>
  <files>cmd/sentinel/main.go</files>
  <action>
1. Add to cmd/sentinel/main.go after enforcement commands section:
   ```go
   // Audit commands
   cli.ConfigureAuditVerifyCommand(app, s)
   ```

2. Verify the command shows in help:
   ```bash
   go run ./cmd/sentinel audit --help
   go run ./cmd/sentinel audit verify --help
   ```

3. Verify command structure:
   - sentinel audit verify --start "2026-01-16T00:00:00Z" --end "2026-01-16T12:00:00Z"
   - sentinel audit verify --start ... --end ... --role arn:aws:iam::123456789012:role/MyRole
   - sentinel audit verify --start ... --end ... --user alice
   - sentinel audit verify --start ... --end ... --json
  </action>
  <verify>go run ./cmd/sentinel audit verify --help shows all flags</verify>
  <done>main.go updated, "sentinel audit verify --help" displays usage with all flags</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test ./cli -run TestAuditVerify passes
- [ ] go build ./cmd/sentinel succeeds
- [ ] sentinel audit --help shows verify subcommand
- [ ] sentinel audit verify --help shows all flags (--start, --end, --role, --user, --region, --json)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- sentinel audit verify command works with Verifier from Phase 46
- Human output shows summary with pass rate and issue details
- JSON output marshals VerificationResult directly
- Exit code non-zero when issues found (for scripting)
</success_criteria>

<output>
After completion, create `.planning/phases/47-audit-verify-command/47-01-SUMMARY.md`
</output>
