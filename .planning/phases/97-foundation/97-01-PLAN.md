---
phase: 97-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [go.mod, go.sum, Makefile, lambda/types.go]
autonomous: true
---

<objective>
Establish Lambda build infrastructure and type definitions for the Token Vending Machine.

Purpose: Create the foundation for Lambda-based credential vending - build pipeline and shared types that the handler will use.
Output: Lambda dependency added, Makefile target for Linux/amd64 Lambda binary, and lambda/ package with request/response types.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@sentinel/server.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add aws-lambda-go dependency and Makefile target</name>
  <files>go.mod, go.sum, Makefile</files>
  <action>
1. Add `github.com/aws/aws-lambda-go` to go.mod:
   - Run `go get github.com/aws/aws-lambda-go`

2. Add Lambda build target to Makefile after the `aws-vault-windows-arm64.exe` target:
   ```makefile
   # Lambda TVM binary (Linux amd64 for AWS Lambda)
   lambda-tvm-linux-amd64: $(SRC)
   	GOOS=linux GOARCH=amd64 go build $(BUILD_FLAGS) -o $@ ./cmd/lambda-tvm
   ```

3. Add `lambda-tvm-linux-amd64` to the `clean` target's rm list.

Note: Lambda requires Linux amd64 binary. The build uses the same BUILD_FLAGS as other targets for consistency.
  </action>
  <verify>
  - `grep "aws-lambda-go" go.mod` returns the dependency
  - `grep "lambda-tvm-linux-amd64" Makefile` returns the target
  </verify>
  <done>
  - aws-lambda-go dependency in go.mod
  - lambda-tvm-linux-amd64 Makefile target exists
  - clean target includes lambda binary
  </done>
</task>

<task type="auto">
  <name>Task 2: Create lambda package with types</name>
  <files>lambda/types.go</files>
  <action>
Create `lambda/types.go` with:

1. Package doc: "Package lambda provides the Lambda handler for the Token Vending Machine (TVM)."

2. `CallerIdentity` struct for IAM authorization context:
   ```go
   // CallerIdentity represents the IAM identity of the API Gateway caller.
   // Extracted from API Gateway v2 HTTP API IAM authorizer context.
   type CallerIdentity struct {
       AccountID      string // AWS account ID of the caller
       UserARN        string // Full ARN of the calling IAM principal
       UserID         string // Unique ID of the calling principal
       AccessKey      string // Access key used to sign the request
       PrincipalOrgID string // AWS Organizations ID (if applicable)
   }
   ```

3. `TVMRequest` struct for credential request:
   ```go
   // TVMRequest contains parameters for a credential vending request.
   type TVMRequest struct {
       Profile         string        // Target profile/role to assume
       SessionDuration time.Duration // Requested credential duration (optional)
   }
   ```

4. `TVMResponse` struct for credential response (AWS container credentials format):
   ```go
   // TVMResponse contains credentials in AWS container credentials format.
   // Compatible with AWS_CONTAINER_CREDENTIALS_FULL_URI.
   type TVMResponse struct {
       AccessKeyId     string `json:"AccessKeyId"`
       SecretAccessKey string `json:"SecretAccessKey"`
       Token           string `json:"Token"`
       Expiration      string `json:"Expiration"` // RFC3339 format
   }
   ```

5. `TVMError` struct for error responses:
   ```go
   // TVMError represents an error response from the TVM.
   type TVMError struct {
       Message string `json:"Message"`
       Code    string `json:"Code,omitempty"`
   }
   ```

6. Helper function to extract CallerIdentity from API Gateway v2 request:
   ```go
   // ExtractCallerIdentity extracts the IAM caller identity from an API Gateway v2 HTTP request.
   // Returns an error if IAM authorization context is missing or incomplete.
   func ExtractCallerIdentity(req events.APIGatewayV2HTTPRequest) (*CallerIdentity, error)
   ```
   Implementation:
   - Access `req.RequestContext.Authorizer.IAM`
   - Validate required fields (AccountID, UserARN) are present
   - Return populated CallerIdentity struct
   - Return error if IAM context is missing (API Gateway not configured for IAM auth)

Import github.com/aws/aws-lambda-go/events for the API Gateway types.
  </action>
  <verify>
  - `go build ./lambda/` compiles without errors
  - Types match AWS container credentials format (AccessKeyId, SecretAccessKey, Token, Expiration)
  </verify>
  <done>
  - lambda/types.go exists with CallerIdentity, TVMRequest, TVMResponse, TVMError
  - ExtractCallerIdentity function parses IAM authorizer context
  - Package compiles successfully
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go mod tidy` runs without errors
- [ ] `go build ./lambda/` compiles
- [ ] `grep "lambda-tvm" Makefile` shows the build target
- [ ] No TypeScript/linting errors
</verification>

<success_criteria>

- aws-lambda-go dependency added to go.mod
- Makefile has lambda-tvm-linux-amd64 target
- lambda/ package compiles with all required types
- ExtractCallerIdentity function exists
</success_criteria>

<output>
After completion, create `.planning/phases/97-foundation/97-01-SUMMARY.md`
</output>
