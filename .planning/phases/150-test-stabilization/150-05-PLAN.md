---
phase: 150-test-stabilization
plan: 05
type: execute
wave: 3
depends_on: ["150-03", "150-04"]
files_modified: [cli/integration_test.go]
autonomous: true
---

<objective>
Add integration tests exercising all CLI commands.

Purpose: CLI commands are the user-facing interface. Integration tests verify commands work end-to-end with proper argument parsing, output formatting, and error handling.
Output: Integration test file covering all sentinel CLI commands.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@cli/global.go
@docs/guide/commands.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inventory all CLI commands</name>
  <files>cli/integration_test.go</files>
  <action>
  1. Read cli/global.go to find all registered commands
  2. Cross-reference with docs/guide/commands.md for complete list
  3. Create a command inventory covering:
     - sentinel credentials
     - sentinel exec
     - sentinel whoami
     - sentinel policy (pull, push, diff, validate, sign, verify, lint)
     - sentinel init (wizard, bootstrap, status, approvals, breakglass, sessions, validate, scp, dynamodb, ssm, monitoring)
     - sentinel request, approve, deny, list-requests, check-request
     - sentinel breakglass, breakglass-list, breakglass-check, breakglass-close
     - sentinel shell init
     - sentinel permissions, permissions check
     - sentinel audit (verify, trust-status, analyze-role, session-compliance, untracked-sessions)
     - sentinel server-sessions
     - sentinel device-sessions, devices
     - sentinel config (validate, generate)
     - sentinel validate-trust-policy
     - sentinel validate-deployment

  4. Create integration_test.go scaffold with test function stubs for each command
  </action>
  <verify>cli/integration_test.go exists with test stubs for all commands</verify>
  <done>Command inventory complete, test scaffold created</done>
</task>

<task type="auto">
  <name>Task 2: Implement CLI integration tests</name>
  <files>cli/integration_test.go</files>
  <action>
  For each command, create an integration test that:

  1. Tests help output (--help flag):
     ```go
     func TestIntegration_CommandName_Help(t *testing.T) {
         cmd := exec.Command("go", "run", ".", "command", "--help")
         output, err := cmd.CombinedOutput()
         if err != nil {
             t.Fatalf("help failed: %v\n%s", err, output)
         }
         if !strings.Contains(string(output), "expected-description") {
             t.Errorf("help missing expected content")
         }
     }
     ```

  2. Tests error handling (missing required args):
     ```go
     func TestIntegration_CommandName_MissingArgs(t *testing.T) {
         cmd := exec.Command("go", "run", ".", "command")
         output, err := cmd.CombinedOutput()
         if err == nil {
             t.Fatal("expected error for missing args")
         }
         // Verify helpful error message
     }
     ```

  3. For commands that don't require AWS (validate, lint, etc.), test actual functionality:
     ```go
     func TestIntegration_PolicyValidate(t *testing.T) {
         // Create temp policy file
         // Run sentinel policy validate
         // Verify output
     }
     ```

  NOTE: Commands requiring AWS credentials should test help/error paths only to avoid external dependencies.

  Focus on:
  - All commands accept --help
  - Required arguments are enforced
  - Error messages are user-friendly
  - Commands that work offline are fully tested
  </action>
  <verify>go test -v ./cli/... -run TestIntegration passes</verify>
  <done>CLI integration tests cover all commands</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] cli/integration_test.go exists with tests for all commands
- [ ] go test ./cli/... -run TestIntegration passes
- [ ] Each command has at least help and error handling tests
- [ ] Offline commands (validate, lint, shell init) have functional tests
</verification>

<success_criteria>

- All CLI commands have integration tests
- Tests verify help output and error handling
- Offline commands tested end-to-end
- No AWS credentials required for CI
</success_criteria>

<output>
After completion, create `.planning/phases/150-test-stabilization/150-05-SUMMARY.md`
</output>
