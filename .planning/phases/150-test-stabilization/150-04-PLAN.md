---
phase: 150-test-stabilization
plan: 04
type: execute
wave: 2
depends_on: ["150-02"]
files_modified: [security/stride_coverage_test.go]
autonomous: true
---

<objective>
Verify security regression tests cover 100% of identified STRIDE findings.

Purpose: The STRIDE threat model (docs/STRIDE_THREAT_MODEL.md) identified 30+ threats. Security regression tests must cover all actionable findings.
Output: Documentation of STRIDE coverage, additional tests if gaps found.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@docs/STRIDE_THREAT_MODEL.md
@docs/STRIDE_FINDINGS_CATEGORIZED.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Map STRIDE findings to existing tests</name>
  <files>security/stride_coverage_test.go</files>
  <action>
  1. Read docs/STRIDE_THREAT_MODEL.md and docs/STRIDE_FINDINGS_CATEGORIZED.md
  2. Extract all threat IDs (S-01, T-01, etc.) and their descriptions
  3. For each "Already Fixed" threat (Category 4), find the corresponding test:
     - S-01 (OS Username Spoofing) → identity/security_test.go
     - T-01 (Policy Cache Poisoning) → policy/security_test.go
     - T-03 (Audit Log Tampering) → logging/security_test.go
     - etc.

  4. Create a coverage mapping document in security/stride_coverage_test.go:
     ```go
     // STRIDE Coverage Map
     // This test file documents STRIDE threat model test coverage.
     //
     // S-01: OS Username Spoofing
     //   Fixed: v1.7.1
     //   Test: TestSecurityRegression_UsernameFromAWSIdentity (identity/security_test.go)
     //
     // T-01: Policy Cache Poisoning
     //   Fixed: v1.18 Phase 126
     //   Test: TestSecurityRegression_PolicyCachePoisoning (policy/security_test.go)
     // ...
     ```

  5. Document any gaps where threats lack corresponding tests

  This task creates the coverage map, next task fills gaps.
  </action>
  <verify>security/stride_coverage_test.go contains mapping for all Category 4 (Fixed) threats</verify>
  <done>STRIDE-to-test mapping documented</done>
</task>

<task type="auto">
  <name>Task 2: Add missing security regression tests</name>
  <files>Files identified in Task 1 mapping</files>
  <action>
  For each STRIDE finding without a corresponding test:

  1. Determine if test is needed:
     - Category 1 (Sentinel Implementation Issues) - tests needed for fixed items
     - Category 2 (Customer Deployment) - no Sentinel code tests needed
     - Category 3 (Documentation Gaps) - no tests needed
     - Category 4 (Already Fixed) - tests REQUIRED

  2. For each gap in Category 4 (Already Fixed), add a security regression test:
     - Use TestSecurityRegression_ prefix for CI filtering
     - Include "SECURITY VIOLATION" marker in failure messages
     - Test the vulnerable scenario, verify it's blocked

  3. Regression test pattern:
     ```go
     func TestSecurityRegression_ThreatID_Description(t *testing.T) {
         // STRIDE ID: X-NN
         // Threat: [description]
         // Mitigation: [what was done]

         // Attempt the attack
         result := attemptAttack()

         // Verify mitigation blocks attack
         if result.Success {
             t.Fatal("SECURITY VIOLATION: [threat] not prevented")
         }
     }
     ```

  4. Run new tests to verify they pass: `go test -run TestSecurityRegression ./...`
  </action>
  <verify>All Category 4 STRIDE findings have corresponding TestSecurityRegression_ tests</verify>
  <done>100% STRIDE coverage for fixed vulnerabilities</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] STRIDE coverage map exists in security/stride_coverage_test.go
- [ ] All Category 4 (Fixed) threats have corresponding tests
- [ ] go test -run TestSecurityRegression ./... passes
- [ ] Test count matches or exceeds the "153 security regression tests" mentioned in threat model
</verification>

<success_criteria>

- STRIDE threat mapping documented
- 100% test coverage for fixed vulnerabilities
- All security regression tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/150-test-stabilization/150-04-SUMMARY.md`
</output>
