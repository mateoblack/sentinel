---
phase: 150-test-stabilization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [go.mod, policy/coverage_test.go, identity/coverage_test.go]
autonomous: true
---

<objective>
Fix Go version and establish test coverage baselines for policy and identity packages.

Purpose: The go.mod incorrectly requires Go 1.25 (non-existent). Fix this, then measure and achieve coverage targets for policy (90%) and identity (85%) packages which are the highest-priority test targets.
Output: Working test suite with coverage measurements and additional tests if needed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@go.mod
@policy/evaluate.go
@policy/evaluate_test.go
@identity/aws_identity.go
@identity/aws_identity_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Go version in go.mod</name>
  <files>go.mod</files>
  <action>
  The go.mod file specifies `go 1.25` which doesn't exist. This was likely set optimistically for a future Go release.

  1. Read go.mod to confirm the version
  2. Change `go 1.25` to `go 1.22` (matching the system Go version)
  3. Run `go mod tidy` to ensure dependencies are consistent
  4. Verify tests can now run with `go test ./... -count=1`

  This unblocks all subsequent testing work.
  </action>
  <verify>GOTOOLCHAIN=auto go test ./... runs without "go.mod requires go >= 1.25" error</verify>
  <done>Tests execute (pass or fail) without Go version errors</done>
</task>

<task type="auto">
  <name>Task 2: Measure and achieve policy package coverage (90%)</name>
  <files>policy/coverage_test.go</files>
  <action>
  1. Run `go test -cover ./policy/...` to measure current coverage
  2. If coverage is below 90%, identify uncovered lines using:
     `go test -coverprofile=policy.cov ./policy/... && go tool cover -func=policy.cov`
  3. Add tests for uncovered code paths - focus on:
     - Error handling branches
     - Edge cases in Evaluate, Lint, and Marshal functions
     - Cache expiration paths
  4. Re-measure to confirm 90% target is met

  DO NOT add frivolous tests just for coverage - each test should verify meaningful behavior.
  The policy package is critical for security so high coverage is warranted.
  </action>
  <verify>go test -cover ./policy/... shows coverage >= 90%</verify>
  <done>Policy package coverage meets 90% target</done>
</task>

<task type="auto">
  <name>Task 3: Measure and achieve identity package coverage (85%)</name>
  <files>identity/coverage_test.go</files>
  <action>
  1. Run `go test -cover ./identity/...` to measure current coverage
  2. If coverage is below 85%, identify uncovered lines using:
     `go test -coverprofile=identity.cov ./identity/... && go tool cover -func=identity.cov`
  3. Add tests for uncovered code paths - focus on:
     - ARN parsing edge cases
     - GetCallerIdentity error handling
     - Request ID generation
  4. Re-measure to confirm 85% target is met

  The identity package handles AWS identity extraction (security-critical).
  </action>
  <verify>go test -cover ./identity/... shows coverage >= 85%</verify>
  <done>Identity package coverage meets 85% target</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test ./... runs without Go version errors
- [ ] go test -cover ./policy/... >= 90%
- [ ] go test -cover ./identity/... >= 85%
- [ ] No new test failures introduced
</verification>

<success_criteria>

- Go version fixed, tests execute
- Policy package coverage at 90%+
- Identity package coverage at 85%+
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/150-test-stabilization/150-01-SUMMARY.md`
</output>
