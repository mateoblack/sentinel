---
phase: 150-test-stabilization
plan: 03
type: execute
wave: 2
depends_on: ["150-01"]
files_modified: []
autonomous: true
---

<objective>
Run race detector on full test suite and fix any data races.

Purpose: Data races can cause security vulnerabilities (TOCTOU bugs, inconsistent state). The race detector must pass with zero warnings.
Output: Clean race detector run on entire test suite.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan for Go version fix
@.planning/phases/150-test-stabilization/150-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run race detector on full test suite</name>
  <files></files>
  <action>
  1. Run full test suite with race detector:
     `go test -race -timeout 10m ./...`
  2. Capture the output to identify any race warnings
  3. Race warnings appear as:
     ```
     WARNING: DATA RACE
     Read at 0x... by goroutine N:
       ...
     Previous write at 0x... by goroutine M:
       ...
     ```
  4. If no races found, document the clean run
  5. If races found, record file locations and proceed to Task 2

  Race detector adds significant overhead so use 10m timeout.
  </action>
  <verify>go test -race ./... completes (may have warnings to fix)</verify>
  <done>Race detector run completes, any races identified</done>
</task>

<task type="auto">
  <name>Task 2: Fix any data races identified</name>
  <files>Files with races identified in Task 1</files>
  <action>
  For each data race identified:

  1. Analyze the race:
     - What data is being accessed unsafely?
     - Which goroutines are involved?
     - Is this a test bug or production code bug?

  2. Fix using appropriate pattern:
     - **sync.Mutex** - for protecting shared state
     - **sync.RWMutex** - for read-heavy access patterns
     - **atomic operations** - for simple counters/flags
     - **channels** - for goroutine coordination
     - **sync.Once** - for one-time initialization

  3. Common race patterns in tests:
     - Test writing to shared variable after spawning goroutine
     - Missing WaitGroup before assertions
     - Shared mock state across parallel subtests

  4. After each fix, re-run: `go test -race ./path/to/package/...`

  5. Once all races fixed, run full suite: `go test -race ./...`

  DO NOT use `-race=false` or skip race detection. Fix the actual issue.
  </action>
  <verify>go test -race ./... shows zero WARNING: DATA RACE messages</verify>
  <done>Race detector passes with zero warnings</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test -race ./... runs to completion
- [ ] Zero "WARNING: DATA RACE" messages in output
- [ ] All tests still pass after race fixes
</verification>

<success_criteria>

- Race detector passes on full test suite
- Zero data race warnings
- No test functionality broken by race fixes
</success_criteria>

<output>
After completion, create `.planning/phases/150-test-stabilization/150-03-SUMMARY.md`
</output>
