---
phase: 143-uat-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vault/config.go
  - policy/signature.go
  - policy/verifying_loader.go
  - docs/POLICY_SIGNING.md
  - vault/keyring_security.go
autonomous: true
---

<objective>
Fix UAT-identified issues from v1.19 verification testing.

Purpose: Address security and reliability issues found during user acceptance testing.
Output: Code fixes for panic removal, constant-time comparison, enforce default flip, and runtime validation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@vault/config.go
@policy/signature.go
@policy/verifying_loader.go
@vault/keyring_security_test.go
</context>

<tasks>
<task type="auto">
  <name>Task 1: Remove panic() calls in vault/config.go</name>
  <files>vault/config.go</files>
  <action>
    Replace two panic(err) calls with proper error returns:

    1. Line 213 in ProfileSection method: Change `panic(err)` to `return Profile{}, err`
       - Update method signature from `func (c *Config) ProfileSection(name string) Profile`
         to `func (c *Config) ProfileSection(name string) (Profile, error)`

    2. Line 233 in SSOSessionSection method: Change `panic(err)` to `return SSOSession{}, err`
       - Update method signature from `func (c *Config) SSOSessionSection(name string) SSOSession`
         to `func (c *Config) SSOSessionSection(name string) (SSOSession, error)`

    3. Update all callers to handle the new error returns.

    Why: panic() crashes the entire server on malformed config. Error returns allow graceful handling and informative error messages.
  </action>
  <verify>
    - `go build ./...` succeeds
    - `go test ./vault/...` passes
    - Grep for `panic(` in vault/config.go returns no results
  </verify>
  <done>
    - ProfileSection returns (Profile, error)
    - SSOSessionSection returns (SSOSession, error)
    - All callers handle errors
    - No panic() calls remain in config.go
  </done>
</task>

<task type="auto">
  <name>Task 2: Add constant-time hash comparison in policy/signature.go</name>
  <files>policy/signature.go</files>
  <action>
    Fix timing-safe comparison in ValidateHash method at line 124:

    1. Add import for `crypto/subtle`
    2. Replace `return s.Metadata.PolicyHash == computedHash` with:
       ```go
       return subtle.ConstantTimeCompare([]byte(s.Metadata.PolicyHash), []byte(computedHash)) == 1
       ```

    Why: Using == for hash comparison leaks timing information. Defense-in-depth aligns with v1.16 security hardening.
  </action>
  <verify>
    - `go build ./...` succeeds
    - `go test ./policy/...` passes
    - `grep -n "subtle.ConstantTimeCompare" policy/signature.go` shows the fix
  </verify>
  <done>
    - ValidateHash uses subtle.ConstantTimeCompare
    - All existing tests pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Flip VerifyingLoader enforce default to true</name>
  <files>policy/verifying_loader.go</files>
  <action>
    Change default enforcement behavior:

    1. Line 63: Change `enforce: false` to `enforce: true`

    Why: Security by default. v1.* is alpha - breaking changes are expected. Invalid signatures should be rejected, not just logged.
  </action>
  <verify>
    - `go build ./...` succeeds
    - `go test ./policy/...` passes
    - `grep -n "enforce:" policy/verifying_loader.go` shows `enforce: true`
  </verify>
  <done>
    - Default is now enforce: true
    - Tests updated if needed
  </done>
</task>

<task type="auto">
  <name>Task 4: Update POLICY_SIGNING.md for new defaults</name>
  <files>docs/POLICY_SIGNING.md</files>
  <action>
    Update documentation to reflect new enforce default:

    1. Update any references that say enforce defaults to false
    2. Document that enforcement is now enabled by default
    3. Show how to disable enforcement if needed: WithEnforce(false)
    4. Remove any "migration path" or "v2.0" language - just document current behavior

    Why: Docs should reflect actual behavior. Enforcement enabled by default is the new normal.
  </action>
  <verify>
    - Documentation matches code behavior
    - No references to enforce defaulting to false
  </verify>
  <done>
    - Docs reflect enforce: true default
    - WithEnforce(false) documented for opt-out
  </done>
</task>

<task type="auto">
  <name>Task 5: Add keyring runtime validation</name>
  <files>vault/keyring_security.go</files>
  <action>
    Create new file vault/keyring_security.go with runtime validation for macOS keychain:

    1. Create ValidateKeychainSecurity() function that:
       - Checks if running on macOS (return nil early on other platforms)
       - Attempts to read sentinel's keychain item attributes
       - Warns if: application trust list allows other apps
       - Warns if: kSecAttrSynchronizable is true (iCloud sync enabled)
       - Returns []string of warnings (empty if secure)

    2. Call ValidateKeychainSecurity() during vault initialization (Open function)
       - Log warnings with `log.Printf("[SECURITY] %s", warning)` prefix
       - Do NOT fail - these are warnings for awareness

    3. Use the same security properties tested in keyring_security_test.go:
       - KeychainNotTrustApplication
       - KeychainNotSynchronizable

    Why: Runtime warnings help operators detect misconfigured keychains in production.
  </action>
  <verify>
    - `go build ./...` succeeds
    - `go test ./vault/...` passes
    - New file exists: vault/keyring_security.go
  </verify>
  <done>
    - ValidateKeychainSecurity() implemented
    - Called during vault initialization
    - Warnings logged for insecure configurations
    - No failures on non-macOS platforms
  </done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds without errors
- [ ] `go test ./...` passes all tests
- [ ] No panic() calls in vault/config.go
- [ ] Constant-time comparison used in policy/signature.go
- [ ] VerifyingLoader defaults to enforce: true
- [ ] Documentation updated
- [ ] Keyring validation runs at startup on macOS
</verification>

<success_criteria>
- All 5 tasks completed
- All verification checks pass
- No regressions introduced
- Build and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/143-uat-fixes/143-01-SUMMARY.md`
</output>
