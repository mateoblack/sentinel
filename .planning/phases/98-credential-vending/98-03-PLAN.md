---
phase: 98-credential-vending
plan: 03
type: execute
wave: 2
depends_on: ["98-01"]
files_modified: [docs/iam/LAMBDA_ROLES.md]
autonomous: true
---

<objective>
Create IAM role templates for Lambda TVM deployment.

Purpose: Provide ready-to-use IAM policy templates for Lambda execution role and protected role trust policies. Without these, deployers would have to figure out the minimum permissions themselves.
Output: Documentation with copy-paste IAM policies and trust policy templates.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference patterns:
@docs/iam/ENFORCEMENT.md
@docs/iam/ASSURANCE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Lambda IAM role documentation</name>
  <files>docs/iam/LAMBDA_ROLES.md</files>
  <action>
Create `docs/iam/LAMBDA_ROLES.md` with:

1. Overview section explaining:
   - Lambda TVM architecture (Lambda IS the trust boundary)
   - Why protected roles must ONLY trust Lambda execution role
   - How this prevents clients from bypassing policy enforcement

2. Lambda Execution Role section:
   ```markdown
   ## Lambda Execution Role

   The Lambda TVM needs an execution role with permissions to:
   - Assume protected roles (sts:AssumeRole)
   - Write logs (CloudWatch Logs)

   ### Minimum IAM Policy

   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Sid": "AssumeProtectedRoles",
         "Effect": "Allow",
         "Action": "sts:AssumeRole",
         "Resource": "arn:aws:iam::*:role/SentinelProtected-*",
         "Condition": {
           "StringEquals": {
             "sts:SourceIdentity": "sentinel:*"
           }
         }
       },
       {
         "Sid": "CloudWatchLogs",
         "Effect": "Allow",
         "Action": [
           "logs:CreateLogGroup",
           "logs:CreateLogStream",
           "logs:PutLogEvents"
         ],
         "Resource": "arn:aws:logs:*:*:log-group:/aws/lambda/sentinel-tvm*"
       }
     ]
   }
   ```

   ### Trust Policy (for Lambda)

   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Principal": {
           "Service": "lambda.amazonaws.com"
         },
         "Action": "sts:AssumeRole"
       }
     ]
   }
   ```
   ```

3. Protected Role Trust Policy section:
   ```markdown
   ## Protected Role Trust Policies

   Protected roles MUST only trust the Lambda execution role. This is the key security control that prevents clients from calling AssumeRole directly.

   ### Trust Policy Template

   Replace `LAMBDA_ROLE_ARN` with your Lambda execution role ARN.

   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Principal": {
           "AWS": "LAMBDA_ROLE_ARN"
         },
         "Action": "sts:AssumeRole",
         "Condition": {
           "StringLike": {
             "sts:SourceIdentity": "sentinel:*:*:*"
           }
         }
       }
     ]
   }
   ```

   ### SourceIdentity Condition

   The `sts:SourceIdentity` condition ensures only Sentinel-stamped credentials work:
   - Format: `sentinel:<user>:<approval-marker>:<request-id>`
   - Use `StringLike` with `sentinel:*:*:*` to match all Sentinel credentials
   - For approved-only access, use: `sentinel:*:????????:*` (8-char hex approval ID)
   ```

4. Naming Conventions section:
   ```markdown
   ## Naming Conventions

   Recommended naming for TVM-protected roles:
   - `SentinelProtected-<profile>` - Standard protected roles
   - `SentinelProtected-prod-admin` - Production admin role
   - `SentinelProtected-staging-dev` - Staging developer role

   This convention:
   - Clearly identifies Sentinel-managed roles
   - Enables wildcard policies on the Lambda execution role
   - Supports resource-based filtering in CloudTrail queries
   ```

5. Security Considerations section:
   - Why protected roles must NOT allow direct AssumeRole from users
   - How to audit existing trust policies
   - SCPs to block direct AssumeRole (reference Phase 101)

6. Terraform Example section (brief, full Terraform in Phase 102):
   ```hcl
   # Lambda execution role
   resource "aws_iam_role" "sentinel_tvm" {
     name = "SentinelTVMLambda"
     assume_role_policy = jsonencode({
       Version = "2012-10-17"
       Statement = [{
         Effect = "Allow"
         Principal = { Service = "lambda.amazonaws.com" }
         Action = "sts:AssumeRole"
       }]
     })
   }

   # Protected role (example)
   resource "aws_iam_role" "protected" {
     name = "SentinelProtected-prod-admin"
     assume_role_policy = jsonencode({
       Version = "2012-10-17"
       Statement = [{
         Effect = "Allow"
         Principal = { AWS = aws_iam_role.sentinel_tvm.arn }
         Action = "sts:AssumeRole"
         Condition = {
           StringLike = { "sts:SourceIdentity" = "sentinel:*:*:*" }
         }
       }]
     })
   }
   ```
  </action>
  <verify>
  - File exists at docs/iam/LAMBDA_ROLES.md
  - JSON policies are valid (check syntax)
  - All placeholders are clearly marked
  </verify>
  <done>
  - Lambda execution role policy documented
  - Protected role trust policy template documented
  - Naming conventions defined
  - Security considerations explained
  - Terraform example provided
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] docs/iam/LAMBDA_ROLES.md exists
- [ ] IAM policies have valid JSON syntax
- [ ] Trust policy enforces Lambda-only access
- [ ] SourceIdentity condition documented
</verification>

<success_criteria>

- Lambda execution role IAM policy documented
- Protected role trust policy template exists
- SourceIdentity condition explained
- Naming conventions defined
- Security considerations documented
</success_criteria>

<output>
After completion, create `.planning/phases/98-credential-vending/98-03-SUMMARY.md`
</output>
