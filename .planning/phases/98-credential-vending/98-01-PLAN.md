---
phase: 98-credential-vending
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [lambda/vend.go, lambda/vend_test.go]
autonomous: true
---

<objective>
Implement credential vending via STS AssumeRole with SourceIdentity stamping.

Purpose: Replace mock credentials with real STS AssumeRole calls that stamp SourceIdentity for CloudTrail correlation. This is the core TVM functionality.
Output: `lambda/vend.go` with `VendCredentials()` function and comprehensive unit tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/97-foundation/97-01-SUMMARY.md
@.planning/phases/97-foundation/97-02-SUMMARY.md

Existing patterns to reuse:
@sentinel/assume_role.go
@identity/types.go
@identity/request_id.go
@lambda/types.go
@lambda/handler.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create credential vending function</name>
  <files>lambda/vend.go</files>
  <action>
Create `lambda/vend.go` with the `VendCredentials()` function that:

1. Define `VendInput` struct:
   ```go
   type VendInput struct {
       Caller          *CallerIdentity  // From API Gateway IAM auth
       RoleARN         string           // Target role to assume
       SessionDuration time.Duration    // Requested duration (optional, default 1h)
       Region          string           // AWS region for STS endpoint
   }
   ```

2. Define `VendOutput` struct:
   ```go
   type VendOutput struct {
       Credentials    *TVMResponse              // AWS container credentials format
       SourceIdentity *identity.SourceIdentity  // For logging/correlation
   }
   ```

3. Implement `VendCredentials(ctx context.Context, input *VendInput) (*VendOutput, error)`:
   - Validate input (Caller and RoleARN required)
   - Extract username from CallerIdentity.UserARN using ARN parsing:
     - For IAM user: arn:aws:iam::123456789012:user/alice → "alice"
     - For assumed-role: arn:aws:sts::123456789012:assumed-role/RoleName/SessionName → "SessionName"
     - For SSO: arn:aws:sts::123456789012:assumed-role/AWSReservedSSO_PermissionSet_abc/user@example.com → "userexamplecom" (sanitized)
   - Generate request-id using `identity.NewRequestID()`
   - Create SourceIdentity using `identity.New(sanitizedUser, "", requestID)` (empty approval for direct access)
   - Create STS client using aws-sdk-go-v2 (NOT using vault.NewAwsConfigWithCredsProvider - Lambda uses execution role)
   - Call STS AssumeRole with:
     - RoleArn: input.RoleARN
     - RoleSessionName: fmt.Sprintf("tvm-%s-%s", sanitizedUser, requestID)
     - DurationSeconds: input.SessionDuration (default 1 hour)
     - SourceIdentity: sourceIdentity.Format()
   - Convert STS response to TVMResponse:
     - AccessKeyId, SecretAccessKey, Token from STS response
     - Expiration in RFC3339 format
   - Return VendOutput with credentials and SourceIdentity

4. Add helper function `extractUsername(userARN string) (string, error)`:
   - Parse ARN format: arn:aws:SERVICE:REGION:ACCOUNT:RESOURCE
   - Extract username based on resource type
   - Sanitize using `identity.SanitizeUser()`

5. Add interface for STS client to enable testing:
   ```go
   type STSClient interface {
       AssumeRole(ctx context.Context, params *sts.AssumeRoleInput, optFns ...func(*sts.Options)) (*sts.AssumeRoleOutput, error)
   }
   ```

6. Add `VendCredentialsWithClient()` variant that accepts STSClient for testing.

Import: github.com/aws/aws-sdk-go-v2/service/sts, github.com/aws/aws-sdk-go-v2/config, github.com/byteness/aws-vault/v7/identity
  </action>
  <verify>
  - `go build ./lambda/` compiles without errors
  - `gofmt -e lambda/vend.go` shows no syntax errors
  </verify>
  <done>
  - VendCredentials function exists with proper STS AssumeRole call
  - SourceIdentity stamping follows identity package format
  - Username extraction handles IAM user, assumed-role, SSO ARN formats
  - STSClient interface enables testing
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for credential vending</name>
  <files>lambda/vend_test.go</files>
  <action>
Create `lambda/vend_test.go` with comprehensive tests:

1. Create mock STS client:
   ```go
   type mockSTSClient struct {
       AssumeRoleFunc func(ctx context.Context, params *sts.AssumeRoleInput, optFns ...func(*sts.Options)) (*sts.AssumeRoleOutput, error)
   }
   ```

2. Test cases for `VendCredentials`:
   - `TestVendCredentials_Success`: Valid input returns credentials with correct format
   - `TestVendCredentials_MissingCaller`: Returns error when Caller is nil
   - `TestVendCredentials_MissingRoleARN`: Returns error when RoleARN is empty
   - `TestVendCredentials_STSError`: Propagates STS errors correctly
   - `TestVendCredentials_SourceIdentityFormat`: Validates SourceIdentity format (sentinel:user:direct:requestid)
   - `TestVendCredentials_DefaultDuration`: Uses 1 hour when SessionDuration is 0
   - `TestVendCredentials_CustomDuration`: Respects custom SessionDuration

3. Test cases for `extractUsername`:
   - `TestExtractUsername_IAMUser`: arn:aws:iam::123456789012:user/alice → "alice"
   - `TestExtractUsername_AssumedRole`: arn:aws:sts::123456789012:assumed-role/Role/Session → "Session"
   - `TestExtractUsername_SSOUser`: arn:aws:sts::123456789012:assumed-role/AWSReservedSSO_.../user@example.com → "userexamplecom"
   - `TestExtractUsername_FederatedUser`: arn:aws:sts::123456789012:federated-user/fed-user → "feduser"
   - `TestExtractUsername_InvalidARN`: Returns error for malformed ARN
   - `TestExtractUsername_EmptyARN`: Returns error for empty ARN

4. Test credential format:
   - `TestVendOutput_CredentialFormat`: Verify TVMResponse has correct JSON field names
   - `TestVendOutput_ExpirationFormat`: Verify Expiration is RFC3339

Use table-driven tests where appropriate. Verify the mock receives correct SourceIdentity in AssumeRoleInput.
  </action>
  <verify>
  - `gofmt -e lambda/vend_test.go` shows no syntax errors
  - Test file compiles with `go build ./lambda/`
  </verify>
  <done>
  - Mock STS client enables unit testing without AWS calls
  - All username extraction patterns tested
  - SourceIdentity format validated in tests
  - Error cases covered
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./lambda/` compiles without errors
- [ ] `gofmt -e lambda/*.go` shows no syntax errors
- [ ] VendCredentials function follows existing SentinelAssumeRole pattern
- [ ] SourceIdentity format matches identity package (sentinel:user:direct:requestid)
</verification>

<success_criteria>

- VendCredentials function exists with STS AssumeRole integration
- SourceIdentity stamping uses identity package format
- Username extraction handles all AWS identity types
- Unit tests cover success and error paths
- STSClient interface enables mock injection
</success_criteria>

<output>
After completion, create `.planning/phases/98-credential-vending/98-01-SUMMARY.md`
</output>
