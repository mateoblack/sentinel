---
phase: 98-credential-vending
plan: 02
type: execute
wave: 2
depends_on: ["98-01"]
files_modified: [lambda/handler.go, lambda/handler_test.go]
autonomous: true
---

<objective>
Integrate VendCredentials into Lambda handler, replacing mock credentials with real STS calls.

Purpose: Wire the credential vending function into the Lambda handler so API Gateway requests result in real AWS credentials.
Output: Updated handler that calls VendCredentials and returns real credentials.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/98-credential-vending/98-01-SUMMARY.md

Files to update:
@lambda/handler.go
@lambda/handler_test.go
@lambda/vend.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate VendCredentials into handler</name>
  <files>lambda/handler.go</files>
  <action>
Update `lambda/handler.go` to use VendCredentials:

1. Update Handler struct to include configuration:
   ```go
   type Handler struct {
       STSClient STSClient  // STS client (nil = use default from Lambda execution role)
       Region    string     // AWS region for STS endpoint (defaults to AWS_REGION env var)
   }
   ```

2. Update `NewHandler()` to accept optional configuration:
   ```go
   type HandlerConfig struct {
       STSClient STSClient  // Optional: custom STS client for testing
       Region    string     // Optional: AWS region (defaults to AWS_REGION)
   }

   func NewHandler(cfg *HandlerConfig) *Handler {
       h := &Handler{}
       if cfg != nil {
           h.STSClient = cfg.STSClient
           h.Region = cfg.Region
       }
       if h.Region == "" {
           h.Region = os.Getenv("AWS_REGION")
       }
       return h
   }
   ```

3. Update `HandleRequest()` to call VendCredentials:
   - Extract caller identity (existing code)
   - Parse profile parameter (existing code)
   - Build RoleARN from profile (for now, use profile directly as RoleARN - Phase 100 will add profile lookup)
   - Parse optional `duration` query parameter (e.g., `?profile=xxx&duration=900` for 15 min)
   - Call VendCredentials (or VendCredentialsWithClient if STSClient is set)
   - Return credentials on success
   - Return appropriate error codes:
     - 403 for IAM auth missing
     - 400 for missing/invalid profile
     - 400 for invalid duration
     - 500 for STS errors (with generic message, don't leak details)

4. Add helper for duration parsing:
   ```go
   func parseDuration(durationStr string) (time.Duration, error)
   ```
   - Empty string → return 0 (use default)
   - Parse as seconds (integer)
   - Validate: 900 ≤ duration ≤ 43200 (AWS limits: 15 min to 12 hours)

5. Remove mock credential code (the TODO comment and mock response).

6. Add logging:
   - Log successful credential issuance (profile, caller account, source identity request-id)
   - Do NOT log credentials or full ARNs

Import: os, strconv
  </action>
  <verify>
  - `go build ./lambda/` compiles without errors
  - Mock credential code removed
  - Handler uses VendCredentials
  </verify>
  <done>
  - Handler calls VendCredentials instead of returning mocks
  - Duration parameter supported with validation
  - Error codes match specification
  - Logging added for observability
  </done>
</task>

<task type="auto">
  <name>Task 2: Update handler tests for real credential flow</name>
  <files>lambda/handler_test.go</files>
  <action>
Update `lambda/handler_test.go` to test the integrated flow:

1. Update existing tests to use mock STS client:
   - Create mock that returns valid credentials
   - Inject via HandlerConfig

2. Add/update test cases:
   - `TestHandleRequest_Success`: With mock STS, returns credentials in correct format
   - `TestHandleRequest_WithDuration`: Duration parameter passed to STS
   - `TestHandleRequest_InvalidDuration_TooShort`: duration < 900 returns 400
   - `TestHandleRequest_InvalidDuration_TooLong`: duration > 43200 returns 400
   - `TestHandleRequest_InvalidDuration_NotNumber`: Non-numeric duration returns 400
   - `TestHandleRequest_STSError`: STS failure returns 500 with safe message
   - `TestHandleRequest_SourceIdentityInSTSCall`: Verify mock receives correct SourceIdentity format

3. Keep existing tests:
   - `TestHandleRequest_MissingIAMAuth` (403)
   - `TestHandleRequest_MissingProfile` (400)

4. Test handler configuration:
   - `TestNewHandler_DefaultRegion`: Uses AWS_REGION env var
   - `TestNewHandler_CustomRegion`: Uses provided region
   - `TestNewHandler_CustomSTSClient`: Uses provided client

5. Verify credential response format:
   - AccessKeyId, SecretAccessKey, Token, Expiration present
   - Expiration is valid RFC3339 timestamp
  </action>
  <verify>
  - `gofmt -e lambda/handler_test.go` shows no syntax errors
  - All tests compile with `go build ./lambda/`
  </verify>
  <done>
  - Handler tests use mock STS client
  - Duration validation tested
  - STS error handling tested
  - SourceIdentity passed to STS correctly
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./lambda/` compiles without errors
- [ ] `gofmt -e lambda/*.go` shows no syntax errors
- [ ] No mock credentials remain in handler
- [ ] Handler properly calls VendCredentials
</verification>

<success_criteria>

- Handler uses VendCredentials for real STS calls
- Duration parameter support with AWS-compliant validation
- Error codes follow specification (403, 400, 500)
- Tests use mock STS client for isolation
- Logging provides observability without leaking secrets
</success_criteria>

<output>
After completion, create `.planning/phases/98-credential-vending/98-02-SUMMARY.md`
</output>
