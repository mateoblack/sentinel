---
phase: 70-identity-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [identity/aws_identity.go, identity/aws_identity_test.go, cli/credentials.go, cli/credentials_test.go, cli/sentinel_exec.go, cli/sentinel_exec_test.go]
autonomous: true
---

<objective>
Replace OS username (user.Current()) with AWS identity extraction in the credential flow.

Purpose: Fix critical security bug where policy evaluation uses OS username instead of AWS-authenticated identity, allowing potential policy bypass when usernames differ.

Output: Updated credentials.go and sentinel_exec.go using AWS identity for policy evaluation, with a new GetAWSUsername helper in the identity package.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 69 summary - ARN parsing foundation
@.planning/phases/69-aws-identity-core/69-01-SUMMARY.md

# Existing identity package with ParseARN
@identity/aws_identity.go

# Files to modify
@cli/credentials.go
@cli/sentinel_exec.go

# Pattern for STS GetCallerIdentity usage
@permissions/checker.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GetAWSUsername helper to identity package</name>
  <files>identity/aws_identity.go, identity/aws_identity_test.go</files>
  <action>
Add to `identity/aws_identity.go`:

1. **STSAPI interface** for testability:
```go
// STSAPI defines the STS operations needed for identity extraction.
type STSAPI interface {
    GetCallerIdentity(ctx context.Context, params *sts.GetCallerIdentityInput, optFns ...func(*sts.Options)) (*sts.GetCallerIdentityOutput, error)
}
```

2. **GetAWSUsername function**:
```go
// GetAWSUsername retrieves the AWS-authenticated username for policy evaluation.
// It calls STS GetCallerIdentity and extracts the username from the ARN.
// Returns the sanitized username suitable for policy matching.
func GetAWSUsername(ctx context.Context, stsClient STSAPI) (string, error) {
    identity, err := stsClient.GetCallerIdentity(ctx, &sts.GetCallerIdentityInput{})
    if err != nil {
        return "", fmt.Errorf("failed to get caller identity: %w", err)
    }

    arn := aws.ToString(identity.Arn)
    if arn == "" {
        return "", errors.New("GetCallerIdentity returned empty ARN")
    }

    return ExtractUsername(arn)
}
```

3. **GetAWSIdentity function** (returns full identity for future use):
```go
// GetAWSIdentity retrieves the full AWS identity information.
// It calls STS GetCallerIdentity and parses the ARN.
func GetAWSIdentity(ctx context.Context, stsClient STSAPI) (*AWSIdentity, error) {
    identity, err := stsClient.GetCallerIdentity(ctx, &sts.GetCallerIdentityInput{})
    if err != nil {
        return nil, fmt.Errorf("failed to get caller identity: %w", err)
    }

    arn := aws.ToString(identity.Arn)
    if arn == "" {
        return nil, errors.New("GetCallerIdentity returned empty ARN")
    }

    return ParseARN(arn)
}
```

Add imports:
```go
import (
    "context"
    "github.com/aws/aws-sdk-go-v2/aws"
    "github.com/aws/aws-sdk-go-v2/service/sts"
)
```

Add tests to `identity/aws_identity_test.go`:

1. **Mock STS client** following testutil/mock_aws.go pattern:
```go
type mockSTSClient struct {
    GetCallerIdentityFunc func(ctx context.Context, params *sts.GetCallerIdentityInput, optFns ...func(*sts.Options)) (*sts.GetCallerIdentityOutput, error)
}

func (m *mockSTSClient) GetCallerIdentity(ctx context.Context, params *sts.GetCallerIdentityInput, optFns ...func(*sts.Options)) (*sts.GetCallerIdentityOutput, error) {
    if m.GetCallerIdentityFunc != nil {
        return m.GetCallerIdentityFunc(ctx, params, optFns...)
    }
    return &sts.GetCallerIdentityOutput{}, nil
}
```

2. **TestGetAWSUsername** with table-driven tests:
   - IAM user ARN → returns sanitized username
   - SSO assumed-role ARN → returns sanitized email
   - Regular assumed-role ARN → returns session name
   - Empty ARN → returns error
   - GetCallerIdentity error → propagates error

3. **TestGetAWSIdentity** with similar cases returning full AWSIdentity struct

Pattern: Follow permissions/checker.go and testutil/mock_aws.go patterns for STS interface and mocking.
  </action>
  <verify>go test ./identity/... -v -run "GetAWS" passes all new tests</verify>
  <done>GetAWSUsername and GetAWSIdentity functions exist with STSAPI interface, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Update credentials.go to use AWS identity</name>
  <files>cli/credentials.go, cli/credentials_test.go</files>
  <action>
Modify `cli/credentials.go`:

1. **Add STSClient field to CredentialsCommandInput** for testing:
```go
type CredentialsCommandInput struct {
    // ... existing fields ...
    STSClient identity.STSAPI // Optional: for testing (nil = create from AWS config)
}
```

2. **Replace user.Current() with GetAWSUsername** at line ~122:

BEFORE:
```go
// 1. Get current user
currentUser, err := user.Current()
if err != nil {
    fmt.Fprintf(os.Stderr, "Failed to get current user: %v\n", err)
    return err
}
username := currentUser.Username
```

AFTER:
```go
// 1. Create AWS config for SSM (moved up - needed for identity)
awsCfgOpts := []func(*config.LoadOptions) error{}
if input.Region != "" {
    awsCfgOpts = append(awsCfgOpts, config.WithRegion(input.Region))
}
awsCfg, err := config.LoadDefaultConfig(ctx, awsCfgOpts...)
if err != nil {
    configErr := sentinelerrors.New(
        sentinelerrors.ErrCodeConfigMissingCredentials,
        fmt.Sprintf("Failed to load AWS config: %v", err),
        sentinelerrors.GetSuggestion(sentinelerrors.ErrCodeConfigMissingCredentials),
        err,
    )
    FormatErrorWithSuggestionTo(stderr, configErr)
    return configErr
}

// 2. Get AWS identity for policy evaluation
stsClient := input.STSClient
if stsClient == nil {
    stsClient = sts.NewFromConfig(awsCfg)
}
username, err := identity.GetAWSUsername(ctx, stsClient)
if err != nil {
    identityErr := sentinelerrors.New(
        sentinelerrors.ErrCodeSTSError,
        fmt.Sprintf("Failed to get AWS identity: %v", err),
        "Ensure your AWS credentials are valid and have sts:GetCallerIdentity permission",
        err,
    )
    FormatErrorWithSuggestionTo(stderr, identityErr)
    return identityErr
}
```

3. **Remove duplicate AWS config loading** (it was at step 2, now moved to step 1)

4. **Update imports** - remove "os/user", add sts import

5. **Add testable version for credential tests**:
```go
// testableCredentialsCommand is for testing with mock STS client
func testableCredentialsCommand(ctx context.Context, input CredentialsCommandInput, s *Sentinel) error {
    // Same as CredentialsCommand but uses input.STSClient
    return CredentialsCommand(ctx, input, s)
}
```

Update tests in `cli/credentials_test.go` (or create if doesn't exist):
- Add tests verifying AWS identity is used instead of OS username
- Use mock STS client returning various ARN types
- Verify policy evaluation uses AWS username not OS username
  </action>
  <verify>go build ./cli/... succeeds; go test ./cli/... -run "Credential" passes</verify>
  <done>credentials.go uses AWS identity for policy evaluation, existing tests updated</done>
</task>

<task type="auto">
  <name>Task 3: Update sentinel_exec.go to use AWS identity</name>
  <files>cli/sentinel_exec.go, cli/sentinel_exec_test.go</files>
  <action>
Modify `cli/sentinel_exec.go`:

1. **Add STSClient field to SentinelExecCommandInput** for testing:
```go
type SentinelExecCommandInput struct {
    // ... existing fields ...
    STSClient identity.STSAPI // Optional: for testing (nil = create from AWS config)
}
```

2. **Replace user.Current() with GetAWSUsername** at line ~120:

BEFORE:
```go
// 2. Get current user
currentUser, err := user.Current()
if err != nil {
    fmt.Fprintf(os.Stderr, "Failed to get current user: %v\n", err)
    return 1, err
}
username := currentUser.Username
```

AFTER:
```go
// 2. Create AWS config for SSM (moved up - needed for identity)
awsCfgOpts := []func(*config.LoadOptions) error{}
if input.Region != "" {
    awsCfgOpts = append(awsCfgOpts, config.WithRegion(input.Region))
}
awsCfg, err := config.LoadDefaultConfig(ctx, awsCfgOpts...)
if err != nil {
    configErr := sentinelerrors.New(
        sentinelerrors.ErrCodeConfigMissingCredentials,
        fmt.Sprintf("Failed to load AWS config: %v", err),
        sentinelerrors.GetSuggestion(sentinelerrors.ErrCodeConfigMissingCredentials),
        err,
    )
    FormatErrorWithSuggestion(configErr)
    return 1, configErr
}

// 3. Get AWS identity for policy evaluation
stsClient := input.STSClient
if stsClient == nil {
    stsClient = sts.NewFromConfig(awsCfg)
}
username, err := identity.GetAWSUsername(ctx, stsClient)
if err != nil {
    identityErr := sentinelerrors.New(
        sentinelerrors.ErrCodeSTSError,
        fmt.Sprintf("Failed to get AWS identity: %v", err),
        "Ensure your AWS credentials are valid and have sts:GetCallerIdentity permission",
        err,
    )
    FormatErrorWithSuggestion(identityErr)
    return 1, identityErr
}
```

3. **Remove duplicate AWS config loading** (it was at step 3, now moved to step 2)

4. **Update imports** - remove "os/user", add sts import

5. **Renumber subsequent steps** in comments (policy loader, etc.)

Note: The logger creation (step 1) stays at the top since it doesn't need AWS config.

Update tests in `cli/sentinel_exec_test.go`:
- Update existing tests that mock user.Current() to use mock STS instead
- Verify policy evaluation uses AWS username
  </action>
  <verify>go build ./cli/... succeeds; go test ./cli/... -run "SentinelExec" passes</verify>
  <done>sentinel_exec.go uses AWS identity for policy evaluation, existing tests updated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `go test ./identity/...` passes all tests including new GetAWSUsername tests
- [ ] `go test ./cli/...` passes all tests
- [ ] `go test ./... -cover` shows coverage maintained
- [ ] `golangci-lint run ./identity/... ./cli/...` shows no new errors
- [ ] Verify user.Current() is no longer used in credentials.go or sentinel_exec.go
</verification>

<success_criteria>
- All tasks completed
- credentials.go and sentinel_exec.go use identity.GetAWSUsername() instead of user.Current()
- Policy evaluation now based on AWS identity, fixing the security vulnerability
- All existing tests pass or are updated to use mock STS
- New GetAWSUsername helper is fully tested
- No regressions in credential issuance flow
</success_criteria>

<output>
After completion, create `.planning/phases/70-identity-integration/70-01-SUMMARY.md`
</output>
