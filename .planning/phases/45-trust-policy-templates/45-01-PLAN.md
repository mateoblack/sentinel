---
phase: 45-trust-policy-templates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [enforce/generate.go, enforce/generate_test.go, cli/enforce_generate.go, cli/enforce_generate_test.go, cmd/sentinel/main.go]
autonomous: true
---

<objective>
Generate ready-to-use IAM trust policy JSON snippets with SourceIdentity conditions.

Purpose: Users running `sentinel enforce plan` see recommendations like "Add StringLike condition for sts:SourceIdentity". This command generates the actual trust policy JSON they can apply.
Output: `sentinel enforce generate trust-policy` command with Pattern A/B/C templates from ENFORCEMENT.md
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/43-enforcement-types/43-02-SUMMARY.md
@.planning/phases/44-enforcement-advisor/44-01-SUMMARY.md

@enforce/types.go
@enforce/analyze.go
@cli/enforce.go
@docs/ENFORCEMENT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trust policy template generator</name>
  <files>enforce/generate.go, enforce/generate_test.go</files>
  <action>
Create trust policy generator in enforce package.

**Types:**
```go
// TrustPolicyPattern represents the three documented patterns from ENFORCEMENT.md
type TrustPolicyPattern string

const (
    PatternA TrustPolicyPattern = "any-sentinel"    // Any Sentinel-issued credentials
    PatternB TrustPolicyPattern = "specific-users"  // Sentinel + specific users
    PatternC TrustPolicyPattern = "migration"       // Sentinel OR legacy (migration period)
)

// GenerateInput contains options for trust policy generation
type GenerateInput struct {
    Pattern        TrustPolicyPattern
    PrincipalARN   string   // Required: e.g., "arn:aws:iam::123456789012:root"
    Users          []string // Pattern B only: usernames to allow (e.g., ["alice", "bob"])
    LegacyPrincipal string  // Pattern C only: legacy principal ARN to include
}

// GenerateOutput contains the generated trust policy
type GenerateOutput struct {
    Pattern TrustPolicyPattern     `json:"pattern"`
    Policy  *TrustPolicyDocument   `json:"policy"`
}
```

**Functions:**
- `GenerateTrustPolicy(input GenerateInput) (*GenerateOutput, error)` - main generator
- Validate input: Pattern required, PrincipalARN required, Users required for Pattern B, LegacyPrincipal required for Pattern C
- Return error for invalid combinations (e.g., Users with Pattern A)

**Pattern A output (any Sentinel):**
```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Sid": "AllowSentinelAccess",
    "Effect": "Allow",
    "Principal": {"AWS": "<principal>"},
    "Action": "sts:AssumeRole",
    "Condition": {
      "StringLike": {"sts:SourceIdentity": "sentinel:*"}
    }
  }]
}
```

**Pattern B output (specific users):**
```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Sid": "AllowSentinelUsers",
    "Effect": "Allow",
    "Principal": {"AWS": "<principal>"},
    "Action": "sts:AssumeRole",
    "Condition": {
      "StringLike": {"sts:SourceIdentity": ["sentinel:alice:*", "sentinel:bob:*"]}
    }
  }]
}
```

**Pattern C output (migration):**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowSentinelAccess",
      "Effect": "Allow",
      "Principal": {"AWS": "<principal>"},
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringLike": {"sts:SourceIdentity": "sentinel:*"}
      }
    },
    {
      "Sid": "AllowLegacyAccess",
      "Effect": "Allow",
      "Principal": {"AWS": "<legacy-principal>"},
      "Action": "sts:AssumeRole"
    }
  ]
}
```

**Tests:**
- Pattern A generates correct JSON structure
- Pattern B generates user-specific patterns from Users list
- Pattern C generates both Sentinel and legacy statements
- Validation: Pattern required error
- Validation: PrincipalARN required error
- Validation: Users required for Pattern B
- Validation: LegacyPrincipal required for Pattern C
- Validation: Users not allowed for Pattern A (warn or ignore, don't error)
  </action>
  <verify>go test ./enforce/... -run TestGenerate -v passes</verify>
  <done>GenerateTrustPolicy produces correct JSON for all three patterns with validation</done>
</task>

<task type="auto">
  <name>Task 2: Create sentinel enforce generate trust-policy CLI command</name>
  <files>cli/enforce_generate.go, cli/enforce_generate_test.go, cmd/sentinel/main.go</files>
  <action>
Add `generate trust-policy` subcommand under the existing `enforce` command group.

**Command structure:**
```
sentinel enforce generate trust-policy --pattern <pattern> --principal <arn> [--users <user>...] [--legacy-principal <arn>]
```

**Flags:**
- `--pattern` (required): One of "any-sentinel", "specific-users", "migration"
- `--principal` (required): Principal ARN (e.g., "arn:aws:iam::123456789012:root")
- `--users` (repeatable): Usernames for Pattern B (e.g., --users alice --users bob)
- `--legacy-principal`: Legacy principal ARN for Pattern C

**Implementation:**
1. Create `EnforceGenerateTrustPolicyCommandInput` struct
2. Create `ConfigureEnforceGenerateTrustPolicyCommand` function
   - Add under existing `enforce` command (from cli/enforce.go)
   - Create `generate` subcommand under enforce
   - Create `trust-policy` subcommand under generate
3. Create `EnforceGenerateTrustPolicyCommand` function
   - Validate flags
   - Call `enforce.GenerateTrustPolicy`
   - Output JSON with indentation to stdout

**Output format (always JSON):**
Pretty-printed trust policy JSON that can be directly used with `aws iam update-assume-role-policy --policy-document`.

**Wire in main.go:**
Add `ConfigureEnforceGenerateTrustPolicyCommand(app, sentinel)` after the existing enforce plan command.

**Tests:**
- Pattern A: generates correct output
- Pattern B: generates correct output with multiple users
- Pattern C: generates correct output with legacy principal
- Error: missing --pattern flag
- Error: missing --principal flag
- Error: Pattern B without --users
- Error: Pattern C without --legacy-principal
  </action>
  <verify>go build ./cmd/sentinel && ./sentinel enforce generate trust-policy --help shows all flags</verify>
  <done>Command generates trust policy JSON, all flag combinations work correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test ./enforce/... -v passes
- [ ] go test ./cli/... -run TestEnforceGenerate -v passes
- [ ] go build ./cmd/sentinel succeeds
- [ ] `sentinel enforce generate trust-policy --pattern any-sentinel --principal arn:aws:iam::123456789012:root` outputs valid JSON
- [ ] `sentinel enforce generate trust-policy --pattern specific-users --principal arn:aws:iam::123456789012:root --users alice --users bob` includes user-specific patterns
- [ ] `sentinel enforce generate trust-policy --pattern migration --principal arn:aws:iam::123456789012:root --legacy-principal arn:aws:iam::123456789012:role/Legacy` includes both statements
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Trust policy generator produces correct JSON for all three patterns
- CLI command provides ready-to-use output for AWS IAM
</success_criteria>

<output>
After completion, create `.planning/phases/45-trust-policy-templates/45-01-SUMMARY.md`
</output>
