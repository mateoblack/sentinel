---
phase: 14-enhanced-decision-logging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [logging/decision.go, logging/decision_test.go]
autonomous: true
---

<objective>
Add new fields to DecisionLogEntry for enhanced CloudTrail correlation.

Purpose: Enable correlation between Sentinel decision logs and CloudTrail events by including request-id, source-identity, role-arn, and session-duration in decision logs.
Output: Extended DecisionLogEntry struct with new fields and updated constructor.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-source-identity-schema/09-01-SUMMARY.md

@logging/decision.go
@identity/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend DecisionLogEntry with new fields</name>
  <files>logging/decision.go</files>
  <action>
Add four new fields to DecisionLogEntry struct:
- `RequestID string json:"request_id,omitempty"` - 8-char hex request identifier
- `SourceIdentity string json:"source_identity,omitempty"` - Full sentinel:user:request-id string
- `RoleARN string json:"role_arn,omitempty"` - Target role ARN if applicable
- `SessionDuration int json:"session_duration_seconds,omitempty"` - Session duration in seconds

These fields are optional (omitempty) because:
- Denied requests won't have SourceIdentity/RoleARN
- Profiles without role_arn won't have SourceIdentity
- The fields are populated when credentials are actually issued

Do NOT modify NewDecisionLogEntry yet - that's Task 2.
  </action>
  <verify>go build ./logging/... compiles without errors</verify>
  <done>DecisionLogEntry struct has RequestID, SourceIdentity, RoleARN, SessionDuration fields</done>
</task>

<task type="auto">
  <name>Task 2: Create EnhancedDecisionLogEntry constructor</name>
  <files>logging/decision.go</files>
  <action>
Create a new constructor function that extends the base entry with credential-issuance fields:

```go
// CredentialIssuanceFields contains fields populated when credentials are issued.
type CredentialIssuanceFields struct {
    RequestID       string
    SourceIdentity  string // Full sentinel:user:request-id string
    RoleARN         string
    SessionDuration time.Duration
}

// NewEnhancedDecisionLogEntry creates a DecisionLogEntry with credential issuance details.
// Use this when credentials are being issued (allow decisions with credential context).
func NewEnhancedDecisionLogEntry(req *policy.Request, decision policy.Decision, policyPath string, creds *CredentialIssuanceFields) DecisionLogEntry
```

Implementation:
1. Call existing NewDecisionLogEntry to get base entry
2. If creds is not nil, populate the new fields:
   - entry.RequestID = creds.RequestID
   - entry.SourceIdentity = creds.SourceIdentity
   - entry.RoleARN = creds.RoleARN
   - entry.SessionDuration = int(creds.SessionDuration.Seconds()) if > 0
3. Return the entry

Keep NewDecisionLogEntry unchanged for backward compatibility (deny decisions, simple cases).
  </action>
  <verify>go build ./logging/... compiles without errors</verify>
  <done>NewEnhancedDecisionLogEntry function exists and returns DecisionLogEntry with all fields populated</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for enhanced logging</name>
  <files>logging/decision_test.go</files>
  <action>
Add tests following existing test patterns in logging/decision_test.go:

1. Test NewEnhancedDecisionLogEntry with all fields populated:
   - Verify RequestID, SourceIdentity, RoleARN, SessionDuration are set
   - Verify base fields (Timestamp, User, Profile, etc.) are also set

2. Test NewEnhancedDecisionLogEntry with nil creds:
   - Verify it works like NewDecisionLogEntry (backward compat)
   - Verify new fields are empty/zero

3. Test JSON marshaling includes new fields when present:
   - Marshal entry with all fields, verify JSON has request_id, source_identity, role_arn, session_duration_seconds
   - Marshal entry without creds, verify new fields are omitted (omitempty)

4. Test omitempty behavior:
   - Entry with only some fields populated marshals correctly
   - Empty strings and zero values are omitted from JSON
  </action>
  <verify>go test ./logging/... -v passes all tests</verify>
  <done>Tests cover NewEnhancedDecisionLogEntry with full fields, nil creds, and JSON marshaling</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `go test ./logging/...` passes
- [ ] DecisionLogEntry has RequestID, SourceIdentity, RoleARN, SessionDuration fields
- [ ] NewEnhancedDecisionLogEntry accepts credential context
- [ ] JSON output includes new fields when populated
</verification>

<success_criteria>

- All tasks completed
- logging package builds and tests pass
- DecisionLogEntry struct extended with correlation fields
- NewEnhancedDecisionLogEntry constructor available for CLI commands
</success_criteria>

<output>
After completion, create `.planning/phases/14-enhanced-decision-logging/14-01-SUMMARY.md`
</output>
