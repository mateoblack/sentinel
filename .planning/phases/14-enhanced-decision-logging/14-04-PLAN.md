---
phase: 14-enhanced-decision-logging
plan: 04
type: execute
wave: 3
depends_on: ["14-02", "14-03"]
files_modified: [cli/credentials_test.go, cli/sentinel_exec_test.go, sentinel/provider_test.go]
autonomous: true
---

<objective>
Add integration tests for enhanced decision logging across CLI commands.

Purpose: Verify enhanced logging works correctly in credentials and exec commands, ensuring correlation fields are populated.
Output: Tests covering enhanced logging for allow decisions and backward compatibility for deny decisions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-enhanced-decision-logging/14-02-SUMMARY.md
@.planning/phases/14-enhanced-decision-logging/14-03-SUMMARY.md

@cli/credentials_test.go
@cli/sentinel_exec_test.go
@sentinel/provider_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tests for TwoHopCredentialProvider RequestID handling</name>
  <files>sentinel/provider_test.go</files>
  <action>
Add tests to sentinel/provider_test.go for RequestID behavior:

1. Test Retrieve with pre-provided RequestID:
   - Create TwoHopCredentialProvider with Input.RequestID = "abc12345"
   - Call Retrieve (may need mock or skip if requires real AWS)
   - Verify LastSourceIdentity contains the provided request-id

2. Test Retrieve without RequestID (auto-generation):
   - Create TwoHopCredentialProvider without RequestID
   - Verify LastSourceIdentity is populated after Retrieve
   - Verify request-id is 8 hex characters

If provider tests require mock STS, document the test approach:
- Unit test: Verify Input.RequestID is used when provided
- Integration test: Verify full flow (may require real AWS or extensive mocking)

Focus on unit-level validation that can run without AWS credentials.
  </action>
  <verify>go test ./sentinel/... passes</verify>
  <done>Tests verify RequestID field handling in TwoHopCredentialProvider</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for SentinelCredentialResult fields</name>
  <files>cli/sentinel_provider_test.go</files>
  <action>
Add tests to cli/sentinel_provider_test.go for new result fields:

1. Test SentinelCredentialRequest has RequestID field:
   - Create request with RequestID set
   - Verify it compiles and field is accessible

2. Test SentinelCredentialResult has SourceIdentity and RoleARN fields:
   - Create result with all fields populated
   - Verify fields are accessible and correctly typed

These are structural tests ensuring the types are correct. Functional tests would require mocking GetCredentialsWithSourceIdentity.
  </action>
  <verify>go test ./cli/... passes</verify>
  <done>Tests verify SentinelCredentialRequest.RequestID and SentinelCredentialResult.SourceIdentity/RoleARN fields</done>
</task>

<task type="auto">
  <name>Task 3: Add logging verification tests</name>
  <files>logging/decision_test.go</files>
  <action>
Extend logging/decision_test.go with integration-style tests:

1. Test JSON output format for enhanced entry:
   - Create entry via NewEnhancedDecisionLogEntry with all fields
   - Marshal to JSON
   - Verify JSON contains: "request_id", "source_identity", "role_arn", "session_duration_seconds"
   - Verify values match input

2. Test JSON output for basic entry (deny case):
   - Create entry via NewDecisionLogEntry
   - Marshal to JSON
   - Verify JSON does NOT contain: "request_id", "source_identity", "role_arn", "session_duration_seconds" (omitempty)

3. Test JSON output for partial credential fields:
   - Create entry with only RequestID (no SourceIdentity)
   - Verify only request_id appears in JSON
   - This tests omitempty behavior for individual fields
  </action>
  <verify>go test ./logging/... -v passes</verify>
  <done>Tests verify JSON serialization of enhanced log entries</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test ./...` passes all tests
- [ ] sentinel/provider_test.go covers RequestID handling
- [ ] cli/sentinel_provider_test.go covers new result fields
- [ ] logging/decision_test.go covers JSON serialization
</verification>

<success_criteria>

- All tasks completed
- All tests pass
- Test coverage for new fields and enhanced logging path
</success_criteria>

<output>
After completion, create `.planning/phases/14-enhanced-decision-logging/14-04-SUMMARY.md`
</output>
