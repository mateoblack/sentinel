---
phase: 14-enhanced-decision-logging
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified: [cli/sentinel_provider.go, cli/credentials.go, cli/sentinel_exec.go]
autonomous: true
---

<objective>
Integrate enhanced decision logging into CLI commands with SourceIdentity correlation.

Purpose: Generate request-id before credential retrieval so decision logs can be correlated with CloudTrail events via SourceIdentity.
Output: credentials and exec commands log enhanced decision entries with request-id, source-identity, role-arn when issuing credentials.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-enhanced-decision-logging/14-01-SUMMARY.md

@cli/credentials.go
@cli/sentinel_exec.go
@cli/sentinel_provider.go
@logging/decision.go
@identity/request_id.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RequestID to SentinelCredentialRequest and return SourceIdentity</name>
  <files>cli/sentinel_provider.go</files>
  <action>
Modify SentinelCredentialRequest and SentinelCredentialResult to support request-id flow:

1. Add field to SentinelCredentialRequest:
   - `RequestID string` - Pre-generated request-id to use (if empty, will be generated)

2. Add field to SentinelCredentialResult:
   - `SourceIdentity string` - Full source identity string used (empty if no role assumption)
   - `RoleARN string` - Role ARN assumed (empty if no role assumption)

3. Modify GetCredentialsWithSourceIdentity:
   - If req.RequestID is empty, generate one with identity.NewRequestID()
   - Pass the request-id to TwoHopCredentialProvider (need to modify TwoHopCredentialProviderInput to accept RequestID)
   - Populate result.SourceIdentity with the full sentinel:user:request-id string
   - Populate result.RoleARN from config.RoleARN

4. For the GetCredentials path (no role assumption):
   - Leave SourceIdentity and RoleARN empty in result

Import identity package for NewRequestID if not already imported.
  </action>
  <verify>go build ./cli/... compiles without errors</verify>
  <done>SentinelCredentialResult includes SourceIdentity and RoleARN fields populated after credential retrieval</done>
</task>

<task type="auto">
  <name>Task 2: Modify TwoHopCredentialProvider to accept pre-generated RequestID</name>
  <files>sentinel/provider.go</files>
  <action>
Update TwoHopCredentialProviderInput and Retrieve method to accept optional pre-generated RequestID:

1. Add field to TwoHopCredentialProviderInput:
   - `RequestID string` - Optional pre-generated request-id. If empty, Retrieve() generates one.

2. Modify TwoHopCredentialProvider.Retrieve():
   - Use p.Input.RequestID if non-empty, otherwise call identity.NewRequestID()
   - Rest of logic unchanged (sanitize user, create SourceIdentity, call SentinelAssumeRole)

3. Add method to TwoHopCredentialProvider to get the SourceIdentity string after Retrieve:
   - This is tricky because Retrieve() generates it. Instead, have Retrieve return the SourceIdentity in a new return type, OR
   - Better: Store the generated SourceIdentity in the provider struct after Retrieve
   - Simplest: Add a field to track the last used SourceIdentity:
     ```go
     LastSourceIdentity *identity.SourceIdentity // Set during Retrieve()
     ```
   - After creating sourceIdentity in Retrieve(), set p.LastSourceIdentity = sourceIdentity

This allows CLI commands to retrieve the actual SourceIdentity used after calling Retrieve().
  </action>
  <verify>go build ./sentinel/... compiles without errors</verify>
  <done>TwoHopCredentialProvider accepts RequestID and exposes LastSourceIdentity after Retrieve</done>
</task>

<task type="auto">
  <name>Task 3: Update credentials command to use enhanced logging</name>
  <files>cli/credentials.go</files>
  <action>
Modify CredentialsCommand to generate request-id early and log enhanced entries:

1. After policy evaluation, check if decision.Effect == policy.EffectAllow:
   - Generate request-id: `requestID := identity.NewRequestID()`
   - Include in credential request: `credReq.RequestID = requestID`

2. After GetCredentialsWithSourceIdentity returns successfully:
   - Build CredentialIssuanceFields from result:
     ```go
     credFields := &logging.CredentialIssuanceFields{
         RequestID:       requestID,
         SourceIdentity:  creds.SourceIdentity,
         RoleARN:         creds.RoleARN,
         SessionDuration: input.SessionDuration, // or credReq.SessionDuration
     }
     ```

3. Move logging AFTER credential retrieval for allow decisions:
   - For DENY: Log immediately with NewDecisionLogEntry (no credential context)
   - For ALLOW: Log AFTER credentials retrieved with NewEnhancedDecisionLogEntry

Current flow:
```
Evaluate → Log → (if allow) Get credentials → Output
```

New flow:
```
Evaluate → (if deny) Log deny and exit
         → (if allow) Generate request-id → Get credentials → Log with enhanced fields → Output
```

Import logging and identity packages as needed.
  </action>
  <verify>go build ./cli/... compiles; manual test shows request_id in logs</verify>
  <done>credentials command logs request_id, source_identity, role_arn for allow decisions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `go test ./...` passes
- [ ] credentials command logs request_id for allow decisions
- [ ] credentials command logs source_identity when role assumed
- [ ] Deny decisions still log correctly (without new fields)
</verification>

<success_criteria>

- All tasks completed
- All packages build and tests pass
- credentials command emits enhanced decision logs
- SourceIdentity in logs matches CloudTrail correlatable format
</success_criteria>

<output>
After completion, create `.planning/phases/14-enhanced-decision-logging/14-02-SUMMARY.md`
</output>
