---
phase: 91-unified-bootstrap-extension
plan: 02
type: execute
wave: 2
depends_on: ["91-01"]
files_modified: [cli/bootstrap.go, cli/bootstrap_test.go]
autonomous: true
---

<objective>
Extend `--generate-iam-policies` to include DynamoDB table permissions when `--with-*` flags are used, producing a unified IAM policy document.

Purpose: Generate complete IAM policy covering both SSM (policy loading) and DynamoDB (approvals/breakglass/sessions) permissions.
Output: Combined IAM policy generation that includes all requested infrastructure permissions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@cli/bootstrap.go
@cli/init_approvals.go (for IAM policy generation pattern)
@bootstrap/iam.go (for existing SSM IAM policy generation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create combined IAM policy generation function</name>
  <files>cli/bootstrap.go</files>
  <action>
Add a new function that generates combined IAM policies for both SSM and DynamoDB resources:

```go
// CombinedIAMPolicy represents a combined IAM policy for all Sentinel resources.
type CombinedIAMPolicy struct {
    SSMReader       string   // JSON policy for reading SSM parameters
    SSMAdmin        string   // JSON policy for managing SSM parameters
    DynamoDBTables  []string // JSON policies for each DynamoDB table
}

// generateCombinedIAMPolicies generates IAM policy documents for all configured resources.
func generateCombinedIAMPolicies(input BootstrapCommandInput) CombinedIAMPolicy {
    result := CombinedIAMPolicy{}

    // SSM policies (always included)
    policyRoot := input.PolicyRoot
    if policyRoot == "" {
        policyRoot = bootstrap.DefaultPolicyRoot
    }
    readerPolicy := bootstrap.GenerateReaderPolicy(policyRoot)
    result.SSMReader, _ = bootstrap.FormatIAMPolicy(readerPolicy)
    adminPolicy := bootstrap.GenerateAdminPolicy(policyRoot)
    result.SSMAdmin, _ = bootstrap.FormatIAMPolicy(adminPolicy)

    // DynamoDB table policies (conditional on --with-* flags)
    withApprovals := input.WithApprovals || input.WithAll
    withBreakGlass := input.WithBreakGlass || input.WithAll
    withSessions := input.WithSessions || input.WithAll

    if withApprovals {
        policy := generateTableIAMPolicy(input.ApprovalTableName, input.Region)
        result.DynamoDBTables = append(result.DynamoDBTables, policy)
    }
    if withBreakGlass {
        policy := generateBreakGlassTableIAMPolicy(input.BreakGlassTableName, input.Region)
        result.DynamoDBTables = append(result.DynamoDBTables, policy)
    }
    if withSessions {
        policy := generateSessionTableIAMPolicy(input.SessionTableName, input.Region)
        result.DynamoDBTables = append(result.DynamoDBTables, policy)
    }

    return result
}
```
  </action>
  <verify>go build ./cmd/sentinel succeeds</verify>
  <done>generateCombinedIAMPolicies function exists and compiles</done>
</task>

<task type="auto">
  <name>Task 2: Update outputIAMPolicies to include DynamoDB tables</name>
  <files>cli/bootstrap.go</files>
  <action>
Modify outputIAMPolicies to accept the full input and output DynamoDB policies when --with-* flags are set:

1. Change signature from `outputIAMPolicies(stdout *os.File, policyRoot string)` to:
```go
func outputCombinedIAMPolicies(stdout *os.File, input BootstrapCommandInput)
```

2. Implement the new function:
```go
// outputCombinedIAMPolicies prints all IAM policy documents to stdout.
func outputCombinedIAMPolicies(stdout *os.File, input BootstrapCommandInput) {
    policies := generateCombinedIAMPolicies(input)

    fmt.Fprintln(stdout, "\n"+strings.Repeat("=", 60))
    fmt.Fprintln(stdout, "IAM Policy Documents")
    fmt.Fprintln(stdout, strings.Repeat("=", 60))

    // SSM Reader policy
    fmt.Fprintln(stdout, "\n--- SentinelPolicyReader ---")
    fmt.Fprintln(stdout, "Attach to: Roles that need to read Sentinel policies (e.g., Sentinel CLI)")
    fmt.Fprintln(stdout, policies.SSMReader)

    // SSM Admin policy
    fmt.Fprintln(stdout, "\n--- SentinelPolicyAdmin ---")
    fmt.Fprintln(stdout, "Attach to: Roles that manage Sentinel policies (e.g., CI/CD pipelines)")
    fmt.Fprintln(stdout, policies.SSMAdmin)

    // DynamoDB table policies
    withApprovals := input.WithApprovals || input.WithAll
    withBreakGlass := input.WithBreakGlass || input.WithAll
    withSessions := input.WithSessions || input.WithAll

    tableIndex := 0
    if withApprovals {
        fmt.Fprintln(stdout, "\n--- SentinelApprovalTable ---")
        fmt.Fprintf(stdout, "Attach to: Roles that use approval workflows (table: %s)\n", input.ApprovalTableName)
        fmt.Fprintln(stdout, policies.DynamoDBTables[tableIndex])
        tableIndex++
    }
    if withBreakGlass {
        fmt.Fprintln(stdout, "\n--- SentinelBreakGlassTable ---")
        fmt.Fprintf(stdout, "Attach to: Roles that use break-glass access (table: %s)\n", input.BreakGlassTableName)
        fmt.Fprintln(stdout, policies.DynamoDBTables[tableIndex])
        tableIndex++
    }
    if withSessions {
        fmt.Fprintln(stdout, "\n--- SentinelSessionTable ---")
        fmt.Fprintf(stdout, "Attach to: Roles that use server mode sessions (table: %s)\n", input.SessionTableName)
        fmt.Fprintln(stdout, policies.DynamoDBTables[tableIndex])
        tableIndex++
    }
}
```

3. Update all call sites of outputIAMPolicies in BootstrapCommand to use outputCombinedIAMPolicies:
- In plan-only mode: `outputCombinedIAMPolicies(stdout, input)`
- After apply: `outputCombinedIAMPolicies(stdout, input)`

4. Remove the old outputIAMPolicies function (it's now replaced).
  </action>
  <verify>go build ./cmd/sentinel && go vet ./cli/...</verify>
  <done>--generate-iam-policies outputs combined SSM + DynamoDB policies</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for combined IAM policy generation</name>
  <files>cli/bootstrap_test.go</files>
  <action>
Add tests for the combined IAM policy generation:

1. TestGenerateCombinedIAMPolicies_SSMOnly - verify SSM policies always included
2. TestGenerateCombinedIAMPolicies_WithApprovals - verify approval table policy included
3. TestGenerateCombinedIAMPolicies_WithAll - verify all three table policies included

Test that:
- SSMReader and SSMAdmin are always present
- DynamoDBTables slice has correct length based on flags
- DynamoDB policies contain correct table names and regions
- --all flag enables all three tables

```go
func TestGenerateCombinedIAMPolicies_SSMOnly(t *testing.T) {
    input := BootstrapCommandInput{
        PolicyRoot: "/sentinel/policies",
        Region:     "us-east-1",
    }

    result := generateCombinedIAMPolicies(input)

    if result.SSMReader == "" {
        t.Error("SSMReader policy should not be empty")
    }
    if result.SSMAdmin == "" {
        t.Error("SSMAdmin policy should not be empty")
    }
    if len(result.DynamoDBTables) != 0 {
        t.Errorf("DynamoDBTables should be empty without --with-* flags, got %d", len(result.DynamoDBTables))
    }
}

func TestGenerateCombinedIAMPolicies_WithApprovals(t *testing.T) {
    input := BootstrapCommandInput{
        PolicyRoot:        "/sentinel/policies",
        Region:            "us-east-1",
        WithApprovals:     true,
        ApprovalTableName: "my-requests",
    }

    result := generateCombinedIAMPolicies(input)

    if len(result.DynamoDBTables) != 1 {
        t.Errorf("Expected 1 DynamoDB policy, got %d", len(result.DynamoDBTables))
    }
    if !strings.Contains(result.DynamoDBTables[0], "my-requests") {
        t.Error("Approval table policy should contain table name")
    }
}

func TestGenerateCombinedIAMPolicies_WithAll(t *testing.T) {
    input := BootstrapCommandInput{
        PolicyRoot:         "/sentinel/policies",
        Region:             "us-east-1",
        WithAll:            true,
        ApprovalTableName:  "sentinel-requests",
        BreakGlassTableName: "sentinel-breakglass",
        SessionTableName:   "sentinel-sessions",
    }

    result := generateCombinedIAMPolicies(input)

    if len(result.DynamoDBTables) != 3 {
        t.Errorf("Expected 3 DynamoDB policies with --all, got %d", len(result.DynamoDBTables))
    }
}
```
  </action>
  <verify>go test ./cli/... -run TestGenerateCombinedIAMPolicies -v</verify>
  <done>Tests pass for combined IAM policy generation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./cmd/sentinel` succeeds
- [ ] `go test ./cli/... -run TestGenerateCombinedIAMPolicies` passes
- [ ] `go test ./cli/... -run TestBootstrapCommand` passes
- [ ] `go vet ./cli/...` has no warnings
</verification>

<success_criteria>
- All tasks completed
- --generate-iam-policies outputs SSM policies (always)
- --generate-iam-policies with --with-* flags also outputs DynamoDB policies
- Tests verify correct policy inclusion based on flags
</success_criteria>

<output>
After completion, create `.planning/phases/91-unified-bootstrap-extension/91-02-SUMMARY.md`
</output>
