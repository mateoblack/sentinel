---
phase: 63-permission-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [permissions/checker.go, permissions/checker_test.go, cli/permissions.go, cli/permissions_test.go]
autonomous: true
---

<objective>
Implement `sentinel permissions check` command to validate that current AWS credentials have the required permissions for Sentinel features.

Purpose: Help users verify their IAM configuration before runtime failures, enabling proactive permission troubleshooting during onboarding and after changes.
Output: Working `sentinel permissions check` command with human/JSON output showing which permissions pass/fail.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-feature-detection/62-01-SUMMARY.md

Relevant source files:
@permissions/types.go
@permissions/registry.go
@permissions/detection.go
@cli/permissions.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Checker types and IAM SimulatePrincipalPolicy implementation</name>
  <files>permissions/checker.go, permissions/checker_test.go</files>
  <action>
Create permission validation using IAM SimulatePrincipalPolicy API.

**Types to create:**
- `CheckStatus` - string type with constants: `StatusAllowed`, `StatusDenied`, `StatusError`, `StatusNotChecked`
- `CheckResult` - struct with: Feature, Action, Resource, Status, Message (reason for status)
- `CheckSummary` - struct with: Results []CheckResult, PassCount, FailCount, ErrorCount int
- `iamCheckerAPI` interface - with SimulatePrincipalPolicy method for testability
- `Checker` struct - holds iamClient and optional callerArn
- `CheckerInterface` - interface with Check(ctx, []Feature) (*CheckSummary, error) for CLI testing

**Implementation:**
1. `NewChecker(cfg aws.Config) *Checker` - creates checker with IAM client
2. `newCheckerWithClient(client iamCheckerAPI) *Checker` - for testing
3. `Checker.Check(ctx context.Context, features []Feature) (*CheckSummary, error)`:
   - Get caller identity via STS GetCallerIdentity (needed for SimulatePrincipalPolicy)
   - For each feature, get permissions from registry
   - For each permission, call SimulatePrincipalPolicy with the action and resource
   - Map IAM evaluation decision (allowed/implicitDeny/explicitDeny) to CheckStatus
   - Collect all results into CheckSummary
   - If SimulatePrincipalPolicy itself fails (permission denied), return StatusError with clear message

**Error handling:**
- If STS GetCallerIdentity fails, return error (can't proceed without identity)
- If SimulatePrincipalPolicy returns AccessDenied, add StatusError result with message "cannot simulate - requires iam:SimulatePrincipalPolicy permission"
- Other errors become StatusError with error message

**Important:** Follow detection.go patterns:
- Interface for testability (iamCheckerAPI)
- NewFromConfig for production, injection for testing
- Collect results even if some checks fail (best-effort)
  </action>
  <verify>go build ./permissions && go test ./permissions -run Checker -v</verify>
  <done>Checker type with Check() method that validates permissions via IAM SimulatePrincipalPolicy, comprehensive tests with mock IAM client</done>
</task>

<task type="auto">
  <name>Task 2: Add `sentinel permissions check` CLI subcommand</name>
  <files>cli/permissions.go, cli/permissions_test.go</files>
  <action>
Add `check` subcommand to existing permissions command.

**CLI structure:**
The permissions command already exists. Add a subcommand: `sentinel permissions check`

**Flags for check subcommand:**
- `--detect` - use auto-detected features (reuse detection logic from main permissions command)
- `--feature` - check specific feature(s), comma-separated
- `--format` - output format: human (default), json
- `--region` - AWS region for API calls (optional)

**Implementation:**
1. Add `ConfigurePermissionsCheckCommand` function that registers `check` as subcommand of `permissions`
2. Create `PermissionsCheckCommandInput` struct with: Format, Features ([]string), Detect bool, Region string, Checker CheckerInterface (for testing)
3. `PermissionsCheckCommand(input PermissionsCheckCommandInput) error`:
   - Validate flags (--detect and --feature mutually exclusive)
   - If --detect, run detection and get feature list
   - If --feature, parse comma-separated list and validate each
   - If neither, check all features
   - Create Checker (or use injected one for tests)
   - Call Checker.Check(ctx, features)
   - Format and output results

**Human output format:**
```
Checking permissions for 5 features...

✓ policy_load
  ✓ ssm:GetParameter on arn:aws:ssm:*:*:parameter/sentinel/policies/*
  ✓ ssm:GetParameters on arn:aws:ssm:*:*:parameter/sentinel/policies/*

✗ approval_workflow
  ✗ dynamodb:PutItem on arn:aws:dynamodb:*:*:table/sentinel-requests - Access denied

⚠ credential_issue
  ⚠ sts:AssumeRole on arn:aws:iam::*:role/* - cannot simulate (requires iam:SimulatePrincipalPolicy)

Summary: 3 passed, 1 failed, 1 error
```

**JSON output format:**
```json
{
  "results": [...CheckResult array...],
  "summary": {"passed": 3, "failed": 1, "errors": 1}
}
```

**Exit codes:**
- 0: All checks passed
- 1: One or more checks failed or errored

**Tests:**
- Test --detect flag uses detector
- Test --feature flag parses comma-separated values
- Test mutual exclusivity of --detect and --feature
- Test human output formatting
- Test JSON output formatting
- Test exit codes
  </action>
  <verify>go build ./cli && go test ./cli -run PermissionsCheck -v</verify>
  <done>`sentinel permissions check` command works with --detect, --feature, --format flags; outputs human/JSON results; returns non-zero exit on failures</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds without errors
- [ ] `go test ./permissions -v` passes all tests including Checker tests
- [ ] `go test ./cli -v` passes all tests including PermissionsCheck tests
- [ ] `sentinel permissions check --help` shows correct flags
- [ ] Manual test: `sentinel permissions check --feature policy_load` runs without panic
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Checker validates permissions via IAM SimulatePrincipalPolicy
- CLI command outputs clear pass/fail results
- Exit codes indicate success/failure for scripting
</success_criteria>

<output>
After completion, create `.planning/phases/63-permission-validation/63-01-SUMMARY.md`
</output>
