---
phase: 61-permissions-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - permissions/format.go
  - permissions/format_test.go
  - cli/permissions.go
  - cli/permissions_test.go
  - cmd/sentinel/main.go
autonomous: true
---

<objective>
Create `sentinel permissions` CLI command with multiple output formats.

Purpose: Allow users to discover exactly what IAM permissions Sentinel needs, in formats they can directly use in their infrastructure (JSON policy documents, Terraform, CloudFormation).
Output: Working CLI command with human-readable, JSON, Terraform HCL, and CloudFormation YAML output formats.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/60-permissions-schema/60-01-SUMMARY.md

@permissions/types.go
@permissions/registry.go
@cli/status.go
@cli/bootstrap.go
@bootstrap/iam.go
@cmd/sentinel/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create permission formatters</name>
  <files>permissions/format.go, permissions/format_test.go</files>
  <action>
Create formatters for outputting permissions in different formats:

1. **FormatHuman(perms []FeaturePermissions) string** - Human-readable table:
   ```
   Feature: policy_load (core) [required]
     ssm:GetParameter, ssm:GetParameters, ssm:GetParametersByPath
     Resource: arn:aws:ssm:*:*:parameter/sentinel/policies/*
   ```
   Group by subsystem, show optional/required, list actions and resources.

2. **FormatJSON(perms []FeaturePermissions) (string, error)** - JSON IAM policy document using existing bootstrap.IAMPolicyDocument pattern. Consolidate permissions by resource pattern, deduplicate actions.

3. **FormatTerraform(perms []FeaturePermissions) string** - Terraform HCL format:
   ```hcl
   data "aws_iam_policy_document" "sentinel" {
     statement {
       sid       = "SentinelSSMRead"
       effect    = "Allow"
       actions   = ["ssm:GetParameter", ...]
       resources = ["arn:aws:ssm:*:*:parameter/sentinel/policies/*"]
     }
     ...
   }
   ```
   Group statements by service for readability.

4. **FormatCloudFormation(perms []FeaturePermissions) string** - CloudFormation YAML:
   ```yaml
   Type: AWS::IAM::ManagedPolicy
   Properties:
     PolicyName: SentinelPermissions
     PolicyDocument:
       Version: "2012-10-17"
       Statement:
         - Sid: SentinelSSMRead
           Effect: Allow
           Action:
             - ssm:GetParameter
           Resource:
             - arn:aws:ssm:*:*:parameter/sentinel/policies/*
   ```

5. **Helper: groupByResource(perms []FeaturePermissions) []ConsolidatedPermission** - Consolidate permissions with same resource pattern, merging actions. This is the key transformation used by JSON/Terraform/CloudFormation formatters.

Tests:
- FormatHuman includes all features, shows optional flag, correct grouping
- FormatJSON produces valid JSON that matches bootstrap.IAMPolicyDocument structure
- FormatTerraform produces valid HCL syntax
- FormatCloudFormation produces valid YAML with correct indentation
- groupByResource correctly deduplicates actions and merges by resource
- Empty permissions list produces minimal valid output for each format
  </action>
  <verify>go test ./permissions/... -run TestFormat -v passes</verify>
  <done>All four formatters produce correct output, helper consolidates permissions correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create permissions CLI command</name>
  <files>cli/permissions.go, cli/permissions_test.go, cmd/sentinel/main.go</files>
  <action>
Create `sentinel permissions` command following existing CLI patterns (see cli/status.go, cli/bootstrap.go):

1. **PermissionsCommandInput struct:**
   - Format string (human, json, terraform, cloudformation) - default "human"
   - Subsystem string (optional filter by subsystem)
   - Feature string (optional filter by single feature)
   - RequiredOnly bool (only show required permissions, exclude optional)
   - Stdout, Stderr *os.File (for testing)

2. **ConfigurePermissionsCommand(app *kingpin.Application, s *Sentinel):**
   - Command: `sentinel permissions`
   - Flags:
     - `--format` (human|json|terraform|cloudformation|cf) default "human"
     - `--subsystem` filter by subsystem name (core, credentials, approvals, breakglass, notifications, audit, enforce, bootstrap)
     - `--feature` filter by specific feature
     - `--required-only` exclude optional features (notify_sns, notify_webhook)
   - Use app.Command() directly (not a subcommand like init/bootstrap)

3. **PermissionsCommand(input PermissionsCommandInput) error:**
   - Get permissions using permissions.GetAllPermissions(), GetSubsystemPermissions(), or GetFeaturePermissions() based on flags
   - Filter by RequiredOnly if set
   - Call appropriate formatter based on --format flag
   - Output to stdout
   - Return nil on success

4. **Wire up in main.go:**
   - Add `cli.ConfigurePermissionsCommand(app, s)` after audit commands

Tests:
- Default format outputs human-readable with all features
- --format=json outputs valid IAM policy JSON
- --format=terraform outputs HCL
- --format=cloudformation (and --format=cf alias) outputs YAML
- --subsystem=core filters to only core subsystem features
- --feature=policy_load shows single feature
- --required-only excludes notify_sns and notify_webhook
- Invalid format returns error
- Invalid subsystem returns error
- Invalid feature returns error
  </action>
  <verify>go test ./cli/... -run TestPermissions -v passes && go build ./cmd/sentinel && ./sentinel permissions --help</verify>
  <done>sentinel permissions command works with all flags and formats, wired into main.go</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test ./permissions/... -v` passes (including new format tests)
- [ ] `go test ./cli/... -v` passes (including new permissions command tests)
- [ ] `go build ./cmd/sentinel` succeeds
- [ ] `./sentinel permissions` outputs human-readable permission list
- [ ] `./sentinel permissions --format=json` outputs valid JSON IAM policy
- [ ] `./sentinel permissions --format=terraform` outputs valid HCL
- [ ] `./sentinel permissions --format=cloudformation` outputs valid YAML
- [ ] `./sentinel permissions --subsystem=core` filters correctly
- [ ] `./sentinel permissions --required-only` excludes optional features
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Permissions command discoverable via `sentinel --help`
- All four output formats produce usable infrastructure code
</success_criteria>

<output>
After completion, create `.planning/phases/61-permissions-command/61-01-SUMMARY.md`
</output>
