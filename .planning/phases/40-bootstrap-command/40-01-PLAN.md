---
phase: 40-bootstrap-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [cli/bootstrap.go, cli/bootstrap_test.go, cmd/sentinel/main.go]
autonomous: true
---

<objective>
Implement `sentinel init bootstrap` CLI command with plan/apply workflow.

Purpose: Enable users to bootstrap Sentinel AWS infrastructure (SSM policy parameters) from the command line with terraform-style plan/apply workflow.
Output: Working CLI command with --plan, --yes, --profile, --policy-root, --generate-iam-policies, --json, and --region flags.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context - bootstrap package components
@.planning/phases/35-bootstrap-schema/35-01-SUMMARY.md
@.planning/phases/36-bootstrap-planner/36-01-SUMMARY.md
@.planning/phases/37-ssm-parameter-creation/37-01-SUMMARY.md
@.planning/phases/38-sample-policy-generation/38-01-SUMMARY.md
@.planning/phases/39-iam-policy-generation/39-01-SUMMARY.md

# Implementation references
@bootstrap/types.go
@bootstrap/planner.go
@bootstrap/executor.go
@bootstrap/format.go
@bootstrap/generator.go
@bootstrap/iam.go

# CLI patterns to follow
@cli/sentinel.go
@cli/breakglass.go
@cli/request.go
@cmd/sentinel/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bootstrap command structure and plan mode</name>
  <files>cli/bootstrap.go</files>
  <action>
Create cli/bootstrap.go with:

1. **BootstrapCommandInput struct:**
   - PolicyRoot string (default "/sentinel/policies")
   - Profiles []string (list of profile names to bootstrap)
   - Region string (optional AWS region)
   - PlanOnly bool (--plan flag - show plan without applying)
   - AutoApprove bool (--yes flag - skip confirmation)
   - GenerateIAMPolicies bool (--generate-iam-policies flag)
   - JSONOutput bool (--json flag for machine-readable output)
   - Description string (optional description for generated policies)
   - Planner *bootstrap.Planner (for testing)
   - Executor *bootstrap.Executor (for testing)

2. **ConfigureBootstrapCommand function:**
   - Create as subcommand: `app.Command("init", "Initialize Sentinel infrastructure").Command("bootstrap", "Bootstrap SSM policy parameters")`
   - Flags:
     - `--policy-root` (default "/sentinel/policies")
     - `--profile` (repeatable, required - at least one)
     - `--region` (optional)
     - `--plan` (show plan without applying)
     - `--yes` (auto-approve, skip confirmation)
     - `--generate-iam-policies` (include IAM policy documents in output)
     - `--json` (JSON output format)
     - `--description` (optional description for generated policies)

3. **BootstrapCommand function:**
   - Build BootstrapConfig from input (convert profile names to ProfileConfig structs)
   - Create Planner (use input.Planner if set for testing, else NewPlanner with AWS config)
   - Call Planner.Plan() to get BootstrapPlan
   - If --plan: output plan and return (no apply)
   - If plan.Summary.ToCreate == 0 && plan.Summary.ToUpdate == 0: output "No changes needed" and return
   - If --yes not set AND not --json: prompt for confirmation (use fmt.Fprintf to stderr, bufio.Scanner for stdin)
   - If --yes OR confirmed: create Executor and call Apply()
   - Output results (FormatPlan for human, FormatPlanJSON for --json)
   - For IAM policies: output policy documents using FormatIAMPolicy

4. **Output handling:**
   - Plan mode (--plan): Show plan using FormatPlan or FormatPlanJSON
   - Apply mode: Show plan, then apply, then show ApplyResult
   - If GenerateIAMPolicies: Print IAM policy documents with headers

Follow existing CLI patterns: errors to stderr, success output to stdout, return error on failure.
  </action>
  <verify>go build ./... compiles without errors</verify>
  <done>BootstrapCommand handles plan/apply workflow with all flags</done>
</task>

<task type="auto">
  <name>Task 2: Wire command into main and add comprehensive tests</name>
  <files>cmd/sentinel/main.go, cli/bootstrap_test.go</files>
  <action>
1. **Update cmd/sentinel/main.go:**
   - Add `cli.ConfigureBootstrapCommand(app, s)` after other command configurations
   - Import should already exist for cli package

2. **Create cli/bootstrap_test.go:**
   - Test plan-only mode (--plan flag)
   - Test apply mode with auto-approve (--yes flag)
   - Test confirmation prompt rejection (user types "no")
   - Test JSON output format (--json flag)
   - Test multiple profiles
   - Test IAM policy generation (--generate-iam-policies flag)
   - Test error cases:
     - No profiles provided
     - Invalid policy root (validation failure)
     - SSM API error (mock failure)
     - Apply failure handling

Use mock Planner/Executor via input struct fields for testing (pattern from breakglass_test.go).
Create helper functions for test setup similar to existing patterns.

Table-driven tests with comprehensive coverage of all code paths.
  </action>
  <verify>go test ./cli -run TestBootstrap -v passes all tests</verify>
  <done>Command wired into main.go, tests pass with >90% coverage of bootstrap.go</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds without errors
- [ ] `go test ./cli -run TestBootstrap -v` passes all tests
- [ ] `go test ./... -v` passes (no regressions)
- [ ] `./cmd/sentinel/sentinel init bootstrap --help` shows correct usage
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Command shows plan with `sentinel init bootstrap --profile dev --plan`
- Command applies with `sentinel init bootstrap --profile dev --yes`
- JSON output works with `--json` flag
- IAM policy documents shown with `--generate-iam-policies`
</success_criteria>

<output>
After completion, create `.planning/phases/40-bootstrap-command/40-01-SUMMARY.md`
</output>
