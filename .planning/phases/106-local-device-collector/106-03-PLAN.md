---
phase: 106-local-device-collector
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [device/local_windows.go, device/local_windows_test.go]
autonomous: true
---

<objective>
Implement Windows posture collection for LocalCollector.

Purpose: Enable device posture collection on Windows by detecting disk encryption (BitLocker), OS version, and firewall status from PowerShell/WMI commands.
Output: Windows-specific implementation with build tag for LocalCollector.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/105-device-collector-interface/105-01-SUMMARY.md

# Source files:
@device/collector.go
@device/types.go
@device/local.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Windows posture collection</name>
  <files>device/local_windows.go</files>
  <action>
Create device/local_windows.go with build tag `//go:build windows`:

1. collectDiskEncryption(runner CommandRunner) (*bool, error):
   - Run PowerShell: `powershell -Command "(Get-BitLockerVolume -MountPoint 'C:').ProtectionStatus"`
   - ProtectionStatus: "On" = encrypted, "Off" = not encrypted
   - Return *true if "On", *false if "Off"
   - Return nil, error if command fails (BitLocker may not be available on Home editions)
   - Alternative: WMI query `Get-WmiObject -Namespace root\CIMv2\Security\MicrosoftVolumeEncryption -Class Win32_EncryptableVolume`

2. collectFirewallStatus(runner CommandRunner) (*bool, error):
   - Run PowerShell: `powershell -Command "(Get-NetFirewallProfile -Profile Domain,Public,Private).Enabled"`
   - Returns True/False for each profile
   - Return *true if any profile enabled
   - Return *false if all profiles disabled
   - Return nil, error if command fails

3. collectOSInfo(runner CommandRunner) (string, string, error):
   - OSType is always "windows" (runtime.GOOS)
   - Run PowerShell: `powershell -Command "[System.Environment]::OSVersion.Version.ToString()"`
   - Returns version like "10.0.22621.0"
   - Alternative: Use syscall to call RtlGetVersion from ntdll.dll (more reliable)
   - Return "windows", version, nil on success
   - Return "windows", "", error if command fails

IMPORTANT: PowerShell execution policy may block scripts. Use `-Command` with inline script. Handle cases where BitLocker is not available (Windows Home editions) gracefully.
  </action>
  <verify>gofmt -l device/local_windows.go returns empty (properly formatted)</verify>
  <done>Windows posture collection for BitLocker, Windows Firewall, and OS version via PowerShell</done>
</task>

<task type="auto">
  <name>Task 2: Add Windows-specific tests</name>
  <files>device/local_windows_test.go</files>
  <action>
Create device/local_windows_test.go with build tag `//go:build windows`:

Test cases using MockCommandRunner:

1. BitLocker detection tests:
   - Test_Windows_collectDiskEncryption_On: ProtectionStatus "On" → true
   - Test_Windows_collectDiskEncryption_Off: ProtectionStatus "Off" → false
   - Test_Windows_collectDiskEncryption_NotAvailable: Command fails (Home edition) → nil, error
   - Test_Windows_collectDiskEncryption_Error: PowerShell error → nil, error

2. Firewall detection tests:
   - Test_Windows_collectFirewallStatus_AllEnabled: All profiles True → true
   - Test_Windows_collectFirewallStatus_SomeEnabled: Mixed True/False → true
   - Test_Windows_collectFirewallStatus_AllDisabled: All False → false
   - Test_Windows_collectFirewallStatus_Error: Command fails → nil, error

3. OS info tests:
   - Test_Windows_collectOSInfo_Success: Returns windows and version string
   - Test_Windows_collectOSInfo_Error: Command fails → windows, "", error

Use realistic PowerShell output samples from actual Windows systems.
  </action>
  <verify>gofmt -l device/local_windows_test.go returns empty (properly formatted)</verify>
  <done>Windows-specific tests for BitLocker, firewall, and OS detection with realistic output samples</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] gofmt -l device/local_windows*.go returns empty
- [ ] Build tag `//go:build windows` present on both files
- [ ] All three collection methods implemented with PowerShell
- [ ] Tests cover success, partial failure, and error cases
- [ ] Handles Windows Home edition (no BitLocker) gracefully
</verification>

<success_criteria>

- All tasks completed
- Windows implementation with BitLocker detection via PowerShell
- Windows Firewall status via Get-NetFirewallProfile
- OS version via PowerShell OSVersion
- Tests mock PowerShell output
</success_criteria>

<output>
After completion, create `.planning/phases/106-local-device-collector/106-03-SUMMARY.md`
</output>
