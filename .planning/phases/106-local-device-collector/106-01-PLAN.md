---
phase: 106-local-device-collector
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [device/local.go, device/local_darwin.go, device/local_test.go]
autonomous: true
---

<objective>
Create LocalCollector interface and macOS implementation for collecting device posture from the local system.

Purpose: Enable device posture collection on macOS without MDM by detecting disk encryption (FileVault), firewall status, and OS version from local system commands.
Output: LocalCollector implementing Collector interface with platform-specific darwin implementation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/105-device-collector-interface/105-01-SUMMARY.md

# Source files:
@device/collector.go
@device/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LocalCollector interface and base implementation</name>
  <files>device/local.go</files>
  <action>
Create device/local.go with:

1. LocalCollector struct implementing Collector interface:
   - config *CollectorConfig field for configuration
   - cmdRunner CommandRunner field for testability

2. CommandRunner interface for shelling out (enables testing without actually running commands):
   ```go
   type CommandRunner interface {
       Run(name string, args ...string) ([]byte, error)
   }
   ```

3. DefaultCommandRunner implementation using os/exec.Command().Output()

4. NewLocalCollector(config *CollectorConfig) *LocalCollector constructor:
   - If config.DeviceID is empty, generate new DeviceID
   - Use DefaultCommandRunner (tests will inject mock)

5. Name() method returning "local"

6. Collect(ctx context.Context) method that:
   - Creates DevicePosture with config.DeviceID and CollectedAt = time.Now().UTC()
   - Calls platform-specific collection methods:
     - collectDiskEncryption(runner) (*bool, error)
     - collectFirewallStatus(runner) (*bool, error)
     - collectOSInfo(runner) (osType, osVersion string, error)
   - Sets Status based on collected data (all checks pass = compliant, any fail = non_compliant, errors = unknown)
   - Returns partial posture on errors (don't fail completely)

The platform-specific methods will be defined in build-tagged files (_darwin.go, _linux.go, _windows.go). This file defines the interface and orchestration.

IMPORTANT: Use build tags to keep this file platform-agnostic. Define placeholder methods that will be overridden by platform files.
  </action>
  <verify>gofmt -l device/local.go returns empty (properly formatted)</verify>
  <done>LocalCollector struct with Collect() method defined, CommandRunner interface for testability</done>
</task>

<task type="auto">
  <name>Task 2: Implement macOS (darwin) posture collection</name>
  <files>device/local_darwin.go</files>
  <action>
Create device/local_darwin.go with build tag `//go:build darwin`:

1. collectDiskEncryption(runner CommandRunner) (*bool, error):
   - Run: `fdesetup status`
   - Parse output for "FileVault is On" or "FileVault is Off"
   - Return *true if On, *false if Off
   - Return nil, error if command fails or output unrecognized

2. collectFirewallStatus(runner CommandRunner) (*bool, error):
   - Run: `/usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate`
   - Parse output for "State = 1" (enabled) or "State = 0" (disabled)
   - Return *true if enabled, *false if disabled
   - Return nil, error if command fails or output unrecognized

3. collectOSInfo(runner CommandRunner) (string, string, error):
   - OSType is always "darwin" (runtime.GOOS)
   - Run: `sw_vers -productVersion` for OSVersion
   - Return "darwin", version, nil on success
   - Return "darwin", "", error if command fails

IMPORTANT: Follow existing codebase patterns from prompt/osascript.go for command execution. Don't swallow errors - propagate them so MultiCollector can aggregate.
  </action>
  <verify>gofmt -l device/local_darwin.go returns empty (properly formatted)</verify>
  <done>macOS posture collection for disk encryption (FileVault), firewall (socketfilterfw), and OS version (sw_vers)</done>
</task>

<task type="auto">
  <name>Task 3: Add LocalCollector tests with mock CommandRunner</name>
  <files>device/local_test.go</files>
  <action>
Create device/local_test.go with comprehensive tests:

1. MockCommandRunner struct for testing:
   - responses map[string]struct{ output []byte; err error }
   - Track calls for verification

2. Test cases for LocalCollector:
   - TestLocalCollector_Name: Returns "local"
   - TestLocalCollector_Collect_Success: All commands succeed, status is compliant
   - TestLocalCollector_Collect_DiskEncryptionOff: FileVault off, status non_compliant
   - TestLocalCollector_Collect_FirewallOff: Firewall disabled, status non_compliant
   - TestLocalCollector_Collect_PartialFailure: Some commands fail, partial posture returned
   - TestLocalCollector_Collect_AllFail: All commands fail, status unknown

3. Test macOS-specific parsing (using build tags):
   - Test_collectDiskEncryption_On: "FileVault is On" → true
   - Test_collectDiskEncryption_Off: "FileVault is Off" → false
   - Test_collectFirewallStatus_Enabled: "State = 1" → true
   - Test_collectFirewallStatus_Disabled: "State = 0" → false
   - Test_collectOSInfo_Success: Returns darwin and version

Follow existing table-driven test patterns from device/types_test.go and device/collector_test.go.
  </action>
  <verify>gofmt -l device/local_test.go returns empty (properly formatted)</verify>
  <done>Comprehensive tests with MockCommandRunner covering success, failure, and partial failure scenarios</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] gofmt -l device/local*.go returns empty (all files properly formatted)
- [ ] LocalCollector implements Collector interface (go build compiles)
- [ ] MockCommandRunner enables unit testing without system dependencies
- [ ] macOS-specific methods have correct build tags
</verification>

<success_criteria>

- All tasks completed
- LocalCollector struct with Collect() method
- macOS (darwin) implementation with FileVault, firewall, OS detection
- MockCommandRunner for testable command execution
- Tests cover success, partial failure, and complete failure scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/106-local-device-collector/106-01-SUMMARY.md`
</output>
