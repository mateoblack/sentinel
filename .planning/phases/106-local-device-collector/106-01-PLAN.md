---
phase: 106-local-device-collector
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [device/identity.go, device/identity_test.go, go.mod]
autonomous: true
---

<objective>
Implement stable hardware device identification for CLI (ID only, NOT posture claims).

Purpose: CLI collects a stable, hashed device identifier to send to Lambda TVM. TVM uses this ID to query MDM for actual device posture. This ensures clients cannot fake compliance.
Output: DeviceIdentifier type and GetDeviceID() function using machineid library.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/CONSTRAINTS.md
@.planning/phases/105-device-collector-interface/105-01-SUMMARY.md

# Source files:
@device/types.go
@device/collector.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add machineid dependency</name>
  <files>go.mod</files>
  <action>
Add the machineid library dependency:

```bash
go get github.com/denisbrodbeck/machineid
```

This library provides cross-platform machine ID retrieval:
- macOS: IOPlatformUUID via IOKit framework
- Linux: /etc/machine-id (systemd)
- Windows: HKLM\SOFTWARE\Microsoft\Cryptography\MachineGuid

No admin privileges required on any platform.
  </action>
  <verify>grep "denisbrodbeck/machineid" go.mod shows the dependency</verify>
  <done>machineid library added to go.mod</done>
</task>

<task type="auto">
  <name>Task 2: Create device identity module</name>
  <files>device/identity.go</files>
  <action>
Create device/identity.go with:

1. Constants:
   - `AppID = "sentinel-device-posture"` - Application-specific key for HMAC hashing
   - This ensures the device ID is unique to Sentinel and cannot be correlated with other apps

2. `GetDeviceID() (string, error)` function:
   - Use `machineid.ProtectedID(AppID)` to get hashed machine ID
   - This returns HMAC-SHA256 of the machine ID keyed by AppID
   - The raw machine ID is never exposed (security best practice per freedesktop.org)
   - Returns 64-character hex string (SHA256 output)
   - On error, return empty string and error (do NOT generate random ID - that defeats correlation)

3. `ValidateDeviceIdentifier(id string) bool` function:
   - Validates that ID is 64 lowercase hex characters (SHA256 output format)
   - Used by TVM to validate incoming device IDs

4. Documentation comments explaining:
   - This is for IDENTIFICATION only, not posture claims
   - TVM queries MDM using this ID to get actual posture
   - Why we hash: prevents leaking raw machine ID, app-specific isolation

IMPORTANT: Do NOT collect any posture information (disk encryption, firewall, OS version).
Per CONSTRAINTS.md, posture must be server-verified via MDM APIs.
  </action>
  <verify>gofmt -l device/identity.go returns empty (properly formatted)</verify>
  <done>GetDeviceID() returns stable, hashed device identifier; no posture collection</done>
</task>

<task type="auto">
  <name>Task 3: Add device identity tests</name>
  <files>device/identity_test.go</files>
  <action>
Create device/identity_test.go with tests:

1. TestGetDeviceID_Stable:
   - Call GetDeviceID() twice
   - Verify both calls return identical value (stable across calls)
   - Verify returned ID is 64 hex characters

2. TestGetDeviceID_Format:
   - Verify output is lowercase hex
   - Verify output is exactly 64 characters (SHA256 = 32 bytes = 64 hex chars)

3. TestValidateDeviceIdentifier:
   - Valid: 64 lowercase hex chars → true
   - Invalid: empty string → false
   - Invalid: 63 chars → false
   - Invalid: 65 chars → false
   - Invalid: uppercase hex → false
   - Invalid: non-hex chars → false

4. TestGetDeviceID_NotRawMachineID:
   - Verify GetDeviceID() output differs from raw machineid.ID()
   - This confirms we're using the hashed/protected version

Follow table-driven test patterns from device/types_test.go.
  </action>
  <verify>gofmt -l device/identity_test.go returns empty (properly formatted)</verify>
  <done>Tests verify stability, format, validation, and that raw ID is not exposed</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go mod tidy succeeds
- [ ] gofmt -l device/identity*.go returns empty
- [ ] GetDeviceID() returns consistent 64-char hex string
- [ ] No posture collection (disk encryption, firewall, OS) in this module
- [ ] ValidateDeviceIdentifier correctly validates format
</verification>

<success_criteria>

- All tasks completed
- machineid dependency added
- GetDeviceID() returns stable, hashed device identifier
- No posture claims collected (CONSTRAINTS.md compliance)
- Tests verify stability and format
</success_criteria>

<output>
After completion, create `.planning/phases/106-local-device-collector/106-01-SUMMARY.md`
</output>
