---
phase: 25-approval-policies
plan: 03
type: execute
wave: 3
depends_on: ["25-02"]
files_modified: [cli/request.go, cli/approve.go, cli/request_test.go, cli/approve_test.go]
autonomous: true
---

<objective>
Integrate approval policies into request and approve CLI commands.

Purpose: Enforce approval routing rules when creating and approving requests.
Output: Request command checks approval policies for auto-approve, approve command validates approver authorization.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/25-approval-policies/25-01-SUMMARY.md
@.planning/phases/25-approval-policies/25-02-SUMMARY.md

@cli/request.go
@cli/approve.go
@policy/approval.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate approval policies with request command</name>
  <files>cli/request.go, cli/request_test.go</files>
  <action>
Add approval policy integration to the request command.

Changes to RequestCommandInput:
```go
// ApprovalPolicy is an optional approval policy for auto-approve checking.
// If nil, no auto-approve checking is performed.
ApprovalPolicy *policy.ApprovalPolicy
```

Changes to RequestCommand logic (after validation, before store.Create):
1. If ApprovalPolicy is not nil:
   - Call policy.FindApprovalRule(ApprovalPolicy, profile)
   - If rule found and policy.ShouldAutoApprove(rule, requester, now, duration):
     - Set req.Status = request.StatusApproved
     - Set req.Approver = requester (self-approved)
     - Set req.ApproverComment = "auto-approved by policy"
   - Otherwise leave as StatusPending

This enables automatic approval for low-risk requests that match auto-approve conditions.

Changes to RequestCommandOutput:
- Add `AutoApproved bool` field to indicate if request was auto-approved

Add test cases:
- Request without approval policy stays pending
- Request matching auto-approve becomes approved with requester as approver
- Request not matching auto-approve stays pending
- Auto-approve respects time window
- Auto-approve respects max duration cap
  </action>
  <verify>go test ./cli/... -run TestRequest -v passes</verify>
  <done>Request command auto-approves when policy conditions match, stays pending otherwise</done>
</task>

<task type="auto">
  <name>Task 2: Integrate approver authorization with approve command</name>
  <files>cli/approve.go, cli/approve_test.go</files>
  <action>
Add approval policy integration to the approve command for authorization.

Changes to ApproveCommandInput:
```go
// ApprovalPolicy is an optional approval policy for approver authorization.
// If nil, any user can approve any request.
ApprovalPolicy *policy.ApprovalPolicy
```

Changes to ApproveCommand logic (after fetching request, before state transition):
1. If ApprovalPolicy is not nil:
   - Call policy.FindApprovalRule(ApprovalPolicy, req.Profile)
   - If rule found:
     - Call policy.CanApprove(rule, approver)
     - If false, reject with error: "user X is not authorized to approve requests for profile Y"
   - If no rule found: Allow (no approval routing defined for this profile)

This enforces that only designated approvers can approve requests for specific profiles.

Add test cases:
- Approve without policy allows any approver
- Approve with policy allows authorized approver
- Approve with policy rejects unauthorized approver
- Approve with policy allows when no rule matches profile (passthrough)
  </action>
  <verify>go test ./cli/... -run TestApprove -v passes</verify>
  <done>Approve command validates approver against policy, rejects unauthorized approvers</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `go test ./cli/...` passes
- [ ] `go vet ./...` passes
- [ ] Auto-approve creates approved request with correct fields
- [ ] Unauthorized approver is rejected with clear error message
</verification>

<success_criteria>

- All tasks completed
- Request command supports auto-approve via policy
- Approve command enforces approver authorization
- Error messages are clear and actionable
- Backward compatible (nil policy = existing behavior)
- All tests pass
  </success_criteria>

<output>
After completion, create `.planning/phases/25-approval-policies/25-03-SUMMARY.md`
</output>
