---
phase: 17-integration-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [sentinel/integration_test.go]
autonomous: true
---

<objective>
Create integration tests that verify the Sentinel Fingerprint flow works end-to-end with real AWS resources.

Purpose: Prove that SourceIdentity is correctly stamped on AssumeRole calls and that issued credentials are valid.
Output: Integration test file that can be run with real AWS credentials when environment variables are set.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@sentinel/assume_role.go
@sentinel/provider.go
@identity/types.go
@.planning/codebase/TESTING.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration test infrastructure</name>
  <files>sentinel/integration_test.go</files>
  <action>
Create sentinel/integration_test.go with:

1. Helper function `skipIfNoIntegrationEnv(t)` that skips test if:
   - `testing.Short()` is true (always skip in short mode)
   - `SENTINEL_TEST_ROLE_ARN` env var is not set
   - `SENTINEL_TEST_REGION` env var is not set (default to us-east-1 if not set)

2. Helper function `getIntegrationConfig(t)` that returns test config:
   - RoleARN from SENTINEL_TEST_ROLE_ARN
   - Region from SENTINEL_TEST_REGION (default us-east-1)

3. Document at top of file what env vars are needed and how to set up a test role.

Follow existing test patterns in codebase:
- Table-driven tests with t.Run
- t.Helper() for helper functions
- Standard error checking with t.Fatal/t.Error
  </action>
  <verify>go build ./sentinel/... succeeds</verify>
  <done>integration_test.go exists with skipIfNoIntegrationEnv and getIntegrationConfig helpers</done>
</task>

<task type="auto">
  <name>Task 2: Add SentinelAssumeRole integration test</name>
  <files>sentinel/integration_test.go</files>
  <action>
Add TestIntegration_SentinelAssumeRole that:

1. Calls skipIfNoIntegrationEnv(t) at start
2. Gets base credentials using aws.CredentialsProviderFunc from environment (AWS default credential chain)
3. Creates SourceIdentity with test user and generated request-id
4. Calls SentinelAssumeRole with the test role ARN and SourceIdentity
5. Verifies:
   - No error returned
   - Credentials.AccessKeyID is non-empty
   - Credentials.SecretAccessKey is non-empty
   - Credentials.SessionToken is non-empty (assumed role always has session token)
   - SourceIdentity matches the formatted input
   - AssumedRoleArn contains the role ARN

Use aws-sdk-go-v2 config.LoadDefaultConfig to get base credentials (respects AWS_PROFILE, AWS_ACCESS_KEY_ID, etc.).
  </action>
  <verify>go build ./sentinel/... succeeds (test is skipped without env vars)</verify>
  <done>TestIntegration_SentinelAssumeRole exists, skips without env vars, tests AssumeRole when enabled</done>
</task>

<task type="auto">
  <name>Task 3: Add GetCallerIdentity verification test</name>
  <files>sentinel/integration_test.go</files>
  <action>
Add TestIntegration_CredentialsAreValid that:

1. Calls skipIfNoIntegrationEnv(t) at start
2. Gets credentials via SentinelAssumeRole (same setup as Task 2)
3. Creates new STS client using the assumed credentials
4. Calls GetCallerIdentity with the assumed credentials
5. Verifies:
   - No error returned
   - Arn contains "assumed-role" (confirms we're using the assumed role)
   - UserId is non-empty
   - Account is non-empty

This proves the credentials issued by Sentinel actually work for AWS API calls.

Add package-level comment explaining that integration tests require:
- AWS credentials with permission to call sts:AssumeRole
- A role ARN that the credentials can assume
- The role must allow sts:SetSourceIdentity in its trust policy

Include example trust policy snippet in comments for users setting up test roles.
  </action>
  <verify>go test -short ./sentinel/... passes (tests skipped), go build ./sentinel/... succeeds</verify>
  <done>TestIntegration_CredentialsAreValid exists, verifies credentials work with GetCallerIdentity, includes setup documentation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./sentinel/...` succeeds
- [ ] `go test -short ./sentinel/...` passes (integration tests skipped)
- [ ] `go vet ./sentinel/...` passes
- [ ] Integration test file has clear documentation for setup
</verification>

<success_criteria>

- All tasks completed
- Integration tests exist and are skipped by default
- Tests will run when SENTINEL_TEST_ROLE_ARN is set
- Documentation explains how to set up a test role with SourceIdentity permissions
</success_criteria>

<output>
After completion, create `.planning/phases/17-integration-testing/17-01-SUMMARY.md`
</output>
