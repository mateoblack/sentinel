---
phase: 65-error-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - errors/types.go
  - errors/types_test.go
  - errors/suggestions.go
  - errors/suggestions_test.go
autonomous: true
---

<objective>
Create structured error types with fix suggestions for common permission failures.

Purpose: When users encounter permission errors, provide actionable guidance on how to resolve them rather than generic error messages.

Output: A new `errors` package with specific error types for SSM, DynamoDB, IAM, and policy errors, each including fix suggestions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/64-guided-setup/64-01-SUMMARY.md

@policy/loader.go
@permissions/checker.go
@cli/sentinel_exec.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create structured error types</name>
  <files>errors/types.go, errors/types_test.go</files>
  <action>
Create a new `errors` package at `errors/types.go` with structured error types that wrap AWS errors and provide context:

**SentinelError interface:**
```go
// SentinelError provides additional context for error handling
type SentinelError interface {
    error
    Unwrap() error                // Original error
    Code() string                 // Error code (e.g., "SSM_ACCESS_DENIED")
    Suggestion() string           // Actionable fix suggestion
    Context() map[string]string   // Additional context (parameter, table, etc.)
}
```

**Error codes (constants):**
```go
// SSM errors
const (
    ErrCodeSSMAccessDenied      = "SSM_ACCESS_DENIED"
    ErrCodeSSMParameterNotFound = "SSM_PARAMETER_NOT_FOUND"
    ErrCodeSSMKMSAccessDenied   = "SSM_KMS_ACCESS_DENIED"
    ErrCodeSSMThrottled         = "SSM_THROTTLED"
    ErrCodeSSMInvalidParameter  = "SSM_INVALID_PARAMETER"
)

// DynamoDB errors
const (
    ErrCodeDynamoDBAccessDenied     = "DYNAMODB_ACCESS_DENIED"
    ErrCodeDynamoDBTableNotFound    = "DYNAMODB_TABLE_NOT_FOUND"
    ErrCodeDynamoDBThrottled        = "DYNAMODB_THROTTLED"
    ErrCodeDynamoDBConditionFailed  = "DYNAMODB_CONDITION_FAILED"
)

// IAM errors
const (
    ErrCodeIAMSimulateAccessDenied = "IAM_SIMULATE_ACCESS_DENIED"
    ErrCodeIAMRoleNotFound         = "IAM_ROLE_NOT_FOUND"
    ErrCodeIAMAccessDenied         = "IAM_ACCESS_DENIED"
)

// Policy errors
const (
    ErrCodePolicyDenied        = "POLICY_DENIED"
    ErrCodePolicyNotConfigured = "POLICY_NOT_CONFIGURED"
)

// Config errors
const (
    ErrCodeConfigMissingCredentials = "CONFIG_MISSING_CREDENTIALS"
    ErrCodeConfigInvalidRegion      = "CONFIG_INVALID_REGION"
    ErrCodeConfigProfileNotFound    = "CONFIG_PROFILE_NOT_FOUND"
)
```

**sentinelError struct implementing SentinelError:**
```go
type sentinelError struct {
    code       string
    message    string
    suggestion string
    context    map[string]string
    cause      error
}

func (e *sentinelError) Error() string {
    return e.message
}

func (e *sentinelError) Unwrap() error {
    return e.cause
}

func (e *sentinelError) Code() string {
    return e.code
}

func (e *sentinelError) Suggestion() string {
    return e.suggestion
}

func (e *sentinelError) Context() map[string]string {
    return e.context
}
```

**Constructor functions:**
```go
// New creates a new SentinelError
func New(code, message, suggestion string, cause error) SentinelError

// WithContext adds context to an error
func WithContext(err SentinelError, key, value string) SentinelError

// IsSentinelError checks if err is a SentinelError and returns it
func IsSentinelError(err error) (SentinelError, bool)

// GetCode extracts error code from an error (returns empty string if not SentinelError)
func GetCode(err error) string
```

**Tests in errors/types_test.go:**
- Test sentinelError implements SentinelError interface
- Test Error() returns message
- Test Unwrap() returns cause
- Test Code(), Suggestion(), Context() return expected values
- Test WithContext adds context without mutating original
- Test IsSentinelError returns (error, true) for SentinelError
- Test IsSentinelError returns (nil, false) for regular errors
- Test GetCode returns code for SentinelError, empty for regular error
  </action>
  <verify>go test ./errors -v passes</verify>
  <done>SentinelError interface defined; sentinelError struct implemented; all constructors and helpers work; tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Create AWS error classification and suggestions</name>
  <files>errors/suggestions.go, errors/suggestions_test.go</files>
  <action>
Create error classification functions that examine AWS errors and return appropriate SentinelError with suggestions.

**SSM error classifier:**
```go
// WrapSSMError examines an SSM error and returns a SentinelError with context
func WrapSSMError(err error, parameter string) SentinelError {
    // Examine error for specific AWS error types:
    // - ParameterNotFound -> ErrCodeSSMParameterNotFound
    // - AccessDeniedException -> ErrCodeSSMAccessDenied
    // - InvalidKeyId / KMS errors -> ErrCodeSSMKMSAccessDenied
    // - Throttling -> ErrCodeSSMThrottled
    // - ValidationException -> ErrCodeSSMInvalidParameter

    // Return appropriate SentinelError with:
    // - Descriptive message
    // - Fix suggestion
    // - Context (parameter name)
}
```

**DynamoDB error classifier:**
```go
// WrapDynamoDBError examines a DynamoDB error and returns a SentinelError
func WrapDynamoDBError(err error, table, operation string) SentinelError {
    // Examine error for:
    // - ResourceNotFoundException -> ErrCodeDynamoDBTableNotFound
    // - AccessDeniedException -> ErrCodeDynamoDBAccessDenied
    // - ProvisionedThroughputExceededException -> ErrCodeDynamoDBThrottled
    // - ConditionalCheckFailedException -> ErrCodeDynamoDBConditionFailed
}
```

**IAM error classifier:**
```go
// WrapIAMError examines an IAM error and returns a SentinelError
func WrapIAMError(err error, action, resource string) SentinelError {
    // Examine error for:
    // - AccessDeniedException -> ErrCodeIAMAccessDenied or ErrCodeIAMSimulateAccessDenied
    // - NoSuchEntity -> ErrCodeIAMRoleNotFound
}
```

**Policy denial helper:**
```go
// NewPolicyDeniedError creates a SentinelError for policy denials
func NewPolicyDeniedError(user, profile string, matchedRule *policy.Rule, hasApprovalWorkflow, hasBreakGlass bool) SentinelError {
    // Create helpful message explaining why access was denied
    // Suggestion includes:
    // - If matchedRule is nil: "No rule matches your request"
    // - If rule explicitly denies: "Rule '<name>' denies access because: <conditions>"
    // - If hasApprovalWorkflow: "You may request access with: sentinel request --profile <profile>"
    // - If hasBreakGlass: "For emergencies, use: sentinel breakglass --profile <profile>"
}
```

**Suggestions registry:**
```go
// GetSuggestion returns the default suggestion for an error code
var suggestions = map[string]string{
    ErrCodeSSMAccessDenied: "Ensure your IAM policy includes: ssm:GetParameter on the policy parameter. " +
        "Run: sentinel permissions --feature policy_load",
    ErrCodeSSMParameterNotFound: "The SSM parameter does not exist. " +
        "Create it with: sentinel init bootstrap --profile <profile>",
    ErrCodeSSMKMSAccessDenied: "The SSM parameter is encrypted. " +
        "Ensure your IAM policy includes: kms:Decrypt on the KMS key used for encryption",
    ErrCodeSSMThrottled: "SSM API rate limit exceeded. Wait a moment and retry.",
    ErrCodeDynamoDBAccessDenied: "Ensure your IAM policy includes DynamoDB permissions. " +
        "Run: sentinel permissions --feature approval_workflow",
    ErrCodeDynamoDBTableNotFound: "The DynamoDB table does not exist. " +
        "Create it with CloudFormation or Terraform using the template from: sentinel permissions --format terraform",
    ErrCodeIAMSimulateAccessDenied: "Permission checking requires iam:SimulatePrincipalPolicy. " +
        "This permission is optional - you can verify permissions manually instead.",
    ErrCodePolicyDenied: "Access denied by Sentinel policy.",
    ErrCodeConfigMissingCredentials: "No AWS credentials found. Configure credentials using: " +
        "aws configure, environment variables, or IAM role",
    ErrCodeConfigProfileNotFound: "AWS profile not found in ~/.aws/config. " +
        "List available profiles with: aws configure list-profiles",
}
```

**Helper to detect AWS error types:**
```go
// isAccessDenied checks if error contains access denied indicators
func isAccessDenied(err error) bool {
    // Check for AccessDeniedException, UnauthorizedOperation, etc.
}

// isNotFound checks if error indicates resource not found
func isNotFound(err error) bool

// isThrottled checks if error indicates throttling
func isThrottled(err error) bool
```

**Tests in errors/suggestions_test.go:**
- Test WrapSSMError with ParameterNotFound error returns correct code and suggestion
- Test WrapSSMError with AccessDenied error returns correct code
- Test WrapSSMError with unknown error returns generic wrapper
- Test WrapDynamoDBError with ResourceNotFoundException
- Test WrapDynamoDBError with AccessDeniedException
- Test WrapIAMError with AccessDeniedException for SimulatePrincipalPolicy
- Test NewPolicyDeniedError with no matched rule
- Test NewPolicyDeniedError with explicit deny rule
- Test NewPolicyDeniedError includes approval workflow suggestion when available
- Test NewPolicyDeniedError includes break-glass suggestion when available
- Test isAccessDenied, isNotFound, isThrottled helpers
  </action>
  <verify>go test ./errors -v passes; go build ./errors succeeds</verify>
  <done>WrapSSMError, WrapDynamoDBError, WrapIAMError classifiers work; NewPolicyDeniedError provides contextual suggestions; tests cover all error types</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./errors` succeeds without errors
- [ ] `go test ./errors -v` passes all tests
- [ ] SentinelError interface fully implemented
- [ ] All error codes have corresponding suggestions
- [ ] Error classifiers correctly identify AWS error types
- [ ] NewPolicyDeniedError includes helpful context
</verification>

<success_criteria>
- All tasks completed
- New errors package provides structured error types
- Error classifiers correctly categorize AWS errors
- Suggestions provide actionable fix guidance
- Tests cover all error codes and scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/65-error-enhancement/65-01-SUMMARY.md`
</output>
