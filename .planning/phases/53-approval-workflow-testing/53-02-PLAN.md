---
phase: 53-approval-workflow-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - notification/security_test.go
autonomous: true
---

<objective>
Add security-focused tests for the notification system (SNS, webhook, NotifyStore).

Purpose: Ensure notification payloads don't leak sensitive data, async notifications are reliable, and edge cases are handled safely.
Output: Comprehensive notification security test suite in notification/security_test.go
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@notification/types.go
@notification/sns.go
@notification/webhook.go
@notification/store.go
@notification/store_test.go
@notification/webhook_test.go
@testutil/mock_aws.go
@testutil/mock_stores.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Notification payload security tests</name>
  <files>notification/security_test.go</files>
  <action>
Create notification/security_test.go with payload security tests:

1. **Event type exhaustive validation:**
   - Test all 5 event types: created, approved, denied, expired, cancelled
   - Verify each event type produces correct JSON structure
   - Test invalid event type string handling (empty, whitespace, unknown)
   - Verify event type appears in X-Sentinel-Event header (webhook) and message attributes (SNS)

2. **Payload content validation:**
   - Create Event with sensitive-looking request data (justification with PII patterns)
   - Serialize to JSON and verify no unexpected field leakage
   - Test that only documented fields appear in payload
   - Verify Timestamp is in expected format (RFC3339)

3. **Actor field security:**
   - Test actor field with special characters (newlines, quotes, unicode)
   - Verify actor is properly escaped in JSON output
   - Test actor with very long strings (1000+ chars)
   - Verify actor is correctly mapped: requester (create/cancel), approver (approve/deny), "system" (expired)

Use httptest.Server for webhook tests. Use testutil.MockSNSClient for SNS tests. Table-driven tests for exhaustive coverage.
  </action>
  <verify>go test -v ./notification/... -run Security | grep -E "^(---|PASS|FAIL)"</verify>
  <done>All event types validated, no sensitive data leakage, actor mapping correct</done>
</task>

<task type="auto">
  <name>Task 2: Async notification reliability tests</name>
  <files>notification/security_test.go</files>
  <action>
Add async notification reliability tests to notification/security_test.go:

1. **NotifyStore async delivery tests:**
   - Create multiple requests rapidly (10+)
   - Verify all notifications are delivered (use waitForEvents with appropriate timeout)
   - Test notification order matches creation order
   - Verify no notifications are lost under load

2. **Goroutine leak prevention:**
   - Create NotifyStore with failing notifier
   - Trigger many operations that would fire notifications
   - Verify goroutines complete even when notifications fail
   - Use runtime.NumGoroutine before/after to detect leaks

3. **Context cancellation behavior:**
   - Create NotifyStore and trigger operation
   - Cancel context before notification completes
   - Verify operation succeeds (fire-and-forget semantics)
   - Verify notification goroutine respects cancellation eventually

4. **Concurrent update notification ordering:**
   - Create request in pending state
   - Trigger rapid state transitions from multiple goroutines
   - Verify exactly one transition notification fires
   - Verify notification reflects final state

Follow existing patterns in store_test.go. Use sync.WaitGroup and atomic counters for concurrency tests.
  </action>
  <verify>go test -race -v ./notification/... -run "Async|Concurrent|Reliability" | grep -E "^(---|PASS|FAIL)"</verify>
  <done>Async delivery proven reliable, no goroutine leaks, context handling correct</done>
</task>

<task type="auto">
  <name>Task 3: Webhook and SNS edge case tests</name>
  <files>notification/security_test.go</files>
  <action>
Add webhook and SNS edge case tests to notification/security_test.go:

1. **Webhook URL validation:**
   - Test with non-HTTPS URLs (should warn or reject per security policy)
   - Test with localhost/internal IPs (potential SSRF vector - document behavior)
   - Test with very long URLs (1000+ chars)
   - Test with URLs containing credentials (user:pass@host)

2. **Webhook retry edge cases:**
   - Test with 0 max retries (no retry)
   - Test with very high max retries (100) - should complete eventually
   - Test with network errors (closed server mid-request)
   - Verify exponential backoff formula: delay * 2^(attempt-1)

3. **SNS message attribute security:**
   - Test event_type attribute with special characters
   - Verify attribute values are properly encoded
   - Test with very long attribute values
   - Verify TopicArn validation (empty, malformed, valid)

4. **MultiNotifier error aggregation:**
   - Test with mix of passing and failing notifiers
   - Verify all notifiers are attempted even if some fail
   - Verify error message contains details from all failures
   - Test with nil notifiers in list (should be filtered)

Use httptest.NewServer for webhook tests. Use testutil.MockSNSClient with PublishFunc for error injection.
  </action>
  <verify>go test -v ./notification/... -run "Webhook|SNS|Multi" | grep -E "^(---|PASS|FAIL)"</verify>
  <done>Webhook URL validation tested, retry logic verified, SNS attributes secure</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test -race ./notification/... passes
- [ ] Coverage for notification package â‰¥90%
- [ ] All security tests follow table-driven pattern
- [ ] No goroutine leaks detected
</verification>

<success_criteria>
- All tasks completed
- Event payload security proven (no leakage)
- Async notification reliability verified
- Webhook/SNS edge cases handled safely
- Tests pass with -race flag
</success_criteria>

<output>
After completion, create `.planning/phases/53-approval-workflow-testing/53-02-SUMMARY.md`
</output>
