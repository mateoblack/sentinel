---
phase: 130-identity-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [identity/aws_identity.go, identity/aws_identity_test.go, lambda/vend.go, lambda/vend_test.go, identity/security_test.go]
autonomous: true
---

<objective>
Strengthen AWS STS identity validation by adding missing partition support and consolidating identity extraction logic.

Purpose: Eliminate code duplication, support AWS ISO/ISO-B partitions for government environments, and add security regression tests for identity hardening.
Output: Hardened identity validation with comprehensive partition support and unified identity extraction.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# v1.7.1 established AWS identity extraction pattern
@identity/aws_identity.go
@identity/types.go
@lambda/vend.go

# Existing security tests for reference
@cli/identity_security_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AWS ISO and ISO-B partition support</name>
  <files>identity/aws_identity.go, identity/aws_identity_test.go</files>
  <action>
Add support for aws-iso and aws-iso-b partitions to the validPartitions map in identity/aws_identity.go.

Update validPartitions (around line 39):
```go
var validPartitions = map[string]bool{
    "aws":        true, // Commercial
    "aws-cn":     true, // China
    "aws-us-gov": true, // GovCloud
    "aws-iso":    true, // Isolated Cloud (DoD)
    "aws-iso-b":  true, // Isolated Cloud C2S
}
```

Add test cases to identity/aws_identity_test.go in TestParseARN for:
- arn:aws-iso:iam::123456789012:user/alice (ISO partition IAM user)
- arn:aws-iso:sts::123456789012:assumed-role/MyRole/session (ISO partition assumed role)
- arn:aws-iso-b:iam::123456789012:user/bob (ISO-B partition IAM user)
- arn:aws-iso-b:sts::123456789012:assumed-role/MyRole/session (ISO-B partition assumed role)

Verify that partition validation rejects invalid partitions (existing test already covers this).
  </action>
  <verify>go test ./identity/... -run TestParseARN -v passes with new partition test cases</verify>
  <done>AWS ISO and ISO-B partitions validated correctly, test cases pass</done>
</task>

<task type="auto">
  <name>Task 2: Consolidate Lambda identity extraction to use identity.ParseARN</name>
  <files>lambda/vend.go, lambda/vend_test.go</files>
  <action>
Refactor lambda/vend.go to use identity.ExtractUsername() instead of the local extractUsername() function. This consolidates identity validation and ensures partition validation is consistently applied.

1. Replace the extractUsername function (lines 183-258) with a call to identity.ExtractUsername():

```go
// extractUsername extracts a sanitized username from an AWS ARN using the
// identity package for consistent validation across CLI and Lambda TVM.
func extractUsername(userARN string) (string, error) {
    if userARN == "" {
        return "", ErrInvalidARN
    }
    username, err := identity.ExtractUsername(userARN)
    if err != nil {
        // Wrap identity errors with lambda-specific error types for API consistency
        if errors.Is(err, identity.ErrEmptyARN) {
            return "", ErrInvalidARN
        }
        if errors.Is(err, identity.ErrInvalidARN) {
            return "", ErrInvalidARN
        }
        if errors.Is(err, identity.ErrUnsupportedIdentityType) {
            return "", ErrInvalidARN
        }
        return "", fmt.Errorf("failed to extract username: %w", err)
    }
    if username == "" {
        return "", ErrEmptyUsername
    }
    return username, nil
}
```

2. Update vend_test.go to verify the new extractUsername delegates to identity.ExtractUsername correctly and maintains the same behavior for all existing test cases.

Do NOT break existing tests - the refactored code must pass all existing lambda/vend_test.go tests.
  </action>
  <verify>go test ./lambda/... -v passes all existing tests</verify>
  <done>Lambda identity extraction uses consolidated identity.ExtractUsername, all tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Add identity hardening security regression tests</name>
  <files>identity/security_test.go</files>
  <action>
Create identity/security_test.go with security regression tests for the hardening changes. Tests should use TestSecurityRegression_ prefix for CI/CD filtering.

Test categories:
1. Partition validation security - verify all valid partitions accepted, invalid rejected
2. ARN injection prevention - verify malicious ARN inputs are rejected
3. Identity extraction consistency - verify CLI and Lambda paths produce identical results

Test cases:
```go
// TestSecurityRegression_PartitionValidation verifies all AWS partitions
func TestSecurityRegression_PartitionValidation(t *testing.T) {
    validPartitions := []string{"aws", "aws-cn", "aws-us-gov", "aws-iso", "aws-iso-b"}
    // Test each valid partition with user and assumed-role ARNs

    invalidPartitions := []string{"aws-invalid", "amazon", "ec2", ""}
    // Verify invalid partitions are rejected
}

// TestSecurityRegression_ARNInjectionPrevention verifies injection attacks are blocked
func TestSecurityRegression_ARNInjectionPrevention(t *testing.T) {
    maliciousARNs := []string{
        "arn:aws:iam::123456789012:user/../../../etc/passwd",
        "arn:aws:sts::123456789012:assumed-role/Role/session;admin",
        "arn:aws:iam::123456789012:user/\x00nullbyte",
        "arn:aws:sts::123456789012:assumed-role/Role/${jndi:ldap://evil}",
    }
    // All should either fail parsing or produce sanitized usernames
}

// TestSecurityRegression_IdentityExtractionConsistency verifies CLI and Lambda produce same results
func TestSecurityRegression_IdentityExtractionConsistency(t *testing.T) {
    testARNs := []string{
        "arn:aws:iam::123456789012:user/alice",
        "arn:aws:sts::123456789012:assumed-role/Role/session",
        "arn:aws:sts::123456789012:assumed-role/AWSReservedSSO_Admin_abc/user@company.com",
    }
    // Verify identity.ExtractUsername matches lambda/vend extractUsername for all cases
}
```
  </action>
  <verify>go test ./identity/... -run TestSecurityRegression -v passes</verify>
  <done>Security regression tests cover partition validation, injection prevention, and extraction consistency</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test ./identity/... passes all tests including new partition tests
- [ ] go test ./lambda/... passes all tests with refactored extractUsername
- [ ] go test ./identity/... -run TestSecurityRegression passes security tests
- [ ] gofmt -l identity/ lambda/ reports no formatting issues
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- AWS ISO and ISO-B partitions supported
- Lambda identity extraction uses consolidated identity.ExtractUsername
- Security regression tests cover hardening changes
- No existing tests broken
</success_criteria>

<output>
After completion, create `.planning/phases/130-identity-hardening/130-01-SUMMARY.md`
</output>
