---
phase: 48-require-sentinel-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [enforce/drift.go, enforce/drift_test.go, cli/credentials.go, cli/sentinel_exec.go, cli/sentinel_exec_test.go, logging/decision.go, cmd/sentinel/main.go]
autonomous: true
---

<objective>
Add `require_sentinel` enforcement mode that warns when credentials are issued without verified Sentinel enforcement on the target role.

Purpose: Close the loop between Sentinel decisions and AWS enforcement by detecting "drift" - when teams configure Sentinel but roles lack the trust policy enforcement, creating a false sense of security.

Output: New `--require-sentinel` flag on credentials and exec commands, drift detection logic, warning output, and enhanced decision logging with drift status.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context - enforcement analyzer already exists
@.planning/phases/47-audit-verify-command/47-01-SUMMARY.md

# Key source files
@enforce/analyze.go
@cli/credentials.go
@logging/decision.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create drift detection types and checker</name>
  <files>enforce/drift.go, enforce/drift_test.go</files>
  <action>
Create drift detection module in enforce package:

1. Add DriftStatus type with constants:
   - DriftStatusOK: Role has full Sentinel enforcement
   - DriftStatusPartial: Role has partial enforcement (some statements missing)
   - DriftStatusNone: Role has no Sentinel enforcement
   - DriftStatusUnknown: Could not check (e.g., IAM API error)

2. Add DriftCheckResult struct:
   - Status DriftStatus
   - RoleARN string
   - Message string (human-readable explanation)
   - Error string (if check failed)

3. Add DriftChecker interface:
   ```go
   type DriftChecker interface {
       CheckRole(ctx context.Context, roleARN string) (*DriftCheckResult, error)
   }
   ```

4. Implement driftChecker using existing enforcement.Analyzer:
   - Create via NewDriftChecker(awsCfg aws.Config)
   - CheckRole calls Analyzer.Analyze for the role
   - Map AnalysisResult.Status to DriftStatus
   - Return DriftStatusUnknown if Analyzer returns error

5. Create TestDriftChecker for testing:
   - Accepts a function to return custom results
   - Used by CLI tests

Write comprehensive tests covering:
- Full enforcement returns DriftStatusOK
- Partial enforcement returns DriftStatusPartial
- No enforcement returns DriftStatusNone
- IAM errors return DriftStatusUnknown with error message
  </action>
  <verify>go test ./enforce/... -run Drift -v passes</verify>
  <done>DriftChecker interface and implementation exist with full test coverage</done>
</task>

<task type="auto">
  <name>Task 2: Add drift field to decision logging</name>
  <files>logging/decision.go, logging/decision_test.go</files>
  <action>
Extend DecisionLogEntry to include drift status:

1. Add DriftStatus field to DecisionLogEntry:
   ```go
   DriftStatus string `json:"drift_status,omitempty"` // "ok", "partial", "none", "unknown"
   ```

2. Add DriftMessage field for context:
   ```go
   DriftMessage string `json:"drift_message,omitempty"` // Explanation of drift status
   ```

3. Extend CredentialIssuanceFields to include drift info:
   ```go
   DriftStatus  string // From enforce.DriftStatus
   DriftMessage string // Human-readable explanation
   ```

4. Update NewEnhancedDecisionLogEntry to populate drift fields from CredentialIssuanceFields.

Use omitempty so existing logs without drift checking are unchanged (backward compatible).

Write tests verifying:
- Drift fields included when present
- Drift fields omitted when empty (omitempty behavior)
- JSON marshaling produces expected output
  </action>
  <verify>go test ./logging/... -run Drift -v passes</verify>
  <done>DecisionLogEntry includes drift_status and drift_message fields</done>
</task>

<task type="auto">
  <name>Task 3: Add --require-sentinel flag to credentials command</name>
  <files>cli/credentials.go, cli/credentials_test.go</files>
  <action>
Add drift checking to credentials command:

1. Add to CredentialsCommandInput:
   ```go
   RequireSentinel bool                  // Check role enforcement before issuing
   DriftChecker    enforce.DriftChecker  // Optional: for testing (nil = create from AWS config)
   ```

2. Add --require-sentinel flag:
   ```go
   cmd.Flag("require-sentinel", "Warn if target role lacks Sentinel trust policy enforcement").
       BoolVar(&input.RequireSentinel)
   ```

3. In CredentialsCommand, after credentials are retrieved (before output):
   - Skip if !input.RequireSentinel
   - Skip if RoleARN is empty (no role assumption, drift N/A)
   - Get or create DriftChecker (like Advisor pattern in enforce.go)
   - Call CheckRole with creds.RoleARN
   - On DriftStatusPartial or DriftStatusNone:
     - Print warning to stderr: "Warning: Role {arn} does not have full Sentinel enforcement ({status})"
     - Include DriftMessage if present
   - On DriftStatusUnknown:
     - Print warning: "Warning: Could not verify Sentinel enforcement for {arn}: {error}"
   - Populate CredentialIssuanceFields with drift info for logging

4. DO NOT block credential issuance - this is advisory mode only. Credentials still returned.

Write tests using TestDriftChecker:
- No warning when RequireSentinel=false
- No warning when RoleARN is empty
- Warning printed for partial enforcement
- Warning printed for no enforcement
- Warning printed for check errors
- Credentials still returned despite warnings
- Drift status appears in decision log
  </action>
  <verify>go test ./cli/... -run TestCredentialsCommand -v passes</verify>
  <done>credentials command has --require-sentinel flag with warning output and drift logging</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `go test ./...` passes all tests
- [ ] `go vet ./...` reports no issues
- [ ] Running `sentinel credentials --require-sentinel --profile test --policy-parameter /test` issues appropriate warnings
</verification>

<success_criteria>

- DriftChecker interface and implementation with full test coverage
- DecisionLogEntry extended with drift_status and drift_message fields
- credentials command has --require-sentinel flag
- Warnings output to stderr when drift detected
- Drift status logged in decision logs for audit
- Credentials still issued (advisory only, no blocking)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/48-require-sentinel-mode/48-01-SUMMARY.md`
</output>
