---
phase: 107-mdm-api-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [mdm/types.go, mdm/provider.go, mdm/provider_test.go, lambda/config.go]
autonomous: true
---

<objective>
Define MDM provider interface and configuration types for server-side device posture verification.

Purpose: Establish abstraction layer enabling multiple MDM providers (Jamf, Intune, Kandji) while maintaining consistent API for TVM integration.
Output: mdm/ package with Provider interface, MultiProvider composition, NoopProvider for testing, and configuration types.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/CONSTRAINTS.md

# Prior phase context:
@.planning/phases/106-local-device-collector/106-01-SUMMARY.md

# Reference patterns:
@notification/notifier.go
@device/collector.go
@lambda/config.go

# Device types:
@device/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MDM types and configuration</name>
  <files>mdm/types.go</files>
  <action>
Create new mdm/ package with device posture types for MDM responses:

1. MDMDeviceInfo struct with fields:
   - DeviceID string (hardware identifier - UDID/SerialNumber mapped to our device ID)
   - Enrolled bool (MDM enrollment status)
   - Compliant bool (MDM compliance status)
   - ComplianceDetails string (reason for non-compliance if applicable)
   - LastCheckIn time.Time (when device last reported to MDM)
   - OSVersion string (OS version from MDM)
   - DeviceName string (human-readable device name)
   - MDMProvider string (which MDM returned this info)

2. MDMConfig struct for provider initialization:
   - ProviderType string (jamf, intune, kandji)
   - BaseURL string (API endpoint)
   - APIToken string (authentication token - loaded from Secrets Manager)
   - TenantID string (for multi-tenant MDMs like Intune)
   - Timeout time.Duration (API call timeout, default 10s)

3. MDMError struct with:
   - Provider string (which provider failed)
   - DeviceID string (which device lookup failed)
   - Err error (underlying error)
   - Implements Error() and Unwrap() for error chain compatibility

4. Sentinel errors:
   - ErrDeviceNotFound - device ID not registered in MDM
   - ErrMDMUnavailable - MDM API unreachable
   - ErrMDMAuthFailed - authentication failure

Follow device/types.go patterns for field naming and validation methods.
  </action>
  <verify>gofmt -l mdm/types.go returns empty (no formatting issues)</verify>
  <done>mdm/types.go exists with MDMDeviceInfo, MDMConfig, MDMError, and sentinel errors</done>
</task>

<task type="auto">
  <name>Task 2: Create MDM Provider interface and implementations</name>
  <files>mdm/provider.go</files>
  <action>
Create Provider interface and composition types:

1. Provider interface:
   ```go
   type Provider interface {
       // LookupDevice queries MDM for device posture by device identifier.
       // The deviceID is the HMAC-SHA256 hashed identifier from GetDeviceID().
       // Returns MDMDeviceInfo or error (ErrDeviceNotFound if unknown).
       LookupDevice(ctx context.Context, deviceID string) (*MDMDeviceInfo, error)

       // Name returns the provider name for logging (e.g., "jamf", "intune").
       Name() string
   }
   ```

2. MultiProvider composition (follows notification/notifier.go pattern):
   - Tries each provider in order
   - Returns first successful result
   - Aggregates errors if all fail
   - Filter nil providers in constructor

3. NoopProvider for testing:
   - Always returns ErrDeviceNotFound
   - Name() returns "noop"

4. DeviceIDMapper type for mapping Sentinel device IDs to MDM identifiers:
   - In production, MDM stores may use different device ID formats
   - For MVP, assume direct mapping (document this limitation)
   - Add MapDeviceID(sentinelID string) (mdmID string, err error) method placeholder

Follow notification/notifier.go structure for MultiProvider and NoopProvider patterns.
  </action>
  <verify>gofmt -l mdm/provider.go returns empty</verify>
  <done>mdm/provider.go exists with Provider interface, MultiProvider, NoopProvider, and DeviceIDMapper</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for MDM provider types</name>
  <files>mdm/provider_test.go</files>
  <action>
Create comprehensive tests following device/collector_test.go patterns:

1. TestMDMDeviceInfo_Validation:
   - Valid device info passes
   - Missing DeviceID fails
   - Empty provider name fails

2. TestMDMConfig_Validation:
   - Valid config passes
   - Missing ProviderType fails
   - Missing BaseURL fails

3. TestMDMError:
   - Error() formats correctly
   - Unwrap() returns underlying error
   - errors.Is() works with sentinel errors

4. TestMultiProvider:
   - Empty provider list returns ErrDeviceNotFound
   - First successful provider wins
   - All failures aggregates errors
   - Nil providers filtered out

5. TestNoopProvider:
   - Name() returns "noop"
   - LookupDevice returns ErrDeviceNotFound

Use table-driven tests. Create mock providers for testing MultiProvider behavior.
  </action>
  <verify>go test ./mdm/... passes (or gofmt -l mdm/ returns empty if go test unavailable)</verify>
  <done>mdm/provider_test.go exists with comprehensive test coverage for all types</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] gofmt -l mdm/ returns empty (all files formatted)
- [ ] mdm/types.go compiles without errors
- [ ] mdm/provider.go compiles without errors
- [ ] mdm/provider_test.go compiles without errors
- [ ] Provider interface matches Collector interface patterns
- [ ] MultiProvider matches MultiNotifier/MultiCollector patterns
</verification>

<success_criteria>

- All tasks completed
- mdm/ package created with clean interface design
- Types match existing Sentinel patterns (device/, notification/)
- Provider interface enables future Jamf/Intune/Kandji implementations
- Tests validate core provider behavior
</success_criteria>

<output>
After completion, create `.planning/phases/107-mdm-api-integration/107-01-SUMMARY.md`
</output>
