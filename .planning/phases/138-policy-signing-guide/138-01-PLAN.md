---
phase: 138-policy-signing-guide
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [docs/POLICY_SIGNING.md]
autonomous: true
---

<objective>
Create POLICY_SIGNING.md explaining KMS-based policy integrity for Sentinel.

Purpose: Enable users to understand why policy signing prevents attacks, set up KMS signing keys, sign/verify policies locally, and configure Lambda TVM signature verification.
Output: Complete documentation guide at docs/POLICY_SIGNING.md
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 137 completed policy command documentation
@.planning/phases/137-command-documentation/137-01-SUMMARY.md

# Source code references for policy signing implementation
@policy/signature.go
@policy/signer.go
@policy/verifying_loader.go
@cli/policy_sign.go
@lambda/config.go

# Existing documentation patterns
@docs/LAMBDA_TVM_DEPLOYMENT.md
@docs/SECURITY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create POLICY_SIGNING.md documentation guide</name>
  <files>docs/POLICY_SIGNING.md</files>
  <action>
Create comprehensive policy signing guide covering:

**1. Overview and Threat Model (~50 lines)**
- Why policy signing matters (prevent cache poisoning, SSM parameter tampering)
- Attack scenarios prevented: compromised IAM credentials modifying policies, man-in-the-middle during SSM reads
- Trust model: KMS key access = trusted signer, Lambda TVM verifies before use
- Fail-closed security: invalid signature = no credentials issued

**2. Prerequisites (~20 lines)**
- AWS account with KMS permissions
- Sentinel v1.18 or later
- For Lambda TVM: permissions to update function environment variables

**3. Creating a KMS Signing Key (~60 lines)**
- AWS Console steps (brief)
- AWS CLI commands to create asymmetric RSA_4096 key with SIGN_VERIFY usage
- Terraform example using aws_kms_key with key_spec = RSA_4096 and key_usage = SIGN_VERIFY
- Key alias creation for easier reference (alias/sentinel-policy-signing)
- IAM policy for key access (kms:Sign, kms:Verify)

**4. Signing Policies Locally (~40 lines)**
- `sentinel policy sign <file> --key-id <key> -o signature.json` workflow
- JSON signature format explanation
- Uploading signed policies: `sentinel policy push --sign --key-id <key> <profile> <file>`
- Verifying signatures: `sentinel policy verify <file> --key-id <key> -s signature.json`

**5. Lambda TVM Signature Verification (~50 lines)**
- Environment variables: SENTINEL_POLICY_SIGNING_KEY, SENTINEL_ENFORCE_POLICY_SIGNING
- Configuration workflow (add to existing Lambda or Terraform)
- Loader chain: SSM → VerifyingLoader → CachedLoader
- SSM parameter paths: /sentinel/policies/X for policy, /sentinel/signatures/X for signature

**6. CI/CD Integration (~40 lines)**
- GitHub Actions workflow example for policy validation and signing
- Pre-push validation (validate → diff → sign → push)
- Approval gates for policy changes

**7. Troubleshooting (~30 lines)**
- Common errors: signature missing, signature invalid, key access denied
- Log messages to look for (VerifyingLoader, ErrSignatureInvalid, ErrSignatureEnforced)
- Debugging with `policy verify` command

Use existing docs style: markdown headers, code blocks with language tags, tables for environment variables. Reference commands.md for CLI syntax (policy sign, policy verify, policy push --sign).
  </action>
  <verify>cat docs/POLICY_SIGNING.md | head -100 && wc -l docs/POLICY_SIGNING.md</verify>
  <done>POLICY_SIGNING.md exists with all 7 sections, 250-350 lines total</done>
</task>

<task type="auto">
  <name>Task 2: Add POLICY_SIGNING.md to documentation index</name>
  <files>docs/CHANGELOG.md, README.md</files>
  <action>
Update documentation references:

1. In docs/CHANGELOG.md, add to v1.19 "Added" section (or v1.18 if documenting existing feature):
   - POLICY_SIGNING.md guide for KMS-based policy integrity

2. In README.md, add link to POLICY_SIGNING.md in the "Documentation" or security-related section if such section exists. If no clear section, add to relevant features list.

Keep changes minimal - just add references, don't restructure existing content.
  </action>
  <verify>grep -l "POLICY_SIGNING" docs/CHANGELOG.md README.md 2>/dev/null | wc -l</verify>
  <done>POLICY_SIGNING.md referenced in CHANGELOG.md and README.md</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] docs/POLICY_SIGNING.md exists
- [ ] File has Overview, Prerequisites, KMS Key Creation, Signing Policies, Lambda TVM, CI/CD, Troubleshooting sections
- [ ] Terraform example for aws_kms_key is syntactically valid
- [ ] CLI commands match documented syntax in commands.md
- [ ] CHANGELOG.md references the new guide
</verification>

<success_criteria>

- POLICY_SIGNING.md created with all 7 sections
- User can follow guide to create KMS key, sign policy, configure Lambda TVM
- Troubleshooting section addresses common signature errors
- Documentation indexed in CHANGELOG.md
</success_criteria>

<output>
After completion, create `.planning/phases/138-policy-signing-guide/138-01-SUMMARY.md`
</output>
