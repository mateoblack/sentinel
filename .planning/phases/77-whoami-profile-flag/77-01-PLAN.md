---
phase: 77-whoami-profile-flag
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [cli/whoami.go, cli/whoami_test.go]
autonomous: true
---

<objective>
Add --profile flag to sentinel whoami command for SSO credential loading.

Purpose: The whoami command currently uses the default AWS credential chain without profile support. Users with SSO profiles cannot specify which profile's credentials to use. This is the only Sentinel command missing profile support after Phase 76.

Output: whoami command with --profile flag that enables SSO credential loading via AWS SDK credential provider chain.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/76-sso-credential-loading/76-01-SUMMARY.md

# Pattern reference - audit.go shows the exact pattern to follow:
# 1. Add AWSProfile string field to input struct
# 2. Add --aws-profile flag to CLI command
# 3. Add conditional WithSharedConfigProfile to awsCfgOpts

@cli/whoami.go
@cli/whoami_test.go
@cli/audit.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --profile flag to whoami command</name>
  <files>cli/whoami.go</files>
  <action>
1. Add `Profile string` field to `WhoamiCommandInput` struct after the `Region` field

2. In `ConfigureWhoamiCommand`, add flag registration after the --region flag:
```go
cmd.Flag("profile", "AWS profile for credentials (uses SSO credential provider if profile is SSO-configured)").
    StringVar(&input.Profile)
```

3. In `WhoamiCommand`, update the AWS config loading section. After line 80 (where awsCfgOpts is initialized), add conditional profile loading:
```go
if input.Profile != "" {
    awsCfgOpts = append(awsCfgOpts, config.WithSharedConfigProfile(input.Profile))
}
```

Note: Use `--profile` (not `--aws-profile`) because whoami has no concept of a "target profile" - it only needs credentials to call STS. This matches the semantic of "which AWS profile am I querying".
  </action>
  <verify>gofmt -l cli/whoami.go returns empty (no formatting errors)</verify>
  <done>WhoamiCommandInput has Profile field, CLI has --profile flag, config loading uses WithSharedConfigProfile when profile specified</done>
</task>

<task type="auto">
  <name>Task 2: Add test coverage for profile flag</name>
  <files>cli/whoami_test.go</files>
  <action>
Add test to verify the Profile field is properly passed through to the command input:

1. Add test `TestWhoamiCommand_ProfileFlag` that creates input with a Profile value and verifies the command executes successfully with mock STS client.

2. The test pattern should match the existing `TestWhoamiCommand_CustomRegion` test structure:
- Create temp files for stdout/stderr
- Create mock STS client
- Set Profile field on input
- Execute WhoamiCommand
- Verify no error and output contains expected content

Note: Since we provide a mock STSClient, the profile won't actually be used to load credentials in the test (the mock bypasses that). The test verifies the field exists and doesn't break the command. Real SSO profile testing requires actual AWS credentials.
  </action>
  <verify>go test -v -run TestWhoamiCommand_ProfileFlag ./cli/ passes</verify>
  <done>Test verifies Profile field is accepted and command executes without error when Profile is set</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] gofmt -l cli/whoami.go returns empty
- [ ] go build ./cli/... succeeds (syntax verification)
- [ ] go test -v -run TestWhoami ./cli/ passes all tests
- [ ] sentinel whoami --help shows --profile flag in output
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- whoami command has --profile flag for SSO credential loading
- Pattern matches other Phase 76 SSO credential loading implementations
</success_criteria>

<output>
After completion, create `.planning/phases/77-whoami-profile-flag/77-01-SUMMARY.md`
</output>
