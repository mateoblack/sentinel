---
phase: 72-security-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [cli/approve.go, cli/approve_test.go, cli/deny.go, cli/deny_test.go, cli/request.go, cli/request_test.go, cli/sentinel_list.go, cli/sentinel_list_test.go]
autonomous: true
---

<objective>
Replace OS username with AWS identity in approval workflow commands.

Purpose: Complete the security fix by ensuring approve, deny, request, and list commands use AWS-authenticated identity instead of OS username for authorization and audit trail.
Output: All approval workflow commands use AWS identity for user identification.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/70-identity-integration/70-01-SUMMARY.md

# Reference implementations (already fixed)
@cli/credentials.go
@cli/whoami.go

# Files to update
@cli/approve.go
@cli/deny.go
@cli/request.go
@cli/sentinel_list.go

# Identity package
@identity/aws_identity.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update approve.go and deny.go to use AWS identity</name>
  <files>cli/approve.go, cli/approve_test.go, cli/deny.go, cli/deny_test.go</files>
  <action>
Replace `user.Current()` with AWS identity extraction in both commands:

1. **approve.go changes:**
   - Remove `"os/user"` import, add `"github.com/aws/aws-sdk-go-v2/service/sts"` and identity package
   - Add `STSClient identity.STSAPI` field to `ApproveCommandInput` struct
   - Replace lines 91-97 (user.Current block) with:
     ```go
     // 2. Get AWS identity for approver
     stsClient := input.STSClient
     if stsClient == nil {
         awsCfgOpts := []func(*config.LoadOptions) error{}
         if input.Region != "" {
             awsCfgOpts = append(awsCfgOpts, config.WithRegion(input.Region))
         }
         awsCfg, err := config.LoadDefaultConfig(ctx, awsCfgOpts...)
         if err != nil {
             fmt.Fprintf(os.Stderr, "Failed to load AWS config: %v\n", err)
             return err
         }
         stsClient = sts.NewFromConfig(awsCfg)
     }
     approver, err := identity.GetAWSUsername(ctx, stsClient)
     if err != nil {
         fmt.Fprintf(os.Stderr, "Failed to get AWS identity: %v\n", err)
         return err
     }
     ```
   - Remove the now-duplicate AWS config loading block (merge into the identity section)

2. **deny.go changes:** Apply identical pattern - same structure as approve.go

3. **Update tests:**
   - Add mock STSClient to test inputs
   - Verify approver/denier is extracted from mock ARN, not OS user

WHY: The approver username is used for authorization checks against ApprovalPolicy (who can approve) and stored in audit trail. Using OS username allows policy bypass by running as different local user.
  </action>
  <verify>go test ./cli/... -run "TestApprove|TestDeny" -v passes with new mock STSClient tests</verify>
  <done>approve.go and deny.go use identity.GetAWSUsername, tests verify mock STS client injection works</done>
</task>

<task type="auto">
  <name>Task 2: Update request.go and sentinel_list.go to use AWS identity</name>
  <files>cli/request.go, cli/request_test.go, cli/sentinel_list.go, cli/sentinel_list_test.go</files>
  <action>
Apply the same pattern from Task 1 to request and list commands:

1. **request.go changes:**
   - Remove `"os/user"` import, add STS and identity imports
   - Add `STSClient identity.STSAPI` field to `RequestCommandInput` struct
   - Replace user.Current block with AWS identity extraction (same pattern as approve.go)
   - The username is used for `Requester` field in the request - must be AWS identity

2. **sentinel_list.go changes:**
   - Remove `"os/user"` import, add STS and identity imports
   - Add `STSClient identity.STSAPI` field to `SentinelListCommandInput` struct
   - Replace user.Current block with AWS identity extraction
   - The username is used for `--mine` flag filtering - must match stored AWS identities

3. **Update tests:**
   - Add mock STSClient to test inputs
   - Verify requester/filter uses mock ARN username

WHY: Request.Requester is stored in DynamoDB and used for notification routing and audit trail. List --mine filtering must match stored AWS identities. OS username allows impersonation across these workflows.
  </action>
  <verify>go test ./cli/... -run "TestRequest|TestSentinelList" -v passes with new mock STSClient tests</verify>
  <done>request.go and sentinel_list.go use identity.GetAWSUsername, tests verify mock injection</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds without errors
- [ ] `go test ./cli/... -run "TestApprove|TestDeny|TestRequest|TestSentinelList"` all pass
- [ ] No `"os/user"` imports remain in approve.go, deny.go, request.go, sentinel_list.go
- [ ] All four commands have STSClient field for test injection
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No OS user references in approval workflow commands
- Tests verify AWS identity extraction via mock STS client
  </success_criteria>

<output>
After completion, create `.planning/phases/72-security-validation/72-01-SUMMARY.md`
</output>
