---
phase: 72-security-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [cli/breakglass.go, cli/breakglass_test.go, cli/breakglass_close.go, cli/breakglass_close_test.go, cli/breakglass_list.go, cli/breakglass_list_test.go]
autonomous: true
---

<objective>
Replace OS username with AWS identity in break-glass commands.

Purpose: Complete the security fix by ensuring breakglass, breakglass-close, and breakglass-list commands use AWS-authenticated identity for authorization and audit trail.
Output: All break-glass commands use AWS identity for user identification.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/70-identity-integration/70-01-SUMMARY.md

# Reference implementations (already fixed)
@cli/credentials.go
@cli/whoami.go

# Files to update
@cli/breakglass.go
@cli/breakglass_close.go
@cli/breakglass_list.go

# Identity package
@identity/aws_identity.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update breakglass.go to use AWS identity</name>
  <files>cli/breakglass.go, cli/breakglass_test.go</files>
  <action>
Replace `user.Current()` with AWS identity extraction in breakglass command:

1. **breakglass.go changes:**
   - Remove `"os/user"` import, add `"github.com/aws/aws-sdk-go-v2/service/sts"` and identity package
   - Add `STSClient identity.STSAPI` field to `BreakGlassCommandInput` struct
   - Replace lines 99-105 (user.Current block) with AWS identity extraction:
     ```go
     // 1. Get AWS identity for invoker
     stsClient := input.STSClient
     if stsClient == nil {
         awsCfgOpts := []func(*config.LoadOptions) error{}
         if input.Region != "" {
             awsCfgOpts = append(awsCfgOpts, config.WithRegion(input.Region))
         }
         awsCfg, err := config.LoadDefaultConfig(ctx, awsCfgOpts...)
         if err != nil {
             fmt.Fprintf(os.Stderr, "Failed to load AWS config: %v\n", err)
             return err
         }
         stsClient = sts.NewFromConfig(awsCfg)
     }
     username, err := identity.GetAWSUsername(ctx, stsClient)
     if err != nil {
         fmt.Fprintf(os.Stderr, "Failed to get AWS identity: %v\n", err)
         return err
     }
     ```

2. **Update tests:**
   - Add mock STSClient to BreakGlassCommandInput in tests
   - Verify invoker username is extracted from mock ARN

CRITICAL: The username is used for `CanInvokeBreakGlass(rule, username)` authorization check (line 134). This is security-critical - OS username allows break-glass policy bypass.
  </action>
  <verify>go test ./cli/... -run "TestBreakGlass" -v passes with mock STSClient tests</verify>
  <done>breakglass.go uses identity.GetAWSUsername for invoker, tests verify mock injection</done>
</task>

<task type="auto">
  <name>Task 2: Update breakglass_close.go and breakglass_list.go to use AWS identity</name>
  <files>cli/breakglass_close.go, cli/breakglass_close_test.go, cli/breakglass_list.go, cli/breakglass_list_test.go</files>
  <action>
Apply the same pattern to close and list commands:

1. **breakglass_close.go changes:**
   - Remove `"os/user"` import, add STS and identity imports
   - Add `STSClient identity.STSAPI` field to `BreakGlassCloseCommandInput` struct
   - Replace user.Current block with AWS identity extraction
   - The username is used for `ClosedBy` field - must be AWS identity for audit trail

2. **breakglass_list.go changes:**
   - Remove `"os/user"` import, add STS and identity imports
   - Add `STSClient identity.STSAPI` field to `BreakGlassListCommandInput` struct
   - Replace user.Current block with AWS identity extraction
   - The username is used for `--invoker` flag filtering (default to current user)

3. **Update tests:**
   - Add mock STSClient to test inputs
   - Verify closer and filter username use mock ARN

WHY: ClosedBy is stored in audit trail for accountability. List filtering must match stored AWS identities. OS username allows audit trail confusion and filter bypass.
  </action>
  <verify>go test ./cli/... -run "TestBreakGlassClose|TestBreakGlassList" -v passes</verify>
  <done>breakglass_close.go and breakglass_list.go use identity.GetAWSUsername, tests verify mock injection</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds without errors
- [ ] `go test ./cli/... -run "TestBreakGlass"` all pass (covers all breakglass commands)
- [ ] No `"os/user"` imports remain in breakglass.go, breakglass_close.go, breakglass_list.go
- [ ] All three commands have STSClient field for test injection
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No OS user references in break-glass commands
- Tests verify AWS identity extraction via mock STS client
  </success_criteria>

<output>
After completion, create `.planning/phases/72-security-validation/72-02-SUMMARY.md`
</output>
