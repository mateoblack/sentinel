---
phase: 60-permissions-schema
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [permissions/types.go, permissions/registry.go, permissions/types_test.go, permissions/registry_test.go]
autonomous: true
---

<objective>
Create permission types and registry mapping Sentinel features to required IAM actions.

Purpose: Enable programmatic discovery of what AWS permissions each Sentinel feature requires, supporting the `sentinel permissions` command and guided setup in later phases.
Output: New `permissions` package with types, registry, and query functions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing permission-related code:
@bootstrap/iam.go
@bootstrap/types.go

# Subsystem implementations showing AWS API usage:
@policy/loader.go
@request/dynamodb.go
@breakglass/dynamodb.go
@notification/sns.go
@audit/verifier.go
@enforce/analyze.go
@sentinel/assume_role.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create permission types</name>
  <files>permissions/types.go, permissions/types_test.go</files>
  <action>
Create new `permissions` package with foundational types:

1. **Subsystem type** (string enum with IsValid):
   - `SubsystemCore` - Policy loading from SSM
   - `SubsystemCredentials` - STS operations for credential issuance
   - `SubsystemApprovals` - DynamoDB for approval workflows
   - `SubsystemBreakGlass` - DynamoDB for break-glass events
   - `SubsystemNotifications` - SNS for notifications
   - `SubsystemAudit` - CloudTrail for session verification
   - `SubsystemEnforce` - IAM for trust policy analysis
   - `SubsystemBootstrap` - SSM write operations for setup

2. **Feature type** (string enum with IsValid):
   - `FeaturePolicyLoad` - Load policies from SSM
   - `FeatureCredentialIssue` - Issue credentials via STS
   - `FeatureApprovalWorkflow` - Request/approve/deny with DynamoDB
   - `FeatureBreakGlass` - Emergency access with DynamoDB
   - `FeatureNotifySNS` - SNS notifications
   - `FeatureNotifyWebhook` - Webhook notifications (no AWS permissions)
   - `FeatureAuditVerify` - CloudTrail session verification
   - `FeatureEnforceAnalyze` - IAM trust policy analysis
   - `FeatureBootstrapPlan` - Bootstrap planning (SSM read)
   - `FeatureBootstrapApply` - Bootstrap apply (SSM write)

3. **Permission struct**:
   ```go
   type Permission struct {
       Service     string   // AWS service (e.g., "ssm", "dynamodb", "sns")
       Actions     []string // IAM actions (e.g., "ssm:GetParameter")
       Resource    string   // Resource pattern (e.g., "arn:aws:ssm:*:*:parameter/sentinel/*")
       Description string   // Human-readable description
   }
   ```

4. **FeaturePermissions struct**:
   ```go
   type FeaturePermissions struct {
       Feature     Feature
       Subsystem   Subsystem
       Permissions []Permission
       Optional    bool   // True if feature works without these (e.g., notifications)
   }
   ```

5. Helper functions:
   - `AllSubsystems() []Subsystem` - Returns all subsystem values
   - `AllFeatures() []Feature` - Returns all feature values
   - `(s Subsystem) Features() []Feature` - Returns features in a subsystem

Follow existing type patterns from policy/types.go (string type aliases with IsValid methods).
  </action>
  <verify>go build ./permissions && go test ./permissions -run TestTypes -v</verify>
  <done>Permission types compile, IsValid methods work, helper functions return correct values</done>
</task>

<task type="auto">
  <name>Task 2: Create permission registry</name>
  <files>permissions/registry.go, permissions/registry_test.go</files>
  <action>
Create registry mapping features to their required IAM permissions:

1. **Registry variable** (package-level, unexported):
   ```go
   var registry = map[Feature]FeaturePermissions{...}
   ```

2. **Populate registry with accurate IAM actions** (from codebase analysis):

   **FeaturePolicyLoad** (SubsystemCore):
   - ssm:GetParameter, ssm:GetParameters, ssm:GetParametersByPath
   - Resource: arn:aws:ssm:*:*:parameter/sentinel/policies/*

   **FeatureCredentialIssue** (SubsystemCredentials):
   - sts:AssumeRole (with SourceIdentity)
   - Resource: arn:aws:iam::*:role/* (caller must have assume permission)

   **FeatureApprovalWorkflow** (SubsystemApprovals):
   - dynamodb:PutItem, dynamodb:GetItem, dynamodb:DeleteItem, dynamodb:Query
   - Resource: arn:aws:dynamodb:*:*:table/sentinel-requests
   - Resource: arn:aws:dynamodb:*:*:table/sentinel-requests/index/*

   **FeatureBreakGlass** (SubsystemBreakGlass):
   - dynamodb:PutItem, dynamodb:GetItem, dynamodb:DeleteItem, dynamodb:Query
   - Resource: arn:aws:dynamodb:*:*:table/sentinel-breakglass
   - Resource: arn:aws:dynamodb:*:*:table/sentinel-breakglass/index/*

   **FeatureNotifySNS** (SubsystemNotifications):
   - sns:Publish
   - Resource: arn:aws:sns:*:*:sentinel-* (topic ARN pattern)
   - Optional: true

   **FeatureNotifyWebhook** (SubsystemNotifications):
   - No AWS permissions (HTTP only)
   - Optional: true

   **FeatureAuditVerify** (SubsystemAudit):
   - cloudtrail:LookupEvents
   - Resource: * (CloudTrail doesn't support resource-level permissions for LookupEvents)

   **FeatureEnforceAnalyze** (SubsystemEnforce):
   - iam:GetRole, iam:ListRoles
   - Resource: arn:aws:iam::*:role/*

   **FeatureBootstrapPlan** (SubsystemBootstrap):
   - ssm:GetParameter, ssm:GetParametersByPath
   - Resource: arn:aws:ssm:*:*:parameter/sentinel/*

   **FeatureBootstrapApply** (SubsystemBootstrap):
   - ssm:PutParameter, ssm:DeleteParameter, ssm:AddTagsToResource, ssm:RemoveTagsFromResource
   - Resource: arn:aws:ssm:*:*:parameter/sentinel/*

3. **Query functions**:
   - `GetFeaturePermissions(f Feature) (FeaturePermissions, bool)` - Get permissions for a feature
   - `GetSubsystemPermissions(s Subsystem) []FeaturePermissions` - Get all permissions for a subsystem
   - `GetAllPermissions() []FeaturePermissions` - Get complete permission list
   - `GetRequiredPermissions() []FeaturePermissions` - Get non-optional permissions only

4. **Aggregation helpers**:
   - `UniqueActions(perms []FeaturePermissions) []string` - Deduplicated list of all IAM actions
   - `ByService(perms []FeaturePermissions) map[string][]Permission` - Group permissions by AWS service

Tests should verify:
- All features are registered
- Registry returns correct permissions for each feature
- Aggregation functions work correctly
- No duplicate actions within a feature
  </action>
  <verify>go test ./permissions -v && go build ./...</verify>
  <done>Registry contains all features with accurate IAM actions, query functions work, tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds without errors
- [ ] `go test ./permissions -v` passes all tests
- [ ] All 10 features registered in registry
- [ ] All 8 subsystems have correct feature mappings
- [ ] Permission actions match actual AWS API usage in codebase
</verification>

<success_criteria>
- New permissions package created with types.go and registry.go
- All Sentinel features mapped to required IAM actions
- Query functions enable programmatic permission discovery
- Tests verify type validation and registry completeness
- Code follows existing patterns (string type aliases, IsValid methods)
</success_criteria>

<output>
After completion, create `.planning/phases/60-permissions-schema/60-01-SUMMARY.md`
</output>
