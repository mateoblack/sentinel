---
phase: 137-command-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/guide/commands.md
  - cmd/sentinel/main.go
autonomous: true
---

<objective>
Document all 6 policy commands in commands.md with syntax, flags, and practical examples.

Purpose: Users can find and use the v1.17/v1.18 policy management commands (pull, push, diff, validate, sign, verify) with clear documentation following the established commands.md pattern.
Output: Updated commands.md with Policy Commands section; main.go fixed to register policy command.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files for accurate documentation:
@cli/policy.go
@cli/policy_sign.go

# Existing documentation pattern to follow:
@docs/guide/commands.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register policy command in main.go</name>
  <files>cmd/sentinel/main.go</files>
  <action>
Add the missing policy command registration to main.go. The ConfigurePolicyCommand function exists in cli/policy.go but is not called from main.go.

Add after the Config commands section (line ~55):
```go
// Policy commands
cli.ConfigurePolicyCommand(app, s)
```

This enables the `sentinel policy` command group with its 6 subcommands (pull, push, diff, validate, sign, verify).
  </action>
  <verify>go build ./cmd/sentinel && ./sentinel policy --help shows the policy subcommands</verify>
  <done>sentinel policy command is registered and shows 6 subcommands in help output</done>
</task>

<task type="auto">
  <name>Task 2: Add Policy Commands section to commands.md</name>
  <files>docs/guide/commands.md</files>
  <action>
Add a new "## Policy Commands" section to commands.md after the "## Shell Commands" section (at the end of the file, before any footer content).

Document all 6 commands following the exact pattern used for other commands in the file:
- Command name and description
- Usage syntax
- Flags table with Flag, Description, Required columns
- Examples (both basic and advanced)
- Output format (JSON where applicable)
- Exit codes table

Commands to document:

### policy pull
- Fetches policy YAML from SSM Parameter Store
- Flags: --policy-root, --policy-parameter, --output/-o, --region, --aws-profile
- Output to stdout (pipeable) or file with -o
- Exit codes: 0=success, 1=error

### policy push
- Validates and uploads policy to SSM
- Flags: --policy-root, --policy-parameter, --region, --aws-profile, --no-backup, --force/-f, --sign, --key-id
- Shows confirmation prompt (bypass with --force)
- Exit codes: 0=success, 1=error

### policy diff
- Shows unified diff between local file and SSM policy
- Flags: --policy-root, --policy-parameter, --region, --aws-profile, --no-color
- Color output by default (disable with --no-color)
- Exit codes: 0=no changes, 1=changes exist (scripting-friendly)

### policy validate
- Validates local policy YAML without AWS credentials
- Flags: --quiet/-q
- Exit codes: 0=valid, 1=invalid

### policy sign
- Signs policy with KMS RSASSA_PSS_SHA_256
- Flags: --key-id (required), --output/-o, --region, --aws-profile
- Outputs JSON with base64 signature and metadata
- Exit codes: 0=success, 1=error

### policy verify
- Verifies detached KMS signature
- Flags: --key-id (required), --signature/-s (required), --region, --aws-profile
- Validates signature and policy hash match
- Exit codes: 0=valid, 1=invalid

Also add a "Policy Workflow" subsection showing the recommended workflow:
1. pull (fetch current policy)
2. edit (modify locally)
3. validate (check syntax locally)
4. diff (preview changes)
5. push (deploy with optional signing)

Examples should demonstrate:
- Basic usage (single command)
- Pipeline usage (e.g., pull | yq | push)
- Signing workflow (sign → verify → push --sign)
- CI/CD integration (diff exit code for change detection)
  </action>
  <verify>grep -c "policy pull\|policy push\|policy diff\|policy validate\|policy sign\|policy verify" docs/guide/commands.md returns 6 or more matches</verify>
  <done>All 6 policy commands are documented with syntax, flags, examples, and exit codes following the established pattern</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go build ./cmd/sentinel succeeds
- [ ] ./sentinel policy --help shows all 6 subcommands
- [ ] docs/guide/commands.md contains Policy Commands section
- [ ] Each of the 6 commands has: Usage, Flags table, Examples, Exit codes
- [ ] Policy workflow is documented
</verification>

<success_criteria>

- Task 1: Policy command registered in main.go and working
- Task 2: All 6 policy commands documented in commands.md
- All verification checks pass
- No build errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/137-command-documentation/137-01-SUMMARY.md`
</output>
