---
phase: 44-enforcement-advisor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [enforce/advisor.go, enforce/advisor_test.go, cli/enforce.go, cli/enforce_test.go]
autonomous: true
---

<objective>
Implement `sentinel enforce plan` command that analyzes IAM role trust policies for Sentinel enforcement status.

Purpose: Allow teams to assess their roles and get actionable guidance for enabling Sentinel enforcement.
Output: CLI command that outputs tiered enforcement status (Full/Partial/None) with remediation recommendations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-enforcement-types/43-01-SUMMARY.md
@.planning/phases/43-enforcement-types/43-02-SUMMARY.md

@enforce/types.go
@enforce/analyze.go
@enforce/parse.go
@cli/status.go
@cli/bootstrap.go
@docs/ENFORCEMENT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create enforcement advisor with IAM integration</name>
  <files>enforce/advisor.go, enforce/advisor_test.go</files>
  <action>
Create enforce/advisor.go with:

1. **iamAPI interface** for testability:
   ```go
   type iamAPI interface {
       GetRole(ctx context.Context, params *iam.GetRoleInput, optFns ...func(*iam.Options)) (*iam.GetRoleOutput, error)
   }
   ```

2. **Advisor struct**:
   ```go
   type Advisor struct {
       client iamAPI
   }

   func NewAdvisor(cfg aws.Config) *Advisor
   ```

3. **RoleAnalysis type** that wraps AnalysisResult with role metadata:
   ```go
   type RoleAnalysis struct {
       RoleARN       string           `json:"role_arn"`
       RoleName      string           `json:"role_name"`
       Analysis      *AnalysisResult  `json:"analysis"`
       Error         string           `json:"error,omitempty"`
   }
   ```

4. **AnalyzeRole method** - fetches trust policy via iam:GetRole, parses with ParseTrustPolicy, analyzes with AnalyzeTrustPolicy:
   ```go
   func (a *Advisor) AnalyzeRole(ctx context.Context, roleARN string) (*RoleAnalysis, error)
   ```
   - Extract role name from ARN (last segment after "/")
   - Call GetRole with role name
   - URL-decode the AssumeRolePolicyDocument (IAM returns URL-encoded JSON)
   - Parse with ParseTrustPolicy
   - Analyze with AnalyzeTrustPolicy
   - Return RoleAnalysis with all fields populated

5. **AnalyzeRoles method** - batch analysis for multiple roles:
   ```go
   func (a *Advisor) AnalyzeRoles(ctx context.Context, roleARNs []string) ([]*RoleAnalysis, error)
   ```
   - Iterate through roleARNs
   - Call AnalyzeRole for each
   - Collect results (don't fail fast - capture errors in RoleAnalysis.Error)
   - Return all results

Create enforce/advisor_test.go with:
- Mock iamAPI implementation
- Test AnalyzeRole with sample trust policies (Pattern A/B/C from ENFORCEMENT.md)
- Test error handling (role not found, invalid JSON)
- Test batch AnalyzeRoles
  </action>
  <verify>go test ./enforce/... -run "Advisor" -v passes</verify>
  <done>Advisor struct with AnalyzeRole and AnalyzeRoles methods that fetch and analyze IAM trust policies</done>
</task>

<task type="auto">
  <name>Task 2: Create sentinel enforce plan CLI command</name>
  <files>cli/enforce.go, cli/enforce_test.go</files>
  <action>
Create cli/enforce.go following the status.go and bootstrap.go patterns:

1. **EnforcePlanCommandInput struct**:
   ```go
   type EnforcePlanCommandInput struct {
       RoleARNs   []string
       Region     string
       JSONOutput bool

       // Advisor is optional for testing
       Advisor    *enforce.Advisor

       // Stdout/Stderr for testing
       Stdout     *os.File
       Stderr     *os.File
   }
   ```

2. **ConfigureEnforcePlanCommand function**:
   - Create "enforce" command group: `app.Command("enforce", "Enforcement status and guidance")`
   - Create "plan" subcommand: `enforceCmd.Command("plan", "Analyze role trust policies for Sentinel enforcement")`
   - Flags:
     - `--role` (repeatable, required): Role ARN(s) to analyze
     - `--region`: AWS region
     - `--json`: Output in JSON format
   - Action calls EnforcePlanCommand

3. **EnforcePlanCommand function**:
   - Create Advisor (use input.Advisor if provided for testing)
   - Call AnalyzeRoles with input.RoleARNs
   - Output results:

   **JSON output**: Marshal results with json.MarshalIndent

   **Human output** (default):
   ```
   Sentinel Enforcement Analysis
   =============================

   Role: arn:aws:iam::123456789012:role/ProductionAdmin
   Status: FULL ✓
   Level: trust_policy

   Role: arn:aws:iam::123456789012:role/DeveloperAccess
   Status: PARTIAL ⚠
   Level: trust_policy
   Issues:
     - Mixed enforcement: some Allow statements lack SourceIdentity condition
   Recommendations:
     - Add sts:SourceIdentity condition to all Allow statements

   Role: arn:aws:iam::123456789012:role/LegacyRole
   Status: NONE ✗
   Level: advisory
   Issues:
     - No sts:SourceIdentity condition found
   Recommendations:
     - Add StringLike condition for sts:SourceIdentity with pattern sentinel:*

   Summary
   -------
   Full enforcement:    1 role(s)
   Partial enforcement: 1 role(s)
   No enforcement:      1 role(s)
   ```

   Use status emoji/symbols:
   - Full: ✓ (green if terminal supports)
   - Partial: ⚠
   - None: ✗

4. Return error if any role analysis failed (after outputting all results)

Create cli/enforce_test.go with:
- Test human output formatting
- Test JSON output
- Test with mock Advisor (inject via input.Advisor)
- Test error cases
  </action>
  <verify>go test ./cli/... -run "EnforcePlan" -v passes && go build -o /dev/null . succeeds</verify>
  <done>`sentinel enforce plan --role arn:... [--role arn:...] [--json]` command works with both human and JSON output</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go test ./enforce/... -v` passes (including new advisor tests)
- [ ] `go test ./cli/... -v` passes (including new enforce tests)
- [ ] `go build .` succeeds without errors
- [ ] `./sentinel enforce plan --help` shows correct usage
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- `sentinel enforce plan` command analyzes role trust policies
- Human output shows tiered status with recommendations
- JSON output provides structured analysis results
</success_criteria>

<output>
After completion, create `.planning/phases/44-enforcement-advisor/44-01-SUMMARY.md`
</output>
