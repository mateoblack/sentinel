# Milestone v1.7.1: Security Patch

**Status:** SHIPPED 2026-01-19
**Phases:** 69-72
**Total Plans:** 7

## Overview

Critical security patch fixing a vulnerability where policy evaluation used the local OS username (`os/user.Current()`) instead of the AWS-authenticated identity. This allowed attackers with local access to bypass user-based policy restrictions by running Sentinel as a different local user.

## Phases

### Phase 69: AWS Identity Core

**Goal**: Extract username from AWS ARN for all identity types (IAM user, SSO, assumed-role)
**Depends on**: v1.7 complete
**Plans**: 1 plan

Plans:
- [x] 69-01: ARN parsing and username extraction

**Details:**
- Created AWSIdentity struct with ARN, AccountID, Type, Username, RawUsername fields
- Implemented ParseARN function handling all 6 ARN patterns
- Added support for all AWS partitions (aws, aws-cn, aws-us-gov)
- 95.6% test coverage including security tests

### Phase 70: Identity Integration

**Goal**: Replace `user.Current()` with AWS identity extraction in credential flow
**Depends on**: Phase 69
**Plans**: 1 plan

Plans:
- [x] 70-01: AWS identity integration in credential flow

**Details:**
- Added STSAPI interface for testability
- Implemented GetAWSUsername and GetAWSIdentity helpers
- Updated credentials.go and sentinel_exec.go to use AWS identity
- Added ErrCodeSTSError and ErrCodeSTSAccessDenied error codes

### Phase 71: Whoami Command

**Goal**: Add `sentinel whoami` command showing AWS identity and extracted policy username
**Depends on**: Phase 70
**Plans**: 1 plan

Plans:
- [x] 71-01: Whoami command with human and JSON output

**Details:**
- Created `sentinel whoami` command for identity visibility
- Human and JSON output formats
- Displays ARN, Account, Identity Type, Raw Username, Policy Username
- 15 test cases covering all identity types

### Phase 72: Security Validation

**Goal**: Complete identity fix across all commands, security validation tests, documentation
**Depends on**: Phase 71
**Plans**: 4 plans

Plans:
- [x] 72-01: Fix approval workflow commands (approve, deny, request, list)
- [x] 72-02: Fix break-glass commands (breakglass, breakglass-close, breakglass-list)
- [x] 72-03: Security regression tests for identity extraction
- [x] 72-04: Changelog and security advisory documentation

**Details:**
- Removed os/user dependency from all CLI commands
- Added STSClient field for dependency injection in all commands
- Created 1,072 lines of security regression tests
- Attack scenario tests demonstrating vulnerability and fix
- Created CHANGELOG.md and SECURITY.md with vulnerability advisory

---

## Milestone Summary

**Key Decisions:**
- STSAPI interface enables mock injection for unit tests without AWS credentials
- Username extraction uses existing sanitization logic (removes @, ., -, _, truncates to 20 chars)
- Mock STS client pattern established for all CLI command tests
- TestSecurityRegression_ prefix for CI/CD filtering of security tests
- Attack scenario tests explicitly demonstrate pre-v1.7.1 vulnerability and verify fix

**Issues Resolved:**
- CRITICAL: Policy bypass via OS username impersonation (SENTINEL-2026-001)
- All commands now use AWS STS GetCallerIdentity for user identity
- Comprehensive test coverage prevents regression

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None

---

_For current project status, see .planning/ROADMAP.md_
