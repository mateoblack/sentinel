# Milestone v1.12: Infrastructure Provisioning

**Status:** Planning
**Phases:** 88-93
**Total Plans:** ~14

## Overview

Approval workflows, break-glass, and server sessions all require DynamoDB tables. Currently users must create these manually. v1.12 adds automated infrastructure provisioning to `sentinel init`.

**Problem:**
```bash
# User wants to use approvals
sentinel request --profile prod --justification "Deploy hotfix" --request-table sentinel-requests

# Error: table doesn't exist, and user has to manually:
# 1. Figure out the table schema
# 2. Create the table with correct GSIs
# 3. Set up IAM permissions
# 4. Hope they got it right
```

**Solution:**
```bash
# One command creates everything
sentinel init approvals --region us-east-1

# Or all at once
sentinel init bootstrap --profile dev --with-approvals --with-breakglass --region us-east-1
```

## Phases

### Phase 88: Approval Table Provisioning

**Goal**: `sentinel init approvals` creates DynamoDB table for approval workflows

**Commands:**

```bash
# Plan what will be created
sentinel init approvals --plan --region us-east-1 --aws-profile dev

# Create the table
sentinel init approvals --region us-east-1 --aws-profile dev

# Custom table name
sentinel init approvals --table my-requests --region us-east-1 --aws-profile dev
```

**DynamoDB Table Schema:**

```
Table: sentinel-requests
Partition Key: id (S)

GSIs:
  - requester-index: PK=requester (S), SK=created_at (N)
  - status-index: PK=status (S), SK=created_at (N)
  - profile-index: PK=profile (S), SK=created_at (N)

TTL Attribute: expires_at
Billing: PAY_PER_REQUEST (on-demand)
```

**Features:**
- Idempotent (skip if table exists with correct schema)
- `--plan` shows what would be created
- `--generate-iam` outputs IAM policy for table access
- Validates AWS credentials before creating
- Waits for table to become ACTIVE

**Plans:**
- [x] 88-01: DynamoDB table schema types and validation â€” completed 2026-01-22
- [ ] 88-02: Approval table creation with GSIs
- [ ] 88-03: CLI init approvals command

---

### Phase 89: Break-Glass Table Provisioning

**Goal**: `sentinel init breakglass` creates DynamoDB table for break-glass events

**Commands:**

```bash
sentinel init breakglass --plan --region us-east-1 --aws-profile dev
sentinel init breakglass --region us-east-1 --aws-profile dev
```

**DynamoDB Table Schema:**

```
Table: sentinel-breakglass
Partition Key: id (S)

GSIs:
  - invoker-index: PK=invoker (S), SK=created_at (N)
  - status-index: PK=status (S), SK=created_at (N)
  - profile-index: PK=profile (S), SK=created_at (N)

TTL Attribute: expires_at
Billing: PAY_PER_REQUEST
```

**Plans:**
- [ ] 89-01: Break-glass table creation
- [ ] 89-02: CLI init breakglass command

---

### Phase 90: Session Table Provisioning

**Goal**: `sentinel init sessions` creates DynamoDB table for server session tracking

**Commands:**

```bash
sentinel init sessions --plan --region us-east-1 --aws-profile dev
sentinel init sessions --region us-east-1 --aws-profile dev
```

**DynamoDB Table Schema:**

```
Table: sentinel-sessions
Partition Key: id (S)

GSIs:
  - user-index: PK=user (S), SK=started_at (N)
  - status-index: PK=status (S), SK=started_at (N)
  - server-instance-index: PK=server_instance_id (S), SK=started_at (N)

TTL Attribute: expires_at
Billing: PAY_PER_REQUEST
```

**Plans:**
- [ ] 90-01: Session table creation
- [ ] 90-02: CLI init sessions command

---

### Phase 91: Unified Bootstrap Extension

**Goal**: Extend `sentinel init bootstrap` with `--with-*` flags for infrastructure

**Commands:**

```bash
# Bootstrap profile + approvals
sentinel init bootstrap --profile dev --with-approvals --region us-east-1 --aws-profile dev

# Bootstrap everything
sentinel init bootstrap --profile dev \
  --with-approvals \
  --with-breakglass \
  --with-sessions \
  --region us-east-1 \
  --aws-profile dev

# Shorthand for all optional features
sentinel init bootstrap --profile dev --all --region us-east-1 --aws-profile dev

# Plan mode shows SSM + DynamoDB changes
sentinel init bootstrap --profile dev --with-approvals --plan
```

**Features:**
- `--with-approvals` creates sentinel-requests table
- `--with-breakglass` creates sentinel-breakglass table
- `--with-sessions` creates sentinel-sessions table
- `--all` enables all optional infrastructure
- Combined `--generate-iam-policies` includes DynamoDB permissions
- Single atomic operation (rollback on failure? or continue with warnings?)

**Plans:**
- [ ] 91-01: Bootstrap flag extensions
- [ ] 91-02: Combined IAM policy generation
- [ ] 91-03: Plan output for infrastructure

---

### Phase 92: Enhanced Init Status

**Goal**: Show infrastructure health in `sentinel init status`

**Commands:**

```bash
sentinel init status --aws-profile dev --region us-east-1
```

**Enhanced Output:**

```
Sentinel Status
===============

Policy Parameters (/sentinel/policies):
  dev            v7   (2026-01-19 10:14:04)
  ai-readonly    v4   (2026-01-19 10:33:02)

Infrastructure:
  sentinel-requests    DynamoDB   us-east-1   ACTIVE
  sentinel-breakglass  DynamoDB   us-east-1   NOT FOUND
  sentinel-sessions    DynamoDB   us-east-1   NOT FOUND

Suggestions:
  Run: sentinel init breakglass --region us-east-1
  Run: sentinel init sessions --region us-east-1

Shell Integration:
  Add to ~/.zshrc: eval "$(sentinel shell init --aws-profile dev)"
```

**Features:**
- Check DynamoDB table existence and status
- Show suggestions for missing infrastructure
- `--json` output includes infrastructure status
- Optional `--check-tables` flag (default: check if region provided)

**Plans:**
- [ ] 92-01: DynamoDB table status checks
- [ ] 92-02: Suggestion generation
- [ ] 92-03: Shell integration hints

---

### Phase 93: Documentation & Validation

**Goal**: Update docs and add integration tests

**Plans:**
- [ ] 93-01: Update QUICKSTART.md with init commands
- [ ] 93-02: Update BOOTSTRAP.md with infrastructure provisioning
- [ ] 93-03: Integration tests for table creation

---

## Summary

| Phase | Name | Plans | Description |
|-------|------|-------|-------------|
| 88 | Approval Table | 3 | `sentinel init approvals` |
| 89 | Break-Glass Table | 2 | `sentinel init breakglass` |
| 90 | Session Table | 2 | `sentinel init sessions` |
| 91 | Unified Bootstrap | 3 | `--with-approvals` etc. |
| 92 | Enhanced Status | 3 | Infrastructure health display |
| 93 | Documentation | 3 | Docs and tests |

**Total:** 6 phases, 16 plans

## Example Full Onboarding

After v1.12, new user onboarding becomes:

```bash
# 1. Login to SSO
aws sso login --profile dev

# 2. Bootstrap everything (creates SSM params + DynamoDB tables)
sentinel init bootstrap --profile dev --all --region us-east-1 --aws-profile dev

# 3. Set up shell integration
echo 'eval "$(sentinel shell init --aws-profile dev)"' >> ~/.zshrc
source ~/.zshrc

# 4. Use it!
sentinel-dev aws s3 ls

# 5. Request approval for prod
sentinel request --profile prod --justification "Deploy hotfix" \
  --request-table sentinel-requests --region us-east-1
```

## Dependencies

- v1.10 (server sessions) - session table schema
- v1.11 (shell integration) - shell init command exists
- Existing DynamoDB patterns from request/ and breakglass/ packages

## Out of Scope

- CloudFormation/Terraform export for DynamoDB tables (maybe v1.13)
- SNS topic creation
- Cross-account infrastructure
- Table migration/updates (only create, not alter)
