# Milestone v1.1: Sentinel Fingerprint

**Status:** ✅ SHIPPED 2026-01-15
**Phases:** 9-17
**Total Plans:** 12

## Overview

Make Sentinel enforceable and provable inside AWS by stamping all sessions with a Sentinel-controlled SourceIdentity. This enables CloudTrail correlation between Sentinel access decisions and AWS API calls, and allows optional IAM enforcement via trust policies and SCPs.

## Phases

### Phase 9: Source Identity Schema

**Goal**: Define SourceIdentity format (`sentinel:<user>:<request-id>`) and request-id generation
**Depends on**: v1.0 complete
**Plans**: 1 plan

Plans:
- [x] 09-01: Create SourceIdentity type and request-id generation

**Details:**
- Created `identity` package with SourceIdentity type
- Implemented Format(), Parse(), Validate(), IsValid(), and String() methods
- Added NewRequestID() using crypto/rand for 8-char lowercase hex generation
- SanitizeUser() helper for username normalization

### Phase 10: AssumeRole Provider

**Goal**: Build AssumeRole wrapper that stamps SourceIdentity on all role assumptions
**Depends on**: Phase 9
**Plans**: 1 plan

Plans:
- [x] 10-01: Create SentinelAssumeRole function with SourceIdentity stamping

**Details:**
- Created `sentinel` package with SentinelAssumeRole function
- Built SentinelAssumeRoleInput/Output structs with validation
- Default handling for RoleSessionName (sentinel-timestamp) and Duration (1 hour)

### Phase 11: Two-Hop Orchestration

**Goal**: Chain aws-vault base credentials → Sentinel AssumeRole with SourceIdentity
**Depends on**: Phase 10
**Plans**: 1 plan

Plans:
- [x] 11-01: Create TwoHopCredentialProvider with SourceIdentity generation

**Details:**
- Created TwoHopCredentialProvider implementing aws.CredentialsProvider interface
- Provider chains aws-vault credentials through SentinelAssumeRole
- Each Retrieve() generates unique request-id for SourceIdentity

### Phase 12: Credential Process Update

**Goal**: Update credential_process command to use two-hop pattern for SourceIdentity stamping
**Depends on**: Phase 11
**Plans**: 1 plan

Plans:
- [x] 12-01: Integrate GetCredentialsWithSourceIdentity into credentials command

**Details:**
- Added `User` field to `SentinelCredentialRequest`
- Created `GetCredentialsWithSourceIdentity` method with role_arn routing
- Updated `credentials` command to call new method with username

### Phase 13: Exec Command Update

**Goal**: Update exec command to use two-hop credential flow with SourceIdentity
**Depends on**: Phase 12
**Plans**: 1 plan

Plans:
- [x] 13-01: Update exec command to use GetCredentialsWithSourceIdentity

**Details:**
- Updated exec command to include User field in credential request
- Unified credential flow between credentials and exec commands

### Phase 14: Enhanced Decision Logging

**Goal**: Add request-id, source-identity, role-arn, session-duration to decision logs
**Depends on**: Phase 13
**Plans**: 4 plans

Plans:
- [x] 14-01: Extend DecisionLogEntry with CloudTrail correlation fields
- [x] 14-02: Integrate enhanced logging into credential_process
- [x] 14-03: Integrate enhanced logging into exec command
- [x] 14-04: Add logging integration tests

**Details:**
- Extended DecisionLogEntry struct with four new optional fields
- Created CredentialIssuanceFields struct for credential context
- Added NewEnhancedDecisionLogEntry constructor
- All new fields use omitempty for backward compatibility

### Phase 15: CloudTrail Correlation

**Goal**: Documentation and tooling for correlating Sentinel logs with CloudTrail events
**Depends on**: Phase 14
**Plans**: 1 plan

Plans:
- [x] 15-01: Create CloudTrail correlation documentation

**Details:**
- Created docs/CLOUDTRAIL.md with complete correlation guide
- Documented AWS CLI lookup-events examples with jq filtering
- Added Athena queries for session lookup and cross-reference joins

### Phase 16: Enforcement Patterns

**Goal**: Document trust policy and SCP patterns for optional Sentinel enforcement
**Depends on**: Phase 15
**Plans**: 1 plan

Plans:
- [x] 16-01: Create enforcement patterns documentation

**Details:**
- Created docs/ENFORCEMENT.md with three enforcement levels
- Provided 3 trust policy patterns and 3 SCP patterns
- Created 4-phase progressive deployment guide
- Added troubleshooting for common enforcement issues

### Phase 17: Integration Testing

**Goal**: End-to-end testing of fingerprint flow with real AWS resources
**Depends on**: Phase 16
**Plans**: 1 plan

Plans:
- [x] 17-01: Create integration tests for Sentinel Fingerprint flow

**Details:**
- Created integration test infrastructure with skip helpers
- Added TestIntegration_SentinelAssumeRole and TestIntegration_CredentialsAreValid
- Documentation for setting up test roles with sts:SetSourceIdentity permission

---

## Milestone Summary

**Key Decisions:**
- SourceIdentity format sentinel:<user>:<request-id> — unique per-request correlation, fits AWS 64-char limit
- Two-hop credential flow — enables SourceIdentity stamping on all role assumptions
- Crypto/rand for request-id — security-first entropy for correlation IDs
- User sanitization at call time — allows raw user storage, sanitizes for AWS constraints
- omitempty for new log fields — backward compatibility with existing log consumers

**Issues Resolved:**
- None — clean implementation

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None — implementation followed plan exactly

---

_For current project status, see .planning/ROADMAP.md_
