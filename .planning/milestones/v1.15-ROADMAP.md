# Milestone v1.15: Device Posture

**Status:** SHIPPED 2026-01-25
**Phases:** 104-112
**Total Plans:** 12

## Overview

Server-verified device posture via MDM APIs in Lambda TVM. CLI sends device identifier only - TVM queries Jamf/Intune/CrowdStrike for actual posture. Clients cannot fake compliance.

## Phases

### Phase 104: Device Fingerprint Schema

**Goal**: Define device posture data model with device ID, attestation claims, and policy binding
**Depends on**: v1.14 complete
**Plans**: 1 plan

Plans:
- [x] 104-01: Device posture types, policy conditions, log fields — completed 2026-01-25

**Details:**
- Created device/ package with DeviceID (32-char hex), PostureStatus enum, and DevicePosture struct
- Added DeviceCondition type with Matches() method for policy evaluation
- Extended DecisionLogEntry with device context fields for forensic logging

### Phase 105: Device Collector Interface

**Goal**: Abstract interface for collecting device posture from multiple sources (MDM, local)
**Depends on**: Phase 104
**Plans**: 1 plan

Plans:
- [x] 105-01: Collector interface and implementations — completed 2026-01-25

**Details:**
- Collector interface returns (*DevicePosture, error) for partial results
- MultiCollector merges with first-non-nil-wins semantics
- NoopCollector for testing and MDM-less deployments

### Phase 106: Device Identification

**Goal**: CLI collects stable hardware device ID only (NOT posture claims)
**Depends on**: Phase 105
**Plans**: 1 plan

Plans:
- [x] 106-01: Device identity module with GetDeviceID() using machineid library — completed 2026-01-25

**Details:**
- machineid.ProtectedID() for HMAC-SHA256 hashed device ID (64 hex chars)
- AppID 'sentinel-device-posture' isolates device IDs from other apps
- Cross-platform support (macOS, Linux, Windows)

### Phase 107: MDM API Integration

**Goal**: Lambda TVM queries MDM APIs (Jamf, Intune, Kandji) server-side to get actual device posture
**Depends on**: Phase 106
**Plans**: 3 plans

Plans:
- [x] 107-01: MDM provider interface and configuration types — completed 2026-01-25
- [x] 107-02: Jamf Pro MDM provider implementation — completed 2026-01-25
- [x] 107-03: Lambda TVM MDM integration — completed 2026-01-25

**Details:**
- MDMProvider interface with LookupDevice() method
- JamfProvider implementing Jamf Pro API (search by UDID/serialNumber)
- Lambda handler queries MDM on credential requests
- Fail-open by default (RequireDevicePosture=false)

### Phase 108: Policy Device Conditions

**Goal**: Add device posture conditions to policy rules (require_encryption, require_mdm, etc.)
**Depends on**: Phase 107
**Plans**: 1 plan

Plans:
- [x] 108-01: Wire device posture into policy evaluation and Lambda handler — completed 2026-01-25

**Details:**
- Device conditions affect RULE MATCHING (not effect) - if posture fails, rule doesn't match
- Nil posture fails non-empty device conditions (security: no posture = no match)
- Empty device conditions always match (backward compatible)
- DENY decision logs include device posture context for debugging

### Phase 109: Device Attestation Flow

**Goal**: Wire device ID into credential request, TVM queries MDM, binds posture to session
**Depends on**: Phase 108
**Plans**: 1 plan

Plans:
- [x] 109-01: CLI device ID collection and TVM integration — completed 2026-01-25

**Details:**
- CLI collects device ID via device.GetDeviceID() and passes to TVM as query param
- Fail-open on device ID collection failure (warning log, continue without)
- Device ID passed as query parameter device_id (64-char lowercase hex)

### Phase 110: Session Device Binding

**Goal**: Store device fingerprint in session metadata for forensic correlation and device-based revocation
**Depends on**: Phase 109
**Plans**: 1 plan

Plans:
- [x] 110-01: DeviceID field in ServerSession, ListByDeviceID query, Lambda integration — completed 2026-01-25

**Details:**
- ServerSession.DeviceID uses omitempty for backward compatibility
- ListByDeviceID enables device-based session queries
- Log device_bound=true flag rather than actual device ID for privacy

### Phase 111: Decision Logging Enhancement

**Goal**: Add device context to decision logs for forensic analysis
**Depends on**: Phase 110
**Plans**: 1 plan

Plans:
- [x] 111-01: Add device ID to CLI and server decision logs — completed 2026-01-25

**Details:**
- Device ID collected once at server startup, cached in struct for efficiency
- Fail-open on device ID collection for CLI decision logs (availability over blocking)
- All credential commands log device_id in decision entries

### Phase 112: Device Audit Commands

**Goal**: CLI commands to list devices, query sessions by device, and flag anomalies
**Depends on**: Phase 111
**Plans**: 1 plan

Plans:
- [x] 112-01: Device-sessions and devices commands with anomaly detection — completed 2026-01-25

**Details:**
- sentinel device-sessions <device-id> queries sessions by 64-char hex device ID
- sentinel devices aggregates unique devices with session history
- Anomaly detection: MULTI_USER (>1 user), HIGH_PROFILE_COUNT (>5 profiles)

---

## Milestone Summary

**Key Decisions:**
- DeviceID uses 32-char hex (128 bits) vs SessionID 16-char for stronger fingerprint uniqueness
- Pointer bools distinguish not checked (nil) from checked and false
- machineid.ProtectedID() for HMAC-SHA256 hashed device ID (64 hex chars)
- Fail-open by default for MDM (RequireDevicePosture=false)
- Device conditions affect RULE MATCHING (not effect) - rule doesn't match if posture fails
- Nil posture fails non-empty device conditions (security: no posture = no match)
- Device ID passed as query parameter device_id (64-char lowercase hex)
- ServerSession.DeviceID uses omitempty for backward compatibility
- Log device_bound=true flag rather than actual device ID for privacy
- Anomaly thresholds: MULTI_USER at >1 user, HIGH_PROFILE_COUNT at >5 profiles

**Issues Resolved:**
- None - milestone completed without blocking issues

**Issues Deferred:**
- Phase 113 (Documentation & Testing) deferred - core functionality complete
- Intune and Kandji MDM providers use NoopProvider until implemented
- Device attestation for hardware TPM/Secure Enclave (future milestone)

**Technical Debt Incurred:**
- Pre-existing test environment issues (missing /etc/machine-id in containers)
- CGO/gcc unavailable for race detection tests

---

_For current project status, see .planning/ROADMAP.md_
