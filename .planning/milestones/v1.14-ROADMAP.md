# Roadmap: Sentinel v1.14 Server-Side Credential Vending

## Overview

This milestone moves credential vending from client-side to server-side infrastructure via AWS Lambda Token Vending Machine (TVM). The Lambda function becomes the trust boundary - protected roles trust ONLY the Lambda execution role, preventing client applications from bypassing policy enforcement by calling AssumeRole directly. The journey reuses 95%+ of existing Sentinel packages (policy evaluation, session tracking, approval/break-glass integration, SourceIdentity stamping) in a serverless, auto-scaling deployment model.

**Critical architectural constraint:** Lambda IS the trust boundary. Protected roles must trust ONLY the Lambda execution role.

## Phases

**Phase Numbering:** Continues from v1.13 (phases 94-96 shipped 2026-01-24)

- [x] **Phase 97: Foundation** - Lambda handler skeleton and build pipeline
- [x] **Phase 98: Credential Vending** - AssumeRole integration with SourceIdentity stamping
- [x] **Phase 99: Policy & Session Integration** - Policy evaluation, session tracking, approval/break-glass checking
- [ ] **Phase 100: API Gateway** - HTTP API with IAM auth and profile discovery
- [ ] **Phase 101: Client Integration** - CLI remote-server mode and SCP enforcement patterns
- [ ] **Phase 102: Infrastructure as Code** - Terraform and CDK deployment automation
- [ ] **Phase 103: Testing & Documentation** - Integration tests, load tests, deployment guide

## Phase Details

### Phase 97: Foundation

**Goal**: Establish Lambda build pipeline and basic handler logic before AWS integration
**Depends on**: v1.13 complete
**Requirements**: LCORE-01
**Success Criteria** (what must be TRUE):
  1. Lambda binary builds for Linux architecture via make target
  2. Lambda handler parses API Gateway request and extracts caller identity
  3. Lambda handler returns credentials in AWS container credentials format
  4. Unit tests verify request parsing logic
**Plans**: 2 plans in 2 waves

Plans:
- [x] 97-01: Lambda infrastructure (build pipeline + types) — Wave 1 — completed 2026-01-24
- [x] 97-02: Handler implementation + tests — Wave 2 — completed 2026-01-24

### Phase 98: Credential Vending

**Goal**: Core TVM functionality - credential issuance via STS AssumeRole
**Depends on**: Phase 97
**Requirements**: LCORE-03, LCORE-04
**Success Criteria** (what must be TRUE):
  1. Lambda calls STS AssumeRole with SourceIdentity stamping
  2. Lambda returns temporary credentials in AWS container credentials format
  3. Returned credentials work for AWS service access (integration test)
  4. Lambda execution role IAM policy template exists for least-privilege AssumeRole
  5. Protected role trust policy template exists (trusts only Lambda execution role)
**Plans**: 3 plans in 2 waves

Plans:
- [x] 98-01: Credential vending function (VendCredentials + SourceIdentity) — Wave 1 — completed 2026-01-25
- [x] 98-02: Handler integration (replace mocks with real STS) — Wave 2 — completed 2026-01-25
- [x] 98-03: IAM role templates documentation — Wave 2 — completed 2026-01-25

### Phase 99: Policy & Session Integration

**Goal**: Reuse existing Sentinel policy evaluation, session tracking, approval, and break-glass logic with session tagging
**Depends on**: Phase 98
**Requirements**: LCORE-02, LCORE-05, LCORE-06, LCORE-07, LCORE-08, LCORE-09
**Success Criteria** (what must be TRUE):
  1. Lambda evaluates Sentinel policy before issuing credentials (policy deny blocks issuance)
  2. Lambda integrates with DynamoDB session tracking (sessions created/tracked via environment variable table name)
  3. Lambda stamps session ID as session tag on AssumeRole for downstream revocation checks
  4. Lambda checks for approved requests before credential issuance (approval flow works)
  5. Lambda checks for active break-glass before credential issuance (emergency access works)
  6. Lambda decision logging to CloudWatch in JSON Lines format (audit trail exists)
**Plans**: 4 plans in 3 waves

Plans:
- [x] 99-01: TVM configuration layer (TVMConfig + environment loading) — Wave 1 — completed 2026-01-25
- [x] 99-02: Policy evaluation integration — Wave 2 — completed 2026-01-25
- [x] 99-03: Session tracking with session tagging — Wave 2 — completed 2026-01-25
- [x] 99-04: Approval, break-glass, and logging integration — Wave 3 — completed 2026-01-25

### Phase 100: API Gateway

**Goal**: Expose Lambda via HTTP API with IAM authorization and instant revocation pattern
**Depends on**: Phase 99
**Requirements**: APIGW-01, APIGW-02, APIGW-03, APIGW-04, APIGW-05
**Success Criteria** (what must be TRUE):
  1. HTTP API endpoint serves credential vending at root path
  2. IAM authorization (SigV4) extracts caller identity from API Gateway request
  3. Profile discovery endpoint (GET /profiles) returns available profiles from SSM
  4. Resource policy restricts API Gateway access to VPC or IP ranges (deployment example)
  5. Lambda authorizer pattern for instant session revocation on sensitive APIs
  6. End-to-end test: API Gateway request returns credentials usable for AWS service access
**Plans**: 4 plans in 3 waves

Plans:
- [ ] 100-01: Routing and profile discovery infrastructure — Wave 1
- [ ] 100-02: Config integration and Lambda entry point — Wave 2
- [ ] 100-03: Lambda authorizer for session revocation — Wave 2
- [ ] 100-04: Deployment documentation — Wave 3

### Phase 101: Client Integration

**Goal**: Enable CLI and SDK clients to use remote TVM for credentials
**Depends on**: Phase 100
**Requirements**: CLIENT-01, CLIENT-02, CLIENT-03
**Success Criteria** (what must be TRUE):
  1. `sentinel exec --remote-server <url>` sets AWS_CONTAINER_CREDENTIALS_FULL_URI for SDK integration
  2. Documentation exists for manual credential URI setup without CLI changes (SDK-only clients)
  3. SCP example patterns exist to enforce TVM-only access (block direct AssumeRole calls)
  4. Integration test: sentinel exec --remote-server calls TVM endpoint and receives working credentials
**Plans**: TBD

Plans:
- [ ] 101-01: TBD

### Phase 102: Infrastructure as Code

**Goal**: Automate deployment once all components work end-to-end
**Depends on**: Phase 101
**Requirements**: INFRA-01, INFRA-02, INFRA-03, INFRA-04, INFRA-05
**Success Criteria** (what must be TRUE):
  1. Terraform module exists for Lambda + API Gateway deployment
  2. Lambda execution role template exists with least-privilege permissions
  3. Protected role trust policy template exists (trusts only Lambda execution role)
  4. CDK example exists for Lambda + API Gateway deployment
  5. Cost optimization documentation exists (low/medium/high volume patterns)
  6. Integration test: terraform apply deploys working TVM (credentials issued successfully)
**Plans**: TBD

Plans:
- [ ] 102-01: TBD

### Phase 103: Testing & Documentation

**Goal**: Comprehensive testing and deployment documentation for production readiness
**Depends on**: Phase 102
**Requirements**: TEST-01, TEST-02, TEST-03, DOC-01, DOC-02, DOC-03
**Success Criteria** (what must be TRUE):
  1. Integration tests cover full credential vending flow (API Gateway → Lambda → STS → working credentials)
  2. Security regression tests validate policy bypass prevention (cannot circumvent TVM)
  3. Load testing confirms <200ms p99 latency at target throughput
  4. LAMBDA_TVM.md deployment guide exists with setup instructions
  5. Migration guide exists comparing CLI server vs Lambda TVM (decision framework for users)
  6. Architecture guide for sensitive API protection with instant revocation pattern
**Plans**: TBD

Plans:
- [ ] 103-01: TBD

## Progress

**Execution Order:** Phases execute in numeric order: 97 → 98 → 99 → 100 → 101 → 102 → 103

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 97. Foundation | 2/2 | Complete | 2026-01-24 |
| 98. Credential Vending | 3/3 | Complete | 2026-01-25 |
| 99. Policy & Session Integration | 4/4 | Complete | 2026-01-25 |
| 100. API Gateway | 0/4 | Not started | - |
| 101. Client Integration | 0/TBD | Not started | - |
| 102. Infrastructure as Code | 0/TBD | Not started | - |
| 103. Testing & Documentation | 0/TBD | Not started | - |
