# Milestone v1.14: Server-Side Credential Vending

**Status:** SHIPPED 2026-01-25
**Phases:** 97-103
**Total Plans:** 19

## Overview

Move credential vending to server-side infrastructure (Lambda TVM) so clients cannot bypass policy enforcement. Lambda IS the trust boundary - protected roles trust ONLY the Lambda execution role.

## Phases

### Phase 97: Foundation

**Goal**: Establish Lambda build pipeline and basic handler logic before AWS integration
**Depends on**: v1.13 complete
**Plans**: 2 plans

Plans:
- [x] 97-01: Lambda infrastructure (build pipeline + types) — completed 2026-01-24
- [x] 97-02: Handler implementation + tests — completed 2026-01-24

**Details:**
- Added aws-lambda-go v1.47.0 dependency
- Created lambda-tvm-linux-amd64 Makefile target
- Implemented TVM types (CallerIdentity, TVMRequest, TVMResponse, TVMError)
- Created Lambda handler with HandleRequest function for API Gateway v2

### Phase 98: Credential Vending

**Goal**: Core TVM functionality - credential issuance via STS AssumeRole
**Depends on**: Phase 97
**Plans**: 3 plans

Plans:
- [x] 98-01: Credential vending function (VendCredentials, SourceIdentity stamping) — completed 2026-01-25
- [x] 98-02: Handler integration (VendCredentials integration, duration parameter) — completed 2026-01-25
- [x] 98-03: Lambda IAM role templates documentation — completed 2026-01-25

**Details:**
- VendCredentials function with STS AssumeRole and SourceIdentity
- Duration parameter support with DurationSeconds field
- Lambda execution role policy template in docs
- Protected role trust policy template

### Phase 99: Policy & Session Integration

**Goal**: Reuse existing Sentinel policy evaluation, session tracking, approval, and break-glass logic with session tagging
**Depends on**: Phase 98
**Plans**: 4 plans

Plans:
- [x] 99-01: TVM configuration layer (TVMConfig + environment loading) — completed 2026-01-25
- [x] 99-02: Policy evaluation integration — completed 2026-01-25
- [x] 99-03: Session tracking with session tagging — completed 2026-01-25
- [x] 99-04: Approval, break-glass, and logging integration — completed 2026-01-25

**Details:**
- TVMConfig with environment variable loading
- Policy evaluation via existing policy.Evaluate function
- Session tracking with DynamoDB and session tags on AssumeRole
- Approval and break-glass checking before credential issuance
- Decision logging to CloudWatch

### Phase 100: API Gateway

**Goal**: Expose Lambda via HTTP API with IAM authorization for caller identity extraction
**Depends on**: Phase 99
**Plans**: 4 plans

Plans:
- [x] 100-01: Routing and profile discovery (Router, ProfileDiscovery) — completed 2026-01-25
- [x] 100-02: Config integration (SSM client, policy root config) — completed 2026-01-25
- [x] 100-03: Lambda authorizer for session validation — completed 2026-01-25
- [x] 100-04: End-to-end test documentation — completed 2026-01-25

**Details:**
- Router with credential vending (POST /) and profile discovery (GET /profiles)
- SSM-based profile discovery from /sentinel/policies/*
- Lambda authorizer validating session status before credential issuance
- Comprehensive E2E testing documentation

### Phase 101: Client Integration

**Goal**: Enable CLI and SDK clients to use remote TVM for credentials
**Depends on**: Phase 100
**Plans**: 2 plans

Plans:
- [x] 101-01: Remote TVM flag (--remote-server, RemoteCredentialClient) — completed 2026-01-25
- [x] 101-02: SCP patterns and documentation — completed 2026-01-25

**Details:**
- --remote-server flag for sentinel exec
- RemoteCredentialClient using AWS_CONTAINER_CREDENTIALS_FULL_URI
- SCP patterns to enforce TVM-only access (block direct AssumeRole)
- Client integration documentation in LAMBDA_TVM.md

### Phase 102: Infrastructure as Code

**Goal**: Automate deployment once all components work end-to-end
**Depends on**: Phase 101
**Plans**: 3 plans

Plans:
- [x] 102-01: Terraform module for Lambda TVM — completed 2026-01-25
- [x] 102-02: CDK TypeScript example — completed 2026-01-25
- [x] 102-03: Protected role module + cost docs — completed 2026-01-25

**Details:**
- Complete Terraform module with Lambda, API Gateway, IAM roles
- CDK TypeScript example with deployment instructions
- Protected role Terraform module for SentinelProtected-* roles
- Cost optimization documentation for low/medium/high volume patterns

### Phase 103: Testing & Documentation

**Goal**: Comprehensive testing and deployment documentation for production readiness
**Depends on**: Phase 102
**Plans**: 2 plans

Plans:
- [x] 103-01: Security regression tests and testing documentation — completed 2026-01-25
- [x] 103-02: Migration guide and CHANGELOG — completed 2026-01-25

**Details:**
- TVM security regression tests with explicit SECURITY VIOLATION markers
- End-to-end testing documentation (unit, integration, security, load)
- Migration guide comparing CLI server vs Lambda TVM
- Decision framework for deployment model selection

---

## Milestone Summary

**Key Decisions:**
- Use aws-lambda-go v1.47.0 for Lambda handler types
- AWS container credentials format for SDK compatibility
- Lambda handler returns (response, error) for all paths
- TVMConfig uses environment variable loading pattern
- Router with POST / for credentials, GET /profiles for discovery
- ARM64 architecture for Lambda cost optimization (Graviton2)
- Security tests use explicit "SECURITY VIOLATION" markers
- Protected roles must use SentinelProtected- prefix for TVM policy match
- Trust policy requires both TVM principal and SourceIdentity condition

**Issues Resolved:**
- Client-side policy bypass risk (Lambda is now trust boundary)
- Credential vending moved server-side for enforceability

**Issues Deferred:**
- Load testing execution (documented but not run due to Go 1.25 toolchain)

**Technical Debt Incurred:**
- None

---

_For current project status, see .planning/ROADMAP.md_
