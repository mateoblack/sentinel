# Milestone v1.13: Enforced Session Tracking

**Status:** ✅ COMPLETE
**Phases:** 94-96
**Total Plans:** 10 (10 complete)
**Shipped:** 2026-01-24

## Overview

Make session tracking the default for all credential access. Instead of hoping users opt-in to `--server --session-table`, enforce it at the policy level so every session is trackable and revocable.

**Problem:**
```bash
# User gets credentials without session tracking
sentinel exec --profile prod -- aws s3 ls

# No record in server-sessions table
# If compromised, no way to revoke access
# Security team has no visibility
```

**Solution:**
```bash
# Policy enforces server mode with session tracking
# sentinel.yaml
policies:
  - match:
      profile: prod
    effect: require_server_session
    session_table: sentinel-sessions

# Now this fails:
sentinel exec --profile prod -- aws s3 ls
# Error: Policy requires server mode with session tracking

# Must use:
sentinel exec --server --session-table sentinel-sessions --profile prod -- aws s3 ls
# ✓ Session tracked, revocable
```

## Phases

### Phase 94: Policy Effect - require_server_session

**Goal**: New policy effect that enforces server mode with session tracking

**Policy Schema:**
```yaml
policies:
  - match:
      profile: prod
    effect: require_server_session
    session_table: sentinel-sessions  # Optional: specify table name

  - match:
      profile: dev
    effect: allow  # Dev can still use without tracking
```

**Behavior:**
- If `effect: require_server_session` matches, credential issuance MUST use `--server` with `--session-table`
- Without both flags, request is denied with clear error message
- Works with `sentinel exec` and `sentinel credentials`

**Plans:**
- [x] 94-01: Add require_server_session effect to policy schema — completed 2026-01-24
- [x] 94-02: CLI enforcement and error messaging — completed 2026-01-24
- [x] 94-03: Documentation for require_server_session — completed 2026-01-24

---

### Phase 95: Default Session Table Configuration

**Goal**: Allow session table to be configured globally so users don't need `--session-table` flag every time

**Configuration:**
```yaml
# ~/.sentinel/config.yaml or sentinel.yaml
defaults:
  session_table: sentinel-sessions
  region: us-east-1
```

**Behavior:**
- If `session_table` configured, `--server` automatically enables session tracking
- Policy can override with specific table name
- `--no-session-tracking` flag to explicitly opt-out (if policy allows)

**Plans:**
- [x] 95-01: Global session table configuration — completed 2026-01-24
- [x] 95-02: Auto-enable session tracking in server mode — completed 2026-01-24
- [x] 95-03: Policy override for table name — completed 2026-01-24
- [x] 95-SSO-FIX: Server mode SSO credential profile bug fix — completed 2026-01-24

---

### Phase 96: Session Tracking Audit & Compliance

**Goal**: Reporting and compliance features for session tracking

**Commands:**
```bash
# Show sessions without tracking (compliance gap)
sentinel audit untracked-sessions --since 7d

# Verify all prod access is tracked
sentinel audit session-compliance --profile prod

# Export session log for compliance
sentinel server-sessions --format csv --since 30d > sessions.csv
```

**Features:**
- Identify credential issuance that bypassed session tracking
- Compliance report showing tracking coverage
- Integration with CloudTrail for complete audit trail

**Plans:**
- [x] [96-01: Untracked session detection via CloudTrail](../phases/96-session-tracking-audit/96-01-PLAN.md) — completed 2026-01-24
- [x] [96-02: Session compliance reporting](../phases/96-session-tracking-audit/96-02-PLAN.md) — completed 2026-01-24
- [x] [96-03: CSV/JSON export for audit](../phases/96-session-tracking-audit/96-03-PLAN.md) — completed 2026-01-24

---

## Success Criteria

1. Organizations can enforce session tracking via policy
2. No credentials issued without tracking when policy requires it
3. Clear error messages guide users to correct usage
4. Audit tools verify compliance

## Dependencies

- v1.10 Real-time Revocation (server sessions infrastructure)
- v1.12 Infrastructure Provisioning (session table creation)

---

## Milestone Summary

**Key Decisions:**
- require_server_session effect evaluates dual conditions: server mode AND session table
- SENTINEL_SESSION_TABLE env var only applies in server mode (--server flag)
- Policy session_table overrides CLI/env (policy is source of truth)
- CloudTrail scan acceptable for audit queries (infrequent, not hot path)
- Non-zero exit code when compliance gaps found (CI/CD integration)

**Issues Resolved:**
- Server mode SSO credential profile bug (95-SSO-FIX)
- Invalid credential profile when using --aws-profile with --server

**Issues Deferred:**
None

**Technical Debt Incurred:**
None

---

_For current project status, see .planning/ROADMAP.md_
