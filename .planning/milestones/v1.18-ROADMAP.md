# Milestone v1.18: Critical Security Hardening

**Status:** ✅ SHIPPED 2026-01-26
**Phases:** 126-135
**Total Plans:** 24

## Overview

Address P0 security threats and high-risk vulnerabilities identified in STRIDE threat model analysis, including policy cache poisoning, break-glass bypass, audit log tampering, and credential exposure. Comprehensive security hardening with 153 regression tests across 13 packages.

## Phases

### Phase 126: Policy Integrity

**Goal**: KMS-signed policy validation to prevent cache poisoning attacks
**Depends on**: v1.17 complete
**Plans**: 3/3

Plans:
- [x] 126-01: KMS signing infrastructure (KMSAPI interface, PolicySigner, signature types) — completed 2026-01-26
- [x] 126-02: Verifying loader & CLI commands (VerifyingLoader, policy sign/verify, push --sign) — completed 2026-01-26
- [x] 126-03: Lambda TVM integration & security tests (config, handler integration, security tests) — completed 2026-01-26

**Details:**
- KMSAPI interface for policy signing/verification
- PolicySigner with Sign/Verify methods using RSASSA_PSS_SHA_256
- VerifyingLoader for signature-validated policy loading with fail-closed security
- CLI commands: `policy sign`, `policy verify`, `policy push --sign`
- Lambda TVM signature verification via SSM → Verifying → Cached pipeline

### Phase 127: Break-Glass MFA

**Goal**: Secondary verification (SMS/push) for emergency access to prevent abuse
**Depends on**: Phase 126
**Plans**: 3/3

Plans:
- [x] 127-01: MFA infrastructure (types, TOTP verifier, SMS verifier via SNS) — completed 2026-01-26
- [x] 127-02: Break-glass MFA integration (policy MFA requirements, CLI flow, logging) — completed 2026-01-26
- [x] 127-03: Security tests & CLI config (regression tests, SSM-based MFA configuration) — completed 2026-01-26

**Details:**
- MFA Verifier interface with Challenge/Verify pattern
- TOTP verifier with RFC 6238 compliance (30-second windows)
- SMS verifier using AWS SNS direct publish
- MFA requirements in break-glass policy rules
- Timing-safe code verification using crypto/subtle

### Phase 128: Audit Log Integrity

**Goal**: CloudWatch forwarding with HMAC signatures for tamper-evident logging
**Depends on**: Phase 127
**Plans**: 3/3

Plans:
- [x] 128-01: HMAC signature types and SignedLogger wrapper — completed 2026-01-26
- [x] 128-02: CloudWatch Logs forwarder and Lambda TVM integration — completed 2026-01-26
- [x] 128-03: verify-logs CLI command and security regression tests — completed 2026-01-26

**Details:**
- HMAC-SHA256 signature infrastructure with json.RawMessage for verification round-trips
- SignedLogger wrapper implementing Logger interface
- CloudWatch Logs forwarder with fail-open on errors (availability over security)
- `sentinel audit verify-logs` command with memory-efficient line-by-line processing
- Minimum 32-byte key length for HMAC-SHA256

### Phase 129: Local Server Security

**Goal**: Process-based authentication for credential servers to prevent local access
**Depends on**: Phase 128
**Plans**: 4/4

Plans:
- [x] 129-01: Peer credential infrastructure (PeerCredentials types, GetPeerCredentials, Linux/macOS/fallback) — completed 2026-01-26
- [x] 129-02: Unix server with process auth (ProcessAuthenticator, UnixServer, WithProcessAuth middleware) — completed 2026-01-26
- [x] 129-03: Credential server integration (SentinelServer Unix mode, CLI flags, integration tests) — completed 2026-01-26
- [x] 129-04: ECS/EC2 Unix mode & security tests (EcsServer Unix mode, EC2 security docs, regression tests) — completed 2026-01-26

**Details:**
- Cross-platform peer credential extraction (SO_PEERCRED on Linux, LOCAL_PEERCRED on macOS)
- ProcessToken type for process-bound bearer tokens with PID/UID validation
- UnixServer for HTTP over Unix domain sockets
- --unix-socket and --unix-socket-path CLI flags
- EcsServer Unix socket mode with process authentication

### Phase 130: Identity Hardening

**Goal**: Strengthen AWS STS identity validation, remove OS username dependency
**Depends on**: Phase 129
**Plans**: 1/1

Plans:
- [x] 130-01: Partition validation & identity extraction (aws-iso, aws-iso-b support, ExtractUsername consolidation) — completed 2026-01-26

**Details:**
- AWS ISO (DoD) and ISO-B (C2S) partition support in ARN validation
- Lambda TVM identity extraction consolidated to identity.ExtractUsername
- Sanitized usernames are alphanumeric-only (a-z, A-Z, 0-9)
- All 5 AWS partitions supported: aws, aws-cn, aws-us-gov, aws-iso, aws-iso-b

### Phase 131: DynamoDB Security

**Goal**: State integrity validation with conditional writes to prevent manipulation
**Depends on**: Phase 130
**Plans**: 2/2

Plans:
- [x] 131-01: Fix optimistic locking bug + state transition validation (session/dynamodb.go Update fix, request/breakglass state validation) — completed 2026-01-26
- [x] 131-02: Security regression tests (TestSecurityRegression_ tests for all three DynamoDB stores) — completed 2026-01-26

**Details:**
- Fixed optimistic locking bug: Update() now saves originalUpdatedAt before overwriting
- ValidTransition() method for RequestStatus and BreakGlassStatus types
- ErrInvalidStateTransition sentinel error for all stores
- Pre-update state validation with Get() call

### Phase 132: Keyring Protection

**Goal**: Secure credential storage with access controls and encryption
**Depends on**: Phase 131
**Plans**: 2/2

Plans:
- [x] 132-01: Keyring security hardening (macOS Keychain ACLs, Linux keyctl permissions, iCloud sync prevention) — completed 2026-01-26
- [x] 132-02: Security regression tests (TestSecurityRegression_* tests for keyring item properties) — completed 2026-01-26

**Details:**
- macOS Keychain: KeychainAccessibleWhenUnlocked: false, KeychainSynchronizable: false, KeychainNotTrustApplication: true
- Linux keyctl: possessor-only permissions (0x3f000000)
- Defense-in-depth at both config and item level
- Tests for Credential, Session, and OIDC keyring stores

### Phase 133: Rate Limit Hardening

**Goal**: Distributed rate limiting with DynamoDB to prevent bypass attacks
**Depends on**: Phase 132
**Plans**: 2/2

Plans:
- [x] 133-01: DynamoDB rate limiter implementation (atomic counters, fail-open, TTL) — completed 2026-01-26
- [x] 133-02: Lambda TVM integration & security tests (config, handler tests, regression tests) — completed 2026-01-26

**Details:**
- DynamoDBRateLimiter with atomic UpdateItem ADD operations
- Fail-open policy: log warning on DynamoDB errors, allow request
- TTL = window end + 1 hour buffer for cleanup
- SENTINEL_RATE_LIMIT_TABLE env var for configuration
- Rate limit key is IAM ARN (not IP) for per-user limiting

### Phase 134: Input Sanitization

**Goal**: Command injection prevention in MFA process and all user inputs
**Depends on**: Phase 133
**Plans**: 2/2

Plans:
- [x] 134-01: Input validation utilities & Lambda handler hardening (validate package, profile validation) — completed 2026-01-26
- [x] 134-02: Shell escaping security regression tests (shellEscape, sanitizeFunctionName tests) — completed 2026-01-26

**Details:**
- validate package with ValidateProfileName, ValidateSafeString, SanitizeForLog
- Profile name: alphanumeric, hyphen, underscore, forward slash, colon (max 256 chars)
- ASCII-only enforcement prevents homoglyph attacks
- Path traversal patterns (.., //, ./, /., \\) all rejected
- Shell escaping uses single-quote strategy for defense-in-depth

### Phase 135: Security Validation

**Goal**: Comprehensive security regression testing for all P0 and high-risk findings
**Depends on**: Phase 134
**Plans**: 2/2

Plans:
- [x] 135-01: Security test infrastructure (scripts/security-test.sh, Makefile targets, v1.18 integration tests) — completed 2026-01-26
- [x] 135-02: Security documentation and CI workflow (docs/SECURITY_TESTING.md, test-security.yml workflow) — completed 2026-01-26

**Details:**
- scripts/security-test.sh discovers 24 test files across 16 packages
- Makefile targets: test-security, test-security-verbose, test-all
- v1.18 integration tests validate cross-phase security
- CI workflow with 250-test threshold enforcement
- -race and -count=1 flags for thoroughness

---

## Milestone Summary

**Key Decisions:**
- Use MessageType RAW for KMS signing (KMS handles hashing internally)
- Return (false, nil) for invalid signatures - not an error, just validation result
- Fail-open on CloudWatch/signing errors (availability over security for logging)
- Fail-closed on policy signature verification (security over availability for policy)
- Entry stored as json.RawMessage to preserve exact bytes for HMAC verification
- Minimum key length 32 bytes (256 bits) for HMAC-SHA256
- Use UpdateItem with condition expression for atomic rate limit increment/window reset
- Rate limit by IAM ARN (not IP) for per-user limiting with IAM auth
- Profile name ASCII-only to prevent homoglyph attacks

**Issues Resolved:**
- Policy cache poisoning via SSM tampering (KMS signatures)
- Break-glass abuse via missing secondary verification (MFA enforcement)
- Audit log tampering (HMAC signatures + CloudWatch forwarding)
- Local credential theft via network sniffing (Unix socket + process auth)
- DynamoDB state manipulation via race conditions (optimistic locking fix + state validation)
- Keyring credential theft on shared systems (macOS ACLs + Linux keyctl permissions)
- Rate limit bypass across Lambda instances (DynamoDB distributed rate limiting)
- Command injection via profile names and shell escaping (input validation + shell hardening)

**Issues Deferred:**
- None - all P0 security threats addressed

**Technical Debt Incurred:**
- None - clean implementation

---

_For current project status, see .planning/ROADMAP.md_
